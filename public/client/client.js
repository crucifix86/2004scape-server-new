import{playWave as v_,setWaveVolume as J_,BZip2 as U_,playMidi as S_,stopMidi as z_,setMidiVolume as K_,MobileKeyboard as P_}from"./deps.js";var O0=document.getElementById("canvas"),t=O0.getContext("2d",{willReadFrequently:!0}),n0=document.createElement("canvas"),h0=document.createElement("img"),c0=n0.getContext("2d",{willReadFrequently:!0});class F0{key=0n;next=null;prev=null;unlink(){if(null!=this.prev){if(this.prev.next=this.next,this.next)this.next.prev=this.prev;this.next=null,this.prev=null}}}class j0 extends F0{next2=null;prev2=null;unlink2(){if(null!==this.prev2){if(this.prev2.next2=this.next2,this.next2)this.next2.prev2=this.prev2;this.next2=null,this.prev2=null}}}class T extends j0{static pixels=new Int32Array;static width2d=0;static height2d=0;static top=0;static bottom=0;static left=0;static right=0;static boundX=0;static centerX2d=0;static centerY2d=0;static bind(i,n,c){this.pixels=i,this.width2d=n,this.height2d=c,this.setBounds(0,0,n,c)}static resetBounds(){this.left=0,this.top=0,this.right=this.width2d,this.bottom=this.height2d,this.boundX=this.right-1,this.centerX2d=this.right/2|0}static setBounds(i,n,c,d){if(i<0)i=0;if(n<0)n=0;if(c>this.width2d)c=this.width2d;if(d>this.height2d)d=this.height2d;this.top=n,this.bottom=d,this.left=i,this.right=c,this.boundX=this.right-1,this.centerX2d=this.right/2|0,this.centerY2d=this.bottom/2|0}static clear(){let i=this.width2d*this.height2d;for(let n=0;n<i;n++)this.pixels[n]=0}static drawRect(i,n,c,d,u){this.drawHorizontalLine(i,n,u,c),this.drawHorizontalLine(i,n+d-1,u,c),this.drawVerticalLine(i,n,u,d),this.drawVerticalLine(i+c-1,n,u,d)}static drawHorizontalLine(i,n,c,d){if(n<this.top||n>=this.bottom)return;if(i<this.left)d-=this.left-i,i=this.left;if(i+d>this.right)d=this.right-i;let u=i+n*this.width2d;for(let i=0;i<d;i++)this.pixels[u+i]=c}static drawVerticalLine(i,n,c,d){if(i<this.left||i>=this.right)return;if(n<this.top)d-=this.top-n,n=this.top;if(n+d>this.bottom)d=this.bottom-n;let u=i+n*this.width2d;for(let i=0;i<d;i++)this.pixels[u+i*this.width2d]=c}static drawLine(i,n,c,d,u){let m=Math.abs(c-i),v=Math.abs(d-n),S=i<c?1:-1,b=n<d?1:-1,x=m-v;while(!0){if(i>=this.left&&i<this.right&&n>=this.top&&n<this.bottom)this.pixels[i+n*this.width2d]=u;if(i===c&&n===d)break;let I=2*x;if(I>-v)x-=v,i+=S;if(I<m)x+=m,n+=b}}static fillRect2d(i,n,c,d,u){if(i<this.left)c-=this.left-i,i=this.left;if(n<this.top)d-=this.top-n,n=this.top;if(i+c>this.right)c=this.right-i;if(n+d>this.bottom)d=this.bottom-n;let m=this.width2d-c,v=i+n*this.width2d;for(let i=-d;i<0;i++){for(let i=-c;i<0;i++)this.pixels[v++]=u;v+=m}}static fillRectAlpha(i,n,c,d,u,m){if(i<this.left)c-=this.left-i,i=this.left;if(n<this.top)d-=this.top-n,n=this.top;if(i+c>this.right)c=this.right-i;if(n+d>this.bottom)d=this.bottom-n;let v=256-m,S=(u>>16&255)*m,b=(u>>8&255)*m,x=(255&u)*m,I=this.width2d-c,A=i+n*this.width2d;for(let i=0;i<d;i++){for(let i=-c;i<0;i++){let i,n,c,d=(S+(this.pixels[A]>>16&255)*v>>8<<16)+(b+(this.pixels[A]>>8&255)*v>>8<<8)+(x+(255&this.pixels[A])*v>>8);this.pixels[A++]=d}A+=I}}static fillCircle(i,n,c,d,u){let m=256-u,v=(d>>16&255)*u,S=(d>>8&255)*u,b=(255&d)*u,x=n-c;if(x<0)x=0;let I=n+c;if(I>=this.height2d)I=this.height2d-1;for(let d=x;d<=I;d++){let u=d-n,x=0|Math.sqrt(c*c-u*u),I=i-x;if(I<0)I=0;let A=i+x;if(A>=this.width2d)A=this.width2d-1;let k=I+d*this.width2d;for(let i=I;i<=A;i++){let i,n,c,d=(v+(this.pixels[k]>>16&255)*m>>8<<16)+(S+(this.pixels[k]>>8&255)*m>>8<<8)+(b+(255&this.pixels[k])*m>>8);this.pixels[k++]=d}}}static setPixel(i,n,c){if(i<this.left||i>=this.right||n<this.top||n>=this.bottom)return;this.pixels[i+n*this.width2d]=c}}class m0{sentinel=new F0;current=null;constructor(){this.sentinel.next=this.sentinel,this.sentinel.prev=this.sentinel}addTail(i){if(i.prev)i.unlink();if(i.prev=this.sentinel.prev,i.next=this.sentinel,i.prev)i.prev.next=i;i.next.prev=i}addHead(i){if(i.prev)i.unlink();if(i.prev=this.sentinel,i.next=this.sentinel.next,i.prev.next=i,i.next)i.next.prev=i}removeHead(){let i=this.sentinel.next;if(i===this.sentinel)return null;return i?.unlink(),i}head(){let i=this.sentinel.next;if(i===this.sentinel)return this.current=null,null;return this.current=i?.next||null,i}tail(){let i=this.sentinel.prev;if(i===this.sentinel)return this.current=null,null;return this.current=i?.prev||null,i}next(){let i=this.current;if(i===this.sentinel)return this.current=null,null;return this.current=i?.next||null,i}prev(){let i=this.current;if(i===this.sentinel)return this.current=null,null;return this.current=i?.prev||null,i}clear(){while(!0){let i=this.sentinel.next;if(i===this.sentinel)return;i?.unlink()}}}var S0=async i=>new Promise(n=>setTimeout(n,i)),t0=async i=>new Uint8Array(await(await fetch(i)).arrayBuffer());function F_(i,n,c,d,u){while(u--)c[d++]=i[n++]}function V_(i){let n=0n;for(let c=0;c<i.length;c++)n=n<<8n|BigInt(i[c]);return n}function j_(i){let n=[];while(i>0n)n.unshift(Number(0xffn&i)),i>>=8n;if(128&n[0])n.unshift(0);return new Uint8Array(n)}function m_(i,n,c){let d=1n;while(n>0n){if(n%2n==1n)d=d*i%c;i=i*i%c,n>>=1n}return d}class f extends j0{static CRC32_POLYNOMIAL=3988292384;static crctable=new Int32Array(256);static bitmask=new Uint32Array(33);static cacheMin=new m0;static cacheMid=new m0;static cacheMax=new m0;static cacheMinCount=0;static cacheMidCount=0;static cacheMaxCount=0;static{for(let i=0;i<32;i++)f.bitmask[i]=(1<<i)-1;f.bitmask[32]=4294967295;for(let i=0;i<256;i++){let n=i;for(let i=0;i<8;i++)if(!(1&~n))n=n>>>1^f.CRC32_POLYNOMIAL;else n>>>=1;f.crctable[i]=n}}static crc32(i){let n=4294967295;for(let c=0;c<i.length;c++)n=n>>>8^f.crctable[255&(n^i[c])];return~n}view;data;pos=0;bitPos=0;random=null;constructor(i){if(!i)throw new Error;if(super(),i instanceof Int8Array)this.data=new Uint8Array(i);else this.data=i;this.view=new DataView(this.data.buffer,this.data.byteOffset,this.data.byteLength)}get length(){return this.view.byteLength}get available(){return this.length-this.pos}static alloc(i){let n=null;if(0===i&&f.cacheMinCount>0)f.cacheMinCount--,n=f.cacheMin.removeHead();else if(1===i&&f.cacheMidCount>0)f.cacheMidCount--,n=f.cacheMid.removeHead();else if(2===i&&f.cacheMaxCount>0)f.cacheMaxCount--,n=f.cacheMax.removeHead();if(n)return n.pos=0,n;if(0===i)return new f(new Uint8Array(100));else if(1===i)return new f(new Uint8Array(5e3));return new f(new Uint8Array(3e4))}release(){if(this.pos=0,100===this.view.byteLength&&f.cacheMinCount<1e3)f.cacheMin.addTail(this),f.cacheMinCount++;else if(5e3===this.view.byteLength&&f.cacheMidCount<250)f.cacheMid.addTail(this),f.cacheMidCount++;else if(3e4===this.view.byteLength&&f.cacheMaxCount<50)f.cacheMax.addTail(this),f.cacheMaxCount++}g1(){return this.view.getUint8(this.pos++)}g1b(){return this.view.getInt8(this.pos++)}g2(){let i=this.view.getUint16(this.pos);return this.pos+=2,i}g2b(){let i=this.view.getInt16(this.pos);return this.pos+=2,i}g3(){let i=this.view.getUint8(this.pos++)<<16|this.view.getUint16(this.pos);return this.pos+=2,i}g4(){let i=this.view.getInt32(this.pos);return this.pos+=4,i}g8(){let i=this.view.getBigInt64(this.pos);return this.pos+=8,i}gsmart(){return this.view.getUint8(this.pos)<128?this.g1()-64:this.g2()-49152}gsmarts(){return this.view.getUint8(this.pos)<128?this.g1():this.g2()-32768}gjstr(){let i=this.view,n=i.byteLength,c="",d;while(10!==(d=i.getUint8(this.pos++))&&this.pos<n)c+=String.fromCharCode(d);return c}gdata(i,n,c){c.set(this.data.subarray(this.pos,this.pos+i),n),this.pos+=i}p1isaac(i){this.view.setUint8(this.pos++,i+(this.random?.nextInt??0)&255)}p1(i){this.view.setUint8(this.pos++,i)}p2(i){this.view.setUint16(this.pos,i),this.pos+=2}ip2(i){this.view.setUint16(this.pos,i,!0),this.pos+=2}p3(i){this.view.setUint8(this.pos++,i>>16),this.view.setUint16(this.pos,i),this.pos+=2}p4(i){this.view.setInt32(this.pos,i),this.pos+=4}ip4(i){this.view.setInt32(this.pos,i,!0),this.pos+=4}p8(i){this.view.setBigInt64(this.pos,i),this.pos+=8}pjstr(i){let n=this.view,c=i.length;for(let d=0;d<c;d++)n.setUint8(this.pos++,i.charCodeAt(d));n.setUint8(this.pos++,10)}pdata(i,n,c){this.data.set(i.subarray(c,c+n),this.pos),this.pos+=n-c}psize1(i){this.view.setUint8(this.pos-i-1,i)}bits(){this.bitPos=this.pos<<3}bytes(){this.pos=this.bitPos+7>>>3}gBit(i){let n=this.bitPos>>>3,c=8-(7&this.bitPos),d=0;for(this.bitPos+=i;i>c;c=8)d+=(this.view.getUint8(n++)&f.bitmask[c])<<i-c,i-=c;if(i===c)d+=this.view.getUint8(n)&f.bitmask[c];else d+=this.view.getUint8(n)>>>c-i&f.bitmask[i];return d}rsaenc(i,n){let c=this.pos;this.pos=0;let d=new Uint8Array(c);this.gdata(c,0,d);let u,m,v=j_(m_(V_(d),n,i));this.pos=0,this.p1(v.length),this.pdata(v,v.length,0)}}class I0 extends j0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;rgbPal;constructor(i,n,c){super(),this.pixels=new Int8Array(i*n),this.width2d=this.cropW=i,this.height2d=this.cropH=n,this.cropX=this.cropY=0,this.rgbPal=c}static fromArchive(i,n,c=0){let d=new f(i.read(n+".dat")),u=new f(i.read("index.dat"));u.pos=d.g2();let m=u.g2(),v=u.g2(),S=u.g1(),b=new Int32Array(S);for(let i=1;i<S;i++)if(b[i]=u.g3(),0===b[i])b[i]=1;for(let i=0;i<c;i++)u.pos+=2,d.pos+=u.g2()*u.g2(),u.pos+=1;if(d.pos>d.length||u.pos>u.length)throw new Error;let x=u.g1(),I=u.g1(),A=u.g2(),k=u.g2(),L=new I0(A,k,b);L.cropX=x,L.cropY=I,L.cropW=m,L.cropH=v;let O=L.pixels,X=u.g1();if(0===X){let i=L.width2d*L.height2d;for(let n=0;n<i;n++)O[n]=d.g1b()}else if(1===X){let{width2d:i,height2d:n}=L;for(let c=0;c<i;c++)for(let u=0;u<n;u++)O[c+u*i]=d.g1b()}return L}draw(i,n){i|=0,n|=0;let c=(i+=this.cropX)+(n+=this.cropY)*T.width2d,d=0,u=this.height2d,m=this.width2d,v=T.width2d-m,S=0;if(n<T.top){let i=T.top-n;u-=i,n=T.top,d+=i*m,c+=i*T.width2d}if(n+u>T.bottom)u-=n+u-T.bottom;if(i<T.left){let n=T.left-i;m-=n,i=T.left,d+=n,c+=n,S+=n,v+=n}if(i+m>T.right){let n=i+m-T.right;m-=n,S+=n,v+=n}if(m>0&&u>0)this.copyImage(m,u,this.pixels,d,S,T.pixels,c,v)}flipHorizontally(){let i=this.pixels,n=this.width2d,c=this.height2d;for(let d=0;d<c;d++){let c=n/2|0;for(let u=0;u<c;u++){let c=u+d*n,m=n-u-1+d*n,v=i[c];i[c]=i[m],i[m]=v}}}flipVertically(){let i=this.pixels,n=this.width2d,c=this.height2d;for(let d=0;d<(c/2|0);d++)for(let u=0;u<n;u++){let m=u+d*n,v=u+(c-d-1)*n,S=i[m];i[m]=i[v],i[v]=S}}translate2d(i,n,c){for(let d=0;d<this.rgbPal.length;d++){let u=this.rgbPal[d]>>16&255;if(u+=i,u<0)u=0;else if(u>255)u=255;let m=this.rgbPal[d]>>8&255;if(m+=n,m<0)m=0;else if(m>255)m=255;let v=255&this.rgbPal[d];if(v+=c,v<0)v=0;else if(v>255)v=255;this.rgbPal[d]=(u<<16)+(m<<8)+v}}shrink(){this.cropW|=0,this.cropH|=0,this.cropW/=2,this.cropH/=2,this.cropW|=0,this.cropH|=0;let i=new Int8Array(this.cropW*this.cropH),n=0;for(let c=0;c<this.height2d;c++)for(let d=0;d<this.width2d;d++)i[(d+this.cropX>>1)+(c+this.cropY>>1)*this.cropW]=this.pixels[n++];this.pixels=i,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}crop(){if(this.width2d===this.cropW&&this.height2d===this.cropH)return;let i=new Int8Array(this.cropW*this.cropH),n=0;for(let c=0;c<this.height2d;c++)for(let d=0;d<this.width2d;d++)i[d+this.cropX+(c+this.cropY)*this.cropW]=this.pixels[n++];this.pixels=i,this.width2d=this.cropW,this.height2d=this.cropH,this.cropX=0,this.cropY=0}copyImage(i,n,c,d,u,m,v,S){let b=-(i>>2);i=-(3&i);for(let x=-n;x<0;x++){for(let i=b;i<0;i++){let i=c[d++];if(0===i)v++;else m[v++]=this.rgbPal[255&i];if(i=c[d++],0===i)v++;else m[v++]=this.rgbPal[255&i];if(i=c[d++],0===i)v++;else m[v++]=this.rgbPal[255&i];if(i=c[d++],0===i)v++;else m[v++]=this.rgbPal[255&i]}for(let n=i;n<0;n++){let i=c[d++];if(0===i)v++;else m[v++]=this.rgbPal[255&i]}v+=S,d+=u}}clip(i,n,c,d){try{let u=this.width2d,m=this.height2d,v=0,S=0,b=(u<<16)/c|0,x=(m<<16)/d|0,I=this.cropW,A=this.cropH,k=(I<<16)/c|0,L=(A<<16)/d|0;if(i=i+(this.cropX*c+I-1)/I|0,n=n+(this.cropY*d+A-1)/A|0,this.cropX*c%I!=0)v=(I-this.cropX*c%I<<16)/c|0;if(this.cropY*d%A!=0)S=(A-this.cropY*d%A<<16)/d|0;c=c*(this.width2d-(v>>16))/I|0,d=d*(this.height2d-(S>>16))/A|0;let O=i+n*T.width2d,X=T.width2d-c,M;if(n<T.top)M=T.top-n,d-=M,n=0,O+=M*T.width2d,S+=L*M;if(n+d>T.bottom)d-=n+d-T.bottom;if(i<T.left)M=T.left-i,c-=M,i=0,O+=M,v+=k*M,X+=M;if(i+c>T.right)M=i+c-T.right,c-=M,X+=M;this.plot_scale(T.pixels,this.pixels,this.rgbPal,v,S,O,X,c,d,k,L,u)}catch(i){}}plot_scale(i,n,c,d,u,m,v,S,b,x,I,A){try{let k=d;for(let L=-b;L<0;L++){let b=(u>>16)*A;for(let u=-S;u<0;u++){let u=n[(d>>16)+b];if(0==u)m++;else i[m++]=c[255&u];d+=x}u+=I,d=k,m+=v}}catch(i){}}}class C extends Array{constructor(i,n){super(i);for(let c=0;c<i;c++)this[c]=n}}class u_ extends Array{constructor(i,n,c){super(i);for(let d=0;d<i;d++){this[d]=new Array(n);for(let i=0;i<n;i++)this[d][i]=c}}}class p0 extends Array{constructor(i,n,c,d){super(i);for(let u=0;u<i;u++){this[u]=new Array(n);for(let i=0;i<n;i++){this[u][i]=new Array(c);for(let n=0;n<c;n++)this[u][i][n]=d}}}}class d0 extends Array{constructor(i,n,c,d,u){super(i);for(let m=0;m<i;m++){this[m]=new Array(n);for(let i=0;i<n;i++){this[m][i]=new Array(c);for(let n=0;n<c;n++){this[m][i][n]=new Array(d);for(let c=0;c<d;c++)this[m][i][n][c]=u}}}}}class B0 extends Array{constructor(i,n,c){super(i);for(let d=0;d<i;d++){this[d]=new Array(n);for(let i=0;i<n;i++)this[d][i]=new Uint8Array(c)}}}class W0 extends Array{constructor(i,n){super(i);for(let c=0;c<i;c++)this[c]=new Int32Array(n)}}class g0 extends Array{constructor(i,n,c){super(i);for(let d=0;d<i;d++){this[d]=new Array(n);for(let i=0;i<n;i++)this[d][i]=new Int32Array(c)}}}class w extends T{static lowMemory=!1;static reciprocal15=new Int32Array(512);static reciprocal16=new Int32Array(2048);static sin=new Int32Array(2048);static cos=new Int32Array(2048);static hslPal=new Int32Array(65536);static textures=new C(50,null);static textureCount=0;static lineOffset=new Int32Array;static centerX=0;static centerY=0;static jagged=!0;static clipX=!1;static alpha=0;static texelPool=null;static activeTexels=new C(50,null);static poolSize=0;static cycle=0;static textureCycle=new Int32Array(50);static texPal=new C(50,null);static opaque=!1;static textureTranslucent=new C(50,!1);static averageTextureRGB=new Int32Array(50);static{for(let i=1;i<512;i++)this.reciprocal15[i]=32768/i|0;for(let i=1;i<2048;i++)this.reciprocal16[i]=65536/i|0;for(let i=0;i<2048;i++)this.sin[i]=65536*Math.sin(.0030679615757712823*i)|0,this.cos[i]=65536*Math.cos(.0030679615757712823*i)|0}static init2D(){this.lineOffset=new Int32Array(T.height2d);for(let i=0;i<T.height2d;i++)this.lineOffset[i]=T.width2d*i;this.centerX=T.width2d/2|0,this.centerY=T.height2d/2|0}static init3D(i,n){this.lineOffset=new Int32Array(n);for(let c=0;c<n;c++)this.lineOffset[c]=i*c;this.centerX=i/2|0,this.centerY=n/2|0}static clearTexels(){this.texelPool=null,this.activeTexels.fill(null)}static unpackTextures(i){this.textureCount=0;for(let n=0;n<50;n++)try{if(this.textures[n]=I0.fromArchive(i,n.toString()),this.lowMemory&&128===this.textures[n]?.cropW)this.textures[n]?.shrink();else this.textures[n]?.crop();this.textureCount++}catch(i){}}static getAverageTextureRGB(i){if(0!==this.averageTextureRGB[i])return this.averageTextureRGB[i];let n=this.texPal[i];if(!n)return 0;let c=0,d=0,u=0,m=n.length;for(let i=0;i<m;i++)c+=n[i]>>16&255,d+=n[i]>>8&255,u+=255&n[i];let v=((c/m|0)<<16)+((d/m|0)<<8)+(u/m|0);if(v=this.setGamma(v,1.4),0===v)v=1;return this.averageTextureRGB[i]=v,v}static setBrightness(i){let n=i+.03*Math.random()-.015,c=0;for(let i=0;i<512;i++){let d=(i/8|0)/64+.0078125,u=(7&i)/8+.0625;for(let i=0;i<128;i++){let m=i/128,v=m,S=m,b=m;if(0!==u){let i;if(m<.5)i=m*(u+1);else i=m+u-m*u;let n=2*m-i,c=d+.3333333333333333;if(c>1)c--;let x=d-.3333333333333333;if(x<0)x++;if(6*c<1)v=n+6*(i-n)*c;else if(2*c<1)v=i;else if(3*c<2)v=n+(i-n)*(.6666666666666666-c)*6;else v=n;if(6*d<1)S=n+6*(i-n)*d;else if(2*d<1)S=i;else if(3*d<2)S=n+(i-n)*(.6666666666666666-d)*6;else S=n;if(6*x<1)b=n+6*(i-n)*x;else if(2*x<1)b=i;else if(3*x<2)b=n+(i-n)*(.6666666666666666-x)*6;else b=n}let x,I,A,k=((256*v|0)<<16)+((256*S|0)<<8)+(256*b|0);this.hslPal[c++]=this.setGamma(k,n)}}for(let i=0;i<50;i++){let c=this.textures[i];if(!c)continue;let d=c.rgbPal;this.texPal[i]=new Int32Array(d.length);for(let c=0;c<d.length;c++){let u=this.texPal[i];if(!u)continue;u[c]=this.setGamma(d[c],n)}}for(let i=0;i<50;i++)this.pushTexture(i)}static setGamma(i,n){let c=(i>>16)/256,d=(i>>8&255)/256,u=(255&i)/256,m,v,S,b,x,I;return((256*Math.pow(c,n)|0)<<16)+((256*Math.pow(d,n)|0)<<8)+(256*Math.pow(u,n)|0)}static initPool(i){if(this.texelPool)return;if(this.poolSize=i,this.lowMemory)this.texelPool=new W0(i,16384);else this.texelPool=new W0(i,65536);this.activeTexels.fill(null)}static fillGouraudTriangle(i,n,c,d,u,m,v,S,b){let x=0,I=0;if(u!==d)x=(n-i<<16)/(u-d)|0,I=(S-v<<15)/(u-d)|0;let A=0,k=0;if(m!==u)A=(c-n<<16)/(m-u)|0,k=(b-S<<15)/(m-u)|0;let L=0,O=0;if(m!==d)L=(i-c<<16)/(d-m)|0,O=(v-b<<15)/(d-m)|0;if(d<=u&&d<=m){if(d<T.bottom){if(u>T.bottom)u=T.bottom;if(m>T.bottom)m=T.bottom;if(u<m){if(c=i<<=16,b=v<<=15,d<0)c-=L*d,i-=x*d,b-=O*d,v-=I*d,d=0;if(n<<=16,S<<=15,u<0)n-=A*u,S-=k*u,u=0;if(d!==u&&L<x||d===u&&L>A){m-=u,u-=d,d=w.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawGouraudScanline(c>>16,n>>16,b>>7,S>>7,T.pixels,d,0),c+=L,n+=A,b+=O,S+=k,d+=T.width2d}this.drawGouraudScanline(c>>16,i>>16,b>>7,v>>7,T.pixels,d,0),c+=L,i+=x,b+=O,v+=I,d+=T.width2d}}else{m-=u,u-=d,d=w.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawGouraudScanline(n>>16,c>>16,S>>7,b>>7,T.pixels,d,0),c+=L,n+=A,b+=O,S+=k,d+=T.width2d}this.drawGouraudScanline(i>>16,c>>16,v>>7,b>>7,T.pixels,d,0),c+=L,i+=x,b+=O,v+=I,d+=T.width2d}}}else{if(n=i<<=16,S=v<<=15,d<0)n-=L*d,i-=x*d,S-=O*d,v-=I*d,d=0;if(c<<=16,b<<=15,m<0)c-=A*m,b-=k*m,m=0;if(d!==m&&L<x||d===m&&A>x){u-=m,m-=d,d=w.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawGouraudScanline(c>>16,i>>16,b>>7,v>>7,T.pixels,d,0),c+=A,i+=x,b+=k,v+=I,d+=T.width2d}this.drawGouraudScanline(n>>16,i>>16,S>>7,v>>7,T.pixels,d,0),n+=L,i+=x,S+=O,v+=I,d+=T.width2d}}else{u-=m,m-=d,d=w.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawGouraudScanline(i>>16,c>>16,v>>7,b>>7,T.pixels,d,0),c+=A,i+=x,b+=k,v+=I,d+=T.width2d}this.drawGouraudScanline(i>>16,n>>16,v>>7,S>>7,T.pixels,d,0),n+=L,i+=x,S+=O,v+=I,d+=T.width2d}}}}}else if(u<=m){if(u<T.bottom){if(m>T.bottom)m=T.bottom;if(d>T.bottom)d=T.bottom;if(m<d){if(i=n<<=16,v=S<<=15,u<0)i-=x*u,n-=A*u,v-=I*u,S-=k*u,u=0;if(c<<=16,b<<=15,m<0)c-=L*m,b-=O*m,m=0;if(u!==m&&x<A||u===m&&x>L){d-=m,m-=u,u=w.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawGouraudScanline(i>>16,c>>16,v>>7,b>>7,T.pixels,u,0),i+=x,c+=L,v+=I,b+=O,u+=T.width2d}this.drawGouraudScanline(i>>16,n>>16,v>>7,S>>7,T.pixels,u,0),i+=x,n+=A,v+=I,S+=k,u+=T.width2d}}else{d-=m,m-=u,u=w.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawGouraudScanline(c>>16,i>>16,b>>7,v>>7,T.pixels,u,0),i+=x,c+=L,v+=I,b+=O,u+=T.width2d}this.drawGouraudScanline(n>>16,i>>16,S>>7,v>>7,T.pixels,u,0),i+=x,n+=A,v+=I,S+=k,u+=T.width2d}}}else{if(c=n<<=16,b=S<<=15,u<0)c-=x*u,n-=A*u,b-=I*u,S-=k*u,u=0;if(i<<=16,v<<=15,d<0)i-=L*d,v-=O*d,d=0;if(m-=d,d-=u,u=w.lineOffset[u],x<A)while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawGouraudScanline(i>>16,n>>16,v>>7,S>>7,T.pixels,u,0),i+=L,n+=A,v+=O,S+=k,u+=T.width2d}this.drawGouraudScanline(c>>16,n>>16,b>>7,S>>7,T.pixels,u,0),c+=x,n+=A,b+=I,S+=k,u+=T.width2d}else while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawGouraudScanline(n>>16,i>>16,S>>7,v>>7,T.pixels,u,0),i+=L,n+=A,v+=O,S+=k,u+=T.width2d}this.drawGouraudScanline(n>>16,c>>16,S>>7,b>>7,T.pixels,u,0),c+=x,n+=A,b+=I,S+=k,u+=T.width2d}}}}else if(m<T.bottom){if(d>T.bottom)d=T.bottom;if(u>T.bottom)u=T.bottom;if(d<u){if(n=c<<=16,S=b<<=15,m<0)n-=A*m,c-=L*m,S-=k*m,b-=O*m,m=0;if(i<<=16,v<<=15,d<0)i-=x*d,v-=I*d,d=0;if(u-=d,d-=m,m=w.lineOffset[m],A<L)while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawGouraudScanline(n>>16,i>>16,S>>7,v>>7,T.pixels,m,0),n+=A,i+=x,S+=k,v+=I,m+=T.width2d}this.drawGouraudScanline(n>>16,c>>16,S>>7,b>>7,T.pixels,m,0),n+=A,c+=L,S+=k,b+=O,m+=T.width2d}else while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawGouraudScanline(i>>16,n>>16,v>>7,S>>7,T.pixels,m,0),n+=A,i+=x,S+=k,v+=I,m+=T.width2d}this.drawGouraudScanline(c>>16,n>>16,b>>7,S>>7,T.pixels,m,0),n+=A,c+=L,S+=k,b+=O,m+=T.width2d}}else{if(i=c<<=16,v=b<<=15,m<0)i-=A*m,c-=L*m,v-=k*m,b-=O*m,m=0;if(n<<=16,S<<=15,u<0)n-=x*u,S-=I*u,u=0;if(d-=u,u-=m,m=w.lineOffset[m],A<L)while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawGouraudScanline(n>>16,c>>16,S>>7,b>>7,T.pixels,m,0),n+=x,c+=L,S+=I,b+=O,m+=T.width2d}this.drawGouraudScanline(i>>16,c>>16,v>>7,b>>7,T.pixels,m,0),i+=A,c+=L,v+=k,b+=O,m+=T.width2d}else while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawGouraudScanline(c>>16,n>>16,b>>7,S>>7,T.pixels,m,0),n+=x,c+=L,S+=I,b+=O,m+=T.width2d}this.drawGouraudScanline(c>>16,i>>16,b>>7,v>>7,T.pixels,m,0),i+=A,c+=L,v+=k,b+=O,m+=T.width2d}}}}static drawGouraudScanline(i,n,c,d,u,m,v){let S;if(w.jagged){let b;if(w.clipX){if(n-i>3)b=(d-c)/(n-i)|0;else b=0;if(n>T.boundX)n=T.boundX;if(i<0)c-=i*b,i=0;if(i>=n)return;m+=i,v=n-i>>2,b<<=2}else if(i<n)if(m+=i,(v=n-i>>2)>0)b=(d-c)*w.reciprocal15[v]>>15;else b=0;else return;if(0===w.alpha)while(!0){if(--v<0){if((v=n-i&3)>0){S=w.hslPal[c>>8];do{u[m++]=S,v--}while(v>0);return}break}S=w.hslPal[c>>8],c+=b,u[m++]=S,u[m++]=S,u[m++]=S,u[m++]=S}else{let d=w.alpha,x=256-w.alpha;while(!0){if(--v<0){if((v=n-i&3)>0){S=w.hslPal[c>>8],S=((16711935&S)*x>>8&16711935)+((65280&S)*x>>8&65280);do{u[m++]=S+((16711935&u[m])*d>>8&16711935)+((65280&u[m])*d>>8&65280),v--}while(v>0)}break}S=w.hslPal[c>>8],c+=b,S=((16711935&S)*x>>8&16711935)+((65280&S)*x>>8&65280),u[m++]=S+((16711935&u[m])*d>>8&16711935)+((65280&u[m])*d>>8&65280),u[m++]=S+((16711935&u[m])*d>>8&16711935)+((65280&u[m])*d>>8&65280),u[m++]=S+((16711935&u[m])*d>>8&16711935)+((65280&u[m])*d>>8&65280),u[m++]=S+((16711935&u[m])*d>>8&16711935)+((65280&u[m])*d>>8&65280)}}}else if(i<n){let b=(d-c)/(n-i)|0;if(w.clipX){if(n>T.boundX)n=T.boundX;if(i<0)c-=i*b,i=0;if(i>=n)return}if(m+=i,v=n-i,0===w.alpha)do{u[m++]=w.hslPal[c>>8],c+=b,v--}while(v>0);else{let i=w.alpha,n=256-w.alpha;do{S=w.hslPal[c>>8],c+=b,S=((16711935&S)*n>>8&16711935)+((65280&S)*n>>8&65280),u[m++]=S+((16711935&u[m])*i>>8&16711935)+((65280&u[m])*i>>8&65280),v--}while(v>0)}}}static fillTriangle(i,n,c,d,u,m,v){let S=0;if(u!==d)S=(n-i<<16)/(u-d)|0;let b=0;if(m!==u)b=(c-n<<16)/(m-u)|0;let x=0;if(m!==d)x=(i-c<<16)/(d-m)|0;if(d<=u&&d<=m){if(d<T.bottom){if(u>T.bottom)u=T.bottom;if(m>T.bottom)m=T.bottom;if(u<m){if(c=i<<=16,d<0)c-=x*d,i-=S*d,d=0;if(n<<=16,u<0)n-=b*u,u=0;if(d!==u&&x<S||d===u&&x>b){m-=u,u-=d,d=this.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawScanline(c>>16,n>>16,T.pixels,d,v),c+=x,n+=b,d+=T.width2d}this.drawScanline(c>>16,i>>16,T.pixels,d,v),c+=x,i+=S,d+=T.width2d}}else{m-=u,u-=d,d=this.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawScanline(n>>16,c>>16,T.pixels,d,v),c+=x,n+=b,d+=T.width2d}this.drawScanline(i>>16,c>>16,T.pixels,d,v),c+=x,i+=S,d+=T.width2d}}}else{if(n=i<<=16,d<0)n-=x*d,i-=S*d,d=0;if(c<<=16,m<0)c-=b*m,m=0;if(d!==m&&x<S||d===m&&b>S){u-=m,m-=d,d=this.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawScanline(c>>16,i>>16,T.pixels,d,v),c+=b,i+=S,d+=T.width2d}this.drawScanline(n>>16,i>>16,T.pixels,d,v),n+=x,i+=S,d+=T.width2d}}else{u-=m,m-=d,d=this.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawScanline(i>>16,c>>16,T.pixels,d,v),c+=b,i+=S,d+=T.width2d}this.drawScanline(i>>16,n>>16,T.pixels,d,v),n+=x,i+=S,d+=T.width2d}}}}}else if(u<=m){if(u<T.bottom){if(m>T.bottom)m=T.bottom;if(d>T.bottom)d=T.bottom;if(m<d){if(i=n<<=16,u<0)i-=S*u,n-=b*u,u=0;if(c<<=16,m<0)c-=x*m,m=0;if(u!==m&&S<b||u===m&&S>x){d-=m,m-=u,u=this.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawScanline(i>>16,c>>16,T.pixels,u,v),i+=S,c+=x,u+=T.width2d}this.drawScanline(i>>16,n>>16,T.pixels,u,v),i+=S,n+=b,u+=T.width2d}}else{d-=m,m-=u,u=this.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawScanline(c>>16,i>>16,T.pixels,u,v),i+=S,c+=x,u+=T.width2d}this.drawScanline(n>>16,i>>16,T.pixels,u,v),i+=S,n+=b,u+=T.width2d}}}else{if(c=n<<=16,u<0)c-=S*u,n-=b*u,u=0;if(i<<=16,d<0)i-=x*d,d=0;if(S<b){m-=d,d-=u,u=this.lineOffset[u];while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawScanline(i>>16,n>>16,T.pixels,u,v),i+=x,n+=b,u+=T.width2d}this.drawScanline(c>>16,n>>16,T.pixels,u,v),c+=S,n+=b,u+=T.width2d}}else{m-=d,d-=u,u=this.lineOffset[u];while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawScanline(n>>16,i>>16,T.pixels,u,v),i+=x,n+=b,u+=T.width2d}this.drawScanline(n>>16,c>>16,T.pixels,u,v),c+=S,n+=b,u+=T.width2d}}}}}else if(m<T.bottom){if(d>T.bottom)d=T.bottom;if(u>T.bottom)u=T.bottom;if(d<u){if(n=c<<=16,m<0)n-=b*m,c-=x*m,m=0;if(i<<=16,d<0)i-=S*d,d=0;if(b<x){u-=d,d-=m,m=this.lineOffset[m];while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawScanline(n>>16,i>>16,T.pixels,m,v),n+=b,i+=S,m+=T.width2d}this.drawScanline(n>>16,c>>16,T.pixels,m,v),n+=b,c+=x,m+=T.width2d}}else{u-=d,d-=m,m=this.lineOffset[m];while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawScanline(i>>16,n>>16,T.pixels,m,v),n+=b,i+=S,m+=T.width2d}this.drawScanline(c>>16,n>>16,T.pixels,m,v),n+=b,c+=x,m+=T.width2d}}}else{if(i=c<<=16,m<0)i-=b*m,c-=x*m,m=0;if(n<<=16,u<0)n-=S*u,u=0;if(b<x){d-=u,u-=m,m=this.lineOffset[m];while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawScanline(n>>16,c>>16,T.pixels,m,v),n+=S,c+=x,m+=T.width2d}this.drawScanline(i>>16,c>>16,T.pixels,m,v),i+=b,c+=x,m+=T.width2d}}else{d-=u,u-=m,m=this.lineOffset[m];while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawScanline(c>>16,n>>16,T.pixels,m,v),n+=S,c+=x,m+=T.width2d}this.drawScanline(c>>16,i>>16,T.pixels,m,v),i+=b,c+=x,m+=T.width2d}}}}}static fillTexturedTriangle(i,n,c,d,u,m,v,S,b,x,I,A,k,L,O,X,M,Y,B){let F=this.getTexels(B);this.opaque=!this.textureTranslucent[B];let E=x-k,D=I-O,R=A-M,_=L-x,z=X-I,Z=Y-A,q=_*I-z*x<<14,N=z*A-Z*I<<8,W=Z*x-_*A<<5,j=E*I-D*x<<14,H=D*A-R*I<<8,G=R*x-E*A<<5,U=D*_-E*z<<14,Q=R*z-D*Z<<8,K=E*Z-R*_<<5,$=0,ee=0;if(u!==d)$=(n-i<<16)/(u-d)|0,ee=(S-v<<16)/(u-d)|0;let te=0,ie=0;if(m!==u)te=(c-n<<16)/(m-u)|0,ie=(b-S<<16)/(m-u)|0;let se=0,ae=0;if(m!==d)se=(i-c<<16)/(d-m)|0,ae=(v-b<<16)/(d-m)|0;if(d<=u&&d<=m){if(d<T.bottom){if(u>T.bottom)u=T.bottom;if(m>T.bottom)m=T.bottom;if(u<m){if(c=i<<=16,b=v<<=16,d<0)c-=se*d,i-=$*d,b-=ae*d,v-=ee*d,d=0;if(n<<=16,S<<=16,u<0)n-=te*u,S-=ie*u,u=0;let x=d-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,d!==u&&se<$||d===u&&se>te){m-=u,u-=d,d=this.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawTexturedScanline(c>>16,n>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,b>>8,S>>8),c+=se,n+=te,b+=ae,S+=ie,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(c>>16,i>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,b>>8,v>>8),c+=se,i+=$,b+=ae,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}else{m-=u,u-=d,d=this.lineOffset[d];while(!0){if(--u<0)while(!0){if(--m<0)return;this.drawTexturedScanline(n>>16,c>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,S>>8,b>>8),c+=se,n+=te,b+=ae,S+=ie,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(i>>16,c>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,v>>8,b>>8),c+=se,i+=$,b+=ae,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}}else{if(n=i<<=16,S=v<<=16,d<0)n-=se*d,i-=$*d,S-=ae*d,v-=ee*d,d=0;if(c<<=16,b<<=16,m<0)c-=te*m,b-=ie*m,m=0;let x=d-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,(d===m||se>=$)&&(d!==m||te<=$)){u-=m,m-=d,d=this.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawTexturedScanline(i>>16,c>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,v>>8,b>>8),c+=te,i+=$,b+=ie,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(i>>16,n>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,v>>8,S>>8),n+=se,i+=$,S+=ae,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}else{u-=m,m-=d,d=this.lineOffset[d];while(!0){if(--m<0)while(!0){if(--u<0)return;this.drawTexturedScanline(c>>16,i>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,b>>8,v>>8),c+=te,i+=$,b+=ie,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(n>>16,i>>16,T.pixels,d,F,0,0,q,j,U,N,H,Q,S>>8,v>>8),n+=se,i+=$,S+=ae,v+=ee,d+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}}}}else if(u<=m){if(u<T.bottom){if(m>T.bottom)m=T.bottom;if(d>T.bottom)d=T.bottom;if(m<d){if(i=n<<=16,v=S<<=16,u<0)i-=$*u,n-=te*u,v-=ee*u,S-=ie*u,u=0;if(c<<=16,b<<=16,m<0)c-=se*m,b-=ae*m,m=0;let x=u-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,u!==m&&$<te||u===m&&$>se){d-=m,m-=u,u=this.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawTexturedScanline(i>>16,c>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,v>>8,b>>8),i+=$,c+=se,v+=ee,b+=ae,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(i>>16,n>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,v>>8,S>>8),i+=$,n+=te,v+=ee,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}else{d-=m,m-=u,u=this.lineOffset[u];while(!0){if(--m<0)while(!0){if(--d<0)return;this.drawTexturedScanline(c>>16,i>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,b>>8,v>>8),i+=$,c+=se,v+=ee,b+=ae,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(n>>16,i>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,S>>8,v>>8),i+=$,n+=te,v+=ee,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}}else{if(c=n<<=16,b=S<<=16,u<0)c-=$*u,n-=te*u,b-=ee*u,S-=ie*u,u=0;if(i<<=16,v<<=16,d<0)i-=se*d,v-=ae*d,d=0;let x=u-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,m-=d,d-=u,u=this.lineOffset[u],$<te)while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawTexturedScanline(i>>16,n>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,v>>8,S>>8),i+=se,n+=te,v+=ae,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(c>>16,n>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,b>>8,S>>8),c+=$,n+=te,b+=ee,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}else while(!0){if(--d<0)while(!0){if(--m<0)return;this.drawTexturedScanline(n>>16,i>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,S>>8,v>>8),i+=se,n+=te,v+=ae,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(n>>16,c>>16,T.pixels,u,F,0,0,q,j,U,N,H,Q,S>>8,b>>8),c+=$,n+=te,b+=ee,S+=ie,u+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}}}else if(m<T.bottom){if(d>T.bottom)d=T.bottom;if(u>T.bottom)u=T.bottom;if(d<u){if(n=c<<=16,S=b<<=16,m<0)n-=te*m,c-=se*m,S-=ie*m,b-=ae*m,m=0;if(i<<=16,v<<=16,d<0)i-=$*d,v-=ee*d,d=0;let x=m-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,u-=d,d-=m,m=this.lineOffset[m],te<se)while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawTexturedScanline(n>>16,i>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,S>>8,v>>8),n+=te,i+=$,S+=ie,v+=ee,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(n>>16,c>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,S>>8,b>>8),n+=te,c+=se,S+=ie,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}else while(!0){if(--d<0)while(!0){if(--u<0)return;this.drawTexturedScanline(i>>16,n>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,v>>8,S>>8),n+=te,i+=$,S+=ie,v+=ee,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(c>>16,n>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,b>>8,S>>8),n+=te,c+=se,S+=ie,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}else{if(i=c<<=16,v=b<<=16,m<0)i-=te*m,c-=se*m,v-=ie*m,b-=ae*m,m=0;if(n<<=16,S<<=16,u<0)n-=$*u,S-=ee*u,u=0;let x=m-this.centerY;if(q+=W*x,j+=G*x,U+=K*x,q|=0,j|=0,U|=0,d-=u,u-=m,m=this.lineOffset[m],te<se)while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawTexturedScanline(n>>16,c>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,S>>8,b>>8),n+=$,c+=se,S+=ee,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(i>>16,c>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,v>>8,b>>8),i+=te,c+=se,v+=ie,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}else while(!0){if(--u<0)while(!0){if(--d<0)return;this.drawTexturedScanline(c>>16,n>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,b>>8,S>>8),n+=$,c+=se,S+=ee,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}this.drawTexturedScanline(c>>16,i>>16,T.pixels,m,F,0,0,q,j,U,N,H,Q,b>>8,v>>8),i+=te,c+=se,v+=ie,b+=ae,m+=T.width2d,q+=W,j+=G,U+=K,q|=0,j|=0,U|=0}}}}static drawTexturedScanline(i,n,c,d,u,m,v,S,b,x,I,A,k,L,O){if(i>=n)return;let X,M;if(this.clipX){if(X=(O-L)/(n-i)|0,n>T.boundX)n=T.boundX;if(i<0)L-=i*X,i=0;if(i>=n)return;M=n-i>>3,X<<=12}else if(n-i>7)M=n-i>>3,X=(O-L)*this.reciprocal15[M]>>6;else M=0,X=0;let Y,B,F,E,D,R,_;if(L<<=9,d+=i,this.lowMemory&&u){if(Y=0,B=0,E=i-this.centerX,S+=(I>>3)*E,b+=(A>>3)*E,x+=(k>>3)*E,S|=0,b|=0,F=(x|=0)>>12,0!==F)if(v=b/F|0,(m=S/F|0)<0)m=0;else if(m>4032)m=4032;if(S+=I,b+=A,x+=k,S|=0,b|=0,F=(x|=0)>>12,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>4032)Y=4032;if(D=Y-m>>3,R=B-v>>3,m+=L>>3&786432,_=L>>23,this.opaque){while(M-- >0){if(c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R,c[d++]=u[(4032&v)+(m>>6)]>>>_,m=Y,v=B,S+=I,b+=A,F=(x+=k)>>12,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>4032)Y=4032;D=Y-m>>3,R=B-v>>3,m+=(L+=X)>>3&786432,_=L>>23}M=n-i&7;while(M-- >0)c[d++]=u[(4032&v)+(m>>6)]>>>_,m+=D,v+=R}else{while(M-- >0){let i;if(0!==(i=u[(4032&v)+(m>>6)]>>>_))c[d]=i;if(d+=1,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d++,0!==(i=u[(4032&(v+=R))+((m+=D)>>6)]>>>_))c[d]=i;if(d+=1,m=Y,v=B,S+=I,b+=A,x+=k,S|=0,b|=0,F=(x|=0)>>12,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>4032)Y=4032;D=Y-m>>3,R=B-v>>3,m+=(L+=X)>>3&786432,_=L>>23}M=n-i&7;while(M-- >0){let i;if(0!==(i=u[(4032&v)+(m>>6)]>>>_))c[d]=i;d++,m+=D,v+=R}}return}if(Y=0,B=0,E=i-this.centerX,S+=(I>>3)*E,b+=(A>>3)*E,x+=(k>>3)*E,S|=0,b|=0,F=(x|=0)>>14,0!==F)if(v=b/F|0,(m=S/F|0)<0)m=0;else if(m>16256)m=16256;if(S+=I,b+=A,x+=k,S|=0,b|=0,F=(x|=0)>>14,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>16256)Y=16256;if(D=Y-m>>3,R=B-v>>3,m+=6291456&L,_=L>>23,this.opaque&&u){while(M-- >0){if(c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R,c[d++]=u[(16256&v)+(m>>7)]>>>_,m=Y,v=B,S+=I,b+=A,x+=k,S|=0,b|=0,F=(x|=0)>>14,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>16256)Y=16256;D=Y-m>>3,R=B-v>>3,m+=6291456&(L+=X),_=L>>23}M=n-i&7;while(M-- >0)c[d++]=u[(16256&v)+(m>>7)]>>>_,m+=D,v+=R;return}while(M-- >0&&u){let i;if(0!==(i=u[(16256&v)+(m>>7)]>>>_))c[d]=i;if(d+=1,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,0!==(i=u[(16256&(v+=R))+((m+=D)>>7)]>>>_))c[d]=i;if(d++,m=Y,v=B,S+=I,b+=A,x+=k,S|=0,b|=0,F=(x|=0)>>14,0!==F)if(Y=S/F|0,B=b/F|0,Y<7)Y=7;else if(Y>16256)Y=16256;D=Y-m>>3,R=B-v>>3,m+=6291456&(L+=X),_=L>>23}M=n-i&7;while(M-- >0&&u){let i;if(0!==(i=u[(16256&v)+(m>>7)]>>>_))c[d]=i;d++,m+=D,v+=R}}static drawScanline(i,n,c,d,u){if(this.clipX){if(n>T.boundX)n=T.boundX;if(i<0)i=0}if(i>=n)return;d+=i;let m=n-i>>2;if(0===this.alpha)while(!0){if(m--,m<0){m=n-i&3;while(!0){if(m--,m<0)return;c[d++]=u}}c[d++]=u,c[d++]=u,c[d++]=u,c[d++]=u}let v=this.alpha,S=256-this.alpha;u=((16711935&u)*S>>8&16711935)+((65280&u)*S>>8&65280);while(!0){if(m--,m<0){m=n-i&3;while(!0){if(m--,m<0)return;c[d++]=u+((16711935&c[d])*v>>8&16711935)+((65280&c[d])*v>>8&65280)}}c[d++]=u+((16711935&c[d])*v>>8&16711935)+((65280&c[d])*v>>8&65280),c[d++]=u+((16711935&c[d])*v>>8&16711935)+((65280&c[d])*v>>8&65280),c[d++]=u+((16711935&c[d])*v>>8&16711935)+((65280&c[d])*v>>8&65280),c[d++]=u+((16711935&c[d])*v>>8&16711935)+((65280&c[d])*v>>8&65280)}}static pushTexture(i){if(this.activeTexels[i]&&this.texelPool)this.texelPool[this.poolSize++]=this.activeTexels[i],this.activeTexels[i]=null}static getTexels(i){if(this.textureCycle[i]=this.cycle++,this.activeTexels[i])return this.activeTexels[i];let n;if(this.poolSize>0&&this.texelPool)n=this.texelPool[--this.poolSize],this.texelPool[this.poolSize]=null;else{let i=0,c=-1;for(let n=0;n<this.textureCount;n++)if(this.activeTexels[n]&&(this.textureCycle[n]<i||-1===c))i=this.textureCycle[n],c=n;n=this.activeTexels[c],this.activeTexels[c]=null}this.activeTexels[i]=n;let c=this.textures[i],d=this.texPal[i];if(!n||!c||!d)return null;if(this.lowMemory){this.textureTranslucent[i]=!1;for(let u=0;u<4096;u++){let m=n[u]=16316671&d[c.pixels[u]];if(0===m)this.textureTranslucent[i]=!0;n[u+4096]=m-(m>>>3)&16316671,n[u+8192]=m-(m>>>2)&16316671,n[u+12288]=m-(m>>>2)-(m>>>3)&16316671}}else{if(64===c.width2d)for(let i=0;i<128;i++)for(let u=0;u<128;u++)n[u+(i<<7|0)]=d[c.pixels[(u>>1)+(i>>1<<6|0)]];else for(let i=0;i<16384;i++)n[i]=d[c.pixels[i]];this.textureTranslucent[i]=!1;for(let c=0;c<16384;c++){n[c]&=16316671;let d=n[c];if(0===d)this.textureTranslucent[i]=!0;n[c+16384]=d-(d>>>3)&16316671,n[c+32768]=d-(d>>>2)&16316671,n[c+49152]=d-(d>>>2)-(d>>>3)&16316671}}return n}}class b0{image;width2d;height2d;ctx;paint;pixels;constructor(i,n,c=t){this.ctx=c,this.image=this.ctx.getImageData(0,0,i,n),this.paint=new Uint32Array(this.image.data.buffer),this.pixels=new Int32Array(i*n),this.width2d=i,this.height2d=n,this.bind()}clear(){this.pixels.fill(0)}bind(){T.bind(this.pixels,this.width2d,this.height2d)}draw(i,n){this.#e(),this.ctx.putImageData(this.image,i,n)}#e(){let i=this.pixels.length,n=this.pixels,c=this.paint;for(let d=0;d<i;d++){let i=n[d];c[d]=i>>16&255|(i>>8&255)<<8|(255&i)<<16|4278190080}}}var k_=["F11","F12"],P=new Map;P.set("ArrowLeft",{code:37,ch:1}),P.set("ArrowRight",{code:39,ch:2}),P.set("ArrowUp",{code:38,ch:3}),P.set("ArrowDown",{code:40,ch:4}),P.set("Control",{code:17,ch:5}),P.set("Shift",{code:16,ch:6}),P.set("Alt",{code:18,ch:7}),P.set("Backspace",{code:8,ch:8}),P.set("Tab",{code:9,ch:9}),P.set("Enter",{code:10,ch:10}),P.set("Escape",{code:27,ch:27}),P.set(" ",{code:32,ch:32}),P.set("Delete",{code:127,ch:127}),P.set("Home",{code:36,ch:1e3}),P.set("End",{code:35,ch:1001}),P.set("PageUp",{code:33,ch:1002}),P.set("PageDown",{code:34,ch:1003}),P.set("F1",{code:112,ch:1008}),P.set("F2",{code:113,ch:1009}),P.set("F3",{code:114,ch:1010}),P.set("F4",{code:115,ch:1011}),P.set("F5",{code:116,ch:1012}),P.set("F6",{code:117,ch:1013}),P.set("F7",{code:118,ch:1014}),P.set("F8",{code:119,ch:1015}),P.set("F9",{code:120,ch:1016}),P.set("F10",{code:121,ch:1017}),P.set("F11",{code:122,ch:1018}),P.set("F12",{code:123,ch:1019}),P.set("CapsLock",{code:20,ch:65535}),P.set("Meta",{code:524,ch:65535}),P.set("Insert",{code:155,ch:65535}),P.set("`",{code:192,ch:96}),P.set("~",{code:192,ch:126}),P.set("!",{code:49,ch:33}),P.set("@",{code:50,ch:64}),P.set("#",{code:51,ch:35}),P.set("Â£",{code:51,ch:163}),P.set("$",{code:52,ch:36}),P.set("%",{code:53,ch:37}),P.set("^",{code:54,ch:94}),P.set("&",{code:55,ch:38}),P.set("*",{code:56,ch:42}),P.set("(",{code:57,ch:40}),P.set(")",{code:48,ch:41}),P.set("-",{code:45,ch:45}),P.set("_",{code:45,ch:95}),P.set("=",{code:61,ch:61}),P.set("+",{code:61,ch:43}),P.set("[",{code:91,ch:91}),P.set("{",{code:91,ch:123}),P.set("]",{code:93,ch:93}),P.set("}",{code:93,ch:125}),P.set("\\",{code:92,ch:92}),P.set("|",{code:92,ch:124}),P.set(";",{code:59,ch:59}),P.set(":",{code:59,ch:58}),P.set("'",{code:222,ch:39}),P.set('"',{code:222,ch:34}),P.set(",",{code:44,ch:44}),P.set("<",{code:44,ch:60}),P.set(".",{code:46,ch:46}),P.set(">",{code:46,ch:62}),P.set("/",{code:47,ch:47}),P.set("?",{code:47,ch:63}),P.set("0",{code:48,ch:48}),P.set("1",{code:49,ch:49}),P.set("2",{code:50,ch:50}),P.set("3",{code:51,ch:51}),P.set("4",{code:52,ch:52}),P.set("5",{code:53,ch:53}),P.set("6",{code:54,ch:54}),P.set("7",{code:55,ch:55}),P.set("8",{code:56,ch:56}),P.set("9",{code:57,ch:57}),P.set("a",{code:65,ch:97}),P.set("b",{code:66,ch:98}),P.set("c",{code:67,ch:99}),P.set("d",{code:68,ch:100}),P.set("e",{code:69,ch:101}),P.set("f",{code:70,ch:102}),P.set("g",{code:71,ch:103}),P.set("h",{code:72,ch:104}),P.set("i",{code:73,ch:105}),P.set("j",{code:74,ch:106}),P.set("k",{code:75,ch:107}),P.set("l",{code:76,ch:108}),P.set("m",{code:77,ch:109}),P.set("n",{code:78,ch:110}),P.set("o",{code:79,ch:111}),P.set("p",{code:80,ch:112}),P.set("q",{code:81,ch:113}),P.set("r",{code:82,ch:114}),P.set("s",{code:83,ch:115}),P.set("t",{code:84,ch:116}),P.set("u",{code:85,ch:117}),P.set("v",{code:86,ch:118}),P.set("w",{code:87,ch:119}),P.set("x",{code:88,ch:120}),P.set("y",{code:89,ch:121}),P.set("z",{code:90,ch:122}),P.set("A",{code:65,ch:65}),P.set("B",{code:66,ch:66}),P.set("C",{code:67,ch:67}),P.set("D",{code:68,ch:68}),P.set("E",{code:69,ch:69}),P.set("F",{code:70,ch:70}),P.set("G",{code:71,ch:71}),P.set("H",{code:72,ch:72}),P.set("I",{code:73,ch:73}),P.set("J",{code:74,ch:74}),P.set("K",{code:75,ch:75}),P.set("L",{code:76,ch:76}),P.set("M",{code:77,ch:77}),P.set("N",{code:78,ch:78}),P.set("O",{code:79,ch:79}),P.set("P",{code:80,ch:80}),P.set("Q",{code:81,ch:81}),P.set("R",{code:82,ch:82}),P.set("S",{code:83,ch:83}),P.set("T",{code:84,ch:84}),P.set("U",{code:85,ch:85}),P.set("V",{code:86,ch:86}),P.set("W",{code:87,ch:87}),P.set("X",{code:88,ch:88}),P.set("Y",{code:89,ch:89}),P.set("Z",{code:90,ch:90});class $0{static trackingActive=!1;static outBuffer=null;static oldBuffer=null;static lastTime=0;static trackedCount=0;static lastMoveTime=0;static lastX=0;static lastY=0;static setEnabled(){this.outBuffer=f.alloc(1),this.oldBuffer=null,this.lastTime=performance.now(),this.trackingActive=!0}static setDisabled(){this.trackingActive=!1,this.outBuffer=null}static flush(){let i=null;if(this.oldBuffer&&this.trackingActive)i=this.oldBuffer;return this.oldBuffer=null,i}static stop(){let i=null;if(this.outBuffer&&this.outBuffer.pos>0&&this.trackingActive)i=this.outBuffer;return this.setDisabled(),i}static mousePressed(i,n,c){if(!(this.trackingActive&&i>=0&&i<789&&n>=0&&n<532))return;this.trackedCount++;let d=performance.now(),u=(d-this.lastTime)/10|0;if(u>250)u=250;if(this.lastTime=d,this.ensureCapacity(5),2===c)this.outBuffer?.p1(1);else this.outBuffer?.p1(2);this.outBuffer?.p1(u),this.outBuffer?.p3(i+(n<<10))}static mouseReleased(i){if(!this.trackingActive)return;this.trackedCount++;let n=performance.now(),c=(n-this.lastTime)/10|0;if(c>250)c=250;if(this.lastTime=n,this.ensureCapacity(2),2===i)this.outBuffer?.p1(3);else this.outBuffer?.p1(4);this.outBuffer?.p1(c)}static mouseMoved(i,n){if(!(this.trackingActive&&i>=0&&i<789&&n>=0&&n<532))return;let c=performance.now();if(c-this.lastMoveTime>=50){this.lastMoveTime=c,this.trackedCount++;let d=(c-this.lastTime)/10|0;if(d>250)d=250;if(this.lastTime=c,i-this.lastX<8&&i-this.lastX>=-8&&n-this.lastY<8&&n-this.lastY>=-8)this.ensureCapacity(3),this.outBuffer?.p1(5),this.outBuffer?.p1(d),this.outBuffer?.p1(i+(n-this.lastY+8<<4)+8-this.lastX);else if(i-this.lastX<128&&i-this.lastX>=-128&&n-this.lastY<128&&n-this.lastY>=-128)this.ensureCapacity(4),this.outBuffer?.p1(6),this.outBuffer?.p1(d),this.outBuffer?.p1(i+128-this.lastX),this.outBuffer?.p1(n+128-this.lastY);else this.ensureCapacity(5),this.outBuffer?.p1(7),this.outBuffer?.p1(d),this.outBuffer?.p3(i+(n<<10));this.lastX=i,this.lastY=n}}static keyPressed(i){if(!this.trackingActive)return;this.trackedCount++;let n=performance.now(),c=(n-this.lastTime)/10|0;if(c>250)c=250;if(this.lastTime=n,1e3===i)i=11;else if(1001===i)i=12;else if(1002===i)i=14;else if(1003===i)i=15;else if(i>=1008)i-=992;this.ensureCapacity(3),this.outBuffer?.p1(8),this.outBuffer?.p1(c),this.outBuffer?.p1(i)}static keyReleased(i){if(!this.trackingActive)return;this.trackedCount++;let n=performance.now(),c=(n-this.lastTime)/10|0;if(c>250)c=250;if(this.lastTime=n,1e3===i)i=11;else if(1001===i)i=12;else if(1002===i)i=14;else if(1003===i)i=15;else if(i>=1008)i-=992;this.ensureCapacity(3),this.outBuffer?.p1(9),this.outBuffer?.p1(c),this.outBuffer?.p1(i)}static focusGained(){if(!this.trackingActive)return;this.trackedCount++;let i=performance.now(),n=(i-this.lastTime)/10|0;if(n>250)n=250;this.lastTime=i,this.ensureCapacity(2),this.outBuffer?.p1(10),this.outBuffer?.p1(n)}static focusLost(){if(!this.trackingActive)return;this.trackedCount++;let i=performance.now(),n=(i-this.lastTime)/10|0;if(n>250)n=250;this.lastTime=i,this.ensureCapacity(2),this.outBuffer?.p1(11),this.outBuffer?.p1(n)}static mouseEntered(){if(!this.trackingActive)return;this.trackedCount++;let i=performance.now(),n=(i-this.lastTime)/10|0;if(n>250)n=250;this.lastTime=i,this.ensureCapacity(2),this.outBuffer?.p1(12),this.outBuffer?.p1(n)}static mouseExited(){if(!this.trackingActive)return;this.trackedCount++;let i=performance.now(),n=(i-this.lastTime)/10|0;if(n>250)n=250;this.lastTime=i,this.ensureCapacity(2),this.outBuffer?.p1(13),this.outBuffer?.p1(n)}static ensureCapacity(i){if(!this.outBuffer)return;if(this.outBuffer.pos+i>=500){let i=this.outBuffer;this.outBuffer=f.alloc(1),this.oldBuffer=i}}}import{MobileKeyboard as A0}from"./deps.js";class l0{slowestMS=0;averageMS=[];averageIndexMS=0;drawArea=null;state=0;deltime=20;mindel=1;otim=[];fps=0;fpos=0;frameTime=[];redrawScreen=!0;resizeToFit=!1;tfps=50;hasFocus=!0;ingame=!1;idleCycles=performance.now();mouseButton=0;mouseX=-1;mouseY=-1;mouseClickButton=0;mouseClickX=-1;mouseClickY=-1;actionKey=[];keyQueue=[];keyQueueReadPos=0;keyQueueWritePos=0;touching=!1;startedInViewport=!1;startedInTabArea=!1;time=-1;sx=0;sy=0;mx=0;my=0;nx=0;ny=0;async load(){}async update(){}async draw(){}async refresh(){}constructor(i=!1){if(O0.tabIndex=-1,t.fillStyle="black",t.fillRect(0,0,O0.width,O0.height),this.resizeToFit=i,this.resizeToFit)this.resize(window.innerWidth,window.innerHeight);else this.resize(O0.width,O0.height)}get width(){return O0.width}get height(){return O0.height}resize(i,n){O0.width=i,O0.height=n,this.drawArea=new b0(i,n),w.init2D()}async run(){if(O0.addEventListener("resize",()=>{if(this.resizeToFit)this.resize(window.innerWidth,window.innerHeight)},!1),O0.onfocus=this.onfocus.bind(this),O0.onblur=this.onblur.bind(this),O0.onmousedown=this.onmousedown.bind(this),O0.onmouseup=this.onmouseup.bind(this),O0.onmouseenter=this.onmouseenter.bind(this),O0.onmouseleave=this.onmouseleave.bind(this),O0.onmousemove=this.onmousemove.bind(this),O0.onkeydown=this.onkeydown.bind(this),O0.onkeyup=this.onkeyup.bind(this),this.isMobile)O0.ontouchstart=this.ontouchstart.bind(this),O0.ontouchend=this.ontouchend.bind(this),O0.ontouchmove=this.ontouchmove.bind(this);O0.oncontextmenu=i=>{i.preventDefault()},window.oncontextmenu=i=>{i.preventDefault()},await this.showProgress(0,"Loading..."),await this.load();for(let i=0;i<10;i++)this.otim[i]=performance.now();let i,n=0,c=256,d=1,u=0;while(this.state>=0){if(this.state>0)if(this.state--,0===this.state)return void this.shutdown();let m=c,v=d;c=300,d=1,i=performance.now();let S=this.otim[n];if(0===S)c=m,d=v;else if(i>S)c=2560*this.deltime/(i-S)|0;if(c<25)c=25;else if(c>256)c=256,d=this.deltime-(i-S)/10|0;if(this.otim[n]=i,n=(n+1)%10,d>1)for(let i=0;i<10;i++)if(0!==this.otim[i])this.otim[i]+=d;if(d<this.mindel)d=this.mindel;await S0(d);while(u<256)await this.update(),this.mouseClickButton=0,this.keyQueueReadPos=this.keyQueueWritePos,u+=c;if(u&=255,this.deltime>0)this.fps=1e3*c/(256*this.deltime)|0;let b=performance.now();if(await this.draw(),this.isMobile)A0.draw();if(this.frameTime[this.fpos]=(performance.now()-b)/1e3,this.fpos=(this.fpos+1)%this.frameTime.length,this.tfps<50){let n=1e3/this.tfps-(performance.now()-i);if(n>0)await S0(n)}}if(-1===this.state)this.shutdown()}shutdown(){this.state=-2}setFramerate(i){this.deltime=1e3/i|0}setTargetedFramerate(i){this.tfps=Math.max(Math.min(50,0|i),0)}start(){if(this.state>=0)this.state=0}stop(){if(this.state>=0)this.state=4e3/this.deltime|0}destroy(){this.state=-1}async showProgress(i,n){let c=this.width,d=this.height;if(this.redrawScreen)t.fillStyle="black",t.fillRect(0,0,c,d),this.redrawScreen=!1;let u=d/2-18;t.fillStyle="rgb(140, 17, 17)",t.rect((c/2|0)-152,u,304,34),t.fillRect((c/2|0)-150,u+2,3*i,30),t.fillStyle="black",t.fillRect((c/2|0)-150+3*i,u+2,300-3*i,30),t.font="bold 13px helvetica, sans-serif",t.textAlign="center",t.fillStyle="white",t.fillText(n,c/2|0,u+22),await S0(5)}pollKey(){let i=-1;if(this.keyQueueWritePos!==this.keyQueueReadPos)i=this.keyQueue[this.keyQueueReadPos],this.keyQueueReadPos=this.keyQueueReadPos+1&127;return i}get ms(){let i=this.frameTime.length,n=0;for(let c=0;c<i;c++)n+=this.frameTime[c];let c=n/i*1e3;if(c>this.slowestMS)this.slowestMS=c;return this.averageMS[this.averageIndexMS]=c,this.averageIndexMS=(this.averageIndexMS+1)%250,c}get msAvg(){return this.averageMS.reduce((i,n)=>i+n,0)/250}onkeydown(i){this.idleCycles=performance.now();let n=P.get(i.key);if(!n||0===i.code.length&&!i.isTrusted)return;let c=n.ch;if(i.ctrlKey)if(c>=65&&c<=93||95==c)c-=64;else if(c>=97&&c<=122)c-=96;if(c>0&&c<128)this.actionKey[c]=1;if(c>4)this.keyQueue[this.keyQueueWritePos]=c,this.keyQueueWritePos=this.keyQueueWritePos+1&127;if($0.trackingActive)$0.keyPressed(c);if(!k_.includes(i.key))i.preventDefault()}onkeyup(i){this.idleCycles=performance.now();let n=P.get(i.key);if(!n||0===i.code.length&&!i.isTrusted)return;let c=n.ch;if(i.ctrlKey)if(c>=65&&c<=93||95==c)c-=64;else if(c>=97&&c<=122)c-=96;if(c>0&&c<128)this.actionKey[c]=0;if($0.trackingActive)$0.keyReleased(c);if(!k_.includes(i.key))i.preventDefault()}onmousedown(i){if(this.touching=!1,i.clientX>0||i.clientY>0)this.setMousePosition(i);if(this.idleCycles=performance.now(),this.mouseClickX=this.mouseX,this.mouseClickY=this.mouseY,this.isMobile&&!this.isCapacitor){if(this.insideMobileInputArea()&&!this.insideUsernameArea()&&!this.inPasswordArea())return this.mouseClickButton=0,void(this.mouseButton=0);if(i.timeStamp>=this.time+500)this.mouseClickButton=2,this.mouseButton=2;else this.mouseClickButton=1,this.mouseButton=1}else if(2===i.button)this.mouseClickButton=2,this.mouseButton=2;else if(0===i.button)this.mouseClickButton=1,this.mouseButton=1;if(A0.isDisplayed())if(A0.captureMouseDown(this.mouseX,this.mouseY))this.mouseButton=0,this.mouseClickButton=0;if($0.trackingActive)$0.mousePressed(this.mouseClickX,this.mouseClickY,i.button)}onmouseup(i){if(this.setMousePosition(i),this.idleCycles=performance.now(),this.mouseButton=0,$0.trackingActive)$0.mouseReleased(i.button);if(this.isMobile)if(this.insideMobileInputArea()&&!A0.isDisplayed())A0.show(this.mouseX,this.mouseY);else if(A0.isDisplayed())if(!A0.captureMouseUp(this.mouseX,this.mouseY))A0.hide(),this.refresh()}onmouseenter(i){if(this.setMousePosition(i),$0.trackingActive)$0.mouseEntered()}onmouseleave(i){if(this.setMousePosition(i),this.idleCycles=performance.now(),this.mouseX=-1,this.mouseY=-1,this.mouseButton=0,this.mouseClickX=-1,this.mouseClickY=-1,$0.trackingActive)$0.mouseExited()}onmousemove(i){if(this.setMousePosition(i),this.idleCycles=performance.now(),this.isMobile&&this.touching)if(A0.isDisplayed())A0.notifyTouchMove(this.mouseX,this.mouseY);if($0.trackingActive)$0.mouseMoved(this.mouseX,this.mouseY)}onfocus(i){if(this.hasFocus=!0,this.redrawScreen=!0,this.refresh(),$0.trackingActive)$0.focusGained()}onblur(i){this.hasFocus=!1;for(let i=0;i<128;i++)this.actionKey[i]=0;if($0.trackingActive)$0.focusLost()}ontouchstart(i){if(!this.isMobile)return;this.touching=!0;let n=i.changedTouches[0],c=0|n.clientX,d=0|n.clientY;this.onmousemove(new MouseEvent("mousemove",{clientX:c,clientY:d})),this.sx=this.nx=this.mx=0|n.screenX,this.sy=this.ny=this.my=0|n.screenY,this.time=i.timeStamp,this.startedInViewport=this.insideViewportArea(),this.startedInTabArea=this.insideTabArea()}ontouchend(i){if(!this.isMobile||!this.touching)return;let n=i.changedTouches[0],c=0|n.clientX,d=0|n.clientY;if(this.onmousemove(new MouseEvent("mousemove",{clientX:c,clientY:d})),this.nx=0|n.screenX,this.ny=0|n.screenY,this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.startedInViewport&&!this.insideViewportArea())return void(this.touching=!1);else if(this.startedInTabArea&&!this.insideTabArea())return void(this.touching=!1);else if(this.insideMobileInputArea())return void(this.touching=!1);let u=i.timeStamp>=this.time+500,m=Math.abs(this.sx-this.nx)>16||Math.abs(this.sy-this.ny)>16;if(u&&!m)this.touching=!0,this.onmousedown(new MouseEvent("mousedown",{clientX:c,clientY:d,button:2})),this.onmouseup(new MouseEvent("mouseup",{clientX:c,clientY:d,button:2}))}ontouchmove(i){if(!this.isMobile||!this.touching)return;if(i.touches.length>1)return;i.preventDefault();let n=i.changedTouches[0],c=0|n.clientX,d=0|n.clientY;if(this.onmousemove(new MouseEvent("mousemove",{clientX:c,clientY:d})),this.nx=0|n.screenX,this.ny=0|n.screenY,!A0.isWithinCanvasKeyboard(this.mouseX,this.mouseY))if(this.startedInViewport&&-1===this.getViewportInterfaceId()){if(this.mx-this.nx>0)this.rotate(2);else if(this.mx-this.nx<0)this.rotate(0);if(this.my-this.ny>0)this.rotate(3);else if(this.my-this.ny<0)this.rotate(1)}else if(this.startedInTabArea||-1!==this.getViewportInterfaceId())this.onmousedown(new MouseEvent("mousedown",{clientX:c,clientY:d,button:1}));this.mx=this.nx,this.my=this.ny}get isMobile(){if(["Android","webOS","iPhone","iPad","iPod","BlackBerry","Windows Phone"].some(i=>navigator.userAgent.includes(i)))return!0;if(navigator)if(void 0!==navigator.maxTouchPoints&&navigator.maxTouchPoints>2&&void 0!==navigator.standalone)return!0;return!1}get isAndroid(){return["Android"].some(i=>navigator.userAgent.includes(i))}get isCapacitor(){return["Capacitor"].some(i=>navigator.userAgent.includes(i))}insideViewportArea(){return this.ingame&&this.mouseX>=8&&this.mouseX<=520&&this.mouseY>=11&&this.mouseY<=345}insideMobileInputArea(){return this.insideChatInputArea()||this.insideChatPopupArea()||this.insideUsernameArea()||this.inPasswordArea()||this.insideReportInterfaceTextArea()}insideChatInputArea(){return this.ingame&&-1===this.getChatInterfaceId()&&!this.isChatBackInputOpen()&&!this.isShowSocialInput()&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=449&&this.mouseY<=482}insideChatPopupArea(){return this.ingame&&(this.isChatBackInputOpen()||this.isShowSocialInput())&&this.mouseX>=11&&this.mouseX<=506&&this.mouseY>=383&&this.mouseY<=482}insideReportInterfaceTextArea(){if(!this.ingame)return!1;let i=this.getViewportInterfaceId(),n=this.getReportAbuseInterfaceId();if(-1===i||-1===n)return!1;if(i!==n)return!1;let c=82,d=137,u=c+366,m=d+26;return this.mouseX>=c&&this.mouseX<=u&&this.mouseY>=d&&this.mouseY<=m}insideTabArea(){return this.ingame&&this.mouseX>=562&&this.mouseX<=752&&this.mouseY>=231&&this.mouseY<=492}insideUsernameArea(){return!this.ingame&&2===this.getTitleScreenState()&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=262&&this.mouseY<=279}inPasswordArea(){return!this.ingame&&2===this.getTitleScreenState()&&this.mouseX>=301&&this.mouseX<=562&&this.mouseY>=279&&this.mouseY<=296}rotate(i){if(0===i)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowRight",code:"ArrowRight"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowLeft",code:"ArrowLeft"}));else if(1===i)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowDown",code:"ArrowDown"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowUp",code:"ArrowUp"}));else if(2===i)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowLeft",code:"ArrowLeft"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowRight",code:"ArrowRight"}));else if(3===i)this.onkeyup(new KeyboardEvent("keyup",{key:"ArrowUp",code:"ArrowUp"})),this.onkeydown(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown"}))}isFullScreen(){return null!==document.fullscreenElement}setMousePosition(i){let n=this.width,c=this.height,d=O0.getBoundingClientRect(),u=i.clientX-d.left,m=i.clientY-d.top;if(this.isFullScreen()){let i=n/c,d,v=0,S=0,b=0,x=0;if(window.innerWidth/window.innerHeight>=i)v=window.innerHeight*i,S=window.innerHeight,b=(window.innerWidth-v)/2;else v=window.innerWidth,S=window.innerWidth/i,x=(window.innerHeight-S)/2;let I=n/v,A=c/S;this.mouseX=(u-b)*I|0,this.mouseY=(m-x)*A|0}else{let i=O0.width/d.width,n=O0.height/d.height;this.mouseX=u*i|0,this.mouseY=m*n|0}if(this.mouseX<0)this.mouseX=0;if(this.mouseY<0)this.mouseY=0;if(this.mouseX>n)this.mouseX=n;if(this.mouseY>c)this.mouseY=c}}class u0{id;debugname=null;constructor(i){this.id=i}unpackType(i){while(!0){let n=i.g1();if(0===n)break;this.unpack(n,i)}return this}}class N0 extends u0{static totalCount=0;static instances=[];static unpack(i){let n=new f(i.read("flo.dat"));this.totalCount=n.g2();for(let i=0;i<this.totalCount;i++)this.instances[i]=new N0(i).unpackType(n)}static hsl24to16(i,n,c){if(c>179)n=n/2|0;if(c>192)n=n/2|0;if(c>217)n=n/2|0;if(c>243)n=n/2|0;return((i/4|0)<<10)+((n/32|0)<<7)+(c/2|0)}static mulHSL(i,n){if(-1===i)return 12345678;if((n=n*(127&i)/128|0)<2)n=2;else if(n>126)n=126;return(65408&i)+n}static adjustLightness(i,n){if(-2===i)return 12345678;if(-1===i){if(n<0)n=0;else if(n>127)n=127;return 127-n}else{if((n=n*(127&i)/128|0)<2)n=2;else if(n>126)n=126;return(65408&i)+n}}rgb=0;overlayTexture=-1;opcode3=!1;occlude=!0;hue=0;saturation=0;lightness=0;luminance=0;chroma=0;hsl=0;unpack(i,n){if(1===i)this.rgb=n.g3(),this.setColor(this.rgb);else if(2===i)this.overlayTexture=n.g1();else if(3===i)this.opcode3=!0;else if(5===i)this.occlude=!1;else if(6===i)this.debugname=n.gjstr()}setColor(i){let n=(i>>16&255)/256,c=(i>>8&255)/256,d=(255&i)/256,u=n;if(c<n)u=c;if(d<u)u=d;let m=n;if(c>n)m=c;if(d>m)m=d;let v=0,S=0,b=(u+m)/2;if(u!==m){if(b<.5)S=(m-u)/(m+u);if(b>=.5)S=(m-u)/(2-m-u);if(n===m)v=(c-d)/(m-u);else if(c===m)v=(d-n)/(m-u)+2;else if(d===m)v=(n-c)/(m-u)+4}if(v/=6,this.hue=256*v|0,this.saturation=256*S|0,this.lightness=256*b|0,this.saturation<0)this.saturation=0;else if(this.saturation>255)this.saturation=255;if(this.lightness<0)this.lightness=0;else if(this.lightness>255)this.lightness=255;if(b>.5)this.luminance=(1-b)*S*512|0;else this.luminance=b*S*512|0;if(this.luminance<1)this.luminance=1;this.chroma=v*this.luminance|0;let x=this.hue+(16*Math.random()|0)-8;if(x<0)x=0;else if(x>255)x=255;let I=this.saturation+(48*Math.random()|0)-24;if(I<0)I=0;else if(I>255)I=255;let A=this.lightness+(48*Math.random()|0)-24;if(A<0)A=0;else if(A>255)A=255;this.hsl=N0.hsl24to16(x,I,A)}}class f0{static instances=[];static unpack(i){let n=new f(i.read("base_head.dat")),c=new f(i.read("base_type.dat")),d=new f(i.read("base_label.dat")),u=n.g2();n.pos+=2;for(let i=0;i<u;i++){let i=n.g2(),u=n.g1(),m=new Uint8Array(u),v=new C(u,null);for(let i=0;i<u;i++){m[i]=c.g1();let n=d.g1(),u=new Uint8Array(n);for(let i=0;i<n;i++)u[i]=d.g1();v[i]=u}this.instances[i]=new f0,this.instances[i].animLength=u,this.instances[i].animTypes=m,this.instances[i].animLabels=v}}animLength=0;animTypes=null;animLabels=null}class X0{static instances=[];static unpack(i){let n=new f(i.read("frame_head.dat")),c=new f(i.read("frame_tran1.dat")),d=new f(i.read("frame_tran2.dat")),u=new f(i.read("frame_del.dat")),m=n.g2();n.pos+=2;let v=new Int32Array(500),S=new Int32Array(500),b=new Int32Array(500),x=new Int32Array(500);for(let i=0;i<m;i++){let i=n.g2(),m=this.instances[i]=new X0;m.frameDelay=u.g1();let I=n.g2(),A=f0.instances[I];m.base=A;let k=n.g1(),L=-1,O=0;for(let i=0;i<k;i++){if(!A.animTypes)throw new Error;let n=c.g1();if(n>0){if(0!==A.animTypes[i])for(let n=i-1;n>L;n--)if(0===A.animTypes[n]){v[O]=n,S[O]=0,b[O]=0,x[O]=0,O++;break}v[O]=i;let c=0;if(3===A.animTypes[v[O]])c=128;if(!(1&n))S[O]=c;else S[O]=d.gsmart();if(!(2&n))b[O]=c;else b[O]=d.gsmart();if(!(4&n))x[O]=c;else x[O]=d.gsmart();L=i,O++}}m.frameLength=O,m.bases=new Int32Array(O),m.x=new Int32Array(O),m.y=new Int32Array(O),m.z=new Int32Array(O);for(let i=0;i<O;i++)m.bases[i]=v[i],m.x[i]=S[i],m.y[i]=b[i],m.z[i]=x[i]}}frameDelay=0;base=null;frameLength=0;bases=null;x=null;y=null;z=null}class r extends u0{static totalCount=0;static instances=[];seqFrameCount=0;seqFrames=null;seqIframes=null;seqDelay=null;replayoff=-1;walkmerge=null;stretches=!1;seqPriority=5;righthand=-1;lefthand=-1;replaycount=99;seqDuration=0;static unpack(i){let n=new f(i.read("seq.dat"));this.totalCount=n.g2();for(let i=0;i<this.totalCount;i++){let c=new r(i).unpackType(n);if(0===c.seqFrameCount)c.seqFrameCount=1,c.seqFrames=new Int16Array(1),c.seqFrames[0]=-1,c.seqIframes=new Int16Array(1),c.seqIframes[0]=-1,c.seqDelay=new Int16Array(1),c.seqDelay[0]=-1;this.instances[i]=c}}unpack(i,n){if(1===i){this.seqFrameCount=n.g1(),this.seqFrames=new Int16Array(this.seqFrameCount),this.seqIframes=new Int16Array(this.seqFrameCount),this.seqDelay=new Int16Array(this.seqFrameCount);for(let i=0;i<this.seqFrameCount;i++){if(this.seqFrames[i]=n.g2(),this.seqIframes[i]=n.g2(),65535===this.seqIframes[i])this.seqIframes[i]=-1;if(this.seqDelay[i]=n.g2(),0===this.seqDelay[i])this.seqDelay[i]=X0.instances[this.seqFrames[i]].frameDelay;if(0===this.seqDelay[i])this.seqDelay[i]=1;this.seqDuration+=this.seqDelay[i]}}else if(2===i)this.replayoff=n.g2();else if(3===i){let i=n.g1();this.walkmerge=new Int32Array(i+1);for(let c=0;c<i;c++)this.walkmerge[c]=n.g1();this.walkmerge[i]=9999999}else if(4===i)this.stretches=!0;else if(5===i)this.seqPriority=n.g1();else if(6===i)this.righthand=n.g2();else if(7===i)this.lefthand=n.g2();else if(8===i)this.replaycount=n.g1()}}class o0{bucketCount;buckets;constructor(i){this.buckets=new Array(i),this.bucketCount=i;for(let n=0;n<i;n++){let i=this.buckets[n]=new F0;i.next=i,i.prev=i}}get(i){let n=this.buckets[Number(i&BigInt(this.bucketCount-1))];for(let c=n.next;c!==n;c=c.next){if(!c)continue;if(c.key===i)return c}return null}put(i,n){if(n.prev)n.unlink();let c=this.buckets[Number(i&BigInt(this.bucketCount-1))];if(n.prev=c.prev,n.next=c,n.prev)n.prev.next=n;n.next.prev=n,n.key=i}}class e0{head=new j0;constructor(){this.head.next2=this.head,this.head.prev2=this.head}push(i){if(i.prev2)i.unlink2();if(i.prev2=this.head.prev2,i.next2=this.head,i.prev2)i.prev2.next2=i;i.next2.prev2=i}pop(){let i=this.head.next2;if(i===this.head)return null;else return i?.unlink2(),i}}class k0{capacity;hashtable=new o0(1024);cacheHistory=new e0;cacheAvailable;constructor(i){this.capacity=i,this.cacheAvailable=i}get(i){let n=this.hashtable.get(i);if(n)this.cacheHistory.push(n);return n}put(i,n){if(0===this.cacheAvailable){let i=this.cacheHistory.pop();i?.unlink(),i?.unlink2()}else this.cacheAvailable--;this.hashtable.put(i,n),this.cacheHistory.push(n)}clear(){while(!0){let i=this.cacheHistory.pop();if(!i)return void(this.cacheAvailable=this.capacity);i.unlink(),i.unlink2()}}}class h{static WALL_STRAIGHT=new h(0,0);static WALL_DIAGONAL_CORNER=new h(1,0);static WALL_L=new h(2,0);static WALL_SQUARE_CORNER=new h(3,0);static WALLDECOR_STRAIGHT_NOOFFSET=new h(4,1);static WALLDECOR_STRAIGHT_OFFSET=new h(5,1);static WALLDECOR_DIAGONAL_OFFSET=new h(6,1);static WALLDECOR_DIAGONAL_NOOFFSET=new h(7,1);static WALLDECOR_DIAGONAL_BOTH=new h(8,1);static WALL_DIAGONAL=new h(9,2);static CENTREPIECE_STRAIGHT=new h(10,2);static CENTREPIECE_DIAGONAL=new h(11,2);static ROOF_STRAIGHT=new h(12,2);static ROOF_DIAGONAL_WITH_ROOFEDGE=new h(13,2);static ROOF_DIAGONAL=new h(14,2);static ROOF_L_CONCAVE=new h(15,2);static ROOF_L_CONVEX=new h(16,2);static ROOF_FLAT=new h(17,2);static ROOFEDGE_STRAIGHT=new h(18,2);static ROOFEDGE_DIAGONAL_CORNER=new h(19,2);static ROOFEDGE_L=new h(20,2);static ROOFEDGE_SQUARE_CORNER=new h(21,2);static GROUND_DECOR=new h(22,3);static values(){return[this.WALL_STRAIGHT,this.WALL_DIAGONAL_CORNER,this.ROOF_FLAT,this.ROOF_L_CONCAVE,this.WALL_L,this.ROOF_DIAGONAL,this.WALL_DIAGONAL,this.WALL_SQUARE_CORNER,this.GROUND_DECOR,this.ROOF_STRAIGHT,this.CENTREPIECE_DIAGONAL,this.WALLDECOR_DIAGONAL_OFFSET,this.ROOFEDGE_L,this.CENTREPIECE_STRAIGHT,this.WALLDECOR_STRAIGHT_OFFSET,this.ROOF_DIAGONAL_WITH_ROOFEDGE,this.WALLDECOR_DIAGONAL_NOOFFSET,this.WALLDECOR_STRAIGHT_NOOFFSET,this.ROOF_L_CONVEX,this.WALLDECOR_DIAGONAL_BOTH,this.ROOFEDGE_DIAGONAL_CORNER,this.ROOFEDGE_SQUARE_CORNER,this.ROOFEDGE_STRAIGHT]}static of(i){let n=this.values();for(let c=0;c<n.length;c++){let d=n[c];if(d.id===i)return d}throw Error("shape not found")}id;layer;constructor(i,n){this.id=i,this.layer=n}}class Y_{vertexCount=0;faceCount=0;texturedFaceCount=0;vertexFlagsOffset=-1;vertexXOffset=-1;vertexYOffset=-1;vertexZOffset=-1;vertexLabelsOffset=-1;faceVerticesOffset=-1;faceOrientationsOffset=-1;faceColorsOffset=-1;faceInfosOffset=-1;facePrioritiesOffset=0;faceAlphasOffset=-1;faceLabelsOffset=-1;faceTextureAxisOffset=-1;data=null}class __{x=0;y=0;z=0;w=0}class J extends j0{static modelMeta=null;static head=null;static face1=null;static face2=null;static face3=null;static face4=null;static face5=null;static point1=null;static point2=null;static point3=null;static point4=null;static point5=null;static vertex1=null;static vertex2=null;static axis=null;static faceClippedX=new C(4096,!1);static faceNearClipped=new C(4096,!1);static vertexScreenX=new Int32Array(4096);static vertexScreenY=new Int32Array(4096);static vertexScreenZ=new Int32Array(4096);static vertexViewSpaceX=new Int32Array(4096);static vertexViewSpaceY=new Int32Array(4096);static vertexViewSpaceZ=new Int32Array(4096);static tmpDepthFaceCount=new Int32Array(1500);static tmpDepthFaces=new W0(1500,512);static tmpPriorityFaceCount=new Int32Array(12);static tmpPriorityFaces=new W0(12,2e3);static tmpPriority10FaceDepth=new Int32Array(2e3);static tmpPriority11FaceDepth=new Int32Array(2e3);static tmpPriorityDepthSum=new Int32Array(12);static clippedX=new Int32Array(10);static clippedY=new Int32Array(10);static clippedColor=new Int32Array(10);static baseX=0;static baseY=0;static baseZ=0;static checkHover=!1;static mouseX=0;static mouseY=0;static pickedCount=0;static picked=new Int32Array(1e3);static checkHoverFace=!1;static unpack(i){try{J.head=new f(i.read("ob_head.dat")),J.face1=new f(i.read("ob_face1.dat")),J.face2=new f(i.read("ob_face2.dat")),J.face3=new f(i.read("ob_face3.dat")),J.face4=new f(i.read("ob_face4.dat")),J.face5=new f(i.read("ob_face5.dat")),J.point1=new f(i.read("ob_point1.dat")),J.point2=new f(i.read("ob_point2.dat")),J.point3=new f(i.read("ob_point3.dat")),J.point4=new f(i.read("ob_point4.dat")),J.point5=new f(i.read("ob_point5.dat")),J.vertex1=new f(i.read("ob_vertex1.dat")),J.vertex2=new f(i.read("ob_vertex2.dat")),J.axis=new f(i.read("ob_axis.dat")),J.head.pos=0,J.point1.pos=0,J.point2.pos=0,J.point3.pos=0,J.point4.pos=0,J.vertex1.pos=0,J.vertex2.pos=0;let n=J.head.g2();J.modelMeta=new C(n+100,null);let c=0,d=0,u=0,m=0,v=0,S=0,b=0;for(let i=0;i<n;i++){let i=J.head.g2(),n=new Y_;n.vertexCount=J.head.g2(),n.faceCount=J.head.g2(),n.texturedFaceCount=J.head.g1(),n.vertexFlagsOffset=J.point1.pos,n.vertexXOffset=J.point2.pos,n.vertexYOffset=J.point3.pos,n.vertexZOffset=J.point4.pos,n.faceVerticesOffset=J.vertex1.pos,n.faceOrientationsOffset=J.vertex2.pos;let x=J.head.g1(),I=J.head.g1(),A=J.head.g1(),k=J.head.g1(),L=J.head.g1();for(let i=0;i<n.vertexCount;i++){let i=J.point1.g1();if(!!(1&i))J.point2.gsmart();if(!!(2&i))J.point3.gsmart();if(!!(4&i))J.point4.gsmart()}for(let i=0;i<n.faceCount;i++){if(1===J.vertex2.g1())J.vertex1.gsmart(),J.vertex1.gsmart();J.vertex1.gsmart()}if(n.faceColorsOffset=u,u+=2*n.faceCount,1===x)n.faceInfosOffset=m,m+=n.faceCount;if(255===I)n.facePrioritiesOffset=v,v+=n.faceCount;else n.facePrioritiesOffset=-I-1;if(1===A)n.faceAlphasOffset=S,S+=n.faceCount;if(1===k)n.faceLabelsOffset=b,b+=n.faceCount;if(1===L)n.vertexLabelsOffset=d,d+=n.vertexCount;n.faceTextureAxisOffset=c,c+=n.texturedFaceCount,J.modelMeta[i]=n}}catch(i){}}static mulColorLightness(i,n,c){if(!(2&~c)){if(n<0)n=0;else if(n>127)n=127;return 127-n}if((n=n*(127&i)>>7)<2)n=2;else if(n>126)n=126;return(65408&i)+n}static modelCopyFaces(i,n,c){let{vertexCount:d,faceCount:u,texturedFaceCount:m}=i,v;if(n){v=new Int32Array(d);for(let n=0;n<d;n++)v[n]=i.vertexY[n]}else v=i.vertexY;let S,b,x,I,A=null,k=null;if(c){S=new Int32Array(u),b=new Int32Array(u),x=new Int32Array(u);for(let n=0;n<u;n++){if(i.faceColorA)S[n]=i.faceColorA[n];if(i.faceColorB)b[n]=i.faceColorB[n];if(i.faceColorC)x[n]=i.faceColorC[n]}if(I=new Int32Array(u),!i.faceInfo)for(let i=0;i<u;i++)I[i]=0;else for(let n=0;n<u;n++)I[n]=i.faceInfo[n];A=new C(d,null);for(let n=0;n<d;n++){let c=A[n]=new __;if(i.vertexNormal){let d=i.vertexNormal[n];if(d)c.x=d.x,c.y=d.y,c.z=d.z,c.w=d.w}}k=i.vertexNormalOriginal}else S=i.faceColorA,b=i.faceColorB,x=i.faceColorC,I=i.faceInfo;return new J({vertexCount:d,vertexX:i.vertexX,vertexY:v,vertexZ:i.vertexZ,faceCount:u,faceVertexA:i.faceVertexA,faceVertexB:i.faceVertexB,faceVertexC:i.faceVertexC,faceColorA:S,faceColorB:b,faceColorC:x,faceInfo:I,facePriority:i.facePriority,faceAlpha:i.faceAlpha,faceColor:i.faceColor,priorityVal:i.priorityVal,texturedFaceCount:m,texturedVertexA:i.texturedVertexA,texturedVertexB:i.texturedVertexB,texturedVertexC:i.texturedVertexC,minX:i.minX,maxX:i.maxX,minZ:i.minZ,maxZ:i.maxZ,radius:i.radius,minY:i.minY,maxY:i.maxY,maxDepth:i.maxDepth,minDepth:i.minDepth,vertexNormal:A,vertexNormalOriginal:k})}static modelShareColored(i,n,c,d){let{vertexCount:u,faceCount:m,texturedFaceCount:v}=i,S,b,x;if(d)S=i.vertexX,b=i.vertexY,x=i.vertexZ;else{S=new Int32Array(u),b=new Int32Array(u),x=new Int32Array(u);for(let n=0;n<u;n++)S[n]=i.vertexX[n],b[n]=i.vertexY[n],x[n]=i.vertexZ[n]}let I;if(n)I=i.faceColor;else{I=new Int32Array(m);for(let n=0;n<m;n++)if(i.faceColor)I[n]=i.faceColor[n]}let A;if(c)A=i.faceAlpha;else if(A=new Int32Array(m),!i.faceAlpha)for(let i=0;i<m;i++)A[i]=0;else for(let n=0;n<m;n++)A[n]=i.faceAlpha[n];return new J({vertexCount:u,vertexX:S,vertexY:b,vertexZ:x,faceCount:m,faceVertexA:i.faceVertexA,faceVertexB:i.faceVertexB,faceVertexC:i.faceVertexC,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:i.faceInfo,facePriority:i.facePriority,faceAlpha:A,faceColor:I,priorityVal:i.priorityVal,texturedFaceCount:v,texturedVertexA:i.texturedVertexA,texturedVertexB:i.texturedVertexB,texturedVertexC:i.texturedVertexC,vertexLabel:i.vertexLabel,faceLabel:i.faceLabel})}static modelShareAlpha(i,n){let{vertexCount:c,faceCount:d,texturedFaceCount:u}=i,m=new Int32Array(c),v=new Int32Array(c),S=new Int32Array(c);for(let n=0;n<c;n++)m[n]=i.vertexX[n],v[n]=i.vertexY[n],S[n]=i.vertexZ[n];let b;if(n)b=i.faceAlpha;else if(b=new Int32Array(d),!i.faceAlpha)for(let i=0;i<d;i++)b[i]=0;else for(let n=0;n<d;n++)b[n]=i.faceAlpha[n];return new J({vertexCount:c,vertexX:m,vertexY:v,vertexZ:S,faceCount:d,faceVertexA:i.faceVertexA,faceVertexB:i.faceVertexB,faceVertexC:i.faceVertexC,faceColorA:i.faceColorA,faceColorB:i.faceColorB,faceColorC:i.faceColorC,faceInfo:i.faceInfo,facePriority:i.facePriority,faceAlpha:b,faceColor:i.faceColor,priorityVal:i.priorityVal,texturedFaceCount:u,texturedVertexA:i.texturedVertexA,texturedVertexB:i.texturedVertexB,texturedVertexC:i.texturedVertexC,labelVertices:i.labelVertices,labelFaces:i.labelFaces})}static modelFromModelsBounds(i,n){let c=!1,d=!1,u=!1,m=!1,v=0,S=0,b=0,x=-1;for(let I=0;I<n;I++){let n=i[I];if(n){if(v+=n.vertexCount,S+=n.faceCount,b+=n.texturedFaceCount,c||=null!==n.faceInfo,!n.facePriority){if(-1===x)x=n.priorityVal;if(x!==n.priorityVal)d=!0}else d=!0;u||=null!==n.faceAlpha,m||=null!==n.faceColor}}let I=new Int32Array(v),A=new Int32Array(v),k=new Int32Array(v),L=new Int32Array(S),O=new Int32Array(S),X=new Int32Array(S),M=new Int32Array(S),Y=new Int32Array(S),B=new Int32Array(S),F=new Int32Array(b),E=new Int32Array(b),D=new Int32Array(b),R=null;if(c)R=new Int32Array(S);let _=null;if(d)_=new Int32Array(S);let z=null;if(u)z=new Int32Array(S);let Z=null;if(m)Z=new Int32Array(S);v=0,S=0,b=0;for(let x=0;x<n;x++){let n=i[x];if(n){let i=v;for(let i=0;i<n.vertexCount;i++)I[v]=n.vertexX[i],A[v]=n.vertexY[i],k[v]=n.vertexZ[i],v++;for(let v=0;v<n.faceCount;v++){if(L[S]=n.faceVertexA[v]+i,O[S]=n.faceVertexB[v]+i,X[S]=n.faceVertexC[v]+i,n.faceColorA)M[S]=n.faceColorA[v];if(n.faceColorB)Y[S]=n.faceColorB[v];if(n.faceColorC)B[S]=n.faceColorC[v];if(c)if(!n.faceInfo){if(R)R[S]=0}else if(R)R[S]=n.faceInfo[v];if(d)if(!n.facePriority){if(_)_[S]=n.priorityVal}else if(_)_[S]=n.facePriority[v];if(u)if(!n.faceAlpha){if(z)z[S]=0}else if(z)z[S]=n.faceAlpha[v];if(m&&n.faceColor)if(Z)Z[S]=n.faceColor[v];S++}for(let c=0;c<n.texturedFaceCount;c++)F[b]=n.texturedVertexA[c]+i,E[b]=n.texturedVertexB[c]+i,D[b]=n.texturedVertexC[c]+i,b++}}let q=new J({vertexCount:v,vertexX:I,vertexY:A,vertexZ:k,faceCount:S,faceVertexA:L,faceVertexB:O,faceVertexC:X,faceColorA:M,faceColorB:Y,faceColorC:B,faceInfo:R,facePriority:_,faceAlpha:z,faceColor:Z,priorityVal:x,texturedFaceCount:b,texturedVertexA:F,texturedVertexB:E,texturedVertexC:D});return q.calculateBoundsCylinder(),q}static modelFromModels(i,n){let c=!1,d=!1,u=!1,m=!1,v=0,S=0,b=0,x=-1;for(let I=0;I<n;I++){let n=i[I];if(n){if(v+=n.vertexCount,S+=n.faceCount,b+=n.texturedFaceCount,c||=null!==n.faceInfo,!n.facePriority){if(-1===x)x=n.priorityVal;if(x!==n.priorityVal)d=!0}else d=!0;u||=null!==n.faceAlpha,m||=null!==n.faceLabel}}let I=new Int32Array(v),A=new Int32Array(v),k=new Int32Array(v),L=new Int32Array(v),O=new Int32Array(S),X=new Int32Array(S),M=new Int32Array(S),Y=new Int32Array(b),B=new Int32Array(b),F=new Int32Array(b),E=null;if(c)E=new Int32Array(S);let D=null;if(d)D=new Int32Array(S);let R=null;if(u)R=new Int32Array(S);let _=null;if(m)_=new Int32Array(S);let z=new Int32Array(S);v=0,S=0,b=0;let g=(i,n,c,d,u,m,v)=>{let S=-1,b=i.vertexX[n],x=i.vertexY[n],I=i.vertexZ[n];for(let i=0;i<v;i++)if(b===c[i]&&x===d[i]&&I===u[i]){S=i;break}if(-1===S){if(c[v]=b,d[v]=x,u[v]=I,m&&i.vertexLabel)m[v]=i.vertexLabel[n];S=v++}return{vertex:S,vertexCount:v}};for(let x=0;x<n;x++){let n=i[x];if(n){for(let i=0;i<n.faceCount;i++){if(c)if(!n.faceInfo){if(E)E[S]=0}else if(E)E[S]=n.faceInfo[i];if(d)if(!n.facePriority){if(D)D[S]=n.priorityVal}else if(D)D[S]=n.facePriority[i];if(u)if(!n.faceAlpha){if(R)R[S]=0}else if(R)R[S]=n.faceAlpha[i];if(m&&n.faceLabel)if(_)_[S]=n.faceLabel[i];if(n.faceColor)z[S]=n.faceColor[i];let b=g(n,n.faceVertexA[i],I,A,k,L,v);v=b.vertexCount;let x=g(n,n.faceVertexB[i],I,A,k,L,v);v=x.vertexCount;let Y=g(n,n.faceVertexC[i],I,A,k,L,v);v=Y.vertexCount,O[S]=b.vertex,X[S]=x.vertex,M[S]=Y.vertex,S++}for(let i=0;i<n.texturedFaceCount;i++){let c=g(n,n.texturedVertexA[i],I,A,k,L,v);v=c.vertexCount;let d=g(n,n.texturedVertexB[i],I,A,k,L,v);v=d.vertexCount;let u=g(n,n.texturedVertexC[i],I,A,k,L,v);v=u.vertexCount,Y[b]=c.vertex,B[b]=d.vertex,F[b]=u.vertex,b++}}}return new J({vertexCount:v,vertexX:I,vertexY:A,vertexZ:k,faceCount:S,faceVertexA:O,faceVertexB:X,faceVertexC:M,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:E,facePriority:D,faceAlpha:R,faceColor:z,priorityVal:x,texturedFaceCount:b,texturedVertexA:Y,texturedVertexB:B,texturedVertexC:F,vertexLabel:L,faceLabel:_})}static model(i){if(!J.modelMeta)throw new Error;let n=J.modelMeta[i];if(!n)throw new Error;if(!(J.head&&J.face1&&J.face2&&J.face3&&J.face4&&J.face5&&J.point1&&J.point2&&J.point3&&J.point4&&J.point5&&J.vertex1&&J.vertex2&&J.axis))throw new Error;let{vertexCount:c,faceCount:d,texturedFaceCount:u}=n,m=new Int32Array(c),v=new Int32Array(c),S=new Int32Array(c),b=new Int32Array(d),x=new Int32Array(d),I=new Int32Array(d),A=new Int32Array(u),k=new Int32Array(u),L=new Int32Array(u),O=null;if(n.vertexLabelsOffset>=0)O=new Int32Array(c);let X=null;if(n.faceInfosOffset>=0)X=new Int32Array(d);let M=null,Y=0;if(n.facePrioritiesOffset>=0)M=new Int32Array(d);else Y=-n.facePrioritiesOffset-1;let B=null;if(n.faceAlphasOffset>=0)B=new Int32Array(d);let F=null;if(n.faceLabelsOffset>=0)F=new Int32Array(d);let E=new Int32Array(d);J.point1.pos=n.vertexFlagsOffset,J.point2.pos=n.vertexXOffset,J.point3.pos=n.vertexYOffset,J.point4.pos=n.vertexZOffset,J.point5.pos=n.vertexLabelsOffset;let D=0,R=0,_=0,z,Z,q;for(let i=0;i<c;i++){let n=J.point1.g1();if(z=0,!!(1&n))z=J.point2.gsmart();if(Z=0,!!(2&n))Z=J.point3.gsmart();if(q=0,!!(4&n))q=J.point4.gsmart();if(m[i]=D+z,v[i]=R+Z,S[i]=_+q,D=m[i],R=v[i],_=S[i],O)O[i]=J.point5.g1()}J.face1.pos=n.faceColorsOffset,J.face2.pos=n.faceInfosOffset,J.face3.pos=n.facePrioritiesOffset,J.face4.pos=n.faceAlphasOffset,J.face5.pos=n.faceLabelsOffset;for(let i=0;i<d;i++){if(E[i]=J.face1.g2(),X)X[i]=J.face2.g1();if(M)M[i]=J.face3.g1();if(B)B[i]=J.face4.g1();if(F)F[i]=J.face5.g1()}J.vertex1.pos=n.faceVerticesOffset,J.vertex2.pos=n.faceOrientationsOffset,z=0,Z=0,q=0;let N=0;for(let i=0;i<d;i++){let n=J.vertex2.g1();if(1===n)z=J.vertex1.gsmart()+N,N=z,Z=J.vertex1.gsmart()+N,N=Z,q=J.vertex1.gsmart()+N,N=q;else if(2===n)Z=q,q=J.vertex1.gsmart()+N,N=q;else if(3===n)z=q,q=J.vertex1.gsmart()+N,N=q;else if(4===n){let i=z;z=Z,Z=i,q=J.vertex1.gsmart()+N,N=q}b[i]=z,x[i]=Z,I[i]=q}J.axis.pos=6*n.faceTextureAxisOffset;for(let i=0;i<u;i++)A[i]=J.axis.g2(),k[i]=J.axis.g2(),L[i]=J.axis.g2();return new J({vertexCount:c,vertexX:m,vertexY:v,vertexZ:S,faceCount:d,faceVertexA:b,faceVertexB:x,faceVertexC:I,faceColorA:null,faceColorB:null,faceColorC:null,faceInfo:X,facePriority:M,faceAlpha:B,faceColor:E,priorityVal:Y,texturedFaceCount:u,texturedVertexA:A,texturedVertexB:k,texturedVertexC:L,vertexLabel:O,faceLabel:F})}vertexCount;vertexX;vertexY;vertexZ;faceCount;faceVertexA;faceVertexB;faceVertexC;faceColorA;faceColorB;faceColorC;faceInfo;facePriority;faceAlpha;faceColor;priorityVal;texturedFaceCount;texturedVertexA;texturedVertexB;texturedVertexC;minX;maxX;minZ;maxZ;radius;minY;maxY;maxDepth;minDepth;vertexLabel;faceLabel;labelVertices;labelFaces;vertexNormal;vertexNormalOriginal;objRaise=0;pickable=!1;pickedFace=-1;pickedFaceDepth=-1;constructor(i){super(),this.vertexCount=i.vertexCount,this.vertexX=i.vertexX,this.vertexY=i.vertexY,this.vertexZ=i.vertexZ,this.faceCount=i.faceCount,this.faceVertexA=i.faceVertexA,this.faceVertexB=i.faceVertexB,this.faceVertexC=i.faceVertexC,this.faceColorA=i.faceColorA,this.faceColorB=i.faceColorB,this.faceColorC=i.faceColorC,this.faceInfo=i.faceInfo,this.facePriority=i.facePriority,this.faceAlpha=i.faceAlpha,this.faceColor=i.faceColor,this.priorityVal=i.priorityVal,this.texturedFaceCount=i.texturedFaceCount,this.texturedVertexA=i.texturedVertexA,this.texturedVertexB=i.texturedVertexB,this.texturedVertexC=i.texturedVertexC,this.minX=i.minX??0,this.maxX=i.maxX??0,this.minZ=i.minZ??0,this.maxZ=i.maxZ??0,this.radius=i.radius??0,this.minY=i.minY??0,this.maxY=i.maxY??0,this.maxDepth=i.maxDepth??0,this.minDepth=i.minDepth??0,this.vertexLabel=i.vertexLabel??null,this.faceLabel=i.faceLabel??null,this.labelVertices=i.labelVertices??null,this.labelFaces=i.labelFaces??null,this.vertexNormal=i.vertexNormal??null,this.vertexNormalOriginal=i.vertexNormalOriginal??null}calculateBoundsCylinder(){this.maxY=0,this.radius=0,this.minY=0;for(let i=0;i<this.vertexCount;i++){let n=this.vertexX[i],c=this.vertexY[i],d=this.vertexZ[i];if(-c>this.maxY)this.maxY=-c;if(c>this.minY)this.minY=c;let u=n*n+d*d;if(u>this.radius)this.radius=u}this.radius=Math.sqrt(this.radius)+.99|0,this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+.99|0)}calculateBoundsY(){this.maxY=0,this.minY=0;for(let i=0;i<this.vertexCount;i++){let n=this.vertexY[i];if(-n>this.maxY)this.maxY=-n;if(n>this.minY)this.minY=n}this.minDepth=Math.sqrt(this.radius*this.radius+this.maxY*this.maxY)+.99|0,this.maxDepth=this.minDepth+(Math.sqrt(this.radius*this.radius+this.minY*this.minY)+.99|0)}createLabelReferences(){if(this.vertexLabel){let i=new Int32Array(256),n=0;for(let c=0;c<this.vertexCount;c++){let d=this.vertexLabel[c];if(i[d]++,d>n)n=d}this.labelVertices=new C(n+1,null);for(let c=0;c<=n;c++)this.labelVertices[c]=new Int32Array(i[c]),i[c]=0;let c=0;while(c<this.vertexCount){let n=this.vertexLabel[c],d=this.labelVertices[n];if(!d)continue;d[i[n]++]=c++}this.vertexLabel=null}if(this.faceLabel){let i=new Int32Array(256),n=0;for(let c=0;c<this.faceCount;c++){let d=this.faceLabel[c];if(i[d]++,d>n)n=d}this.labelFaces=new C(n+1,null);for(let c=0;c<=n;c++)this.labelFaces[c]=new Int32Array(i[c]),i[c]=0;let c=0;while(c<this.faceCount){let n=this.faceLabel[c],d=this.labelFaces[n];if(!d)continue;d[i[n]++]=c++}this.faceLabel=null}}applyTransforms(i,n,c){if(-1===i)return;if(!c||-1===n)this.applyTransform(i);else{let d=X0.instances[i],u=X0.instances[n],m=d.base;J.baseX=0,J.baseY=0,J.baseZ=0;let v=0,S=c[v++];for(let i=0;i<d.frameLength;i++){if(!d.bases)continue;let n=d.bases[i];while(n>S)S=c[v++];if(m&&m.animTypes&&d.x&&d.y&&d.z&&m.animLabels&&(n!==S||0===m.animTypes[n]))this.applyTransform2(d.x[i],d.y[i],d.z[i],m.animLabels[n],m.animTypes[n])}J.baseX=0,J.baseY=0,J.baseZ=0,v=0,S=c[v++];for(let i=0;i<u.frameLength;i++){if(!u.bases)continue;let n=u.bases[i];while(n>S)S=c[v++];if(m&&m.animTypes&&u.x&&u.y&&u.z&&m.animLabels&&(n===S||0===m.animTypes[n]))this.applyTransform2(u.x[i],u.y[i],u.z[i],m.animLabels[n],m.animTypes[n])}}}applyTransform(i){if(!this.labelVertices||-1===i||!X0.instances[i])return;let n=X0.instances[i],c=n.base;J.baseX=0,J.baseY=0,J.baseZ=0;for(let i=0;i<n.frameLength;i++){if(!(n.bases&&n.x&&n.y&&n.z&&c&&c.animLabels&&c.animTypes))continue;let d=n.bases[i];this.applyTransform2(n.x[i],n.y[i],n.z[i],c.animLabels[d],c.animTypes[d])}}rotateY90(){for(let i=0;i<this.vertexCount;i++){let n=this.vertexX[i];this.vertexX[i]=this.vertexZ[i],this.vertexZ[i]=-n}}rotateX(i){let n=w.sin[i],c=w.cos[i];for(let i=0;i<this.vertexCount;i++){let d=this.vertexY[i]*c-this.vertexZ[i]*n>>16;this.vertexZ[i]=this.vertexY[i]*n+this.vertexZ[i]*c>>16,this.vertexY[i]=d}}translateModel(i,n,c){for(let d=0;d<this.vertexCount;d++)this.vertexX[d]+=n,this.vertexY[d]+=i,this.vertexZ[d]+=c}recolor(i,n){if(!this.faceColor)return;for(let c=0;c<this.faceCount;c++)if(this.faceColor[c]===i)this.faceColor[c]=n}rotateY180(){for(let i=0;i<this.vertexCount;i++)this.vertexZ[i]=-this.vertexZ[i];for(let i=0;i<this.faceCount;i++){let n=this.faceVertexA[i];this.faceVertexA[i]=this.faceVertexC[i],this.faceVertexC[i]=n}}scale(i,n,c){for(let d=0;d<this.vertexCount;d++)this.vertexX[d]=this.vertexX[d]*i/128|0,this.vertexY[d]=this.vertexY[d]*n/128|0,this.vertexZ[d]=this.vertexZ[d]*c/128|0}calculateNormals(i,n,c,d,u,m){let v,S=n*(0|Math.sqrt(c*c+d*d+u*u))>>8;if(!this.faceColorA||!this.faceColorB||!this.faceColorC)this.faceColorA=new Int32Array(this.faceCount),this.faceColorB=new Int32Array(this.faceCount),this.faceColorC=new Int32Array(this.faceCount);if(!this.vertexNormal){this.vertexNormal=new C(this.vertexCount,null);for(let i=0;i<this.vertexCount;i++)this.vertexNormal[i]=new __}for(let n=0;n<this.faceCount;n++){let m=this.faceVertexA[n],v=this.faceVertexB[n],b=this.faceVertexC[n],x=this.vertexX[v]-this.vertexX[m],I=this.vertexY[v]-this.vertexY[m],A=this.vertexZ[v]-this.vertexZ[m],k=this.vertexX[b]-this.vertexX[m],L=this.vertexY[b]-this.vertexY[m],O=this.vertexZ[b]-this.vertexZ[m],X=I*O-L*A,M=A*k-O*x,Y=x*L-k*I;while(X>8192||M>8192||Y>8192||X<-8192||M<-8192||Y<-8192)X>>=1,M>>=1,Y>>=1;let B=0|Math.sqrt(X*X+M*M+Y*Y);if(B<=0)B=1;if(X=256*X/B|0,M=256*M/B|0,Y=256*Y/B|0,!(this.faceInfo&&1&this.faceInfo[n])){let i=this.vertexNormal[m];if(i)i.x+=X,i.y+=M,i.z+=Y,i.w++;if(i=this.vertexNormal[v],i)i.x+=X,i.y+=M,i.z+=Y,i.w++;if(i=this.vertexNormal[b],i)i.x+=X,i.y+=M,i.z+=Y,i.w++}else{let m=i+((c*X+d*M+u*Y)/(S+(S/2|0))|0);if(this.faceColor)this.faceColorA[n]=J.mulColorLightness(this.faceColor[n],m,this.faceInfo[n])}}if(m)this.applyLighting(i,S,c,d,u);else{this.vertexNormalOriginal=new C(this.vertexCount,null);for(let i=0;i<this.vertexCount;i++){let n=this.vertexNormal[i],c=new __;if(n)c.x=n.x,c.y=n.y,c.z=n.z,c.w=n.w;this.vertexNormalOriginal[i]=c}}if(m)this.calculateBoundsCylinder();else this.calculateBoundsAABB()}applyLighting(i,n,c,d,u){for(let m=0;m<this.faceCount;m++){let v=this.faceVertexA[m],S=this.faceVertexB[m],b=this.faceVertexC[m];if(!this.faceInfo&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let x=this.faceColor[m],I=this.vertexNormal[v];if(I)this.faceColorA[m]=J.mulColorLightness(x,i+((c*I.x+d*I.y+u*I.z)/(n*I.w)|0),0);let A=this.vertexNormal[S];if(A)this.faceColorB[m]=J.mulColorLightness(x,i+((c*A.x+d*A.y+u*A.z)/(n*A.w)|0),0);let k=this.vertexNormal[b];if(k)this.faceColorC[m]=J.mulColorLightness(x,i+((c*k.x+d*k.y+u*k.z)/(n*k.w)|0),0)}else if(this.faceInfo&&!(1&this.faceInfo[m])&&this.faceColor&&this.vertexNormal&&this.faceColorA&&this.faceColorB&&this.faceColorC){let x=this.faceColor[m],I=this.faceInfo[m],A=this.vertexNormal[v];if(A)this.faceColorA[m]=J.mulColorLightness(x,i+((c*A.x+d*A.y+u*A.z)/(n*A.w)|0),I);let k=this.vertexNormal[S];if(k)this.faceColorB[m]=J.mulColorLightness(x,i+((c*k.x+d*k.y+u*k.z)/(n*k.w)|0),I);let L=this.vertexNormal[b];if(L)this.faceColorC[m]=J.mulColorLightness(x,i+((c*L.x+d*L.y+u*L.z)/(n*L.w)|0),I)}}if(this.vertexNormal=null,this.vertexNormalOriginal=null,this.vertexLabel=null,this.faceLabel=null,this.faceInfo)for(let i=0;i<this.faceCount;i++)if(!(2&~this.faceInfo[i]))return;this.faceColor=null}drawSimple(i,n,c,d,u,m,v){let S=w.sin[i],b=w.cos[i],x=w.sin[n],I=w.cos[n],A=w.sin[c],k=w.cos[c],L=w.sin[d],O=w.cos[d],X=m*L+v*O>>16;for(let d=0;d<this.vertexCount;d++){let M=this.vertexX[d],Y=this.vertexY[d],B=this.vertexZ[d],F;if(0!==c)F=Y*A+M*k>>16,Y=Y*k-M*A>>16,M=F;if(0!==i)F=Y*b-B*S>>16,B=Y*S+B*b>>16,Y=F;if(0!==n)F=B*x+M*I>>16,B=B*I-M*x>>16,M=F;if(M+=u,Y+=m,B+=v,F=Y*O-B*L>>16,B=Y*L+B*O>>16,Y=F,J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ)J.vertexScreenZ[d]=B-X,J.vertexScreenX[d]=w.centerX+((M<<9)/B|0),J.vertexScreenY[d]=w.centerY+((Y<<9)/B|0);if(this.texturedFaceCount>0&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[d]=M,J.vertexViewSpaceY[d]=Y,J.vertexViewSpaceZ[d]=B}try{this.draw2(!1,!1,0)}catch(i){}}draw(i,n,c,d,u,m,v,S,b){let x=S*u-m*d>>16,I=v*n+x*c>>16,A=this.radius*c>>16,k=I+A;if(k<=50||I>=3500)return;let L=S*d+m*u>>16,O=L-this.radius<<9;if((O/k|0)>=T.centerX2d)return;let X=L+this.radius<<9;if((X/k|0)<=-T.centerX2d)return;let M=v*c-x*n>>16,Y=this.radius*n>>16,B=M+Y<<9;if((B/k|0)<=-T.centerY2d)return;let F,E=M-(Y+(this.maxY*c>>16))<<9;if((E/k|0)>=T.centerY2d)return;let D,R=I-(A+(this.maxY*n>>16))<=50,_=!1;if(b>0&&J.checkHover){let i=I-A;if(i<=50)i=50;if(L>0)O=O/k|0,X=X/i|0;else X=X/k|0,O=O/i|0;if(M>0)E=E/k|0,B=B/i|0;else B=B/k|0,E=E/i|0;let n=J.mouseX-w.centerX,c=J.mouseY-w.centerY;if(n>O&&n<X&&c>E&&c<B)if(this.pickable)J.picked[J.pickedCount++]=b;else _=!0}let z=w.centerX,Z=w.centerY,q=0,N=0;if(0!==i)q=w.sin[i],N=w.cos[i];for(let b=0;b<this.vertexCount;b++){let x=this.vertexX[b],A=this.vertexY[b],k=this.vertexZ[b],L;if(0!==i)L=k*q+x*N>>16,k=k*N-x*q>>16,x=L;if(x+=m,A+=v,k+=S,L=k*d+x*u>>16,k=k*u-x*d>>16,x=L,L=A*c-k*n>>16,k=A*n+k*c>>16,A=L,J.vertexScreenZ)J.vertexScreenZ[b]=k-I;if(k>=50&&J.vertexScreenX&&J.vertexScreenY)J.vertexScreenX[b]=z+((x<<9)/k|0),J.vertexScreenY[b]=Z+((A<<9)/k|0);else if(J.vertexScreenX)J.vertexScreenX[b]=-5e3,R=!0;if((R||this.texturedFaceCount>0)&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ)J.vertexViewSpaceX[b]=x,J.vertexViewSpaceY[b]=A,J.vertexViewSpaceZ[b]=k}try{this.draw2(R,_,b)}catch(i){}}draw2(i,n,c,d=!1){if(J.checkHoverFace)this.pickedFace=-1,this.pickedFaceDepth=-1;for(let i=0;i<this.maxDepth;i++)if(J.tmpDepthFaceCount)J.tmpDepthFaceCount[i]=0;for(let d=0;d<this.faceCount;d++){if(this.faceInfo&&-1===this.faceInfo[d])continue;if(J.vertexScreenX&&J.vertexScreenY&&J.vertexScreenZ&&J.tmpDepthFaces&&J.tmpDepthFaceCount){let u=this.faceVertexA[d],m=this.faceVertexB[d],v=this.faceVertexC[d],S=J.vertexScreenX[u],b=J.vertexScreenX[m],x=J.vertexScreenX[v],I=J.vertexScreenY[u],A=J.vertexScreenY[m],k=J.vertexScreenY[v],L=J.vertexScreenZ[u],O=J.vertexScreenZ[m],X=J.vertexScreenZ[v];if(i&&(-5e3===S||-5e3===b||-5e3===x)){if(J.faceNearClipped)J.faceNearClipped[d]=!0;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let i=((L+O+X)/3|0)+this.minDepth;J.tmpDepthFaces[i][J.tmpDepthFaceCount[i]++]=d}}else{if(n&&this.pointWithinTriangle(J.mouseX,J.mouseY,I,A,k,S,b,x))J.picked[J.pickedCount++]=c,n=!1;let i,u,m,v;if((S-b)*(k-A)-(I-A)*(x-b)<=0)continue;if(J.faceNearClipped)J.faceNearClipped[d]=!1;if(J.faceClippedX)J.faceClippedX[d]=S<0||b<0||x<0||S>T.boundX||b>T.boundX||x>T.boundX;if(J.tmpDepthFaces&&J.tmpDepthFaceCount){let i=((L+O+X)/3|0)+this.minDepth;if(J.tmpDepthFaces[i][J.tmpDepthFaceCount[i]++]=d,J.checkHoverFace&&this.pointWithinTriangle(J.mouseX,J.mouseY,I,A,k,S,b,x)&&this.pickedFaceDepth<i)this.pickedFace=d,this.pickedFaceDepth=i}}}}if(!this.facePriority&&J.tmpDepthFaceCount){for(let i=this.maxDepth-1;i>=0;i--){let n=J.tmpDepthFaceCount[i];if(n<=0)continue;if(J.tmpDepthFaces){let c=J.tmpDepthFaces[i];for(let i=0;i<n;i++)try{this.drawFace(c[i],d)}catch(i){}}}return}for(let i=0;i<12;i++)if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum)J.tmpPriorityFaceCount[i]=0,J.tmpPriorityDepthSum[i]=0;if(J.tmpDepthFaceCount)for(let i=this.maxDepth-1;i>=0;i--){let n=J.tmpDepthFaceCount[i];if(n>0&&J.tmpDepthFaces){let c=J.tmpDepthFaces[i];for(let d=0;d<n;d++)if(this.facePriority&&J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let n=c[d],u=this.facePriority[n],m=J.tmpPriorityFaceCount[u]++;if(J.tmpPriorityFaces[u][m]=n,u<10&&J.tmpPriorityDepthSum)J.tmpPriorityDepthSum[u]+=i;else if(10===u&&J.tmpPriority10FaceDepth)J.tmpPriority10FaceDepth[m]=i;else if(J.tmpPriority11FaceDepth)J.tmpPriority11FaceDepth[m]=i}}}let u=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[1]>0||J.tmpPriorityFaceCount[2]>0))u=(J.tmpPriorityDepthSum[1]+J.tmpPriorityDepthSum[2])/(J.tmpPriorityFaceCount[1]+J.tmpPriorityFaceCount[2])|0;let m=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[3]>0||J.tmpPriorityFaceCount[4]>0))m=(J.tmpPriorityDepthSum[3]+J.tmpPriorityDepthSum[4])/(J.tmpPriorityFaceCount[3]+J.tmpPriorityFaceCount[4])|0;let v=0;if(J.tmpPriorityFaceCount&&J.tmpPriorityDepthSum&&(J.tmpPriorityFaceCount[6]>0||J.tmpPriorityFaceCount[8]>0))v=(J.tmpPriorityDepthSum[6]+J.tmpPriorityDepthSum[8])/(J.tmpPriorityFaceCount[6]+J.tmpPriorityFaceCount[8])|0;if(J.tmpPriorityFaceCount&&J.tmpPriorityFaces){let i=0,n=J.tmpPriorityFaceCount[10],c=J.tmpPriorityFaces[10],S=J.tmpPriority10FaceDepth;if(i===n)i=0,n=J.tmpPriorityFaceCount[11],c=J.tmpPriorityFaces[11],S=J.tmpPriority11FaceDepth;let b;if(i<n&&S)b=S[i];else b=-1e3;for(let x=0;x<10;x++){while(0===x&&b>u)try{if(this.drawFace(c[i++],d),i===n&&c!==J.tmpPriorityFaces[11])i=0,n=J.tmpPriorityFaceCount[11],c=J.tmpPriorityFaces[11],S=J.tmpPriority11FaceDepth;if(i<n&&S)b=S[i];else b=-1e3}catch(i){}while(3===x&&b>m)try{if(this.drawFace(c[i++],d),i===n&&c!==J.tmpPriorityFaces[11])i=0,n=J.tmpPriorityFaceCount[11],c=J.tmpPriorityFaces[11],S=J.tmpPriority11FaceDepth;if(i<n&&S)b=S[i];else b=-1e3}catch(i){}while(5===x&&b>v)try{if(this.drawFace(c[i++],d),i===n&&c!==J.tmpPriorityFaces[11])i=0,n=J.tmpPriorityFaceCount[11],c=J.tmpPriorityFaces[11],S=J.tmpPriority11FaceDepth;if(i<n&&S)b=S[i];else b=-1e3}catch(i){}let I=J.tmpPriorityFaceCount[x],A=J.tmpPriorityFaces[x];for(let i=0;i<I;i++)try{this.drawFace(A[i],d)}catch(i){}}while(-1e3!==b)try{if(this.drawFace(c[i++],d),i===n&&c!==J.tmpPriorityFaces[11])i=0,c=J.tmpPriorityFaces[11],n=J.tmpPriorityFaceCount[11],S=J.tmpPriority11FaceDepth;if(i<n&&S)b=S[i];else b=-1e3}catch(i){}}}drawFace(i,n=!1){if(J.faceNearClipped&&J.faceNearClipped[i])return void this.drawNearClippedFace(i,n);let c=this.faceVertexA[i],d=this.faceVertexB[i],u=this.faceVertexC[i];if(J.faceClippedX)w.clipX=J.faceClippedX[i];if(!this.faceAlpha)w.alpha=0;else w.alpha=this.faceAlpha[i];let m;if(!this.faceInfo)m=0;else m=3&this.faceInfo[i];if(n&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC)w.drawLine(J.vertexScreenX[c],J.vertexScreenY[c],J.vertexScreenX[d],J.vertexScreenY[d],w.hslPal[this.faceColorA[i]]),w.drawLine(J.vertexScreenX[d],J.vertexScreenY[d],J.vertexScreenX[u],J.vertexScreenY[u],w.hslPal[this.faceColorB[i]]),w.drawLine(J.vertexScreenX[u],J.vertexScreenY[u],J.vertexScreenX[c],J.vertexScreenY[c],w.hslPal[this.faceColorC[i]]);else if(0===m&&this.faceColorA&&this.faceColorB&&this.faceColorC&&J.vertexScreenX&&J.vertexScreenY)w.fillGouraudTriangle(J.vertexScreenX[c],J.vertexScreenX[d],J.vertexScreenX[u],J.vertexScreenY[c],J.vertexScreenY[d],J.vertexScreenY[u],this.faceColorA[i],this.faceColorB[i],this.faceColorC[i]);else if(1===m&&this.faceColorA&&J.vertexScreenX&&J.vertexScreenY)w.fillTriangle(J.vertexScreenX[c],J.vertexScreenX[d],J.vertexScreenX[u],J.vertexScreenY[c],J.vertexScreenY[d],J.vertexScreenY[u],w.hslPal[this.faceColorA[i]]);else if(2===m&&this.faceInfo&&this.faceColor&&this.faceColorA&&this.faceColorB&&this.faceColorC&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,m=this.texturedVertexA[n],v=this.texturedVertexB[n],S=this.texturedVertexC[n];w.fillTexturedTriangle(J.vertexScreenX[c],J.vertexScreenX[d],J.vertexScreenX[u],J.vertexScreenY[c],J.vertexScreenY[d],J.vertexScreenY[u],this.faceColorA[i],this.faceColorB[i],this.faceColorC[i],J.vertexViewSpaceX[m],J.vertexViewSpaceY[m],J.vertexViewSpaceZ[m],J.vertexViewSpaceX[v],J.vertexViewSpaceX[S],J.vertexViewSpaceY[v],J.vertexViewSpaceY[S],J.vertexViewSpaceZ[v],J.vertexViewSpaceZ[S],this.faceColor[i])}else if(3===m&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexScreenX&&J.vertexScreenY&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,m=this.texturedVertexA[n],v=this.texturedVertexB[n],S=this.texturedVertexC[n];w.fillTexturedTriangle(J.vertexScreenX[c],J.vertexScreenX[d],J.vertexScreenX[u],J.vertexScreenY[c],J.vertexScreenY[d],J.vertexScreenY[u],this.faceColorA[i],this.faceColorA[i],this.faceColorA[i],J.vertexViewSpaceX[m],J.vertexViewSpaceY[m],J.vertexViewSpaceZ[m],J.vertexViewSpaceX[v],J.vertexViewSpaceX[S],J.vertexViewSpaceY[v],J.vertexViewSpaceY[S],J.vertexViewSpaceZ[v],J.vertexViewSpaceZ[S],this.faceColor[i])}}drawNearClippedFace(i,n=!1){let c=0;if(J.vertexViewSpaceZ){let n=w.centerX,d=w.centerY,u=this.faceVertexA[i],m=this.faceVertexB[i],v=this.faceVertexC[i],S=J.vertexViewSpaceZ[u],b=J.vertexViewSpaceZ[m],x=J.vertexViewSpaceZ[v];if(S>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorA)J.clippedX[c]=J.vertexScreenX[u],J.clippedY[c]=J.vertexScreenY[u],J.clippedColor[c++]=this.faceColorA[i];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorA){let I=J.vertexViewSpaceX[u],A=J.vertexViewSpaceY[u],k=this.faceColorA[i];if(x>=50&&this.faceColorC){let u=(50-S)*w.reciprocal16[x-S];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[v]-I)*u>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[v]-A)*u>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorC[i]-k)*u>>16)}if(b>=50&&this.faceColorB){let u=(50-S)*w.reciprocal16[b-S];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[m]-I)*u>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[m]-A)*u>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorB[i]-k)*u>>16)}}if(b>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorB)J.clippedX[c]=J.vertexScreenX[m],J.clippedY[c]=J.vertexScreenY[m],J.clippedColor[c++]=this.faceColorB[i];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorB){let I=J.vertexViewSpaceX[m],A=J.vertexViewSpaceY[m],k=this.faceColorB[i];if(S>=50&&this.faceColorA){let m=(50-b)*w.reciprocal16[S-b];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[u]-I)*m>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[u]-A)*m>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorA[i]-k)*m>>16)}if(x>=50&&this.faceColorC){let u=(50-b)*w.reciprocal16[x-b];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[v]-I)*u>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[v]-A)*u>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorC[i]-k)*u>>16)}}if(x>=50&&J.vertexScreenX&&J.vertexScreenY&&this.faceColorC)J.clippedX[c]=J.vertexScreenX[v],J.clippedY[c]=J.vertexScreenY[v],J.clippedColor[c++]=this.faceColorC[i];else if(J.vertexViewSpaceX&&J.vertexViewSpaceY&&this.faceColorC){let I=J.vertexViewSpaceX[v],A=J.vertexViewSpaceY[v],k=this.faceColorC[i];if(b>=50&&this.faceColorB){let u=(50-x)*w.reciprocal16[b-x];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[m]-I)*u>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[m]-A)*u>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorB[i]-k)*u>>16)}if(S>=50&&this.faceColorA){let m=(50-x)*w.reciprocal16[S-x];J.clippedX[c]=n+((I+((J.vertexViewSpaceX[u]-I)*m>>16)<<9)/50|0),J.clippedY[c]=d+((A+((J.vertexViewSpaceY[u]-A)*m>>16)<<9)/50|0),J.clippedColor[c++]=k+((this.faceColorA[i]-k)*m>>16)}}}let d=J.clippedX[0],u=J.clippedX[1],m=J.clippedX[2],v=J.clippedY[0],S=J.clippedY[1],b=J.clippedY[2];if((d-u)*(b-S)-(v-S)*(m-u)<=0)return;if(w.clipX=!1,3===c){if(d<0||u<0||m<0||d>T.boundX||u>T.boundX||m>T.boundX)w.clipX=!0;let c;if(!this.faceInfo)c=0;else c=3&this.faceInfo[i];if(n)w.drawLine(d,u,v,S,J.clippedColor[0]),w.drawLine(u,m,S,b,J.clippedColor[1]),w.drawLine(m,d,b,v,J.clippedColor[2]);else if(0===c)w.fillGouraudTriangle(d,u,m,v,S,b,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2]);else if(1===c&&this.faceColorA)w.fillTriangle(d,u,m,v,S,b,w.hslPal[this.faceColorA[i]]);else if(2===c&&this.faceInfo&&this.faceColor&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,c=this.texturedVertexA[n],x=this.texturedVertexB[n],I=this.texturedVertexC[n];w.fillTexturedTriangle(d,u,m,v,S,b,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i])}else if(3===c&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,c=this.texturedVertexA[n],x=this.texturedVertexB[n],I=this.texturedVertexC[n];w.fillTexturedTriangle(d,u,m,v,S,b,this.faceColorA[i],this.faceColorA[i],this.faceColorA[i],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i])}}else if(4===c){if(d<0||u<0||m<0||d>T.boundX||u>T.boundX||m>T.boundX||J.clippedX[3]<0||J.clippedX[3]>T.boundX)w.clipX=!0;let c;if(!this.faceInfo)c=0;else c=3&this.faceInfo[i];if(n)w.drawLine(d,u,v,S,J.clippedColor[0]),w.drawLine(u,m,S,b,J.clippedColor[1]),w.drawLine(m,J.clippedX[3],b,J.clippedY[3],J.clippedColor[2]),w.drawLine(J.clippedX[3],d,J.clippedY[3],v,J.clippedColor[3]);else if(0===c)w.fillGouraudTriangle(d,u,m,v,S,b,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2]),w.fillGouraudTriangle(d,m,J.clippedX[3],v,b,J.clippedY[3],J.clippedColor[0],J.clippedColor[2],J.clippedColor[3]);else if(1===c){if(this.faceColorA){let n=w.hslPal[this.faceColorA[i]];w.fillTriangle(d,u,m,v,S,b,n),w.fillTriangle(d,m,J.clippedX[3],v,b,J.clippedY[3],n)}}else if(2===c&&this.faceInfo&&this.faceColor&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,c=this.texturedVertexA[n],x=this.texturedVertexB[n],I=this.texturedVertexC[n];w.fillTexturedTriangle(d,u,m,v,S,b,J.clippedColor[0],J.clippedColor[1],J.clippedColor[2],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i]),w.fillTexturedTriangle(d,m,J.clippedX[3],v,b,J.clippedY[3],J.clippedColor[0],J.clippedColor[2],J.clippedColor[3],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i])}else if(3===c&&this.faceInfo&&this.faceColor&&this.faceColorA&&J.vertexViewSpaceX&&J.vertexViewSpaceY&&J.vertexViewSpaceZ){let n=this.faceInfo[i]>>2,c=this.texturedVertexA[n],x=this.texturedVertexB[n],I=this.texturedVertexC[n];w.fillTexturedTriangle(d,u,m,v,S,b,this.faceColorA[i],this.faceColorA[i],this.faceColorA[i],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i]),w.fillTexturedTriangle(d,m,J.clippedX[3],v,b,J.clippedY[3],this.faceColorA[i],this.faceColorA[i],this.faceColorA[i],J.vertexViewSpaceX[c],J.vertexViewSpaceY[c],J.vertexViewSpaceZ[c],J.vertexViewSpaceX[x],J.vertexViewSpaceX[I],J.vertexViewSpaceY[x],J.vertexViewSpaceY[I],J.vertexViewSpaceZ[x],J.vertexViewSpaceZ[I],this.faceColor[i])}}}applyTransform2(i,n,c,d,u){if(!d)return;let m=d.length;if(0===u){let u=0;J.baseX=0,J.baseY=0,J.baseZ=0;for(let i=0;i<m;i++){if(!this.labelVertices)continue;let n=d[i];if(n<this.labelVertices.length){let i=this.labelVertices[n];if(i)for(let n=0;n<i.length;n++){let c=i[n];J.baseX+=this.vertexX[c],J.baseY+=this.vertexY[c],J.baseZ+=this.vertexZ[c],u++}}}if(u>0)J.baseX=(J.baseX/u|0)+i,J.baseY=(J.baseY/u|0)+n,J.baseZ=(J.baseZ/u|0)+c;else J.baseX=i,J.baseY=n,J.baseZ=c}else if(1===u)for(let u=0;u<m;u++){let m=d[u];if(!this.labelVertices||m>=this.labelVertices.length)continue;let v=this.labelVertices[m];if(v)for(let d=0;d<v.length;d++){let u=v[d];this.vertexX[u]+=i,this.vertexY[u]+=n,this.vertexZ[u]+=c}}else if(2===u)for(let u=0;u<m;u++){let m=d[u];if(!this.labelVertices||m>=this.labelVertices.length)continue;let v=this.labelVertices[m];if(v)for(let d=0;d<v.length;d++){let u=v[d];this.vertexX[u]-=J.baseX,this.vertexY[u]-=J.baseY,this.vertexZ[u]-=J.baseZ;let m=8*(255&i),S=8*(255&n),b=8*(255&c),x,I;if(0!==b){x=w.sin[b],I=w.cos[b];let i=this.vertexY[u]*x+this.vertexX[u]*I>>16;this.vertexY[u]=this.vertexY[u]*I-this.vertexX[u]*x>>16,this.vertexX[u]=i}if(0!==m){x=w.sin[m],I=w.cos[m];let i=this.vertexY[u]*I-this.vertexZ[u]*x>>16;this.vertexZ[u]=this.vertexY[u]*x+this.vertexZ[u]*I>>16,this.vertexY[u]=i}if(0!==S){x=w.sin[S],I=w.cos[S];let i=this.vertexZ[u]*x+this.vertexX[u]*I>>16;this.vertexZ[u]=this.vertexZ[u]*I-this.vertexX[u]*x>>16,this.vertexX[u]=i}this.vertexX[u]+=J.baseX,this.vertexY[u]+=J.baseY,this.vertexZ[u]+=J.baseZ}}else if(3===u)for(let u=0;u<m;u++){let m=d[u];if(!this.labelVertices||m>=this.labelVertices.length)continue;let v=this.labelVertices[m];if(v)for(let d=0;d<v.length;d++){let u=v[d];this.vertexX[u]-=J.baseX,this.vertexY[u]-=J.baseY,this.vertexZ[u]-=J.baseZ,this.vertexX[u]=this.vertexX[u]*i/128|0,this.vertexY[u]=this.vertexY[u]*n/128|0,this.vertexZ[u]=this.vertexZ[u]*c/128|0,this.vertexX[u]+=J.baseX,this.vertexY[u]+=J.baseY,this.vertexZ[u]+=J.baseZ}}else if(5===u&&this.labelFaces&&this.faceAlpha)for(let n=0;n<m;n++){let c=d[n];if(c>=this.labelFaces.length)continue;let u=this.labelFaces[c];if(u)for(let n=0;n<u.length;n++){let c=u[n];if(this.faceAlpha[c]+=8*i,this.faceAlpha[c]<0)this.faceAlpha[c]=0;if(this.faceAlpha[c]>255)this.faceAlpha[c]=255}}}calculateBoundsAABB(){this.maxY=0,this.radius=0,this.minY=0,this.minX=999999,this.maxX=-999999,this.maxZ=-99999,this.minZ=99999;for(let i=0;i<this.vertexCount;i++){let n=this.vertexX[i],c=this.vertexY[i],d=this.vertexZ[i];if(n<this.minX)this.minX=n;if(n>this.maxX)this.maxX=n;if(d<this.minZ)this.minZ=d;if(d>this.maxZ)this.maxZ=d;if(-c>this.maxY)this.maxY=-c;if(c>this.minY)this.minY=c;let u=n*n+d*d;if(u>this.radius)this.radius=u}this.radius=0|Math.sqrt(this.radius),this.minDepth=0|Math.sqrt(this.radius*this.radius+this.maxY*this.maxY),this.maxDepth=this.minDepth+(0|Math.sqrt(this.radius*this.radius+this.minY*this.minY))}pointWithinTriangle(i,n,c,d,u,m,v,S){if(n<c&&n<d&&n<u)return!1;else if(n>c&&n>d&&n>u)return!1;else if(i<m&&i<v&&i<S)return!1;else return i<=m||i<=v||i<=S}drawFaceOutline(i){if(!(J.vertexScreenX&&J.vertexScreenY&&this.faceColorA&&this.faceColorB&&this.faceColorC))return;let n=this.faceVertexA[i],c=this.faceVertexB[i],d=this.faceVertexC[i];w.drawLine(J.vertexScreenX[n],J.vertexScreenY[n],J.vertexScreenX[c],J.vertexScreenY[c],w.hslPal[1e3]),w.drawLine(J.vertexScreenX[c],J.vertexScreenY[c],J.vertexScreenX[d],J.vertexScreenY[d],w.hslPal[1e3]),w.drawLine(J.vertexScreenX[d],J.vertexScreenY[d],J.vertexScreenX[n],J.vertexScreenY[n],w.hslPal[1e3])}}class Q0 extends u0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static modelCacheStatic=new k0(500);static modelCacheDynamic=new k0(30);static unpack(i){this.dat=new f(i.read("loc.dat"));let n=new f(i.read("loc.idx"));this.totalCount=n.g2(),this.offsets=new Int32Array(this.totalCount);let c=2;for(let i=0;i<this.totalCount;i++)this.offsets[i]=c,c+=n.g2();this.typeCache=new C(10,null);for(let i=0;i<10;i++)this.typeCache[i]=new Q0(-1)}static get(i){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let n=0;n<10;n++){let c=this.typeCache[n];if(!c)continue;if(c.id===i)return c}this.cachePos=(this.cachePos+1)%10;let n=this.typeCache[this.cachePos];if(this.dat.pos=this.offsets[i],n.id=i,n.reset(),n.unpackType(this.dat),!n.shapes)n.shapes=new Int32Array(1);if(-1===n.active2&&n.shapes)if(n.locActive=n.shapes.length>0&&n.shapes[0]===h.CENTREPIECE_STRAIGHT.id,n.op)n.locActive=!0;return n}models=null;shapes=null;name=null;desc=null;recol_s=null;recol_d=null;width=1;length=1;blockwalk=!0;blockrange=!0;locActive=!1;active2=-1;hillskew=!1;sharelight=!1;occlude=!1;anim=-1;disposeAlpha=!1;wallwidth=16;ambient=0;contrast=0;op=null;mapfunction=-1;mapscene=-1;mirror=!1;shadow=!0;resizex=128;resizey=128;resizez=128;forceapproach=0;offsetx=0;offsety=0;offsetz=0;forcedecor=!1;unpack(i,n){if(1===i){let i=n.g1();this.models=new Int32Array(i),this.shapes=new Int32Array(i);for(let c=0;c<i;c++)this.models[c]=n.g2(),this.shapes[c]=n.g1()}else if(2===i)this.name=n.gjstr();else if(3===i)this.desc=n.gjstr();else if(14===i)this.width=n.g1();else if(15===i)this.length=n.g1();else if(17===i)this.blockwalk=!1;else if(18===i)this.blockrange=!1;else if(19===i){if(this.active2=n.g1(),1===this.active2)this.locActive=!0}else if(21===i)this.hillskew=!0;else if(22===i)this.sharelight=!0;else if(23===i)this.occlude=!0;else if(24===i){if(this.anim=n.g2(),65535===this.anim)this.anim=-1}else if(25===i)this.disposeAlpha=!0;else if(28===i)this.wallwidth=n.g1();else if(29===i)this.ambient=n.g1b();else if(39===i)this.contrast=n.g1b();else if(i>=30&&i<39){if(!this.op)this.op=new C(5,null);if(this.op[i-30]=n.gjstr(),"hidden"===this.op[i-30]?.toLowerCase())this.op[i-30]=null}else if(40===i){let i=n.g1();this.recol_s=new Uint16Array(i),this.recol_d=new Uint16Array(i);for(let c=0;c<i;c++)this.recol_s[c]=n.g2(),this.recol_d[c]=n.g2()}else if(60===i)this.mapfunction=n.g2();else if(62===i)this.mirror=!0;else if(64===i)this.shadow=!1;else if(65===i)this.resizex=n.g2();else if(66===i)this.resizey=n.g2();else if(67===i)this.resizez=n.g2();else if(68===i)this.mapscene=n.g2();else if(69===i)this.forceapproach=n.g1();else if(70===i)this.offsetx=n.g2b();else if(71===i)this.offsety=n.g2b();else if(72===i)this.offsetz=n.g2b();else if(73===i)this.forcedecor=!0}getModel(i,n,c,d,u,m,v){if(!this.shapes)return null;let S=-1;for(let n=0;n<this.shapes.length;n++)if(this.shapes[n]===i){S=n;break}if(-1===S)return null;let b=BigInt(BigInt(this.id)<<6n)+BigInt(BigInt(S)<<3n)+BigInt(n)+BigInt(BigInt(v)+1n<<32n),x=Q0.modelCacheDynamic?.get(b);if(x){if(this.hillskew||this.sharelight)x=J.modelCopyFaces(x,this.hillskew,this.sharelight);if(this.hillskew){let i=(c+d+u+m)/4|0;for(let n=0;n<x.vertexCount;n++){let v=x.vertexX[n],S,b=c+((d-c)*(v+64)/128|0),I,A=b+((m+((u-m)*(v+64)/128|0)-b)*(x.vertexZ[n]+64)/128|0);x.vertexY[n]+=A-i}x.calculateBoundsY()}return x}if(!this.models)return null;if(S>=this.models.length)return null;let I=this.models[S];if(-1===I)return null;let A=this.mirror!==n>3;if(A)I+=65536;let k=Q0.modelCacheStatic?.get(BigInt(I));if(!k){if(k=J.model(65535&I),A)k.rotateY180();Q0.modelCacheStatic?.put(BigInt(I),k)}let L=128!==this.resizex||128!==this.resizey||128!==this.resizez,O=0!==this.offsetx||0!==this.offsety||0!==this.offsetz,X=J.modelShareColored(k,!this.recol_s,!this.disposeAlpha,0===n&&-1===v&&!L&&!O);if(-1!==v)X.createLabelReferences(),X.applyTransform(v),X.labelFaces=null,X.labelVertices=null;while(n-- >0)X.rotateY90();if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)X.recolor(this.recol_s[i],this.recol_d[i]);if(L)X.scale(this.resizex,this.resizey,this.resizez);if(O)X.translateModel(this.offsety,this.offsetx,this.offsetz);if(X.calculateNormals((255&this.ambient)+64,5*(255&this.contrast)+768,-50,-10,-50,!this.sharelight),this.blockwalk)X.objRaise=X.maxY;if(Q0.modelCacheDynamic?.put(b,X),this.hillskew||this.sharelight)X=J.modelCopyFaces(X,this.hillskew,this.sharelight);if(this.hillskew){let i=(c+d+u+m)/4|0;for(let n=0;n<X.vertexCount;n++){let v=X.vertexX[n],S,b=c+((d-c)*(v+64)/128|0),x,I=b+((m+((u-m)*(v+64)/128|0)-b)*(X.vertexZ[n]+64)/128|0);X.vertexY[n]+=I-i}X.calculateBoundsY()}return X}reset(){this.models=null,this.shapes=null,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.width=1,this.length=1,this.blockwalk=!0,this.blockrange=!0,this.locActive=!1,this.active2=-1,this.hillskew=!1,this.sharelight=!1,this.occlude=!1,this.anim=-1,this.wallwidth=16,this.ambient=0,this.contrast=0,this.op=null,this.disposeAlpha=!1,this.mapfunction=-1,this.mapscene=-1,this.mirror=!1,this.shadow=!0,this.resizex=128,this.resizey=128,this.resizez=128,this.forceapproach=0,this.offsetx=0,this.offsety=0,this.offsetz=0,this.forcedecor=!1}}async function w_(i){if(255!==i[0])i[0]=255;URL.revokeObjectURL(h0.src),h0.src=URL.createObjectURL(new Blob([i],{type:"image/jpeg"})),await new Promise(i=>h0.onload=()=>i()),c0.clearRect(0,0,n0.width,n0.height);let n=h0.naturalWidth,c=h0.naturalHeight;return n0.width=n,n0.height=c,c0.drawImage(h0,0,0),c0.getImageData(0,0,n,c)}class e extends j0{pixels;width2d;height2d;cropX;cropY;cropW;cropH;constructor(i,n){super(),this.pixels=new Int32Array(i*n),this.width2d=this.cropW=i,this.height2d=this.cropH=n,this.cropX=this.cropY=0}static async fromJpeg(i,n){let c=i.read(n+".dat");if(!c)throw new Error;let d=await w_(c),u=new e(d.width,d.height),m=new Uint32Array(d.data.buffer),v=u.pixels;for(let i=0;i<v.length;i++){let n=m[i];v[i]=(n>>24&255)<<24|(255&n)<<16|(n>>8&255)<<8|n>>16&255}return u}static fromArchive(i,n,c=0){let d=new f(i.read(n+".dat")),u=new f(i.read("index.dat"));u.pos=d.g2();let m=u.g2(),v=u.g2(),S,b=[],x=u.g1()-1;for(let i=0;i<x;i++)if(b[i+1]=u.g3(),0===b[i+1])b[i+1]=1;for(let i=0;i<c;i++)u.pos+=2,d.pos+=u.g2()*u.g2(),u.pos+=1;if(d.pos>d.length||u.pos>u.length)throw new Error;let I=u.g1(),A=u.g1(),k=u.g2(),L=u.g2(),O=new e(k,L);O.cropX=I,O.cropY=A,O.cropW=m,O.cropH=v;let X=u.g1();if(0===X){let i=O.width2d*O.height2d;for(let n=0;n<i;n++)O.pixels[n]=b[d.g1()]}else if(1===X){let i=O.width2d;for(let n=0;n<i;n++){let c=O.height2d;for(let u=0;u<c;u++)O.pixels[n+u*i]=b[d.g1()]}}return O}bind(){T.bind(this.pixels,this.width2d,this.height2d)}draw(i,n){i|=0,n|=0;let c=(i+=this.cropX)+(n+=this.cropY)*T.width2d,d=0,u=this.height2d,m=this.width2d,v=T.width2d-m,S=0;if(n<T.top){let i=T.top-n;u-=i,n=T.top,d+=i*m,c+=i*T.width2d}if(n+u>T.bottom)u-=n+u-T.bottom;if(i<T.left){let n=T.left-i;m-=n,i=T.left,d+=n,c+=n,S+=n,v+=n}if(i+m>T.right){let n=i+m-T.right;m-=n,S+=n,v+=n}if(m>0&&u>0)this.copyImageDraw(m,u,this.pixels,d,S,T.pixels,c,v)}drawAlpha(i,n,c){n|=0,c|=0;let d=(n+=this.cropX)+(c+=this.cropY)*T.width2d,u=0,m=this.height2d,v=this.width2d,S=T.width2d-v,b=0;if(c<T.top){let i=T.top-c;m-=i,c=T.top,u+=i*v,d+=i*T.width2d}if(c+m>T.bottom)m-=c+m-T.bottom;if(n<T.left){let i=T.left-n;v-=i,n=T.left,u+=i,d+=i,b+=i,S+=i}if(n+v>T.right){let i=n+v-T.right;v-=i,b+=i,S+=i}if(v>0&&m>0)this.copyPixelsAlpha(v,m,this.pixels,u,b,T.pixels,d,S,i)}blitOpaque(i,n){i|=0,n|=0;let c=(i+=this.cropX)+(n+=this.cropY)*T.width2d,d=0,u=this.height2d,m=this.width2d,v=T.width2d-m,S=0;if(n<T.top){let i=T.top-n;u-=i,n=T.top,d+=i*m,c+=i*T.width2d}if(n+u>T.bottom)u-=n+u-T.bottom;if(i<T.left){let n=T.left-i;m-=n,i=T.left,d+=n,c+=n,S+=n,v+=n}if(i+m>T.right){let n=i+m-T.right;m-=n,S+=n,v+=n}if(m>0&&u>0)this.copyImageBlitOpaque(m,u,this.pixels,d,S,T.pixels,c,v)}flipHorizontally(){let i=this.pixels,n=this.width2d,c=this.height2d;for(let d=0;d<c;d++){let c=n/2|0;for(let u=0;u<c;u++){let c=u+d*n,m=n-u-1+d*n,v=i[c];i[c]=i[m],i[m]=v}}}flipVertically(){let i=this.pixels,n=this.width2d,c=this.height2d;for(let d=0;d<(c/2|0);d++)for(let u=0;u<n;u++){let m=u+d*n,v=u+(c-d-1)*n,S=i[m];i[m]=i[v],i[v]=S}}translate2d(i,n,c){for(let d=0;d<this.pixels.length;d++){let u=this.pixels[d];if(0!==u){let m=u>>16&255;if(m+=i,m<1)m=1;else if(m>255)m=255;let v=u>>8&255;if(v+=n,v<1)v=1;else if(v>255)v=255;let S=255&u;if(S+=c,S<1)S=1;else if(S>255)S=255;this.pixels[d]=(m<<16)+(v<<8)+S}}}crop(i,n,c,d){i|=0,n|=0,c|=0,d|=0;try{let u=this.width2d,m=0,v=0,S=this.cropW,b=this.cropH,x=(S<<16)/c|0,I=(b<<16)/d|0;if(i+=(this.cropX*c+S-1)/S|0,n+=(this.cropY*d+b-1)/b|0,this.cropX*c%S!==0)m=(S-this.cropX*c%S<<16)/c|0;if(this.cropY*d%b!==0)v=(b-this.cropY*d%b<<16)/d|0;c=c*(this.width2d-(m>>16))/S|0,d=d*(this.height2d-(v>>16))/b|0;let A=i+n*T.width2d,k=T.width2d-c;if(n<T.top){let i=T.top-n;d-=i,n=0,A+=i*T.width2d,v+=I*i}if(n+d>T.bottom)d-=n+d-T.bottom;if(i<T.left){let n=T.left-i;c-=n,i=0,A+=n,m+=x*n,k+=n}if(i+c>T.right){let n=i+c-T.right;c-=n,k+=n}this.scale(c,d,this.pixels,m,v,T.pixels,k,A,u,x,I)}catch(i){}}drawRotatedMasked(i,n,c,d,u,m,v,S,b,x){i|=0,n|=0,c|=0,d|=0;try{let I=-c/2|0,A=-d/2|0,k=65536*Math.sin(b/326.11)|0,L=65536*Math.cos(b/326.11)|0,O=k*x>>8,X=L*x>>8,M=(v<<16)+A*O+I*X,Y=(S<<16)+(A*X-I*O),B=i+n*T.width2d;for(let i=0;i<d;i++){let n=u[i],c=B+n,d=M+X*n,v=Y-O*n;for(let n=-m[i];n<0;n++)T.pixels[c++]=this.pixels[(d>>16)+(v>>16)*this.width2d],d+=X,v-=O;M+=O,Y+=X,B+=T.width2d}}catch(i){}}drawMasked(i,n,c){i|=0,n|=0;let d=(i+=this.cropX)+(n+=this.cropY)*T.width2d,u=0,m=this.height2d,v=this.width2d,S=T.width2d-v,b=0;if(n<T.top){let i=T.top-n;m-=i,n=T.top,u+=i*v,d+=i*T.width2d}if(n+m>T.bottom)m-=n+m-T.bottom;if(i<T.left){let n=T.left-i;v-=n,i=T.left,u+=n,d+=n,b+=n,S+=n}if(i+v>T.right){let n=i+v-T.right;v-=n,b+=n,S+=n}if(v>0&&m>0)this.copyPixelsMasked(v,m,this.pixels,b,u,T.pixels,d,S,c.pixels)}scale(i,n,c,d,u,m,v,S,b,x,I){try{let A=d;for(let k=-n;k<0;k++){let n=(u>>16)*b;for(let u=-i;u<0;u++){let i=c[(d>>16)+n];if(0===i)S++;else m[S++]=i;d+=x}u+=I,d=A,S+=v}}catch(i){}}copyImageBlitOpaque(i,n,c,d,u,m,v,S){let b=-(i>>2);i=-(3&i);for(let x=-n;x<0;x++){for(let i=b;i<0;i++)m[v++]=c[d++],m[v++]=c[d++],m[v++]=c[d++],m[v++]=c[d++];for(let n=i;n<0;n++)m[v++]=c[d++];v+=S,d+=u}}copyPixelsAlpha(i,n,c,d,u,m,v,S,b){let x=256-b;for(let I=-n;I<0;I++){for(let n=-i;n<0;n++){let i=c[d++];if(0===i)v++;else{let n=m[v];m[v++]=((16711935&i)*b+(16711935&n)*x&4278255360)+((65280&i)*b+(65280&n)*x&16711680)>>8}}v+=S,d+=u}}copyImageDraw(i,n,c,d,u,m,v,S){let b=-(i>>2);i=-(3&i);for(let x=-n;x<0;x++){for(let i=b;i<0;i++){let i=c[d++];if(0===i)v++;else m[v++]=i;if(i=c[d++],0===i)v++;else m[v++]=i;if(i=c[d++],0===i)v++;else m[v++]=i;if(i=c[d++],0===i)v++;else m[v++]=i}for(let n=i;n<0;n++){let i=c[d++];if(0===i)v++;else m[v++]=i}v+=S,d+=u}}copyPixelsMasked(i,n,c,d,u,m,v,S,b){let x=-(i>>2);i=-(3&i);for(let I=-n;I<0;I++){for(let i=x;i<0;i++){let i=c[u++];if(0!==i&&0===b[v])m[v++]=i;else v++;if(i=c[u++],0!==i&&0===b[v])m[v++]=i;else v++;if(i=c[u++],0!==i&&0===b[v])m[v++]=i;else v++;if(i=c[u++],0!==i&&0===b[v])m[v++]=i;else v++}for(let n=i;n<0;n++){let i=c[u++];if(0!==i&&0===b[v])m[v++]=i;else v++}v+=S,u+=d}}}class _0 extends u0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static membersWorld=!0;static modelCache=new k0(50);static iconCache=new k0(200);static unpack(i,n){this.membersWorld=n,this.dat=new f(i.read("obj.dat"));let c=new f(i.read("obj.idx"));this.totalCount=c.g2(),this.offsets=new Int32Array(this.totalCount);let d=2;for(let i=0;i<this.totalCount;i++)this.offsets[i]=d,d+=c.g2();this.typeCache=new C(10,null);for(let i=0;i<10;i++)this.typeCache[i]=new _0(-1)}static get(i){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let n=0;n<10;n++){let c=this.typeCache[n];if(!c)continue;if(c.id===i)return c}this.cachePos=(this.cachePos+1)%10;let n=this.typeCache[this.cachePos];if(this.dat.pos=this.offsets[i],n.id=i,n.reset(),n.unpackType(this.dat),-1!==n.certtemplate)n.toCertificate();if(!this.membersWorld&&n.members)n.name="Members Object",n.desc="Login to a members' server to use this object.",n.op=null,n.iop=null;return n}static getIcon(i,n){if(_0.iconCache){let c=_0.iconCache.get(BigInt(i));if(c&&c.cropH!==n&&-1!==c.cropH)c.unlink(),c=null;if(c)return c}let c=_0.get(i);if(!c.countobj)n=-1;if(c.countobj&&c.countco&&n>1){let i=-1;for(let d=0;d<10;d++)if(n>=c.countco[d]&&0!==c.countco[d])i=c.countobj[d];if(-1!==i)c=_0.get(i)}let d=new e(32,32),u=w.centerX,m=w.centerY,v=w.lineOffset,S=T.pixels,b=T.width2d,x=T.height2d,I=T.left,A=T.right,k=T.top,L=T.bottom;w.jagged=!1,T.bind(d.pixels,32,32),T.fillRect2d(0,0,32,32,0),w.init2D();let O=c.getInterfaceModel(1),X=w.sin[c.xan2d]*c.zoom2d>>16,M=w.cos[c.xan2d]*c.zoom2d>>16;O.drawSimple(0,c.yan2d,c.zan2d,c.xan2d,c.xof2d,X+(O.maxY/2|0)+c.yof2d,M+c.yof2d);for(let i=31;i>=0;i--)for(let n=31;n>=0;n--){if(0!==d.pixels[i+32*n])continue;if(i>0&&d.pixels[i+32*n-1]>1)d.pixels[i+32*n]=1;else if(n>0&&d.pixels[i+32*(n-1)]>1)d.pixels[i+32*n]=1;else if(i<31&&d.pixels[i+32*n+1]>1)d.pixels[i+32*n]=1;else if(n<31&&d.pixels[i+32*(n+1)]>1)d.pixels[i+32*n]=1}for(let i=31;i>=0;i--)for(let n=31;n>=0;n--)if(0===d.pixels[i+32*n]&&i>0&&n>0&&d.pixels[i+32*(n-1)-1]>0)d.pixels[i+32*n]=3153952;if(-1!==c.certtemplate){let i=this.getIcon(c.certlink,10),n=i.cropW,d=i.cropH;i.cropW=32,i.cropH=32,i.crop(5,5,22,22),i.cropW=n,i.cropH=d}if(_0.iconCache?.put(BigInt(i),d),T.bind(S,b,x),T.setBounds(I,k,A,L),w.centerX=u,w.centerY=m,w.lineOffset=v,w.jagged=!0,c.stackable)d.cropW=33;else d.cropW=32;return d.cropH=n,d}model=0;name=null;desc=null;recol_s=null;recol_d=null;zoom2d=2e3;xan2d=0;yan2d=0;zan2d=0;xof2d=0;yof2d=0;code9=!1;code10=-1;stackable=!1;cost=1;members=!1;op=null;iop=null;manwear=-1;manwear2=-1;manwearOffsetY=0;womanwear=-1;womanwear2=-1;womanwearOffsetY=0;manwear3=-1;womanwear3=-1;manhead=-1;manhead2=-1;womanhead=-1;womanhead2=-1;countobj=null;countco=null;certlink=-1;certtemplate=-1;unpack(i,n){if(1===i)this.model=n.g2();else if(2===i)this.name=n.gjstr();else if(3===i)this.desc=n.gjstr();else if(4===i)this.zoom2d=n.g2();else if(5===i)this.xan2d=n.g2();else if(6===i)this.yan2d=n.g2();else if(7===i){if(this.xof2d=n.g2b(),this.xof2d>32767)this.xof2d-=65536}else if(8===i){if(this.yof2d=n.g2b(),this.yof2d>32767)this.yof2d-=65536}else if(9===i)this.code9=!0;else if(10===i)this.code10=n.g2();else if(11===i)this.stackable=!0;else if(12===i)this.cost=n.g4();else if(16===i)this.members=!0;else if(23===i)this.manwear=n.g2(),this.manwearOffsetY=n.g1b();else if(24===i)this.manwear2=n.g2();else if(25===i)this.womanwear=n.g2(),this.womanwearOffsetY=n.g1b();else if(26===i)this.womanwear2=n.g2();else if(i>=30&&i<35){if(!this.op)this.op=new C(5,null);if(this.op[i-30]=n.gjstr(),"hidden"===this.op[i-30]?.toLowerCase())this.op[i-30]=null}else if(i>=35&&i<40){if(!this.iop)this.iop=new C(5,null);this.iop[i-35]=n.gjstr()}else if(40===i){let i=n.g1();this.recol_s=new Uint16Array(i),this.recol_d=new Uint16Array(i);for(let c=0;c<i;c++)this.recol_s[c]=n.g2(),this.recol_d[c]=n.g2()}else if(78===i)this.manwear3=n.g2();else if(79===i)this.womanwear3=n.g2();else if(90===i)this.manhead=n.g2();else if(91===i)this.womanhead=n.g2();else if(92===i)this.manhead2=n.g2();else if(93===i)this.womanhead2=n.g2();else if(95===i)this.zan2d=n.g2();else if(97===i)this.certlink=n.g2();else if(98===i)this.certtemplate=n.g2();else if(i>=100&&i<110){if(!this.countobj||!this.countco)this.countobj=new Uint16Array(10),this.countco=new Uint16Array(10);this.countobj[i-100]=n.g2(),this.countco[i-100]=n.g2()}}getWornModel(i){let n=this.manwear;if(1===i)n=this.womanwear;if(-1===n)return null;let c=this.manwear2,d=this.manwear3;if(1===i)c=this.womanwear2,d=this.womanwear3;let u=J.model(n);if(-1!==c){let i=J.model(c);if(-1===d){let n=[u,i];u=J.modelFromModels(n,2)}else{let n,c=[u,i,J.model(d)];u=J.modelFromModels(c,3)}}if(0===i&&0!==this.manwearOffsetY)u.translateModel(this.manwearOffsetY,0,0);if(1===i&&0!==this.womanwearOffsetY)u.translateModel(this.womanwearOffsetY,0,0);if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)u.recolor(this.recol_s[i],this.recol_d[i]);return u}getHeadModel(i){let n=this.manhead;if(1===i)n=this.womanhead;if(-1===n)return null;let c=this.manhead2;if(1===i)c=this.womanhead2;let d=J.model(n);if(-1!==c){let i,n=[d,J.model(c)];d=J.modelFromModels(n,2)}if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)d.recolor(this.recol_s[i],this.recol_d[i]);return d}getInterfaceModel(i){if(this.countobj&&this.countco&&i>1){let n=-1;for(let c=0;c<10;c++)if(i>=this.countco[c]&&0!==this.countco[c])n=this.countobj[c];if(-1!==n)return _0.get(n).getInterfaceModel(1)}if(_0.modelCache){let i=_0.modelCache.get(BigInt(this.id));if(i)return i}let n=J.model(this.model);if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)n.recolor(this.recol_s[i],this.recol_d[i]);return n.calculateNormals(64,768,-50,-10,-50,!0),n.pickable=!0,_0.modelCache?.put(BigInt(this.id),n),n}toCertificate(){let i=_0.get(this.certtemplate);this.model=i.model,this.zoom2d=i.zoom2d,this.xan2d=i.xan2d,this.yan2d=i.yan2d,this.zan2d=i.zan2d,this.xof2d=i.xof2d,this.yof2d=i.yof2d,this.recol_s=i.recol_s,this.recol_d=i.recol_d;let n=_0.get(this.certlink);this.name=n.name,this.members=n.members,this.cost=n.cost;let c="a",d=(n.name||"").toLowerCase().charAt(0);if("a"===d||"e"===d||"i"===d||"o"===d||"u"===d)c="an";this.desc=`Swap this note at any bank for ${c} ${n.name}.`,this.stackable=!0}reset(){this.model=0,this.name=null,this.desc=null,this.recol_s=null,this.recol_d=null,this.zoom2d=2e3,this.xan2d=0,this.yan2d=0,this.zan2d=0,this.xof2d=0,this.yof2d=0,this.code9=!1,this.code10=-1,this.stackable=!1,this.cost=1,this.members=!1,this.op=null,this.iop=null,this.manwear=-1,this.manwear2=-1,this.manwearOffsetY=0,this.womanwear=-1,this.womanwear2=-1,this.womanwearOffsetY=0,this.manwear3=-1,this.womanwear3=-1,this.manhead=-1,this.manhead2=-1,this.womanhead=-1,this.womanhead2=-1,this.countobj=null,this.countco=null,this.certlink=-1,this.certtemplate=-1}}class w0 extends u0{static totalCount=0;static typeCache=null;static dat=null;static offsets=null;static cachePos=0;static modelCache=new k0(30);static unpack(i){this.dat=new f(i.read("npc.dat"));let n=new f(i.read("npc.idx"));this.totalCount=n.g2(),this.offsets=new Int32Array(this.totalCount);let c=2;for(let i=0;i<this.totalCount;i++)this.offsets[i]=c,c+=n.g2();this.typeCache=new C(20,null);for(let i=0;i<20;i++)this.typeCache[i]=new w0(-1)}static get(i){if(!this.typeCache||!this.offsets||!this.dat)throw new Error;for(let n=0;n<20;n++){let c=this.typeCache[n];if(!c)continue;if(c.id===i)return c}this.cachePos=(this.cachePos+1)%20;let n=this.typeCache[this.cachePos]=new w0(i);return this.dat.pos=this.offsets[i],n.unpackType(this.dat),n}name=null;desc=null;size=1;models=null;heads=null;disposeAlpha=!1;readyanim=-1;walkanim=-1;walkanim_b=-1;walkanim_r=-1;walkanim_l=-1;recol_s=null;recol_d=null;op=null;resizex=-1;resizey=-1;resizez=-1;minimap=!0;vislevel=-1;resizeh=128;resizev=128;unpack(i,n){if(1===i){let i=n.g1();this.models=new Uint16Array(i);for(let c=0;c<i;c++)this.models[c]=n.g2()}else if(2===i)this.name=n.gjstr();else if(3===i)this.desc=n.gjstr();else if(12===i)this.size=n.g1b();else if(13===i)this.readyanim=n.g2();else if(14===i)this.walkanim=n.g2();else if(16===i)this.disposeAlpha=!0;else if(17===i)this.walkanim=n.g2(),this.walkanim_b=n.g2(),this.walkanim_r=n.g2(),this.walkanim_l=n.g2();else if(i>=30&&i<40){if(!this.op)this.op=new C(5,null);if(this.op[i-30]=n.gjstr(),"hidden"===this.op[i-30]?.toLowerCase())this.op[i-30]=null}else if(40===i){let i=n.g1();this.recol_s=new Uint16Array(i),this.recol_d=new Uint16Array(i);for(let c=0;c<i;c++)this.recol_s[c]=n.g2(),this.recol_d[c]=n.g2()}else if(60===i){let i=n.g1();this.heads=new Uint16Array(i);for(let c=0;c<i;c++)this.heads[c]=n.g2()}else if(90===i)this.resizex=n.g2();else if(91===i)this.resizey=n.g2();else if(92===i)this.resizez=n.g2();else if(93===i)this.minimap=!1;else if(95===i)this.vislevel=n.g2();else if(97===i)this.resizeh=n.g2();else if(98===i)this.resizev=n.g2()}getSequencedModel(i,n,c){let d=null,u=null;if(w0.modelCache)if(u=w0.modelCache.get(BigInt(this.id)),!u&&this.models){let i=new C(this.models.length,null);for(let n=0;n<this.models.length;n++)i[n]=J.model(this.models[n]);if(1===i.length)u=i[0];else u=J.modelFromModels(i,i.length);if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)u?.recolor(this.recol_s[i],this.recol_d[i]);if(u?.createLabelReferences(),u?.calculateNormals(64,850,-30,-50,-30,!0),u)w0.modelCache.put(BigInt(this.id),u)}if(u){if(d=J.modelShareAlpha(u,!this.disposeAlpha),-1!==i&&-1!==n)d.applyTransforms(i,n,c);else if(-1!==i)d.applyTransform(i);if(128!==this.resizeh||128!==this.resizev)d.scale(this.resizeh,this.resizev,this.resizeh);if(d.calculateBoundsCylinder(),d.labelFaces=null,d.labelVertices=null,1===this.size)d.pickable=!0;return d}return null}getHeadModel(){if(!this.heads)return null;let i=new C(this.heads.length,null);for(let n=0;n<this.heads.length;n++)i[n]=J.model(this.heads[n]);let n;if(1===i.length)n=i[0];else n=J.modelFromModels(i,i.length);if(this.recol_s&&this.recol_d)for(let i=0;i<this.recol_s.length;i++)n?.recolor(this.recol_s[i],this.recol_d[i]);return n}}class Y0 extends u0{static totalCount=0;static instances=[];static unpack(i){let n=new f(i.read("idk.dat"));this.totalCount=n.g2();for(let i=0;i<this.totalCount;i++)this.instances[i]=new Y0(i).unpackType(n)}bodyPart=-1;models=null;heads=new Int32Array(5).fill(-1);recol_s=new Int32Array(6);recol_d=new Int32Array(6);disableKit=!1;unpack(i,n){if(1===i)this.bodyPart=n.g1();else if(2===i){let i=n.g1();this.models=new Int32Array(i);for(let c=0;c<i;c++)this.models[c]=n.g2()}else if(3===i)this.disableKit=!0;else if(i>=40&&i<50)this.recol_s[i-40]=n.g2();else if(i>=50&&i<60)this.recol_d[i-50]=n.g2();else if(i>=60&&i<70)this.heads[i-60]=n.g2()}getModel(){if(!this.models)return null;let i=new C(this.models.length,null);for(let n=0;n<this.models.length;n++)i[n]=J.model(this.models[n]);let n;if(1===i.length)n=i[0];else n=J.modelFromModels(i,i.length);for(let i=0;i<6&&0!==this.recol_s[i];i++)n?.recolor(this.recol_s[i],this.recol_d[i]);return n}getHeadModel(){let i=0,n=new C(5,null);for(let c=0;c<5;c++)if(-1!==this.heads[c])n[i++]=J.model(this.heads[c]);let c=J.modelFromModels(n,i);for(let i=0;i<6&&0!==this.recol_s[i];i++)c.recolor(this.recol_s[i],this.recol_d[i]);return c}}class T0 extends u0{static totalCount=0;static instances=[];static modelCache=new k0(30);static unpack(i){let n=new f(i.read("spotanim.dat"));this.totalCount=n.g2();for(let i=0;i<this.totalCount;i++)this.instances[i]=new T0(i).unpackType(n)}model=0;anim=-1;seq=null;disposeAlpha=!1;recol_s=new Uint16Array(6);recol_d=new Uint16Array(6);resizeh=128;resizev=128;spotAngle=0;ambient=0;contrast=0;unpack(i,n){if(1===i)this.model=n.g2();else if(2===i){if(this.anim=n.g2(),r.instances)this.seq=r.instances[this.anim]}else if(3===i)this.disposeAlpha=!0;else if(4===i)this.resizeh=n.g2();else if(5===i)this.resizev=n.g2();else if(6===i)this.spotAngle=n.g2();else if(7===i)this.ambient=n.g1();else if(8===i)this.contrast=n.g1();else if(i>=40&&i<50)this.recol_s[i-40]=n.g2();else if(i>=50&&i<60)this.recol_d[i-50]=n.g2()}getModel(){let i=T0.modelCache?.get(BigInt(this.id));if(i)return i;i=J.model(this.model);for(let n=0;n<6;n++)if(0!==this.recol_s[0])i.recolor(this.recol_s[n],this.recol_d[n]);return T0.modelCache?.put(BigInt(this.id),i),i}}class z0 extends u0{static totalCount=0;static instances=[];static code3=[];static code3Count=0;static unpack(i){let n=new f(i.read("varp.dat"));this.totalCount=n.g2();for(let i=0;i<this.totalCount;i++)this.instances[i]=new z0(i).unpackType(n)}scope=0;varType=0;code3=!1;protect=!0;clientcode=0;code7=0;transmit=!1;code8=!1;unpack(i,n){if(1===i)this.scope=n.g1();else if(2===i)this.varType=n.g1();else if(3===i)this.code3=!0,z0.code3[z0.code3Count++]=this.id;else if(4===i)this.protect=!1;else if(5===i)this.clientcode=n.g2();else if(6===i)this.transmit=!0;else if(7===i)this.code7=n.g4();else if(8===i)this.code8=!0;else if(10===i)this.debugname=n.gjstr()}}class l{static BASE37_LOOKUP=["_","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"];static toBase37(i){i=i.trim();let n=0n;for(let c=0;c<i.length&&c<12;c++){let d=i.charCodeAt(c);if(n*=37n,d>=65&&d<=90)n+=BigInt(d+1-65);else if(d>=97&&d<=122)n+=BigInt(d+1-97);else if(d>=48&&d<=57)n+=BigInt(d+27-48)}return n}static fromBase37(i){if(i<0n||i>=6582952005840035281n)return"invalid_name";if(i%37n==0n)return"invalid_name";let n=0,c=Array(12);while(0n!==i){let d=i;i/=37n,c[11-n++]=this.BASE37_LOOKUP[Number(d-37n*i)]}return c.slice(12-n).join("")}static toSentenceCase(i){let n=[...i.toLowerCase()],c=!0;for(let i=0;i<n.length;i++){let d=n[i];if(c&&d>="a"&&d<="z")n[i]=d.toUpperCase(),c=!1;if("."===d||"!"===d)c=!0}return n.join("")}static toAsterisks(i){let n="";for(let c=0;c<i.length;c++)n+="*";return n}static formatIPv4(i){return(i>>24&255)+"."+(i>>16&255)+"."+(i>>8&255)+"."+(255&i)}static formatName(i){if(0===i.length)return i;let n=[...i];for(let i=0;i<n.length;i++)if("_"===n[i])if(n[i]=" ",i+1<n.length&&n[i+1]>="a"&&n[i+1]<="z")n[i+1]=String.fromCharCode(n[i+1].charCodeAt(0)+65-97);if(n[0]>="a"&&n[0]<="z")n[0]=String.fromCharCode(n[0].charCodeAt(0)+65-97);return n.join("")}static hashCode(i){let n=i.toUpperCase(),c=0n;for(let i=0;i<n.length;i++)c=61n*c+BigInt(n.charCodeAt(i))-32n,c=c+(c>>56n)&0xffffffffffffffn;return c}}class s{static instances=[];static imageCache=null;static modelCache=null;static unpack(i,n,c){this.imageCache=new k0(5e4),this.modelCache=new k0(5e4);let d=new f(i.read("data")),u=-1;d.pos+=2;while(d.pos<d.length){let i=d.g2();if(65535===i)u=d.g2(),i=d.g2();let m=this.instances[i]=new s;if(m.id=i,m.layer=u,m.comType=d.g1(),m.buttonType=d.g1(),m.clientCode=d.g2(),m.width=d.g2(),m.height=d.g2(),m.overLayer=d.g1(),0===m.overLayer)m.overLayer=-1;else m.overLayer=(m.overLayer-1<<8)+d.g1();let v=d.g1();if(v>0){m.scriptComparator=new Uint8Array(v),m.scriptOperand=new Uint16Array(v);for(let i=0;i<v;i++)m.scriptComparator[i]=d.g1(),m.scriptOperand[i]=d.g2()}let S=d.g1();if(S>0){m.script=new C(S,null);for(let i=0;i<S;i++){let n=d.g2(),c=new Uint16Array(n);m.script[i]=c;for(let i=0;i<n;i++)c[i]=d.g2()}}if(0===m.comType){m.scroll=d.g2(),m.hide=1===d.g1();let i=d.g1();m.childId=new Array(i),m.childX=new Array(i),m.childY=new Array(i);for(let n=0;n<i;n++)m.childId[n]=d.g2(),m.childX[n]=d.g2b(),m.childY[n]=d.g2b()}if(1===m.comType)d.pos+=3;if(2===m.comType){m.invSlotObjId=new Int32Array(m.width*m.height),m.invSlotObjCount=new Int32Array(m.width*m.height),m.draggable=1===d.g1(),m.interactable=1===d.g1(),m.usable=1===d.g1(),m.marginX=d.g1(),m.marginY=d.g1(),m.invSlotOffsetX=new Int16Array(20),m.invSlotOffsetY=new Int16Array(20),m.invSlotSprite=new C(20,null);for(let i=0;i<20;i++)if(1===d.g1()){m.invSlotOffsetX[i]=d.g2b(),m.invSlotOffsetY[i]=d.g2b();let c=d.gjstr();if(c.length>0){let d=c.lastIndexOf(",");m.invSlotSprite[i]=this.getImage(n,c.substring(0,d),parseInt(c.substring(d+1),10))}}m.iops=new C(5,null);for(let i=0;i<5;i++){let n=d.gjstr();if(m.iops[i]=n,0===n.length)m.iops[i]=null}}if(3===m.comType)m.fill=1===d.g1();if(4===m.comType||1===m.comType){m.center=1===d.g1();let i=d.g1();if(c)m.font=c[i];m.shadowed=1===d.g1()}if(4===m.comType)m.text=d.gjstr(),m.activeText=d.gjstr();if(1===m.comType||3===m.comType||4===m.comType)m.colour=d.g4();if(3===m.comType||4===m.comType)m.activeColour=d.g4(),m.overColour=d.g4();if(5===m.comType){let i=d.gjstr();if(i.length>0){let c=i.lastIndexOf(",");m.graphic=this.getImage(n,i.substring(0,c),parseInt(i.substring(c+1),10))}let c=d.gjstr();if(c.length>0){let i=c.lastIndexOf(",");m.activeGraphic=this.getImage(n,c.substring(0,i),parseInt(c.substring(i+1),10))}}if(6===m.comType){let i=d.g1();if(0!==i)m.model=this.getModel((i-1<<8)+d.g1());let n=d.g1();if(0!==n)m.activeModel=this.getModel((n-1<<8)+d.g1());if(m.anim=d.g1(),0===m.anim)m.anim=-1;else m.anim=(m.anim-1<<8)+d.g1();if(m.activeAnim=d.g1(),0===m.activeAnim)m.activeAnim=-1;else m.activeAnim=(m.activeAnim-1<<8)+d.g1();m.zoom=d.g2(),m.xan=d.g2(),m.yan=d.g2()}if(7===m.comType){m.invSlotObjId=new Int32Array(m.width*m.height),m.invSlotObjCount=new Int32Array(m.width*m.height),m.center=1===d.g1();let i=d.g1();if(c)m.font=c[i];m.shadowed=1===d.g1(),m.colour=d.g4(),m.marginX=d.g2b(),m.marginY=d.g2b(),m.interactable=1===d.g1(),m.iops=new C(5,null);for(let i=0;i<5;i++){let n=d.gjstr();if(m.iops[i]=n,0===n.length)m.iops[i]=null}}if(2===m.buttonType||2===m.comType)m.actionVerb=d.gjstr(),m.action=d.gjstr(),m.actionTarget=d.g2();if(1===m.buttonType||4===m.buttonType||5===m.buttonType||6===m.buttonType)if(m.option=d.gjstr(),0===m.option.length)if(1===m.buttonType)m.option="Ok";else if(4===m.buttonType)m.option="Select";else if(5===m.buttonType)m.option="Select";else if(6===m.buttonType)m.option="Continue"}this.imageCache=null,this.modelCache=null}static getImage(i,n,c){let d=l.hashCode(n)<<8n|BigInt(c);if(this.imageCache){let i=this.imageCache.get(d);if(i)return i}let u;try{u=e.fromArchive(i,n,c),this.imageCache?.put(d,u)}catch(i){return null}return u}static getModel(i){if(this.modelCache){let n=this.modelCache.get(BigInt(i));if(n)return n}let n=J.model(i);return this.modelCache?.put(BigInt(i),n),n}id=-1;layer=-1;comType=-1;buttonType=-1;clientCode=0;width=0;height=0;overLayer=-1;scriptComparator=null;scriptOperand=null;script=null;scroll=0;hide=!1;draggable=!1;interactable=!1;usable=!1;marginX=0;marginY=0;invSlotOffsetX=null;invSlotOffsetY=null;invSlotSprite=null;iops=null;fill=!1;center=!1;font=null;shadowed=!1;text=null;activeText=null;colour=0;activeColour=0;overColour=0;graphic=null;activeGraphic=null;model=null;activeModel=null;anim=-1;activeAnim=-1;zoom=0;xan=0;yan=0;actionVerb=null;action=null;actionTarget=-1;option=null;childId=null;childX=null;childY=null;x=0;y=0;scrollPosition=0;invSlotObjId=null;invSlotObjCount=null;seqFrame=0;seqCycle=0;getModel(i,n,c){let d=this.model;if(c)d=this.activeModel;if(!d)return null;if(-1===i&&-1===n&&!d.faceColor)return d;let u=J.modelShareColored(d,!0,!0,!1);if(-1!==i||-1!==n)u.createLabelReferences();if(-1!==i)u.applyTransform(i);if(-1!==n)u.applyTransform(n);return u.calculateNormals(64,768,-50,-10,-50,!0),u}getAbsoluteX(){if(this.layer===this.id)return this.x;let i=s.instances[this.layer];if(!i.childId||!i.childX||!i.childY)return this.x;let n=i.childId.indexOf(this.id);if(-1===n)return this.x;let c=i.childX[n];while(i.layer!==i.id){let d=s.instances[i.layer];if(d.childId&&d.childX&&d.childY)if(n=d.childId.indexOf(i.id),-1!==n)c+=d.childX[n];i=d}return c}getAbsoluteY(){if(this.layer===this.id)return this.y;let i=s.instances[this.layer];if(!i.childId||!i.childX||!i.childY)return this.y;let n=i.childId.indexOf(this.id);if(-1===n)return this.y;let c=i.childY[n];while(i.layer!==i.id){let d=s.instances[i.layer];if(d.childId&&d.childX&&d.childY)if(n=d.childId.indexOf(i.id),-1!==n)c+=d.childY[n];i=d}return c}outline(i){let n=this.getAbsoluteX(),c=this.getAbsoluteY();T.drawRect(n,c,this.width,this.height,i)}move(i,n){if(this.layer===this.id)return;this.x=0,this.y=0;let c=s.instances[this.layer];if(c.childId&&c.childX&&c.childY){let d=c.childId.indexOf(this.id);if(-1!==d)c.childX[d]=i,c.childY[d]=n}}delete(){if(this.layer===this.id)return;let i=s.instances[this.layer];if(i.childId&&i.childX&&i.childY){let n=i.childId.indexOf(this.id);if(-1!==n)i.childId.splice(n,1),i.childX.splice(n,1),i.childY.splice(n,1)}}}class o{static index=(i,n)=>104*i+n;startX;startZ;sizeX;sizeZ;flags;constructor(){this.startX=0,this.startZ=0,this.sizeX=104,this.sizeZ=104,this.flags=new Int32Array(this.sizeX*this.sizeZ),this.reset()}reset(){for(let i=0;i<this.sizeX;i++)for(let n=0;n<this.sizeZ;n++){let c=o.index(i,n);if(0===i||0===n||i===this.sizeX-1||n===this.sizeZ-1)this.flags[c]=16777215;else this.flags[c]=0}}addFloor(i,n){this.flags[o.index(i-this.startX,n-this.startZ)]|=2097152}removeFloor(i,n){this.flags[o.index(i-this.startX,n-this.startZ)]&=~2097152}addLoc(i,n,c,d,u,m){let v=256;if(m)v|=131072;let S=i-this.startX,b=n-this.startZ;if(1===u||3===u){let i=c;c=d,d=i}for(let i=S;i<S+c;i++){if(!(i>=0&&i<this.sizeX))continue;for(let n=b;n<b+d;n++){if(!(n>=0&&n<this.sizeZ))continue;this.add(i,n,v)}}}removeLoc(i,n,c,d,u,m){let v=256;if(m)v|=131072;let S=i-this.startX,b=n-this.startZ;if(1===u||3===u){let i=c;c=d,d=i}for(let i=S;i<S+c;i++){if(!(i>=0&&i<this.sizeX))continue;for(let n=b;n<b+d;n++){if(!(n>=0&&n<this.sizeZ))continue;this.remove(i,n,v)}}}addWall(i,n,c,d,u){let m=i-this.startX,v=n-this.startZ,S=u?65536:128,b=u?4096:8,x=u?1024:2,I=u?16384:32,A=u?512:1,k=u?8192:16,L=u?2048:4,O=u?32768:64;if(c===h.WALL_STRAIGHT.id){if(0===d)this.add(m,v,S),this.add(m-1,v,b);else if(1===d)this.add(m,v,x),this.add(m,v+1,I);else if(2===d)this.add(m,v,b),this.add(m+1,v,S);else if(3===d)this.add(m,v,I),this.add(m,v-1,x)}else if(c===h.WALL_DIAGONAL_CORNER.id||c===h.WALL_SQUARE_CORNER.id){if(0===d)this.add(m,v,A),this.add(m-1,v+1,k);else if(1===d)this.add(m,v,L),this.add(m+1,v+1,O);else if(2===d)this.add(m,v,k),this.add(m+1,v-1,A);else if(3===d)this.add(m,v,O),this.add(m-1,v-1,L)}else if(c===h.WALL_L.id)if(0===d)this.add(m,v,x|S),this.add(m-1,v,b),this.add(m,v+1,I);else if(1===d)this.add(m,v,x|b),this.add(m,v+1,I),this.add(m+1,v,S);else if(2===d)this.add(m,v,I|b),this.add(m+1,v,S),this.add(m,v-1,x);else if(3===d)this.add(m,v,I|S),this.add(m,v-1,x),this.add(m-1,v,b);if(u)this.addWall(i,n,c,d,!1)}removeWall(i,n,c,d,u){let m=i-this.startX,v=n-this.startZ,S=u?65536:128,b=u?4096:8,x=u?1024:2,I=u?16384:32,A=u?512:1,k=u?8192:16,L=u?2048:4,O=u?32768:64;if(c===h.WALL_STRAIGHT.id){if(0===d)this.remove(m,v,S),this.remove(m-1,v,b);else if(1===d)this.remove(m,v,x),this.remove(m,v+1,I);else if(2===d)this.remove(m,v,b),this.remove(m+1,v,S);else if(3===d)this.remove(m,v,I),this.remove(m,v-1,x)}else if(c===h.WALL_DIAGONAL_CORNER.id||c===h.WALL_SQUARE_CORNER.id){if(0===d)this.remove(m,v,A),this.remove(m-1,v+1,k);else if(1===d)this.remove(m,v,L),this.remove(m+1,v+1,O);else if(2===d)this.remove(m,v,k),this.remove(m+1,v-1,A);else if(3===d)this.remove(m,v,O),this.remove(m-1,v-1,L)}else if(c===h.WALL_L.id)if(0===d)this.remove(m,v,x|S),this.remove(m-1,v,b),this.remove(m,v+1,I);else if(1===d)this.remove(m,v,x|b),this.remove(m,v+1,I),this.remove(m+1,v,S);else if(2===d)this.remove(m,v,I|b),this.remove(m+1,v,S),this.remove(m,v-1,x);else if(3===d)this.remove(m,v,I|S),this.remove(m,v-1,x),this.remove(m-1,v,b);if(u)this.removeWall(i,n,c,d,!1)}reachedWall(i,n,c,d,u,m){if(i===c&&n===d)return!0;let v=i-this.startX,S=n-this.startZ,b=c-this.startX,x=d-this.startZ,I=o.index(v,S);if(u===h.WALL_STRAIGHT.id){if(0===m){if(v===b-1&&S===x)return!0;else if(v===b&&S===x+1&&!(2621728&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2621698&this.flags[I]))return!0}else if(1===m){if(v===b&&S===x+1)return!0;else if(v===b-1&&S===x&&!(2621704&this.flags[I]))return!0;else if(v===b+1&&S===x&&!(2621824&this.flags[I]))return!0}else if(2===m){if(v===b+1&&S===x)return!0;else if(v===b&&S===x+1&&!(2621728&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2621698&this.flags[I]))return!0}else if(3===m)if(v===b&&S===x-1)return!0;else if(v===b-1&&S===x&&!(2621704&this.flags[I]))return!0;else if(v===b+1&&S===x&&!(2621824&this.flags[I]))return!0}else if(u===h.WALL_L.id){if(0===m){if(v===b-1&&S===x)return!0;else if(v===b&&S===x+1)return!0;else if(v===b+1&&S===x&&!(2621824&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2621698&this.flags[I]))return!0}else if(1===m){if(v===b-1&&S===x&&!(2621704&this.flags[I]))return!0;else if(v===b&&S===x+1)return!0;else if(v===b+1&&S===x)return!0;else if(v===b&&S===x-1&&!(2621698&this.flags[I]))return!0}else if(2===m){if(v===b-1&&S===x&&!(2621704&this.flags[I]))return!0;else if(v===b&&S===x+1&&!(2621728&this.flags[I]))return!0;else if(v===b+1&&S===x)return!0;else if(v===b&&S===x-1)return!0}else if(3===m)if(v===b-1&&S===x)return!0;else if(v===b&&S===x+1&&!(2621728&this.flags[I]))return!0;else if(v===b+1&&S===x&&!(2621824&this.flags[I]))return!0;else if(v===b&&S===x-1)return!0}else if(u===h.WALL_DIAGONAL.id)if(v===b&&S===x+1&&!(32&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2&this.flags[I]))return!0;else if(v===b-1&&S===x&&!(8&this.flags[I]))return!0;else if(v===b+1&&S===x&&!(128&this.flags[I]))return!0;return!1}reachedWallDecoration(i,n,c,d,u,m){if(i===c&&n===d)return!0;let v=i-this.startX,S=n-this.startZ,b=c-this.startX,x=d-this.startZ,I=o.index(v,S);if(u===h.WALLDECOR_DIAGONAL_OFFSET.id||u===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(u===h.WALLDECOR_DIAGONAL_NOOFFSET.id)m=m+2&3;if(0===m){if(v===b+1&&S===x&&!(128&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2&this.flags[I]))return!0}else if(1===m){if(v===b-1&&S===x&&!(8&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2&this.flags[I]))return!0}else if(2===m){if(v===b-1&&S===x&&!(8&this.flags[I]))return!0;else if(v===b&&S===x+1&&!(32&this.flags[I]))return!0}else if(3===m)if(v===b+1&&S===x&&!(128&this.flags[I]))return!0;else if(v===b&&S===x+1&&!(32&this.flags[I]))return!0}else if(u===h.WALLDECOR_DIAGONAL_BOTH.id)if(v===b&&S===x+1&&!(32&this.flags[I]))return!0;else if(v===b&&S===x-1&&!(2&this.flags[I]))return!0;else if(v===b-1&&S===x&&!(8&this.flags[I]))return!0;else if(v===b+1&&S===x&&!(128&this.flags[I]))return!0;return!1}reachedLoc(i,n,c,d,u,m,v){let S=c+u-1,b=d+m-1,x=o.index(i-this.startX,n-this.startZ);if(i>=c&&i<=S&&n>=d&&n<=b)return!0;else if(i===c-1&&n>=d&&n<=b&&!(8&this.flags[x])&&!(8&v))return!0;else if(i===S+1&&n>=d&&n<=b&&!(128&this.flags[x])&&!(2&v))return!0;else if(n===d-1&&i>=c&&i<=S&&!(2&this.flags[x])&&!(4&v))return!0;else if(n===b+1&&i>=c&&i<=S&&!(32&this.flags[x])&&!(1&v))return!0;return!1}add(i,n,c){this.flags[o.index(i,n)]|=c}remove(i,n,c){this.flags[o.index(i,n)]&=16777215-c}}class E_{minTileX;maxTileX;minTileZ;maxTileZ;type;minX;maxX;minZ;maxZ;minY;maxY;mode=0;minDeltaX=0;maxDeltaX=0;minDeltaZ=0;maxDeltaZ=0;minDeltaY=0;maxDeltaY=0;constructor(i,n,c,d,u,m,v,S,b,x,I){this.minTileX=i,this.maxTileX=n,this.minTileZ=c,this.maxTileZ=d,this.type=u,this.minX=m,this.maxX=v,this.minZ=S,this.maxZ=b,this.minY=x,this.maxY=I}}class b_{y;x;z;model;typecode;info;constructor(i,n,c,d,u,m){this.y=i,this.x=n,this.z=c,this.model=d,this.typecode=u,this.info=m}}class G_{locLevel;y;x;z;model;entity;yaw;minSceneTileX;maxSceneTileX;minSceneTileZ;maxSceneTileZ;typecode;info;distance=0;cycle=0;constructor(i,n,c,d,u,m,v,S,b,x,I,A,k){this.locLevel=i,this.y=n,this.x=c,this.z=d,this.model=u,this.entity=m,this.yaw=v,this.minSceneTileX=S,this.maxSceneTileX=b,this.minSceneTileZ=x,this.maxSceneTileZ=I,this.typecode=A,this.info=k}}class N_{y;x;z;topObj;middleObj;bottomObj;typecode;offset;constructor(i,n,c,d,u,m,v,S){this.y=i,this.x=n,this.z=c,this.topObj=d,this.middleObj=u,this.bottomObj=m,this.typecode=v,this.offset=S}}class Z0 extends F0{groundLevel;x;z;occludeLevel;locs;locSpan;underlay=null;overlay=null;wall=null;wallDecoration=null;groundDecoration=null;objStack=null;bridge=null;locCount=0;locSpans=0;drawLevel=0;groundVisible=!1;update=!1;containsLocs=!1;checkLocSpans=0;blockLocSpans=0;inverseBlockLocSpans=0;backWallTypes=0;constructor(i,n,c){super(),this.occludeLevel=this.groundLevel=i,this.x=n,this.z=c,this.locs=new C(5,null),this.locSpan=new Int32Array(5)}}class y{static tmpScreenX=new Int32Array(6);static tmpScreenY=new Int32Array(6);static tmpViewspaceX=new Int32Array(6);static tmpViewspaceY=new Int32Array(6);static tmpViewspaceZ=new Int32Array(6);static SHAPE_POINTS=[Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,6),Int8Array.of(1,3,5,7,2,6),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,2,8),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,11,12),Int8Array.of(1,3,5,7,13,14)];static SHAPE_PATHS=[Int8Array.of(0,1,2,3,0,0,1,3),Int8Array.of(1,1,2,3,1,0,1,3),Int8Array.of(0,1,2,3,1,0,1,3),Int8Array.of(0,0,1,2,0,0,2,4,1,0,4,3),Int8Array.of(0,0,1,4,0,0,4,3,1,1,2,4),Int8Array.of(0,0,4,3,1,0,1,2,1,0,2,4),Int8Array.of(0,1,2,4,1,0,1,4,1,0,4,3),Int8Array.of(0,4,1,2,0,4,2,5,1,0,4,5,1,0,5,3),Int8Array.of(0,4,1,2,0,4,2,3,0,4,3,5,1,0,4,5),Int8Array.of(0,0,4,5,1,4,1,2,1,4,2,3,1,4,3,5),Int8Array.of(0,0,1,5,0,1,4,5,0,1,2,4,1,0,5,3,1,5,4,3,1,4,2,3),Int8Array.of(1,0,1,5,1,1,4,5,1,1,2,4,0,0,5,3,0,5,4,3,0,4,2,3),Int8Array.of(1,0,5,4,1,0,1,5,0,0,4,3,0,4,5,3,0,5,2,3,0,1,2,5)];static FULL_SQUARE=128;static HALF_SQUARE=this.FULL_SQUARE/2|0;static CORNER_SMALL=this.FULL_SQUARE/4|0;static CORNER_BIG=3*this.FULL_SQUARE/4|0;vertexX;vertexY;vertexZ;triangleColorA;triangleColorB;triangleColorC;triangleVertexA;triangleVertexB;triangleVertexC;triangleTextureIds;flat;shape;shapeAngle;backgroundRgb;foregroundRgb;constructor(i,n,c,d,u,m,v,S,b,x,I,A,k,L,O,X,M,Y,B){this.flat=!(M!==d||M!==L||M!==S),this.shape=n,this.shapeAngle=m,this.backgroundRgb=k,this.foregroundRgb=b;let F=y.SHAPE_POINTS[n],E=F.length;this.vertexX=new Int32Array(E),this.vertexY=new Int32Array(E),this.vertexZ=new Int32Array(E);let D=new Int32Array(E),R=new Int32Array(E),_=i*y.FULL_SQUARE,z=Y*y.FULL_SQUARE;for(let i=0;i<E;i++){let n=F[i];if(!(1&n)&&n<=8)n=(n-m-m-1&7)+1;if(n>8&&n<=12)n=(n-m-9&3)+9;if(n>12&&n<=16)n=(n-m-13&3)+13;let b,I,k,Y,E;if(1===n)b=_,I=z,k=M,Y=v,E=x;else if(2===n)b=_+y.HALF_SQUARE,I=z,k=M+d>>1,Y=v+B>>1,E=x+c>>1;else if(3===n)b=_+y.FULL_SQUARE,I=z,k=d,Y=B,E=c;else if(4===n)b=_+y.FULL_SQUARE,I=z+y.HALF_SQUARE,k=d+L>>1,Y=B+u>>1,E=c+O>>1;else if(5===n)b=_+y.FULL_SQUARE,I=z+y.FULL_SQUARE,k=L,Y=u,E=O;else if(6===n)b=_+y.HALF_SQUARE,I=z+y.FULL_SQUARE,k=L+S>>1,Y=u+X>>1,E=O+A>>1;else if(7===n)b=_,I=z+y.FULL_SQUARE,k=S,Y=X,E=A;else if(8===n)b=_,I=z+y.HALF_SQUARE,k=S+M>>1,Y=X+v>>1,E=A+x>>1;else if(9===n)b=_+y.HALF_SQUARE,I=z+y.CORNER_SMALL,k=M+d>>1,Y=v+B>>1,E=x+c>>1;else if(10===n)b=_+y.CORNER_BIG,I=z+y.HALF_SQUARE,k=d+L>>1,Y=B+u>>1,E=c+O>>1;else if(11===n)b=_+y.HALF_SQUARE,I=z+y.CORNER_BIG,k=L+S>>1,Y=u+X>>1,E=O+A>>1;else if(12===n)b=_+y.CORNER_SMALL,I=z+y.HALF_SQUARE,k=S+M>>1,Y=X+v>>1,E=A+x>>1;else if(13===n)b=_+y.CORNER_SMALL,I=z+y.CORNER_SMALL,k=M,Y=v,E=x;else if(14===n)b=_+y.CORNER_BIG,I=z+y.CORNER_SMALL,k=d,Y=B,E=c;else if(15===n)b=_+y.CORNER_BIG,I=z+y.CORNER_BIG,k=L,Y=u,E=O;else b=_+y.CORNER_SMALL,I=z+y.CORNER_BIG,k=S,Y=X,E=A;this.vertexX[i]=b,this.vertexY[i]=k,this.vertexZ[i]=I,D[i]=Y,R[i]=E}let Z=y.SHAPE_PATHS[n],q=Z.length/4|0;if(this.triangleVertexA=new Int32Array(q),this.triangleVertexB=new Int32Array(q),this.triangleVertexC=new Int32Array(q),this.triangleColorA=new Int32Array(q),this.triangleColorB=new Int32Array(q),this.triangleColorC=new Int32Array(q),-1!==I)this.triangleTextureIds=new Int32Array(q);else this.triangleTextureIds=null;let N=0;for(let i=0;i<q;i++){let n=Z[N],c=Z[N+1],d=Z[N+2],u=Z[N+3];if(N+=4,c<4)c=c-m&3;if(d<4)d=d-m&3;if(u<4)u=u-m&3;if(this.triangleVertexA[i]=c,this.triangleVertexB[i]=d,this.triangleVertexC[i]=u,0===n){if(this.triangleColorA[i]=D[c],this.triangleColorB[i]=D[d],this.triangleColorC[i]=D[u],this.triangleTextureIds)this.triangleTextureIds[i]=-1}else if(this.triangleColorA[i]=R[c],this.triangleColorB[i]=R[d],this.triangleColorC[i]=R[u],this.triangleTextureIds)this.triangleTextureIds[i]=I}}}class r0{southwestColor;southeastColor;northeastColor;northwestColor;textureId;colour;flat;constructor(i,n,c,d,u,m,v){this.southwestColor=i,this.southeastColor=n,this.northeastColor=c,this.northwestColor=d,this.textureId=u,this.colour=m,this.flat=v}}class L_{y;x;z;typeA;typeB;modelA;modelB;typecode;info;constructor(i,n,c,d,u,m,v,S,b){this.y=i,this.x=n,this.z=c,this.typeA=d,this.typeB=u,this.modelA=m,this.modelB=v,this.typecode=S,this.info=b}}class H_{y;x;z;decorType;decorAngle;model;typecode;info;constructor(i,n,c,d,u,m,v,S){this.y=i,this.x=n,this.z=c,this.decorType=d,this.decorAngle=u,this.model=m,this.typecode=v,this.info=S}}class V{static visibilityMatrix=new d0(8,32,51,51,!1);static locBuffer=new C(100,null);static levelOccluderCount=new Int32Array(4);static levelOccluders=new u_(4,500,null);static activeOccluders=new C(500,null);static drawTileQueue=new m0;static cycle=0;static viewportLeft=0;static viewportTop=0;static viewportRight=0;static viewportBottom=0;static viewportCenterX=0;static viewportCenterY=0;static sinEyePitch=0;static cosEyePitch=0;static sinEyeYaw=0;static cosEyeYaw=0;static eyeX=0;static eyeY=0;static eyeZ=0;static eyeTileX=0;static eyeTileZ=0;static minDrawTileX=0;static maxDrawTileX=0;static minDrawTileZ=0;static maxDrawTileZ=0;static topLevel=0;static tilesRemaining=0;static takingInput=!1;static visibilityMap=null;static FRONT_WALL_TYPES=Uint8Array.of(19,55,38,155,255,110,137,205,76);static DIRECTION_ALLOW_WALL_CORNER_TYPE=Uint8Array.of(160,192,80,96,0,144,80,48,160);static BACK_WALL_TYPES=Uint8Array.of(76,8,137,4,0,1,38,2,19);static WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS=Int8Array.of(0,0,2,0,0,2,1,1,0);static WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS=Int8Array.of(2,0,0,2,0,0,0,4,4);static WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS=Int8Array.of(0,4,4,8,0,0,8,0,0);static WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS=Int8Array.of(1,1,0,0,0,8,0,0,8);static WALL_DECORATION_INSET_X=Int8Array.of(53,-53,-53,53);static WALL_DECORATION_INSET_Z=Int8Array.of(-53,-53,53,53);static WALL_DECORATION_OUTSET_X=Int8Array.of(-45,45,45,-45);static WALL_DECORATION_OUTSET_Z=Int8Array.of(45,45,-45,-45);static MINIMAP_TILE_MASK=[new Int8Array(16),Int8Array.of(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,0,0,0,1,1,0,0,1,1,1,0,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,1,1,0,0,1,1,0,0,0,1,0,0,0,1),Int8Array.of(0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1),Int8Array.of(1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1),Int8Array.of(1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0),Int8Array.of(0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0),Int8Array.of(1,1,1,1,1,1,1,1,0,1,1,1,0,0,1,1),Int8Array.of(1,1,1,1,1,1,0,0,1,0,0,0,1,0,0,0),Int8Array.of(0,0,0,0,0,0,1,1,0,1,1,1,0,1,1,1),Int8Array.of(0,0,0,0,0,0,0,0,0,1,1,0,1,1,1,1)];static MINIMAP_TILE_ROTATION_MAP=[Int8Array.of(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15),Int8Array.of(12,8,4,0,13,9,5,1,14,10,6,2,15,11,7,3),Int8Array.of(15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0),Int8Array.of(3,7,11,15,2,6,10,14,1,5,9,13,0,4,8,12)];static TEXTURE_HSL=Int32Array.of(41,39248,41,4643,41,41,41,41,41,41,41,41,41,41,41,43086,41,41,41,41,41,41,41,8602,41,28992,41,41,41,41,41,5056,41,41,41,41,41,41,41,41,41,41,41,41,41,41,3131,41,41,41);static activeOccluderCount=0;static mouseX=0;static mouseY=0;static clickTileX=-1;static clickTileZ=-1;static lowMemory=!0;static init(i,n,c,d,u){this.viewportLeft=0,this.viewportTop=0,this.viewportRight=i,this.viewportBottom=n,this.viewportCenterX=i/2|0,this.viewportCenterY=n/2|0;let m=new d0(9,32,53,53,!1);for(let i=128;i<=384;i+=32)for(let n=0;n<2048;n+=64){this.sinEyePitch=w.sin[i],this.cosEyePitch=w.cos[i],this.sinEyeYaw=w.sin[n],this.cosEyeYaw=w.cos[n];let v=(i-128)/32|0,S=n/64|0;for(let i=-26;i<=26;i++)for(let n=-26;n<=26;n++){let b=128*i,x=128*n,I=!1;for(let i=-c;i<=d;i+=128)if(this.testPoint(b,x,u[v]+i)){I=!0;break}m[v][S][i+25+1][n+25+1]=I}}for(let i=0;i<8;i++)for(let n=0;n<32;n++)for(let c=-25;c<25;c++)for(let d=-25;d<25;d++){let u=!1;e:for(let v=-1;v<=1;v++)for(let S=-1;S<=1;S++){if(m[i][n][c+v+25+1][d+S+25+1]){u=!0;break e}if(m[i][(n+1)%31][c+v+25+1][d+S+25+1]){u=!0;break e}if(m[i+1][n][c+v+25+1][d+S+25+1]){u=!0;break e}if(m[i+1][(n+1)%31][c+v+25+1][d+S+25+1]){u=!0;break e}}this.visibilityMatrix[i][n][c+25][d+25]=u}}static addOccluder(i,n,c,d,u,m,v,S){V.levelOccluders[i][V.levelOccluderCount[i]++]=new E_(c/128|0,m/128|0,u/128|0,S/128|0,n,c,m,u,S,d,v)}static testPoint(i,n,c){let d=n*this.sinEyeYaw+i*this.cosEyeYaw>>16,u=n*this.cosEyeYaw-i*this.sinEyeYaw>>16,m=c*this.sinEyePitch+u*this.cosEyePitch>>16,v=c*this.cosEyePitch-u*this.sinEyePitch>>16;if(m<50||m>3500)return!1;let S=this.viewportCenterX+((d<<9)/m|0),b=this.viewportCenterY+((v<<9)/m|0);return S>=this.viewportLeft&&S<=this.viewportRight&&b>=this.viewportTop&&b<=this.viewportBottom}maxLevel;maxTileX;maxTileZ;levelHeightmaps;levelTiles;temporaryLocs;levelTileOcclusionCycles;mergeIndexA;mergeIndexB;temporaryLocCount=0;minLevel=0;tmpMergeIndex=0;constructor(i,n,c,d){this.maxLevel=c,this.maxTileX=d,this.maxTileZ=n,this.levelTiles=new p0(c,d,n,null),this.levelTileOcclusionCycles=new g0(c,d+1,n+1),this.levelHeightmaps=i,this.temporaryLocs=new C(5e3,null),this.mergeIndexA=new Int32Array(1e4),this.mergeIndexB=new Int32Array(1e4),this.reset()}reset(){for(let i=0;i<this.maxLevel;i++)for(let n=0;n<this.maxTileX;n++)for(let c=0;c<this.maxTileZ;c++)this.levelTiles[i][n][c]=null;for(let i=0;i<4;i++){for(let n=0;n<V.levelOccluderCount[i];n++)V.levelOccluders[i][n]=null;V.levelOccluderCount[i]=0}for(let i=0;i<this.temporaryLocCount;i++)this.temporaryLocs[i]=null;this.temporaryLocCount=0,V.locBuffer.fill(null)}setMinLevel(i){this.minLevel=i;for(let n=0;n<this.maxTileX;n++)for(let c=0;c<this.maxTileZ;c++)this.levelTiles[i][n][c]=new Z0(i,n,c)}setBridge(i,n){let c=this.levelTiles[0][i][n];for(let c=0;c<3;c++){this.levelTiles[c][i][n]=this.levelTiles[c+1][i][n];let d=this.levelTiles[c][i][n];if(d)d.groundLevel--}if(!this.levelTiles[0][i][n])this.levelTiles[0][i][n]=new Z0(0,i,n);let d=this.levelTiles[0][i][n];if(d)d.bridge=c;this.levelTiles[3][i][n]=null}setDrawLevel(i,n,c,d){let u=this.levelTiles[i][n][c];if(!u)return;u.drawLevel=d}setTile(i,n,c,d,u,m,v,S,b,x,I,A,k,L,O,X,M,Y,B,F){if(0===d){for(let d=i;d>=0;d--)if(!this.levelTiles[d][n][c])this.levelTiles[d][n][c]=new Z0(d,n,c);let d=this.levelTiles[i][n][c];if(d)d.underlay=new r0(I,A,k,L,-1,B,!1)}else if(1===d){for(let d=i;d>=0;d--)if(!this.levelTiles[d][n][c])this.levelTiles[d][n][c]=new Z0(d,n,c);let d=this.levelTiles[i][n][c];if(d)d.underlay=new r0(O,X,M,Y,m,F,v===S&&v===b&&v===x)}else{for(let d=i;d>=0;d--)if(!this.levelTiles[d][n][c])this.levelTiles[d][n][c]=new Z0(d,n,c);let E=this.levelTiles[i][n][c];if(E)E.overlay=new y(n,d,X,S,k,u,I,x,F,O,m,Y,B,b,M,L,v,c,A)}}addGroundDecoration(i,n,c,d,u,m,v){if(!this.levelTiles[n][c][d])this.levelTiles[n][c][d]=new Z0(n,c,d);let S=this.levelTiles[n][c][d];if(S)S.groundDecoration=new b_(u,128*c+64,128*d+64,i,m,v)}removeGroundDecoration(i,n,c){let d=this.levelTiles[i][n][c];if(!d)return;d.groundDecoration=null}addObjStack(i,n,c,d,u,m,v,S){let b=0,x=this.levelTiles[d][i][n];if(x)for(let i=0;i<x.locCount;i++){let n=x.locs[i];if(!n||!n.model)continue;let c=n.model.objRaise;if(c>b)b=c}else this.levelTiles[d][i][n]=new Z0(d,i,n);let I=this.levelTiles[d][i][n];if(I)I.objStack=new N_(c,128*i+64,128*n+64,m,v,S,u,b)}removeObjStack(i,n,c){let d=this.levelTiles[i][n][c];if(!d)return;d.objStack=null}addWall(i,n,c,d,u,m,v,S,b,x){if(!v&&!S)return;for(let d=i;d>=0;d--)if(!this.levelTiles[d][n][c])this.levelTiles[d][n][c]=new Z0(d,n,c);let I=this.levelTiles[i][n][c];if(I)I.wall=new L_(d,128*n+64,128*c+64,u,m,v,S,b,x)}removeWall(i,n,c,d){let u=this.levelTiles[i][n][c];if(1===d&&u)u.wall=null}setWallDecoration(i,n,c,d,u,m,v,S,b,x,I){if(!S)return;for(let d=i;d>=0;d--)if(!this.levelTiles[d][n][c])this.levelTiles[d][n][c]=new Z0(d,n,c);let A=this.levelTiles[i][n][c];if(A)A.wallDecoration=new H_(d,128*n+u+64,128*c+m+64,I,x,S,v,b)}removeWallDecoration(i,n,c){let d=this.levelTiles[i][n][c];if(!d)return;d.wallDecoration=null}setWallDecorationOffset(i,n,c,d){let u=this.levelTiles[i][n][c];if(!u)return;let m=u.wallDecoration;if(!m)return;let v=128*n+64,S=128*c+64;m.x=v+((m.x-v)*d/16|0),m.z=S+((m.z-S)*d/16|0)}setWallDecorationModel(i,n,c,d){if(!d)return;let u=this.levelTiles[i][n][c];if(!u)return;let m=u.wallDecoration;if(!m)return;m.model=d}setGroundDecorationModel(i,n,c,d){if(!d)return;let u=this.levelTiles[i][n][c];if(!u)return;let m=u.groundDecoration;if(!m)return;m.model=d}setWallModel(i,n,c,d){if(!d)return;let u=this.levelTiles[i][n][c];if(!u)return;let m=u.wall;if(!m)return;m.modelA=d}setWallModels(i,n,c,d,u){if(!d)return;let m=this.levelTiles[c][i][n];if(!m)return;let v=m.wall;if(!v)return;v.modelA=d,v.modelB=u}addLoc(i,n,c,d,u,m,v,S,b,x,I){if(!u&&!m)return!0;let A=128*n+64*b,k=128*c+64*x;return this.addLoc2(A,k,d,i,n,c,b,x,u,m,v,S,I,!1)}addTemporary(i,n,c,d,u,m,v,S,b,x){if(!u&&!m)return!0;let I=n-b,A=d-b,k=n+b,L=d+b;if(x){if(S>640&&S<1408)L+=128;if(S>1152&&S<1920)k+=128;if(S>1664||S<384)A-=128;if(S>128&&S<896)I-=128}return I=I/128|0,A=A/128|0,k=k/128|0,L=L/128|0,this.addLoc2(n,d,c,i,I,A,k+1-I,L-A+1,u,m,v,0,S,!0)}addTemporary2(i,n,c,d,u,m,v,S,b,x,I,A){return!b&&!x||this.addLoc2(n,d,c,i,u,m,v+1-u,S-m+1,b,x,I,0,A,!0)}removeLoc(i,n,c){let d=this.levelTiles[i][n][c];if(!d)return;for(let i=0;i<d.locCount;i++){let u=d.locs[i];if(u&&2==(u.typecode>>29&3)&&u.minSceneTileX===n&&u.minSceneTileZ===c)return void this.removeLoc2(u)}}setLocModel(i,n,c,d){if(!d)return;let u=this.levelTiles[i][n][c];if(!u)return;for(let i=0;i<u.locCount;i++){let n=u.locs[i];if(n&&2==(n.typecode>>29&3))return void(n.model=d)}}clearTemporaryLocs(){for(let i=0;i<this.temporaryLocCount;i++){let n=this.temporaryLocs[i];if(n)this.removeLoc2(n);this.temporaryLocs[i]=null}this.temporaryLocCount=0}getWallTypecode(i,n,c){let d=this.levelTiles[i][n][c];return!d||!d.wall?0:d.wall.typecode}getDecorTypecode(i,n,c){let d=this.levelTiles[i][c][n];return!d||!d.wallDecoration?0:d.wallDecoration.typecode}getLocTypecode(i,n,c){let d=this.levelTiles[i][n][c];if(!d)return 0;for(let i=0;i<d.locCount;i++){let u=d.locs[i];if(u&&2==(u.typecode>>29&3)&&u.minSceneTileX===n&&u.minSceneTileZ===c)return u.typecode}return 0}getGroundDecorTypecode(i,n,c){let d=this.levelTiles[i][n][c];return!d||!d.groundDecoration?0:d.groundDecoration.typecode}getInfo(i,n,c,d){let u=this.levelTiles[i][n][c];if(!u)return-1;else if(u.wall&&u.wall.typecode===d)return 255&u.wall.info;else if(u.wallDecoration&&u.wallDecoration.typecode===d)return 255&u.wallDecoration.info;else if(u.groundDecoration&&u.groundDecoration.typecode===d)return 255&u.groundDecoration.info;else{for(let i=0;i<u.locCount;i++){let n=u.locs[i];if(n&&n.typecode===d)return 255&n.info}return-1}}buildModels(i,n,c,d,u){let m,v=n*(0|Math.sqrt(c*c+d*d+u*u))>>8;for(let n=0;n<this.maxLevel;n++)for(let m=0;m<this.maxTileX;m++)for(let S=0;S<this.maxTileZ;S++){let b=this.levelTiles[n][m][S];if(!b)continue;let x=b.wall;if(x&&x.modelA&&x.modelA.vertexNormal){if(this.mergeLocNormals(n,m,S,1,1,x.modelA),x.modelB&&x.modelB.vertexNormal)this.mergeLocNormals(n,m,S,1,1,x.modelB),this.mergeNormals(x.modelA,x.modelB,0,0,0,!1),x.modelB.applyLighting(i,v,c,d,u);x.modelA.applyLighting(i,v,c,d,u)}for(let x=0;x<b.locCount;x++){let I=b.locs[x];if(I&&I.model&&I.model.vertexNormal)this.mergeLocNormals(n,m,S,I.maxSceneTileX+1-I.minSceneTileX,I.maxSceneTileZ-I.minSceneTileZ+1,I.model),I.model.applyLighting(i,v,c,d,u)}let I=b.groundDecoration;if(I&&I.model&&I.model.vertexNormal)this.mergeGroundDecorationNormals(n,m,S,I.model),I.model.applyLighting(i,v,c,d,u)}}mergeGroundDecorationNormals(i,n,c,d){if(n<this.maxTileX){let u=this.levelTiles[i][n+1][c];if(u&&u.groundDecoration&&u.groundDecoration.model&&u.groundDecoration.model.vertexNormal)this.mergeNormals(d,u.groundDecoration.model,128,0,0,!0)}if(c<this.maxTileX){let u=this.levelTiles[i][n][c+1];if(u&&u.groundDecoration&&u.groundDecoration.model&&u.groundDecoration.model.vertexNormal)this.mergeNormals(d,u.groundDecoration.model,0,0,128,!0)}if(n<this.maxTileX&&c<this.maxTileZ){let u=this.levelTiles[i][n+1][c+1];if(u&&u.groundDecoration&&u.groundDecoration.model&&u.groundDecoration.model.vertexNormal)this.mergeNormals(d,u.groundDecoration.model,128,0,128,!0)}if(n<this.maxTileX&&c>0){let u=this.levelTiles[i][n+1][c-1];if(u&&u.groundDecoration&&u.groundDecoration.model&&u.groundDecoration.model.vertexNormal)this.mergeNormals(d,u.groundDecoration.model,128,0,-128,!0)}}mergeLocNormals(i,n,c,d,u,m){let v=!0,S=n,b=n+d,x=c-1,I=c+u;for(let A=i;A<=i+1;A++){if(A===this.maxLevel)continue;for(let k=S;k<=b;k++){if(k<0||k>=this.maxTileX)continue;for(let S=x;S<=I;S++){if(S<0||S>=this.maxTileZ||v&&k<b&&S<I&&(S>=c||k===n))continue;let x=this.levelTiles[A][k][S];if(!x)continue;let L=128*(k-n)+64*(1-d),O=128*(S-c)+64*(1-u),X=((this.levelHeightmaps[A][k][S]+this.levelHeightmaps[A][k+1][S]+this.levelHeightmaps[A][k][S+1]+this.levelHeightmaps[A][k+1][S+1])/4|0)-((this.levelHeightmaps[i][n][c]+this.levelHeightmaps[i][n+1][c]+this.levelHeightmaps[i][n][c+1]+this.levelHeightmaps[i][n+1][c+1])/4|0),M=x.wall;if(M&&M.modelA&&M.modelA.vertexNormal)this.mergeNormals(m,M.modelA,L,X,O,v);if(M&&M.modelB&&M.modelB.vertexNormal)this.mergeNormals(m,M.modelB,L,X,O,v);for(let i=0;i<x.locCount;i++){let S=x.locs[i];if(!S||!S.model||!S.model.vertexNormal)continue;let b=S.maxSceneTileX+1-S.minSceneTileX,I=S.maxSceneTileZ+1-S.minSceneTileZ;this.mergeNormals(m,S.model,128*(S.minSceneTileX-n)+64*(b-d),X,128*(S.minSceneTileZ-c)+64*(I-u),v)}}}S--,v=!1}}mergeNormals(i,n,c,d,u,m){this.tmpMergeIndex++;let v=0,S=n.vertexX,b=n.vertexCount;if(i.vertexNormal&&i.vertexNormalOriginal)for(let m=0;m<i.vertexCount;m++){let x=i.vertexNormal[m],I=i.vertexNormalOriginal[m];if(I&&0!==I.w){let A=i.vertexY[m]-d;if(A>n.minY)continue;let k=i.vertexX[m]-c;if(k<n.minX||k>n.maxX)continue;let L=i.vertexZ[m]-u;if(L<n.minZ||L>n.maxZ)continue;if(n.vertexNormal&&n.vertexNormalOriginal)for(let i=0;i<b;i++){let c=n.vertexNormal[i],d=n.vertexNormalOriginal[i];if(k!==S[i]||L!==n.vertexZ[i]||A!==n.vertexY[i]||d&&0===d.w)continue;if(x&&c&&d)x.x+=d.x,x.y+=d.y,x.z+=d.z,x.w+=d.w,c.x+=I.x,c.y+=I.y,c.z+=I.z,c.w+=I.w,v++;this.mergeIndexA[m]=this.tmpMergeIndex,this.mergeIndexB[i]=this.tmpMergeIndex}}}if(v<3||!m)return;if(i.faceInfo)for(let n=0;n<i.faceCount;n++)if(this.mergeIndexA[i.faceVertexA[n]]===this.tmpMergeIndex&&this.mergeIndexA[i.faceVertexB[n]]===this.tmpMergeIndex&&this.mergeIndexA[i.faceVertexC[n]]===this.tmpMergeIndex)i.faceInfo[n]=-1;if(n.faceInfo)for(let i=0;i<n.faceCount;i++)if(this.mergeIndexB[n.faceVertexA[i]]===this.tmpMergeIndex&&this.mergeIndexB[n.faceVertexB[i]]===this.tmpMergeIndex&&this.mergeIndexB[n.faceVertexC[i]]===this.tmpMergeIndex)n.faceInfo[i]=-1}drawMinimapTile(i,n,c,d,u,m){let v=this.levelTiles[i][n][c];if(!v)return;let S=v.underlay;if(S){let i=S.colour;if(0!==i)for(let n=0;n<4;n++)d[u]=i,d[u+1]=i,d[u+2]=i,d[u+3]=i,u+=m;return}let b=v.overlay;if(!b)return;let{shape:x,shapeAngle:I,backgroundRgb:A,foregroundRgb:k}=b,L=V.MINIMAP_TILE_MASK[x],O=V.MINIMAP_TILE_ROTATION_MAP[I],X=0;if(0!==A){for(let i=0;i<4;i++)d[u]=0===L[O[X++]]?A:k,d[u+1]=0===L[O[X++]]?A:k,d[u+2]=0===L[O[X++]]?A:k,d[u+3]=0===L[O[X++]]?A:k,u+=m;return}for(let i=0;i<4;i++){if(0!==L[O[X++]])d[u]=k;if(0!==L[O[X++]])d[u+1]=k;if(0!==L[O[X++]])d[u+2]=k;if(0!==L[O[X++]])d[u+3]=k;u+=m}}click(i,n){V.takingInput=!0,V.mouseX=i,V.mouseY=n,V.clickTileX=-1,V.clickTileZ=-1}draw(i,n,c,d,u,m,v){if(i<0)i=0;else if(i>=128*this.maxTileX)i=128*this.maxTileX-1;if(c<0)c=0;else if(c>=128*this.maxTileZ)c=128*this.maxTileZ-1;if(V.cycle++,V.sinEyePitch=w.sin[m],V.cosEyePitch=w.cos[m],V.sinEyeYaw=w.sin[u],V.cosEyeYaw=w.cos[u],V.visibilityMap=V.visibilityMatrix[(m-128)/32|0][u/64|0],V.eyeX=i,V.eyeY=n,V.eyeZ=c,V.eyeTileX=i/128|0,V.eyeTileZ=c/128|0,V.topLevel=d,V.minDrawTileX=V.eyeTileX-25,V.minDrawTileX<0)V.minDrawTileX=0;if(V.minDrawTileZ=V.eyeTileZ-25,V.minDrawTileZ<0)V.minDrawTileZ=0;if(V.maxDrawTileX=V.eyeTileX+25,V.maxDrawTileX>this.maxTileX)V.maxDrawTileX=this.maxTileX;if(V.maxDrawTileZ=V.eyeTileZ+25,V.maxDrawTileZ>this.maxTileZ)V.maxDrawTileZ=this.maxTileZ;this.updateActiveOccluders(),V.tilesRemaining=0;for(let i=this.minLevel;i<this.maxLevel;i++){let c=this.levelTiles[i];for(let u=V.minDrawTileX;u<V.maxDrawTileX;u++)for(let m=V.minDrawTileZ;m<V.maxDrawTileZ;m++){let v=c[u][m];if(!v)continue;if(v.drawLevel<=d&&(V.visibilityMap[u+25-V.eyeTileX][m+25-V.eyeTileZ]||this.levelHeightmaps[i][u][m]-n>=2e3))v.groundVisible=!0,v.update=!0,v.containsLocs=v.locCount>0,V.tilesRemaining++;else v.groundVisible=!1,v.update=!1,v.checkLocSpans=0}}for(let i=this.minLevel;i<this.maxLevel;i++){let n=this.levelTiles[i];for(let i=-25;i<=0;i++){let c=V.eyeTileX+i,d=V.eyeTileX-i;if(c<V.minDrawTileX&&d>=V.maxDrawTileX)continue;for(let i=-25;i<=0;i++){let u=V.eyeTileZ+i,m=V.eyeTileZ-i,S;if(c>=V.minDrawTileX){if(u>=V.minDrawTileZ)if(S=n[c][u],S&&S.groundVisible)this.drawTile(S,!0,v);if(m<V.maxDrawTileZ)if(S=n[c][m],S&&S.groundVisible)this.drawTile(S,!0,v)}if(d<V.maxDrawTileX){if(u>=V.minDrawTileZ)if(S=n[d][u],S&&S.groundVisible)this.drawTile(S,!0,v);if(m<V.maxDrawTileZ)if(S=n[d][m],S&&S.groundVisible)this.drawTile(S,!0,v)}if(0===V.tilesRemaining)return void(V.takingInput=!1)}}}for(let i=this.minLevel;i<this.maxLevel;i++){let n=this.levelTiles[i];for(let i=-25;i<=0;i++){let c=V.eyeTileX+i,d=V.eyeTileX-i;if(c<V.minDrawTileX&&d>=V.maxDrawTileX)continue;for(let i=-25;i<=0;i++){let u=V.eyeTileZ+i,m=V.eyeTileZ-i,S;if(c>=V.minDrawTileX){if(u>=V.minDrawTileZ)if(S=n[c][u],S&&S.groundVisible)this.drawTile(S,!1,v);if(m<V.maxDrawTileZ)if(S=n[c][m],S&&S.groundVisible)this.drawTile(S,!1,v)}if(d<V.maxDrawTileX){if(u>=V.minDrawTileZ)if(S=n[d][u],S&&S.groundVisible)this.drawTile(S,!1,v);if(m<V.maxDrawTileZ)if(S=n[d][m],S&&S.groundVisible)this.drawTile(S,!1,v)}if(0===V.tilesRemaining)return void(V.takingInput=!1)}}}}addLoc2(i,n,c,d,u,m,v,S,b,x,I,A,k,L){if(!b&&!x)return!1;for(let i=u;i<u+v;i++)for(let n=m;n<m+S;n++){if(i<0||n<0||i>=this.maxTileX||n>=this.maxTileZ)return!1;let c=this.levelTiles[d][i][n];if(c&&c.locCount>=5)return!1}let O=new G_(d,c,i,n,b,x,k,u,u+v-1,m,m+S-1,I,A);for(let i=u;i<u+v;i++)for(let n=m;n<m+S;n++){let c=0;if(i>u)c|=1;if(i<u+v-1)c+=4;if(n>m)c+=8;if(n<m+S-1)c+=2;for(let c=d;c>=0;c--)if(!this.levelTiles[c][i][n])this.levelTiles[c][i][n]=new Z0(c,i,n);let b=this.levelTiles[d][i][n];if(b)b.locs[b.locCount]=O,b.locSpan[b.locCount]=c,b.locSpans|=c,b.locCount++}if(L)this.temporaryLocs[this.temporaryLocCount++]=O;return!0}removeLoc2(i){for(let n=i.minSceneTileX;n<=i.maxSceneTileX;n++)for(let c=i.minSceneTileZ;c<=i.maxSceneTileZ;c++){let d=this.levelTiles[i.locLevel][n][c];if(!d)continue;for(let n=0;n<d.locCount;n++)if(d.locs[n]===i){d.locCount--;for(let i=n;i<d.locCount;i++)d.locs[i]=d.locs[i+1],d.locSpan[i]=d.locSpan[i+1];d.locs[d.locCount]=null;break}d.locSpans=0;for(let i=0;i<d.locCount;i++)d.locSpans|=d.locSpan[i]}}updateActiveOccluders(){let i=V.levelOccluderCount[V.topLevel],n=V.levelOccluders[V.topLevel];V.activeOccluderCount=0;for(let c=0;c<i;c++){let i=n[c];if(!i)continue;let d,u,m,v;if(1===i.type){if(d=i.minTileX+25-V.eyeTileX,d>=0&&d<=50){if(u=i.minTileZ+25-V.eyeTileZ,u<0)u=0;if(m=i.maxTileZ+25-V.eyeTileZ,m>50)m=50;let n=!1;while(u<=m)if(V.visibilityMap&&V.visibilityMap[d][u++]){n=!0;break}if(n){if(v=V.eyeX-i.minX,v>32)i.mode=1;else{if(v>=-32)continue;i.mode=2,v=-v}i.minDeltaZ=(i.minZ-V.eyeZ<<8)/v|0,i.maxDeltaZ=(i.maxZ-V.eyeZ<<8)/v|0,i.minDeltaY=(i.minY-V.eyeY<<8)/v|0,i.maxDeltaY=(i.maxY-V.eyeY<<8)/v|0,V.activeOccluders[V.activeOccluderCount++]=i}}}else if(2===i.type){if(d=i.minTileZ+25-V.eyeTileZ,d>=0&&d<=50){if(u=i.minTileX+25-V.eyeTileX,u<0)u=0;if(m=i.maxTileX+25-V.eyeTileX,m>50)m=50;let n=!1;while(u<=m)if(V.visibilityMap&&V.visibilityMap[u++][d]){n=!0;break}if(n){if(v=V.eyeZ-i.minZ,v>32)i.mode=3;else{if(v>=-32)continue;i.mode=4,v=-v}i.minDeltaX=(i.minX-V.eyeX<<8)/v|0,i.maxDeltaX=(i.maxX-V.eyeX<<8)/v|0,i.minDeltaY=(i.minY-V.eyeY<<8)/v|0,i.maxDeltaY=(i.maxY-V.eyeY<<8)/v|0,V.activeOccluders[V.activeOccluderCount++]=i}}}else if(4===i.type)if(d=i.minY-V.eyeY,d>128){if(u=i.minTileZ+25-V.eyeTileZ,u<0)u=0;if(m=i.maxTileZ+25-V.eyeTileZ,m>50)m=50;if(u<=m){let n=i.minTileX+25-V.eyeTileX;if(n<0)n=0;if(v=i.maxTileX+25-V.eyeTileX,v>50)v=50;let c=!1;e:for(let i=n;i<=v;i++)for(let n=u;n<=m;n++)if(V.visibilityMap&&V.visibilityMap[i][n]){c=!0;break e}if(c)i.mode=5,i.minDeltaX=(i.minX-V.eyeX<<8)/d|0,i.maxDeltaX=(i.maxX-V.eyeX<<8)/d|0,i.minDeltaZ=(i.minZ-V.eyeZ<<8)/d|0,i.maxDeltaZ=(i.maxZ-V.eyeZ<<8)/d|0,V.activeOccluders[V.activeOccluderCount++]=i}}}}drawTile(i,n,c){V.drawTileQueue.addTail(i);while(!0){let i;do{if(i=V.drawTileQueue.removeHead(),!i)return}while(!i.update);let{x:d,z:u,groundLevel:m,occludeLevel:v}=i,S=this.levelTiles[m];if(i.groundVisible){if(n){if(m>0){let i=this.levelTiles[m-1][d][u];if(i&&i.update)continue}if(d<=V.eyeTileX&&d>V.minDrawTileX){let n=S[d-1][u];if(n&&n.update&&(n.groundVisible||!(1&i.locSpans)))continue}if(d>=V.eyeTileX&&d<V.maxDrawTileX-1){let n=S[d+1][u];if(n&&n.update&&(n.groundVisible||!(4&i.locSpans)))continue}if(u<=V.eyeTileZ&&u>V.minDrawTileZ){let n=S[d][u-1];if(n&&n.update&&(n.groundVisible||!(8&i.locSpans)))continue}if(u>=V.eyeTileZ&&u<V.maxDrawTileZ-1){let n=S[d][u+1];if(n&&n.update&&(n.groundVisible||!(2&i.locSpans)))continue}}else n=!0;if(i.groundVisible=!1,i.bridge){let n=i.bridge;if(!n.underlay){if(n.overlay&&!this.tileVisible(0,d,u))this.drawTileOverlay(d,u,n.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(0,d,u))this.drawTileUnderlay(n.underlay,0,d,u,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let m=n.wall;if(m)m.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m.x-V.eyeX,m.y-V.eyeY,m.z-V.eyeZ,m.typecode);for(let i=0;i<n.locCount;i++){let d=n.locs[i];if(d){let i=d.model;if(!i)i=d.entity?.draw(c)??null;i?.draw(d.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,d.x-V.eyeX,d.y-V.eyeY,d.z-V.eyeZ,d.typecode)}}}let b=!1;if(!i.underlay){if(i.overlay&&!this.tileVisible(v,d,u))b=!0,this.drawTileOverlay(d,u,i.overlay,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw)}else if(!this.tileVisible(v,d,u))b=!0,this.drawTileUnderlay(i.underlay,v,d,u,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw);let x=0,I=0,A=i.wall,k=i.wallDecoration;if(A||k){if(V.eyeTileX===d)x+=1;else if(V.eyeTileX<d)x+=2;if(V.eyeTileZ===u)x+=3;else if(V.eyeTileZ>u)x+=6;I=V.FRONT_WALL_TYPES[x],i.backWallTypes=V.BACK_WALL_TYPES[x]}if(A){if(0===(A.typeA&V.DIRECTION_ALLOW_WALL_CORNER_TYPE[x]))i.checkLocSpans=0;else if(16===A.typeA)i.checkLocSpans=3,i.blockLocSpans=V.WALL_CORNER_TYPE_16_BLOCK_LOC_SPANS[x],i.inverseBlockLocSpans=3-i.blockLocSpans;else if(32===A.typeA)i.checkLocSpans=6,i.blockLocSpans=V.WALL_CORNER_TYPE_32_BLOCK_LOC_SPANS[x],i.inverseBlockLocSpans=6-i.blockLocSpans;else if(64===A.typeA)i.checkLocSpans=12,i.blockLocSpans=V.WALL_CORNER_TYPE_64_BLOCK_LOC_SPANS[x],i.inverseBlockLocSpans=12-i.blockLocSpans;else i.checkLocSpans=9,i.blockLocSpans=V.WALL_CORNER_TYPE_128_BLOCK_LOC_SPANS[x],i.inverseBlockLocSpans=9-i.blockLocSpans;if(0!==(A.typeA&I)&&!this.wallVisible(v,d,u,A.typeA))A.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,A.x-V.eyeX,A.y-V.eyeY,A.z-V.eyeZ,A.typecode);if(0!==(A.typeB&I)&&!this.wallVisible(v,d,u,A.typeB))A.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,A.x-V.eyeX,A.y-V.eyeY,A.z-V.eyeZ,A.typecode)}if(k&&!this.visible(v,d,u,k.model.maxY))if(0!==(k.decorType&I))k.model.draw(k.decorAngle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,k.x-V.eyeX,k.y-V.eyeY,k.z-V.eyeZ,k.typecode);else if(!!(768&k.decorType)){let i=k.x-V.eyeX,n=k.y-V.eyeY,c=k.z-V.eyeZ,d=k.decorAngle,u;if(1===d||2===d)u=-i;else u=i;let m;if(2===d||3===d)m=-c;else m=c;if(!!(256&k.decorType)&&m<u){let u=i+V.WALL_DECORATION_INSET_X[d],m=c+V.WALL_DECORATION_INSET_Z[d];k.model.draw(512*d+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,u,n,m,k.typecode)}if(!!(512&k.decorType)&&m>u){let u=i+V.WALL_DECORATION_OUTSET_X[d],m=c+V.WALL_DECORATION_OUTSET_Z[d];k.model.draw(512*d+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,u,n,m,k.typecode)}}if(b){let n=i.groundDecoration;if(n)n.model?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,n.x-V.eyeX,n.y-V.eyeY,n.z-V.eyeZ,n.typecode);let c=i.objStack;if(c&&0===c.offset){if(c.bottomObj)c.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,c.x-V.eyeX,c.y-V.eyeY,c.z-V.eyeZ,c.typecode);if(c.middleObj)c.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,c.x-V.eyeX,c.y-V.eyeY,c.z-V.eyeZ,c.typecode);if(c.topObj)c.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,c.x-V.eyeX,c.y-V.eyeY,c.z-V.eyeZ,c.typecode)}}let L=i.locSpans;if(0!==L){if(d<V.eyeTileX&&!!(4&L)){let i=S[d+1][u];if(i&&i.update)V.drawTileQueue.addTail(i)}if(u<V.eyeTileZ&&!!(2&L)){let i=S[d][u+1];if(i&&i.update)V.drawTileQueue.addTail(i)}if(d>V.eyeTileX&&!!(1&L)){let i=S[d-1][u];if(i&&i.update)V.drawTileQueue.addTail(i)}if(u>V.eyeTileZ&&!!(8&L)){let i=S[d][u-1];if(i&&i.update)V.drawTileQueue.addTail(i)}}}if(0!==i.checkLocSpans){let n=!0;for(let c=0;c<i.locCount;c++){let d=i.locs[c];if(!d)continue;if(d.cycle!==V.cycle&&(i.locSpan[c]&i.checkLocSpans)===i.blockLocSpans){n=!1;break}}if(n){let n=i.wall;if(n&&!this.wallVisible(v,d,u,n.typeA))n.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,n.x-V.eyeX,n.y-V.eyeY,n.z-V.eyeZ,n.typecode);i.checkLocSpans=0}}if(i.containsLocs){let n=i.locCount;i.containsLocs=!1;let m=0;e:for(let c=0;c<n;c++){let n=i.locs[c];if(!n||n.cycle===V.cycle)continue;for(let c=n.minSceneTileX;c<=n.maxSceneTileX;c++)for(let d=n.minSceneTileZ;d<=n.maxSceneTileZ;d++){let u=S[c][d];if(!u)continue;if(!u.groundVisible){if(0===u.checkLocSpans)continue;let m=0;if(c>n.minSceneTileX)m+=1;if(c<n.maxSceneTileX)m+=4;if(d>n.minSceneTileZ)m+=8;if(d<n.maxSceneTileZ)m+=2;if((m&u.checkLocSpans)!==i.inverseBlockLocSpans)continue}i.containsLocs=!0;continue e}V.locBuffer[m++]=n;let d=V.eyeTileX-n.minSceneTileX,u=n.maxSceneTileX-V.eyeTileX;if(u>d)d=u;let v=V.eyeTileZ-n.minSceneTileZ,b=n.maxSceneTileZ-V.eyeTileZ;if(b>v)n.distance=d+b;else n.distance=d+v}while(!0){let i=-50,n=-1;for(let c=0;c<m;c++){let d=V.locBuffer[c];if(!d)continue;if(d.cycle!==V.cycle)if(d.distance>i)i=d.distance,n=c}if(-1===n)break;let b=V.locBuffer[n];if(b){b.cycle=V.cycle;let i=b.model;if(!i)i=b.entity?.draw(c)??null;if(i&&!this.locVisible(v,b.minSceneTileX,b.maxSceneTileX,b.minSceneTileZ,b.maxSceneTileZ,i.maxY))i.draw(b.yaw,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY,b.z-V.eyeZ,b.typecode);for(let i=b.minSceneTileX;i<=b.maxSceneTileX;i++)for(let n=b.minSceneTileZ;n<=b.maxSceneTileZ;n++){let c=S[i][n];if(!c)continue;if(0!==c.checkLocSpans)V.drawTileQueue.addTail(c);else if((i!==d||n!==u)&&c.update)V.drawTileQueue.addTail(c)}}}if(i.containsLocs)continue}if(!i.update||0!==i.checkLocSpans)continue;if(d<=V.eyeTileX&&d>V.minDrawTileX){let i=S[d-1][u];if(i&&i.update)continue}if(d>=V.eyeTileX&&d<V.maxDrawTileX-1){let i=S[d+1][u];if(i&&i.update)continue}if(u<=V.eyeTileZ&&u>V.minDrawTileZ){let i=S[d][u-1];if(i&&i.update)continue}if(u>=V.eyeTileZ&&u<V.maxDrawTileZ-1){let i=S[d][u+1];if(i&&i.update)continue}i.update=!1,V.tilesRemaining--;let b=i.objStack;if(b&&0!==b.offset){if(b.bottomObj)b.bottomObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY-b.offset,b.z-V.eyeZ,b.typecode);if(b.middleObj)b.middleObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY-b.offset,b.z-V.eyeZ,b.typecode);if(b.topObj)b.topObj.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,b.x-V.eyeX,b.y-V.eyeY-b.offset,b.z-V.eyeZ,b.typecode)}if(0!==i.backWallTypes){let n=i.wallDecoration;if(n&&!this.visible(v,d,u,n.model.maxY))if(0!==(n.decorType&i.backWallTypes))n.model.draw(n.decorAngle,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,n.x-V.eyeX,n.y-V.eyeY,n.z-V.eyeZ,n.typecode);else if(!!(768&n.decorType)){let i=n.x-V.eyeX,c=n.y-V.eyeY,d=n.z-V.eyeZ,u=n.decorAngle,m;if(1===u||2===u)m=-i;else m=i;let v;if(2===u||3===u)v=-d;else v=d;if(!!(256&n.decorType)&&v>=m){let m=i+V.WALL_DECORATION_INSET_X[u],v=d+V.WALL_DECORATION_INSET_Z[u];n.model.draw(512*u+256,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m,c,v,n.typecode)}if(!!(512&n.decorType)&&v<=m){let m=i+V.WALL_DECORATION_OUTSET_X[u],v=d+V.WALL_DECORATION_OUTSET_Z[u];n.model.draw(512*u+1280&2047,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,m,c,v,n.typecode)}}let c=i.wall;if(c){if(0!==(c.typeB&i.backWallTypes)&&!this.wallVisible(v,d,u,c.typeB))c.modelB?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,c.x-V.eyeX,c.y-V.eyeY,c.z-V.eyeZ,c.typecode);if(0!==(c.typeA&i.backWallTypes)&&!this.wallVisible(v,d,u,c.typeA))c.modelA?.draw(0,V.sinEyePitch,V.cosEyePitch,V.sinEyeYaw,V.cosEyeYaw,c.x-V.eyeX,c.y-V.eyeY,c.z-V.eyeZ,c.typecode)}}if(m<this.maxLevel-1){let i=this.levelTiles[m+1][d][u];if(i&&i.update)V.drawTileQueue.addTail(i)}if(d<V.eyeTileX){let i=S[d+1][u];if(i&&i.update)V.drawTileQueue.addTail(i)}if(u<V.eyeTileZ){let i=S[d][u+1];if(i&&i.update)V.drawTileQueue.addTail(i)}if(d>V.eyeTileX){let i=S[d-1][u];if(i&&i.update)V.drawTileQueue.addTail(i)}if(u>V.eyeTileZ){let i=S[d][u-1];if(i&&i.update)V.drawTileQueue.addTail(i)}}}drawTileUnderlay(i,n,c,d,u,m,v,S){let b,x=b=(c<<7)-V.eyeX,I,A=I=(d<<7)-V.eyeZ,k,L=k=x+128,O,X=O=A+128,M=this.levelHeightmaps[n][c][d]-V.eyeY,Y=this.levelHeightmaps[n][c+1][d]-V.eyeY,B=this.levelHeightmaps[n][c+1][d+1]-V.eyeY,F=this.levelHeightmaps[n][c][d+1]-V.eyeY,E=A*v+x*S>>16;if(A=A*S-x*v>>16,x=E,E=M*m-A*u>>16,A=M*u+A*m>>16,M=E,A<50)return;if(E=I*v+L*S>>16,I=I*S-L*v>>16,L=E,E=Y*m-I*u>>16,I=Y*u+I*m>>16,Y=E,I<50)return;if(E=X*v+k*S>>16,X=X*S-k*v>>16,k=E,E=B*m-X*u>>16,X=B*u+X*m>>16,B=E,X<50)return;if(E=O*v+b*S>>16,O=O*S-b*v>>16,b=E,E=F*m-O*u>>16,O=F*u+O*m>>16,F=E,O<50)return;let D=w.centerX+((x<<9)/A|0),R=w.centerY+((M<<9)/A|0),_=w.centerX+((L<<9)/I|0),z=w.centerY+((Y<<9)/I|0),Z=w.centerX+((k<<9)/X|0),q=w.centerY+((B<<9)/X|0),N=w.centerX+((b<<9)/O|0),W=w.centerY+((F<<9)/O|0);if(w.alpha=0,(Z-N)*(z-W)-(q-W)*(_-N)>0){if(w.clipX=Z<0||N<0||_<0||Z>T.boundX||N>T.boundX||_>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,q,W,z,Z,N,_))V.clickTileX=c,V.clickTileZ=d;if(-1===i.textureId){if(12345678!==i.northeastColor)w.fillGouraudTriangle(Z,N,_,q,W,z,i.northeastColor,i.northwestColor,i.southeastColor)}else if(V.lowMemory){let n=V.TEXTURE_HSL[i.textureId];w.fillGouraudTriangle(Z,N,_,q,W,z,this.mulLightness(n,i.northeastColor),this.mulLightness(n,i.northwestColor),this.mulLightness(n,i.southeastColor))}else if(i.flat)w.fillTexturedTriangle(Z,N,_,q,W,z,i.northeastColor,i.northwestColor,i.southeastColor,x,M,A,L,b,Y,F,I,O,i.textureId);else w.fillTexturedTriangle(Z,N,_,q,W,z,i.northeastColor,i.northwestColor,i.southeastColor,k,B,X,b,L,F,Y,O,I,i.textureId)}if((D-_)*(W-z)-(R-z)*(N-_)<=0)return;if(w.clipX=D<0||_<0||N<0||D>T.boundX||_>T.boundX||N>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,R,z,W,D,_,N))V.clickTileX=c,V.clickTileZ=d;if(-1!==i.textureId){if(!V.lowMemory)return void w.fillTexturedTriangle(D,_,N,R,z,W,i.southwestColor,i.southeastColor,i.northwestColor,x,M,A,L,b,Y,F,I,O,i.textureId);let n=V.TEXTURE_HSL[i.textureId];w.fillGouraudTriangle(D,_,N,R,z,W,this.mulLightness(n,i.southwestColor),this.mulLightness(n,i.southeastColor),this.mulLightness(n,i.northwestColor))}else if(12345678!==i.southwestColor)w.fillGouraudTriangle(D,_,N,R,z,W,i.southwestColor,i.southeastColor,i.northwestColor)}drawTileOverlay(i,n,c,d,u,m,v){let S=c.vertexX.length;for(let i=0;i<S;i++){let n=c.vertexX[i]-V.eyeX,S=c.vertexY[i]-V.eyeY,b=c.vertexZ[i]-V.eyeZ,x=b*m+n*v>>16;if(b=b*v-n*m>>16,n=x,x=S*u-b*d>>16,b=S*d+b*u>>16,S=x,b<50)return;if(c.triangleTextureIds)y.tmpViewspaceX[i]=n,y.tmpViewspaceY[i]=S,y.tmpViewspaceZ[i]=b;y.tmpScreenX[i]=w.centerX+((n<<9)/b|0),y.tmpScreenY[i]=w.centerY+((S<<9)/b|0)}w.alpha=0,S=c.triangleVertexA.length;for(let d=0;d<S;d++){let u=c.triangleVertexA[d],m=c.triangleVertexB[d],v=c.triangleVertexC[d],S=y.tmpScreenX[u],b=y.tmpScreenX[m],x=y.tmpScreenX[v],I=y.tmpScreenY[u],A=y.tmpScreenY[m],k=y.tmpScreenY[v];if((S-b)*(k-A)-(I-A)*(x-b)>0){if(w.clipX=S<0||b<0||x<0||S>T.boundX||b>T.boundX||x>T.boundX,V.takingInput&&this.pointInsideTriangle(V.mouseX,V.mouseY,I,A,k,S,b,x))V.clickTileX=i,V.clickTileZ=n;if(!c.triangleTextureIds||-1===c.triangleTextureIds[d]){if(12345678!==c.triangleColorA[d])w.fillGouraudTriangle(S,b,x,I,A,k,c.triangleColorA[d],c.triangleColorB[d],c.triangleColorC[d])}else if(V.lowMemory){let i=V.TEXTURE_HSL[c.triangleTextureIds[d]];w.fillGouraudTriangle(S,b,x,I,A,k,this.mulLightness(i,c.triangleColorA[d]),this.mulLightness(i,c.triangleColorB[d]),this.mulLightness(i,c.triangleColorC[d]))}else if(c.flat)w.fillTexturedTriangle(S,b,x,I,A,k,c.triangleColorA[d],c.triangleColorB[d],c.triangleColorC[d],y.tmpViewspaceX[0],y.tmpViewspaceY[0],y.tmpViewspaceZ[0],y.tmpViewspaceX[1],y.tmpViewspaceX[3],y.tmpViewspaceY[1],y.tmpViewspaceY[3],y.tmpViewspaceZ[1],y.tmpViewspaceZ[3],c.triangleTextureIds[d]);else w.fillTexturedTriangle(S,b,x,I,A,k,c.triangleColorA[d],c.triangleColorB[d],c.triangleColorC[d],y.tmpViewspaceX[u],y.tmpViewspaceY[u],y.tmpViewspaceZ[u],y.tmpViewspaceX[m],y.tmpViewspaceX[v],y.tmpViewspaceY[m],y.tmpViewspaceY[v],y.tmpViewspaceZ[m],y.tmpViewspaceZ[v],c.triangleTextureIds[d])}}}tileVisible(i,n,c){let d=this.levelTileOcclusionCycles[i][n][c];if(d===-V.cycle)return!1;else if(d===V.cycle)return!0;else{let d=n<<7,u=c<<7;if(this.occluded(d+1,this.levelHeightmaps[i][n][c],u+1)&&this.occluded(d+128-1,this.levelHeightmaps[i][n+1][c],u+1)&&this.occluded(d+128-1,this.levelHeightmaps[i][n+1][c+1],u+128-1)&&this.occluded(d+1,this.levelHeightmaps[i][n][c+1],u+128-1))return this.levelTileOcclusionCycles[i][n][c]=V.cycle,!0;else return this.levelTileOcclusionCycles[i][n][c]=-V.cycle,!1}}wallVisible(i,n,c,d){if(!this.tileVisible(i,n,c))return!1;let u=n<<7,m=c<<7,v=this.levelHeightmaps[i][n][c]-1,S=v-120,b=v-230,x=v-238;if(d<16){if(1===d){if(u>V.eyeX){if(!this.occluded(u,v,m))return!1;if(!this.occluded(u,v,m+128))return!1}if(i>0){if(!this.occluded(u,S,m))return!1;if(!this.occluded(u,S,m+128))return!1}if(!this.occluded(u,b,m))return!1;return this.occluded(u,b,m+128)}if(2===d){if(m<V.eyeZ){if(!this.occluded(u,v,m+128))return!1;if(!this.occluded(u+128,v,m+128))return!1}if(i>0){if(!this.occluded(u,S,m+128))return!1;if(!this.occluded(u+128,S,m+128))return!1}if(!this.occluded(u,b,m+128))return!1;return this.occluded(u+128,b,m+128)}if(4===d){if(u<V.eyeX){if(!this.occluded(u+128,v,m))return!1;if(!this.occluded(u+128,v,m+128))return!1}if(i>0){if(!this.occluded(u+128,S,m))return!1;if(!this.occluded(u+128,S,m+128))return!1}if(!this.occluded(u+128,b,m))return!1;return this.occluded(u+128,b,m+128)}if(8===d){if(m>V.eyeZ){if(!this.occluded(u,v,m))return!1;if(!this.occluded(u+128,v,m))return!1}if(i>0){if(!this.occluded(u,S,m))return!1;if(!this.occluded(u+128,S,m))return!1}if(!this.occluded(u,b,m))return!1;return this.occluded(u+128,b,m)}}if(!this.occluded(u+64,x,m+64))return!1;else if(16===d)return this.occluded(u,b,m+128);else if(32===d)return this.occluded(u+128,b,m+128);else if(64===d)return this.occluded(u+128,b,m);else if(128===d)return this.occluded(u,b,m);return!0}visible(i,n,c,d){if(this.tileVisible(i,n,c)){let u=n<<7,m=c<<7;return this.occluded(u+1,this.levelHeightmaps[i][n][c]-d,m+1)&&this.occluded(u+128-1,this.levelHeightmaps[i][n+1][c]-d,m+1)&&this.occluded(u+128-1,this.levelHeightmaps[i][n+1][c+1]-d,m+128-1)&&this.occluded(u+1,this.levelHeightmaps[i][n][c+1]-d,m+128-1)}return!1}locVisible(i,n,c,d,u,m){let v,S;if(n!==c||d!==u){for(v=n;v<=c;v++)for(S=d;S<=u;S++)if(this.levelTileOcclusionCycles[i][v][S]===-V.cycle)return!1;S=(n<<7)+1;let b=(d<<7)+2,x=this.levelHeightmaps[i][n][d]-m;if(!this.occluded(S,x,b))return!1;let I=(c<<7)-1;if(!this.occluded(I,x,b))return!1;let A=(u<<7)-1;if(!this.occluded(S,x,A))return!1;else return this.occluded(I,x,A)}else if(this.tileVisible(i,n,d))return v=n<<7,S=d<<7,this.occluded(v+1,this.levelHeightmaps[i][n][d]-m,S+1)&&this.occluded(v+128-1,this.levelHeightmaps[i][n+1][d]-m,S+1)&&this.occluded(v+128-1,this.levelHeightmaps[i][n+1][d+1]-m,S+128-1)&&this.occluded(v+1,this.levelHeightmaps[i][n][d+1]-m,S+128-1);return!1}occluded(i,n,c){for(let d=0;d<V.activeOccluderCount;d++){let u=V.activeOccluders[d];if(!u)continue;if(1===u.mode){let d=u.minX-i;if(d>0){let i=u.minZ+(u.minDeltaZ*d>>8),m=u.maxZ+(u.maxDeltaZ*d>>8),v=u.minY+(u.minDeltaY*d>>8),S=u.maxY+(u.maxDeltaY*d>>8);if(c>=i&&c<=m&&n>=v&&n<=S)return!0}}else if(2===u.mode){let d=i-u.minX;if(d>0){let i=u.minZ+(u.minDeltaZ*d>>8),m=u.maxZ+(u.maxDeltaZ*d>>8),v=u.minY+(u.minDeltaY*d>>8),S=u.maxY+(u.maxDeltaY*d>>8);if(c>=i&&c<=m&&n>=v&&n<=S)return!0}}else if(3===u.mode){let d=u.minZ-c;if(d>0){let c=u.minX+(u.minDeltaX*d>>8),m=u.maxX+(u.maxDeltaX*d>>8),v=u.minY+(u.minDeltaY*d>>8),S=u.maxY+(u.maxDeltaY*d>>8);if(i>=c&&i<=m&&n>=v&&n<=S)return!0}}else if(4===u.mode){let d=c-u.minZ;if(d>0){let c=u.minX+(u.minDeltaX*d>>8),m=u.maxX+(u.maxDeltaX*d>>8),v=u.minY+(u.minDeltaY*d>>8),S=u.maxY+(u.maxDeltaY*d>>8);if(i>=c&&i<=m&&n>=v&&n<=S)return!0}}else if(5===u.mode){let d=n-u.minY;if(d>0){let n=u.minX+(u.minDeltaX*d>>8),m=u.maxX+(u.maxDeltaX*d>>8),v=u.minZ+(u.minDeltaZ*d>>8),S=u.maxZ+(u.maxDeltaZ*d>>8);if(i>=n&&i<=m&&c>=v&&c<=S)return!0}}}return!1}pointInsideTriangle(i,n,c,d,u,m,v,S){if(n<c&&n<d&&n<u)return!1;else if(n>c&&n>d&&n>u)return!1;else if(i<m&&i<v&&i<S)return!1;else if(i>m&&i>v&&i>S)return!1;let b,x,I=(n-d)*(S-v)-(i-v)*(u-d);return((n-c)*(v-m)-(i-m)*(d-c))*I>0&&I*((n-u)*(m-S)-(i-S)*(c-u))>0}mulLightness(i,n){if((n=(127-n)*(127&i)/160|0)<2)n=2;else if(n>126)n=126;return(65408&i)+n}}class G0 extends F0{heightmapSW;heightmapSE;heightmapNE;heightmapNW;index;seq;seqFrame;seqCycle;constructor(i,n,c,d,u,m,v){if(super(),this.heightmapSW=n,this.heightmapSE=c,this.heightmapNE=d,this.heightmapNW=u,this.index=i,this.seq=m,v&&-1!==m.replayoff&&this.seq.seqDelay)this.seqFrame=Math.random()*this.seq.seqFrameCount|0,this.seqCycle=Math.random()*this.seq.seqDelay[this.seqFrame]|0;else this.seqFrame=-1,this.seqCycle=0}}class a{static ROTATION_WALL_TYPE=Int8Array.of(1,2,4,8);static ROTATION_WALL_CORNER_TYPE=Uint8Array.of(16,32,64,128);static WALL_DECORATION_ROTATION_FORWARD_X=Int8Array.of(1,0,-1,0);static WALL_DECORATION_ROTATION_FORWARD_Z=Int8Array.of(0,-1,0,1);static randomHueOffset=(17*Math.random()|0)-8;static randomLightnessOffset=(33*Math.random()|0)-16;static lowMemory=!0;static levelBuilt=0;static fullbright=!1;static perlin(i,n){let c=this.perlinScale(i+45365,n+91923,4)+(this.perlinScale(i+10294,n+37821,2)-128>>1)+(this.perlinScale(i,n,1)-128>>2)-128;if(c=(.3*c|0)+35,c<10)c=10;else if(c>60)c=60;return c}static perlinScale(i,n,c){let d=i/c|0,u=i&c-1,m=n/c|0,v=n&c-1,S=this.smoothNoise(d,m),b=this.smoothNoise(d+1,m),x=this.smoothNoise(d,m+1),I=this.smoothNoise(d+1,m+1),A=this.interpolate(S,b,u,c),k=this.interpolate(x,I,u,c);return this.interpolate(A,k,v,c)}static interpolate(i,n,c,d){let u=65536-w.cos[1024*c/d|0]>>1;return(i*(65536-u)>>16)+(n*u>>16)}static smoothNoise(i,n){let c,d,u;return((this.noise(i-1,n-1)+this.noise(i+1,n-1)+this.noise(i-1,n+1)+this.noise(i+1,n+1))/16|0)+((this.noise(i-1,n)+this.noise(i+1,n)+this.noise(i,n-1)+this.noise(i,n+1))/8|0)+(this.noise(i,n)/4|0)}static noise(i,n){let c=i+57*n,d=BigInt(c<<13^c);return 255&Number((d*(d*d*15731n+789221n)+1376312589n&0x7fffffffn)>>19n)}static addLoc(i,n,c,d,u,m,v,S,b,x,I){let A=u[I][n][c],k=u[I][n+1][c],L=u[I][n+1][c+1],O=u[I][n][c+1],X=A+k+L+O>>2,M=Q0.get(S),Y=n+(c<<7)+(S<<14)+1073741824|0;if(!M.locActive)Y+=-2147483648;Y|=0;let B=((x<<6)+b|0)<<24>>24;if(b===h.GROUND_DECOR.id){if(d?.addGroundDecoration(M.getModel(h.GROUND_DECOR.id,x,A,k,L,O,-1),i,n,c,X,Y,B),M.blockwalk&&M.locActive)v?.addFloor(n,c);if(-1!==M.anim)m.addTail(new G0(S,i,3,n,c,r.instances[M.anim],!0))}else if(b===h.CENTREPIECE_STRAIGHT.id||b===h.CENTREPIECE_DIAGONAL.id){let u=M.getModel(h.CENTREPIECE_STRAIGHT.id,x,A,k,L,O,-1);if(u){let m=0;if(b===h.CENTREPIECE_DIAGONAL.id)m+=256;let v,S;if(1===x||3===x)v=M.length,S=M.width;else v=M.width,S=M.length;d?.addLoc(i,n,c,X,u,null,Y,B,v,S,m)}if(M.blockwalk)v?.addLoc(n,c,M.width,M.length,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,2,n,c,r.instances[M.anim],!0))}else if(b>=h.ROOF_STRAIGHT.id){if(d?.addLoc(i,n,c,X,M.getModel(b,x,A,k,L,O,-1),null,Y,B,1,1,0),M.blockwalk)v?.addLoc(n,c,M.width,M.length,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,2,n,c,r.instances[M.anim],!0))}else if(b===h.WALL_STRAIGHT.id){if(d?.addWall(i,n,c,X,a.ROTATION_WALL_TYPE[x],0,M.getModel(h.WALL_STRAIGHT.id,x,A,k,L,O,-1),null,Y,B),M.blockwalk)v?.addWall(n,c,b,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,0,n,c,r.instances[M.anim],!0))}else if(b===h.WALL_DIAGONAL_CORNER.id){if(d?.addWall(i,n,c,X,a.ROTATION_WALL_CORNER_TYPE[x],0,M.getModel(h.WALL_DIAGONAL_CORNER.id,x,A,k,L,O,-1),null,Y,B),M.blockwalk)v?.addWall(n,c,b,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,0,n,c,r.instances[M.anim],!0))}else if(b===h.WALL_L.id){let u=x+1&3;if(d?.addWall(i,n,c,X,a.ROTATION_WALL_TYPE[x],a.ROTATION_WALL_TYPE[u],M.getModel(h.WALL_L.id,x+4,A,k,L,O,-1),M.getModel(h.WALL_L.id,u,A,k,L,O,-1),Y,B),M.blockwalk)v?.addWall(n,c,b,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,0,n,c,r.instances[M.anim],!0))}else if(b===h.WALL_SQUARE_CORNER.id){if(d?.addWall(i,n,c,X,a.ROTATION_WALL_CORNER_TYPE[x],0,M.getModel(h.WALL_SQUARE_CORNER.id,x,A,k,L,O,-1),null,Y,B),M.blockwalk)v?.addWall(n,c,b,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,0,n,c,r.instances[M.anim],!0))}else if(b===h.WALL_DIAGONAL.id){if(d?.addLoc(i,n,c,X,M.getModel(b,x,A,k,L,O,-1),null,Y,B,1,1,0),M.blockwalk)v?.addLoc(n,c,M.width,M.length,x,M.blockrange);if(-1!==M.anim)m.addTail(new G0(S,i,2,n,c,r.instances[M.anim],!0))}else if(b===h.WALLDECOR_STRAIGHT_NOOFFSET.id){if(d?.setWallDecoration(i,n,c,X,0,0,Y,M.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,A,k,L,O,-1),B,512*x,a.ROTATION_WALL_TYPE[x]),-1!==M.anim)m.addTail(new G0(S,i,1,n,c,r.instances[M.anim],!0))}else if(b===h.WALLDECOR_STRAIGHT_OFFSET.id){let u=16;if(d){let m=d.getWallTypecode(i,n,c);if(m>0)u=Q0.get(m>>14&32767).wallwidth}if(d?.setWallDecoration(i,n,c,X,a.WALL_DECORATION_ROTATION_FORWARD_X[x]*u,a.WALL_DECORATION_ROTATION_FORWARD_Z[x]*u,Y,M.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,A,k,L,O,-1),B,512*x,a.ROTATION_WALL_TYPE[x]),-1!==M.anim)m.addTail(new G0(S,i,1,n,c,r.instances[M.anim],!0))}else if(b===h.WALLDECOR_DIAGONAL_OFFSET.id){if(d?.setWallDecoration(i,n,c,X,0,0,Y,M.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,A,k,L,O,-1),B,x,256),-1!==M.anim)m.addTail(new G0(S,i,1,n,c,r.instances[M.anim],!0))}else if(b===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(d?.setWallDecoration(i,n,c,X,0,0,Y,M.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,A,k,L,O,-1),B,x,512),-1!==M.anim)m.addTail(new G0(S,i,1,n,c,r.instances[M.anim],!0))}else if(b===h.WALLDECOR_DIAGONAL_BOTH.id)if(d?.setWallDecoration(i,n,c,X,0,0,Y,M.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,A,k,L,O,-1),B,x,768),-1!==M.anim)m.addTail(new G0(S,i,1,n,c,r.instances[M.anim],!0))}maxTileX;maxTileZ;levelHeightmap;levelTileFlags;levelTileUnderlayIds;levelTileOverlayIds;levelTileOverlayShape;levelTileOverlayRotation;levelShademap;levelLightmap;blendChroma;blendSaturation;blendLightness;blendLuminance;blendMagnitude;levelOccludemap;constructor(i,n,c,d){this.maxTileX=i,this.maxTileZ=n,this.levelHeightmap=c,this.levelTileFlags=d,this.levelTileUnderlayIds=new B0(4,i,n),this.levelTileOverlayIds=new B0(4,i,n),this.levelTileOverlayShape=new B0(4,i,n),this.levelTileOverlayRotation=new B0(4,i,n),this.levelOccludemap=new g0(4,i+1,n+1),this.levelShademap=new B0(4,i+1,n+1),this.levelLightmap=new W0(i+1,n+1),this.blendChroma=new Int32Array(n),this.blendSaturation=new Int32Array(n),this.blendLightness=new Int32Array(n),this.blendLuminance=new Int32Array(n),this.blendMagnitude=new Int32Array(n)}build(i,n){for(let i=0;i<4;i++)for(let c=0;c<104;c++)for(let d=0;d<104;d++)if(!(1&~this.levelTileFlags[i][c][d])){let u=i;if(!(2&~this.levelTileFlags[1][c][d]))u--;if(u>=0)n[u]?.addFloor(c,d)}if(a.randomHueOffset+=(5*Math.random()|0)-2,a.randomHueOffset<-8)a.randomHueOffset=-8;else if(a.randomHueOffset>8)a.randomHueOffset=8;if(a.randomLightnessOffset+=(5*Math.random()|0)-2,a.randomLightnessOffset<-16)a.randomLightnessOffset=-16;else if(a.randomLightnessOffset>16)a.randomLightnessOffset=16;for(let n=0;n<4;n++){let c=this.levelShademap[n],d=96,u=768,m=-50,v=-10,S=-50,b=768*(0|Math.sqrt(5100))>>8;for(let i=1;i<this.maxTileZ-1;i++)for(let d=1;d<this.maxTileX-1;d++){let u=this.levelHeightmap[n][d+1][i]-this.levelHeightmap[n][d-1][i],m=this.levelHeightmap[n][d][i+1]-this.levelHeightmap[n][d][i-1],v=0|Math.sqrt(u*u+m*m+65536),S,x,I,A=96+((-50*((u<<8)/v|0)+-10*(65536/v|0)+-50*((m<<8)/v|0))/b|0),k=(c[d-1][i]>>2)+(c[d+1][i]>>3)+(c[d][i-1]>>2)+(c[d][i+1]>>3)+(c[d][i]>>1);this.levelLightmap[d][i]=A-k}for(let i=0;i<this.maxTileZ;i++)this.blendChroma[i]=0,this.blendSaturation[i]=0,this.blendLightness[i]=0,this.blendLuminance[i]=0,this.blendMagnitude[i]=0;for(let c=-5;c<this.maxTileX+5;c++){for(let i=0;i<this.maxTileZ;i++){let d=c+5,u;if(d>=0&&d<this.maxTileX){let c=255&this.levelTileUnderlayIds[n][d][i];if(c>0){let n=N0.instances[c-1];this.blendChroma[i]+=n.chroma,this.blendSaturation[i]+=n.saturation,this.blendLightness[i]+=n.lightness,this.blendLuminance[i]+=n.luminance,u=this.blendMagnitude[i]++}}let m=c-5;if(m>=0&&m<this.maxTileX){let c=255&this.levelTileUnderlayIds[n][m][i];if(c>0){let n=N0.instances[c-1];this.blendChroma[i]-=n.chroma,this.blendSaturation[i]-=n.saturation,this.blendLightness[i]-=n.lightness,this.blendLuminance[i]-=n.luminance,u=this.blendMagnitude[i]--}}}if(c>=1&&c<this.maxTileX-1){let d=0,u=0,m=0,v=0,S=0;for(let b=-5;b<this.maxTileZ+5;b++){let x=b+5;if(x>=0&&x<this.maxTileZ)d+=this.blendChroma[x],u+=this.blendSaturation[x],m+=this.blendLightness[x],v+=this.blendLuminance[x],S+=this.blendMagnitude[x];let I=b-5;if(I>=0&&I<this.maxTileZ)d-=this.blendChroma[I],u-=this.blendSaturation[I],m-=this.blendLightness[I],v-=this.blendLuminance[I],S-=this.blendMagnitude[I];if(b>=1&&b<this.maxTileZ-1&&(!a.lowMemory||!(16&this.levelTileFlags[n][c][b])&&this.getDrawLevel(n,c,b)===a.levelBuilt)){let x=255&this.levelTileUnderlayIds[n][c][b],I=255&this.levelTileOverlayIds[n][c][b];if(x>0||I>0){let A=this.levelHeightmap[n][c][b],k=this.levelHeightmap[n][c+1][b],L=this.levelHeightmap[n][c+1][b+1],O=this.levelHeightmap[n][c][b+1],X=this.levelLightmap[c][b],M=this.levelLightmap[c+1][b],Y=this.levelLightmap[c+1][b+1],B=this.levelLightmap[c][b+1],F=-1,E=-1;if(x>0){let i=256*d/v|0,n=u/S|0,c=m/S|0;F=N0.hsl24to16(i,n,c);let b=i+a.randomHueOffset&255;if(c+=a.randomLightnessOffset,c<0)c=0;else if(c>255)c=255;E=N0.hsl24to16(b,n,c)}if(n>0){let i=0!==x||0===this.levelTileOverlayShape[n][c][b];if(I>0&&!N0.instances[I-1].occlude)i=!1;if(i&&A===k&&A===L&&A===O)this.levelOccludemap[n][c][b]|=2340}let D=0;if(-1!==F)D=w.hslPal[N0.mulHSL(E,96)];if(0===I)i?.setTile(n,c,b,0,0,-1,A,k,L,O,N0.mulHSL(F,X),N0.mulHSL(F,M),N0.mulHSL(F,Y),N0.mulHSL(F,B),0,0,0,0,D,0);else{let d=this.levelTileOverlayShape[n][c][b]+1,u=this.levelTileOverlayRotation[n][c][b],m=N0.instances[I-1],v=m.overlayTexture,S,x;if(v>=0)x=w.getAverageTextureRGB(v),S=-1;else if(16711935===m.rgb)x=0,S=-2,v=-1;else S=N0.hsl24to16(m.hue,m.saturation,m.lightness),x=w.hslPal[N0.adjustLightness(m.hsl,96)];i?.setTile(n,c,b,d,u,v,A,k,L,O,N0.mulHSL(F,X),N0.mulHSL(F,M),N0.mulHSL(F,Y),N0.mulHSL(F,B),N0.adjustLightness(S,X),N0.adjustLightness(S,M),N0.adjustLightness(S,Y),N0.adjustLightness(S,B),D,x)}}}}}}for(let c=1;c<this.maxTileZ-1;c++)for(let d=1;d<this.maxTileX-1;d++)i?.setDrawLevel(n,d,c,this.getDrawLevel(n,d,c))}if(!a.fullbright)i?.buildModels(64,768,-50,-10,-50);for(let n=0;n<this.maxTileX;n++)for(let c=0;c<this.maxTileZ;c++)if(!(2&~this.levelTileFlags[1][n][c]))i?.setBridge(n,c);if(!a.fullbright){let i=1,n=2,c=4;for(let d=0;d<4;d++){if(d>0)i<<=3,n<<=3,c<<=3;for(let u=0;u<=d;u++)for(let m=0;m<=this.maxTileZ;m++)for(let v=0;v<=this.maxTileX;v++){if(0!==(this.levelOccludemap[u][v][m]&i)){let n=m,c=m,S=u,b=u;while(n>0&&0!==(this.levelOccludemap[u][v][n-1]&i))n--;while(c<this.maxTileZ&&0!==(this.levelOccludemap[u][v][c+1]&i))c++;e:while(S>0){for(let d=n;d<=c;d++)if(0===(this.levelOccludemap[S-1][v][d]&i))break e;S--}e:while(b<d){for(let d=n;d<=c;d++)if(0===(this.levelOccludemap[b+1][v][d]&i))break e;b++}if((b+1-S)*(c+1-n)>=8){let u=this.levelHeightmap[b][v][n]-240,m=this.levelHeightmap[S][v][n];V.addOccluder(d,1,128*v,u,128*n,128*v,m,128*c+128);for(let d=S;d<=b;d++)for(let u=n;u<=c;u++)this.levelOccludemap[d][v][u]&=~i}}if(0!==(this.levelOccludemap[u][v][m]&n)){let i=v,c=v,S=u,b=u;while(i>0&&0!==(this.levelOccludemap[u][i-1][m]&n))i--;while(c<this.maxTileX&&0!==(this.levelOccludemap[u][c+1][m]&n))c++;e:while(S>0){for(let d=i;d<=c;d++)if(0===(this.levelOccludemap[S-1][d][m]&n))break e;S--}e:while(b<d){for(let d=i;d<=c;d++)if(0===(this.levelOccludemap[b+1][d][m]&n))break e;b++}if((b+1-S)*(c+1-i)>=8){let u=this.levelHeightmap[b][i][m]-240,v=this.levelHeightmap[S][i][m];V.addOccluder(d,2,128*i,u,128*m,128*c+128,v,128*m);for(let d=S;d<=b;d++)for(let u=i;u<=c;u++)this.levelOccludemap[d][u][m]&=~n}}if(0!==(this.levelOccludemap[u][v][m]&c)){let i=v,n=v,S=m,b=m;while(S>0&&0!==(this.levelOccludemap[u][v][S-1]&c))S--;while(b<this.maxTileZ&&0!==(this.levelOccludemap[u][v][b+1]&c))b++;e:while(i>0){for(let n=S;n<=b;n++)if(0===(this.levelOccludemap[u][i-1][n]&c))break e;i--}e:while(n<this.maxTileX){for(let i=S;i<=b;i++)if(0===(this.levelOccludemap[u][n+1][i]&c))break e;n++}if((n+1-i)*(b+1-S)>=4){let m=this.levelHeightmap[u][i][S];V.addOccluder(d,4,128*i,m,128*S,128*n+128,m,128*b+128);for(let d=i;d<=n;d++)for(let i=S;i<=b;i++)this.levelOccludemap[u][d][i]&=~c}}}}}}clearLandscape(i,n,c,d){let u=0;for(let i=0;i<N0.totalCount;i++)if("water"===N0.instances[i].debugname?.toLowerCase()){u=i+1<<24>>24;break}for(let m=i;m<i+c;m++)for(let i=n;i<n+d;i++)if(i>=0&&i<this.maxTileX&&m>=0&&m<this.maxTileZ){this.levelTileOverlayIds[0][i][m]=u;for(let n=0;n<4;n++)this.levelHeightmap[n][i][m]=0,this.levelTileFlags[n][i][m]=0}}readLandscape(i,n,c,d,u){let m=new f(u);for(let u=0;u<4;u++)for(let v=0;v<64;v++)for(let S=0;S<64;S++){let b=v+c,x=S+d,I;if(b>=0&&b<104&&x>=0&&x<104){this.levelTileFlags[u][b][x]=0;while(!0){if(I=m.g1(),0===I){if(0===u)this.levelHeightmap[0][b][x]=8*-a.perlin(b+i+932731,x+556238+n);else this.levelHeightmap[u][b][x]=this.levelHeightmap[u-1][b][x]-240;break}if(1===I){let i=m.g1();if(1===i)i=0;if(0===u)this.levelHeightmap[0][b][x]=8*-i;else this.levelHeightmap[u][b][x]=this.levelHeightmap[u-1][b][x]-8*i;break}if(I<=49)this.levelTileOverlayIds[u][b][x]=m.g1b(),this.levelTileOverlayShape[u][b][x]=((I-2)/4|0)<<24>>24,this.levelTileOverlayRotation[u][b][x]=(I-2&3)<<24>>24;else if(I<=81)this.levelTileFlags[u][b][x]=I-49<<24>>24;else this.levelTileUnderlayIds[u][b][x]=I-81<<24>>24}}else while(!0){if(I=m.g1(),0===I)break;if(1===I){m.g1();break}if(I<=49)m.g1()}}}readLocs(i,n,c,d,u,m){let v=new f(d),S=-1;while(!0){let d=v.gsmarts();if(0===d)return;S+=d;let b=0;while(!0){let d=v.gsmarts();if(0===d)break;b+=d-1;let x=63&b,I=b>>6&63,A=b>>12,k=v.g1(),L=k>>2,O=3&k,X=I+u,M=x+m;if(X>0&&M>0&&X<104-1&&M<104-1){let d=A;if(!(2&~this.levelTileFlags[1][X][M]))d=A-1;let u=null;if(d>=0)u=c[d];this.addLoc(A,X,M,i,n,u,S,L,O)}}}}addLoc(i,n,c,d,u,m,v,S,b){if(a.lowMemory){if(!!(16&this.levelTileFlags[i][n][c]))return;if(this.getDrawLevel(i,n,c)!==a.levelBuilt)return}let x=this.levelHeightmap[i][n][c],I=this.levelHeightmap[i][n+1][c],A=this.levelHeightmap[i][n+1][c+1],k=this.levelHeightmap[i][n][c+1],L=x+I+A+k>>2,O=Q0.get(v),X=n+(c<<7)+(v<<14)+1073741824|0;if(!O.locActive)X+=-2147483648;X|=0;let M=((b<<6)+S|0)<<24>>24;if(S===h.GROUND_DECOR.id){if(!a.lowMemory||O.locActive||O.forcedecor){if(d?.addGroundDecoration(O.getModel(h.GROUND_DECOR.id,b,x,I,A,k,-1),i,n,c,L,X,M),O.blockwalk&&O.locActive)m?.addFloor(n,c);if(-1!==O.anim)u.addTail(new G0(v,i,3,n,c,r.instances[O.anim],!0))}}else if(S===h.CENTREPIECE_STRAIGHT.id||S===h.CENTREPIECE_DIAGONAL.id){let Y=O.getModel(h.CENTREPIECE_STRAIGHT.id,b,x,I,A,k,-1);if(Y){let u=0;if(S===h.CENTREPIECE_DIAGONAL.id)u+=256;let m,v;if(1===b||3===b)m=O.length,v=O.width;else m=O.width,v=O.length;if(d?.addLoc(i,n,c,L,Y,null,X,M,m,v,u)&&O.shadow)for(let d=0;d<=m;d++)for(let u=0;u<=v;u++){let m=Y.radius/4|0;if(m>30)m=30;if(m>this.levelShademap[i][n+d][c+u])this.levelShademap[i][n+d][c+u]=m<<24>>24}}if(O.blockwalk)m?.addLoc(n,c,O.width,O.length,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,2,n,c,r.instances[O.anim],!0))}else if(S>=h.ROOF_STRAIGHT.id){if(d?.addLoc(i,n,c,L,O.getModel(S,b,x,I,A,k,-1),null,X,M,1,1,0),S>=h.ROOF_STRAIGHT.id&&S<=h.ROOF_FLAT.id&&S!==h.ROOF_DIAGONAL_WITH_ROOFEDGE.id&&i>0)this.levelOccludemap[i][n][c]|=2340;if(O.blockwalk)m?.addLoc(n,c,O.width,O.length,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,2,n,c,r.instances[O.anim],!0))}else if(S===h.WALL_STRAIGHT.id){if(d?.addWall(i,n,c,L,a.ROTATION_WALL_TYPE[b],0,O.getModel(h.WALL_STRAIGHT.id,b,x,I,A,k,-1),null,X,M),0===b){if(O.shadow)this.levelShademap[i][n][c]=50,this.levelShademap[i][n][c+1]=50;if(O.occlude)this.levelOccludemap[i][n][c]|=585}else if(1===b){if(O.shadow)this.levelShademap[i][n][c+1]=50,this.levelShademap[i][n+1][c+1]=50;if(O.occlude)this.levelOccludemap[i][n][c+1]|=1170}else if(2===b){if(O.shadow)this.levelShademap[i][n+1][c]=50,this.levelShademap[i][n+1][c+1]=50;if(O.occlude)this.levelOccludemap[i][n+1][c]|=585}else if(3===b){if(O.shadow)this.levelShademap[i][n][c]=50,this.levelShademap[i][n+1][c]=50;if(O.occlude)this.levelOccludemap[i][n][c]|=1170}if(O.blockwalk)m?.addWall(n,c,S,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,0,n,c,r.instances[O.anim],!0));if(16!==O.wallwidth)d?.setWallDecorationOffset(i,n,c,O.wallwidth)}else if(S===h.WALL_DIAGONAL_CORNER.id){if(d?.addWall(i,n,c,L,a.ROTATION_WALL_CORNER_TYPE[b],0,O.getModel(h.WALL_DIAGONAL_CORNER.id,b,x,I,A,k,-1),null,X,M),O.shadow)if(0===b)this.levelShademap[i][n][c+1]=50;else if(1===b)this.levelShademap[i][n+1][c+1]=50;else if(2===b)this.levelShademap[i][n+1][c]=50;else if(3===b)this.levelShademap[i][n][c]=50;if(O.blockwalk)m?.addWall(n,c,S,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,0,n,c,r.instances[O.anim],!0))}else if(S===h.WALL_L.id){let Y=b+1&3;if(d?.addWall(i,n,c,L,a.ROTATION_WALL_TYPE[b],a.ROTATION_WALL_TYPE[Y],O.getModel(h.WALL_L.id,b+4,x,I,A,k,-1),O.getModel(h.WALL_L.id,Y,x,I,A,k,-1),X,M),O.occlude)if(0===b)this.levelOccludemap[i][n][c]|=265,this.levelOccludemap[i][n][c+1]|=1170;else if(1===b)this.levelOccludemap[i][n][c+1]|=1170,this.levelOccludemap[i][n+1][c]|=585;else if(2===b)this.levelOccludemap[i][n+1][c]|=585,this.levelOccludemap[i][n][c]|=1170;else if(3===b)this.levelOccludemap[i][n][c]|=1170,this.levelOccludemap[i][n][c]|=585;if(O.blockwalk)m?.addWall(n,c,S,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,0,n,c,r.instances[O.anim],!0));if(16!==O.wallwidth)d?.setWallDecorationOffset(i,n,c,O.wallwidth)}else if(S===h.WALL_SQUARE_CORNER.id){if(d?.addWall(i,n,c,L,a.ROTATION_WALL_CORNER_TYPE[b],0,O.getModel(h.WALL_SQUARE_CORNER.id,b,x,I,A,k,-1),null,X,M),O.shadow)if(0===b)this.levelShademap[i][n][c+1]=50;else if(1===b)this.levelShademap[i][n+1][c+1]=50;else if(2===b)this.levelShademap[i][n+1][c]=50;else if(3===b)this.levelShademap[i][n][c]=50;if(O.blockwalk)m?.addWall(n,c,S,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,0,n,c,r.instances[O.anim],!0))}else if(S===h.WALL_DIAGONAL.id){if(d?.addLoc(i,n,c,L,O.getModel(S,b,x,I,A,k,-1),null,X,M,1,1,0),O.blockwalk)m?.addLoc(n,c,O.width,O.length,b,O.blockrange);if(-1!==O.anim)u.addTail(new G0(v,i,2,n,c,r.instances[O.anim],!0))}else if(S===h.WALLDECOR_STRAIGHT_NOOFFSET.id){if(d?.setWallDecoration(i,n,c,L,0,0,X,O.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,x,I,A,k,-1),M,512*b,a.ROTATION_WALL_TYPE[b]),-1!==O.anim)u.addTail(new G0(v,i,1,n,c,r.instances[O.anim],!0))}else if(S===h.WALLDECOR_STRAIGHT_OFFSET.id){let m=16;if(d){let u=d.getWallTypecode(i,n,c);if(u>0)m=Q0.get(u>>14&32767).wallwidth}if(d?.setWallDecoration(i,n,c,L,a.WALL_DECORATION_ROTATION_FORWARD_X[b]*m,a.WALL_DECORATION_ROTATION_FORWARD_Z[b]*m,X,O.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,x,I,A,k,-1),M,512*b,a.ROTATION_WALL_TYPE[b]),-1!==O.anim)u.addTail(new G0(v,i,1,n,c,r.instances[O.anim],!0))}else if(S===h.WALLDECOR_DIAGONAL_OFFSET.id){if(d?.setWallDecoration(i,n,c,L,0,0,X,O.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,x,I,A,k,-1),M,b,256),-1!==O.anim)u.addTail(new G0(v,i,1,n,c,r.instances[O.anim],!0))}else if(S===h.WALLDECOR_DIAGONAL_NOOFFSET.id){if(d?.setWallDecoration(i,n,c,L,0,0,X,O.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,x,I,A,k,-1),M,b,512),-1!==O.anim)u.addTail(new G0(v,i,1,n,c,r.instances[O.anim],!0))}else if(S===h.WALLDECOR_DIAGONAL_BOTH.id)if(d?.setWallDecoration(i,n,c,L,0,0,X,O.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,x,I,A,k,-1),M,b,768),-1!==O.anim)u.addTail(new G0(v,i,1,n,c,r.instances[O.anim],!0))}getDrawLevel(i,n,c){if(!(8&this.levelTileFlags[i][n][c]))return i<=0||!(2&this.levelTileFlags[1][n][c])?i:i-1;return 0}}class P0 extends F0{}class s0 extends P0{x=0;z=0;yaw=0;seqStretches=!1;size=1;seqStandId=-1;seqTurnId=-1;seqWalkId=-1;seqTurnAroundId=-1;seqTurnLeftId=-1;seqTurnRightId=-1;seqRunId=-1;chat=null;chatTimer=100;chatColor=0;chatStyle=0;damage=0;damageType=0;combatCycle=-1e3;health=0;totalHealth=0;targetId=-1;targetTileX=0;targetTileZ=0;secondarySeqId=-1;secondarySeqFrame=0;secondarySeqCycle=0;primarySeqId=-1;primarySeqFrame=0;primarySeqCycle=0;primarySeqDelay=0;primarySeqLoop=0;spotanimId=-1;spotanimFrame=0;spotanimCycle=0;spotanimLastCycle=0;spotanimOffset=0;forceMoveStartSceneTileX=0;forceMoveEndSceneTileX=0;forceMoveStartSceneTileZ=0;forceMoveEndSceneTileZ=0;forceMoveEndCycle=0;forceMoveStartCycle=0;forceMoveFaceDirection=0;cycle=0;maxY=0;dstYaw=0;routeLength=0;routeFlagX=new Int32Array(10);routeFlagZ=new Int32Array(10);routeRun=new C(10,!1);seqTrigger=0;lastMask=-1;lastMaskCycle=-1;lastFaceX=-1;lastFaceZ=-1;move(i,n,c){if(-1!==this.primarySeqId&&r.instances[this.primarySeqId].seqPriority<=1)this.primarySeqId=-1;if(!i){let i=n-this.routeFlagX[0],d=c-this.routeFlagZ[0];if(i>=-8&&i<=8&&d>=-8&&d<=8){if(this.routeLength<9)this.routeLength++;for(let i=this.routeLength;i>0;i--)this.routeFlagX[i]=this.routeFlagX[i-1],this.routeFlagZ[i]=this.routeFlagZ[i-1],this.routeRun[i]=this.routeRun[i-1];return this.routeFlagX[0]=n,this.routeFlagZ[0]=c,void(this.routeRun[0]=!1)}}this.routeLength=0,this.seqTrigger=0,this.routeFlagX[0]=n,this.routeFlagZ[0]=c,this.x=128*this.routeFlagX[0]+64*this.size,this.z=128*this.routeFlagZ[0]+64*this.size}step(i,n){let c=this.routeFlagX[0],d=this.routeFlagZ[0];if(0===n)c--,d++;else if(1===n)d++;else if(2===n)c++,d++;else if(3===n)c--;else if(4===n)c++;else if(5===n)c--,d--;else if(6===n)d--;else if(7===n)c++,d--;if(-1!==this.primarySeqId&&r.instances[this.primarySeqId].seqPriority<=1)this.primarySeqId=-1;if(this.routeLength<9)this.routeLength++;for(let i=this.routeLength;i>0;i--)this.routeFlagX[i]=this.routeFlagX[i-1],this.routeFlagZ[i]=this.routeFlagZ[i-1],this.routeRun[i]=this.routeRun[i-1];this.routeFlagX[0]=c,this.routeFlagZ[0]=d,this.routeRun[0]=i}}class I_ extends s0{npcType=null;draw(i){if(!this.npcType)return null;if(-1===this.spotanimId||-1===this.spotanimFrame)return this.getSequencedModel();let n=this.getSequencedModel();if(!n)return null;let c=T0.instances[this.spotanimId],d=J.modelShareColored(c.getModel(),!0,!c.disposeAlpha,!1);if(d.translateModel(-this.spotanimOffset,0,0),d.createLabelReferences(),c.seq&&c.seq.seqFrames)d.applyTransform(c.seq.seqFrames[this.spotanimFrame]);if(d.labelFaces=null,d.labelVertices=null,128!==c.resizeh||128!==c.resizev)d.scale(c.resizeh,c.resizev,c.resizeh);d.calculateNormals(64+c.ambient,850+c.contrast,-30,-50,-30,!0);let u=[n,d],m=J.modelFromModelsBounds(u,2);if(1===this.npcType.size)m.pickable=!0;return m}isVisibleNow(){return null!==this.npcType}getSequencedModel(){if(!this.npcType)return null;if(this.primarySeqId>=0&&0===this.primarySeqDelay){let i=r.instances[this.primarySeqId].seqFrames;if(i){let n=i[this.primarySeqFrame],c=-1;if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let i=r.instances[this.secondarySeqId].seqFrames;if(i)c=i[this.secondarySeqFrame]}return this.npcType.getSequencedModel(n,c,r.instances[this.primarySeqId].walkmerge)}}let i=-1;if(this.secondarySeqId>=0){let n=r.instances[this.secondarySeqId].seqFrames;if(n)i=n[this.secondarySeqFrame]}let n=this.npcType.getSequencedModel(i,-1,null);if(!n)return null;return this.maxY=n.maxY,n}}class K0 extends s0{static TORSO_RECOLORS=[9104,10275,7595,3610,7975,8526,918,38802,24466,10145,58654,5027,1457,16565,34991,25486];static DESIGN_IDK_COLORS=[[6798,107,10283,16,4797,7744,5799,4634,33697,22433,2983,54193],[8741,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003,25239],[25238,8742,12,64030,43162,7735,8404,1701,38430,24094,10153,56621,4783,1341,16578,35003],[4626,11146,6439,12,4758,10270],[4550,4537,5681,5673,5790,6806,8076,4574]];static modelCache=new k0(200);name=null;playerVisible=!1;gender=0;headicons=0;appearances=new Uint16Array(12);colors=new Uint16Array(5);combatLevel=0;appearanceHashcode=0n;y=0;locStartCycle=0;locStopCycle=0;locOffsetX=0;locOffsetY=0;locOffsetZ=0;locModel=null;minTileX=0;minTileZ=0;maxTileX=0;maxTileZ=0;lowMemory=!1;draw(i){if(!this.playerVisible)return null;let n=this.getSequencedModel();if(this.maxY=n.maxY,n.pickable=!0,this.lowMemory)return n;if(-1!==this.spotanimId&&-1!==this.spotanimFrame){let i=T0.instances[this.spotanimId],c=J.modelShareColored(i.getModel(),!0,!i.disposeAlpha,!1);if(c.translateModel(-this.spotanimOffset,0,0),c.createLabelReferences(),i.seq&&i.seq.seqFrames)c.applyTransform(i.seq.seqFrames[this.spotanimFrame]);if(c.labelFaces=null,c.labelVertices=null,128!==i.resizeh||128!==i.resizev)c.scale(i.resizeh,i.resizev,i.resizeh);c.calculateNormals(i.ambient+64,i.contrast+850,-30,-50,-30,!0);let d=[n,c];n=J.modelFromModelsBounds(d,2)}if(this.locModel){if(i>=this.locStopCycle)this.locModel=null;if(i>=this.locStartCycle&&i<this.locStopCycle){let i=this.locModel;if(i){if(i.translateModel(this.locOffsetY-this.y,this.locOffsetX-this.x,this.locOffsetZ-this.z),512===this.dstYaw)i.rotateY90(),i.rotateY90(),i.rotateY90();else if(1024===this.dstYaw)i.rotateY90(),i.rotateY90();else if(1536===this.dstYaw)i.rotateY90();let c=[n,i];if(n=J.modelFromModelsBounds(c,2),512===this.dstYaw)i.rotateY90();else if(1024===this.dstYaw)i.rotateY90(),i.rotateY90();else if(1536===this.dstYaw)i.rotateY90(),i.rotateY90(),i.rotateY90();i.translateModel(this.y-this.locOffsetY,this.x-this.locOffsetX,this.z-this.locOffsetZ)}}}return n.pickable=!0,n}isVisibleNow(){return this.playerVisible}read(i){i.pos=0,this.gender=i.g1(),this.headicons=i.g1();for(let n=0;n<12;n++){let c=i.g1();if(0===c)this.appearances[n]=0;else this.appearances[n]=(c<<8)+i.g1()}for(let n=0;n<5;n++){let c=i.g1();if(c<0||c>=K0.DESIGN_IDK_COLORS[n].length)c=0;this.colors[n]=c}if(this.seqStandId=i.g2(),65535===this.seqStandId)this.seqStandId=-1;if(this.seqTurnId=i.g2(),65535===this.seqTurnId)this.seqTurnId=-1;if(this.seqWalkId=i.g2(),65535===this.seqWalkId)this.seqWalkId=-1;if(this.seqTurnAroundId=i.g2(),65535===this.seqTurnAroundId)this.seqTurnAroundId=-1;if(this.seqTurnLeftId=i.g2(),65535===this.seqTurnLeftId)this.seqTurnLeftId=-1;if(this.seqTurnRightId=i.g2(),65535===this.seqTurnRightId)this.seqTurnRightId=-1;if(this.seqRunId=i.g2(),65535===this.seqRunId)this.seqRunId=-1;this.name=l.formatName(l.fromBase37(i.g8())),this.combatLevel=i.g1(),this.playerVisible=!0,this.appearanceHashcode=0n;for(let i=0;i<12;i++)if(this.appearanceHashcode<<=0x4n,this.appearances[i]>=256)this.appearanceHashcode+=BigInt(this.appearances[i])-256n;if(this.appearances[0]>=256)this.appearanceHashcode+=BigInt(this.appearances[0])-256n>>4n;if(this.appearances[1]>=256)this.appearanceHashcode+=BigInt(this.appearances[1])-256n>>8n;for(let i=0;i<5;i++)this.appearanceHashcode<<=0x3n,this.appearanceHashcode+=BigInt(this.colors[i]);this.appearanceHashcode<<=0x1n,this.appearanceHashcode+=BigInt(this.gender)}getHeadModel(){if(!this.playerVisible)return null;let i=new C(12,null),n=0;for(let c=0;c<12;c++){let d=this.appearances[c];if(d>=256&&d<512)i[n++]=Y0.instances[d-256].getHeadModel();if(d>=512){let c=_0.get(d-512).getHeadModel(this.gender);if(c)i[n++]=c}}let c=J.modelFromModels(i,n);for(let i=0;i<5;i++){if(0===this.colors[i])continue;if(c.recolor(K0.DESIGN_IDK_COLORS[i][0],K0.DESIGN_IDK_COLORS[i][this.colors[i]]),1===i)c.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.colors[i]])}return c}getSequencedModel(){let i=this.appearanceHashcode,n=-1,c=-1,d=-1,u=-1;if(this.primarySeqId>=0&&0===this.primarySeqDelay){let m=r.instances[this.primarySeqId];if(m.seqFrames)n=m.seqFrames[this.primarySeqFrame];if(this.secondarySeqId>=0&&this.secondarySeqId!==this.seqStandId){let i=r.instances[this.secondarySeqId].seqFrames;if(i)c=i[this.secondarySeqFrame]}if(m.righthand>=0)d=m.righthand,i+=BigInt(d-this.appearances[5])<<8n;if(m.lefthand>=0)u=m.lefthand,i+=BigInt(u-this.appearances[3])<<16n}else if(this.secondarySeqId>=0){let i=r.instances[this.secondarySeqId].seqFrames;if(i)n=i[this.secondarySeqFrame]}let m=K0.modelCache?.get(i);if(!m){let n=new C(12,null),c=0;for(let i=0;i<12;i++){let m=this.appearances[i];if(u>=0&&3===i)m=u;if(d>=0&&5===i)m=d;if(m>=256&&m<512){let i=Y0.instances[m-256].getModel();if(i)n[c++]=i}if(m>=512){let i=_0.get(m-512).getWornModel(this.gender);if(i)n[c++]=i}}m=J.modelFromModels(n,c);for(let i=0;i<5;i++){if(0===this.colors[i])continue;if(m.recolor(K0.DESIGN_IDK_COLORS[i][0],K0.DESIGN_IDK_COLORS[i][this.colors[i]]),1===i)m.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.colors[i]])}m.createLabelReferences(),m.calculateNormals(64,850,-30,-50,-30,!0),K0.modelCache?.put(i,m)}if(this.lowMemory)return m;let v=J.modelShareAlpha(m,!0);if(-1!==n&&-1!==c)v.applyTransforms(n,c,r.instances[this.primarySeqId].walkmerge);else if(-1!==n)v.applyTransform(n);return v.calculateBoundsCylinder(),v.labelFaces=null,v.labelVertices=null,v}}class Q_ extends F0{duration=-1;locIndex=0;locAngle=0;shape=0;plane=0;layer=0;x=0;z=0;lastLocIndex=0;lastAngle=0;lastShape=0;delay=0}class y0 extends F0{index;count;constructor(i,n){super(),this.index=i,this.count=n}}class q_ extends P0{spotanim;projLevel;srcX;srcZ;srcY;projOffsetY;startCycle;lastCycle;peakPitch;projArc;projTarget;mobile=!1;x=0;z=0;y=0;projVelocityX=0;projVelocityZ=0;projVelocity=0;projVelocityY=0;accelerationY=0;yaw=0;pitch=0;seqFrame=0;seqCycle=0;constructor(i,n,c,d,u,m,v,S,b,x,I){super(),this.spotanim=T0.instances[i],this.projLevel=n,this.srcX=c,this.srcZ=u,this.srcY=d,this.startCycle=m,this.lastCycle=v,this.peakPitch=S,this.projArc=b,this.projTarget=x,this.projOffsetY=I}updateVelocity(i,n,c,d){if(!this.mobile){let n=i-this.srcX,d=c-this.srcZ,u=Math.sqrt(n*n+d*d);this.x=this.srcX+n*this.projArc/u,this.z=this.srcZ+d*this.projArc/u,this.y=this.srcY}let u=this.lastCycle+1-d;if(this.projVelocityX=(i-this.x)/u,this.projVelocityZ=(c-this.z)/u,this.projVelocity=Math.sqrt(this.projVelocityX*this.projVelocityX+this.projVelocityZ*this.projVelocityZ),!this.mobile)this.projVelocityY=-this.projVelocity*Math.tan(.02454369*this.peakPitch);this.accelerationY=2*(n-this.y-this.projVelocityY*u)/(u*u)}update(i){if(this.mobile=!0,this.x+=this.projVelocityX*i,this.z+=this.projVelocityZ*i,this.y+=this.projVelocityY*i+.5*this.accelerationY*i*i,this.projVelocityY+=this.accelerationY*i,this.yaw=2047&(325.949*Math.atan2(this.projVelocityX,this.projVelocityZ)+1024|0),this.pitch=2047&(325.949*Math.atan2(this.projVelocityY,this.projVelocity)|0),!this.spotanim.seq||!this.spotanim.seq.seqDelay)return;this.seqCycle+=i;while(this.seqCycle>this.spotanim.seq.seqDelay[this.seqFrame])if(this.seqCycle-=this.spotanim.seq.seqDelay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotanim.seq.seqFrameCount)this.seqFrame=0}draw(){let i=this.spotanim.getModel(),n=J.modelShareColored(i,!0,!this.spotanim.disposeAlpha,!1);if(this.spotanim.seq&&this.spotanim.seq.seqFrames)n.createLabelReferences(),n.applyTransform(this.spotanim.seq.seqFrames[this.seqFrame]),n.labelFaces=null,n.labelVertices=null;if(128!==this.spotanim.resizeh||128!==this.spotanim.resizev)n.scale(this.spotanim.resizeh,this.spotanim.resizev,this.spotanim.resizeh);return n.rotateX(this.pitch),n.calculateNormals(64+this.spotanim.ambient,850+this.spotanim.contrast,-30,-50,-30,!0),n}}class O_ extends P0{spotType;spotLevel;x;z;y;startCycle;seqComplete=!1;seqFrame=0;seqCycle=0;constructor(i,n,c,d,u,m,v){super(),this.spotType=T0.instances[i],this.spotLevel=n,this.x=c,this.z=d,this.y=u,this.startCycle=m+v}update(i){if(!this.spotType.seq||!this.spotType.seq.seqDelay)return;for(this.seqCycle+=i;this.seqCycle>this.spotType.seq.seqDelay[this.seqFrame];)if(this.seqCycle-=this.spotType.seq.seqDelay[this.seqFrame]+1,this.seqFrame++,this.seqFrame>=this.spotType.seq.seqFrameCount)this.seqFrame=0,this.seqComplete=!0}draw(){let i=this.spotType.getModel(),n=J.modelShareColored(i,!0,!this.spotType.disposeAlpha,!1);if(!this.seqComplete&&this.spotType.seq&&this.spotType.seq.seqFrames)n.createLabelReferences(),n.applyTransform(this.spotType.seq.seqFrames[this.seqFrame]),n.labelFaces=null,n.labelVertices=null;if(128!==this.spotType.resizeh||128!==this.spotType.resizev)n.scale(this.spotType.resizeh,this.spotType.resizev,this.spotType.resizeh);if(0!==this.spotType.spotAngle)if(90===this.spotType.spotAngle)n.rotateY90();else if(180===this.spotType.spotAngle)n.rotateY90(),n.rotateY90();else if(270===this.spotType.spotAngle)n.rotateY90(),n.rotateY90(),n.rotateY90();return n.calculateNormals(64+this.spotType.ambient,850+this.spotType.contrast,-30,-50,-30,!0),n}}class $_{seed;constructor(i){this.seed=(0x5deece66dn^i)&(1n<<48n)-1n}setSeed(i){this.seed=(0x5deece66dn^i)&(1n<<48n)-1n}nextInt(){return this.next(32)}next(i){return this.seed=0x5deece66dn*this.seed+0xbn&(1n<<48n)-1n,Number(this.seed)>>>48-i}}class V0 extends j0{static CHARSET=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!"Â£$%^&*()-_=+[{]};:'@#~,<.>/?\\| `;static CHARCODESET=[];charMask=[];charMaskWidth=new Int32Array(94);charMaskHeight=new Int32Array(94);charOffsetX=new Int32Array(94);charOffsetY=new Int32Array(94);charAdvance=new Int32Array(95);drawWidth=new Int32Array(256);random=new $_(BigInt(Date.now()));height2d=0;static{let i=navigator.userAgent.includes("Capacitor");for(let n=0;n<256;n++){let c=V0.CHARSET.indexOf(String.fromCharCode(n));if(i)if(c>=63)c--;if(-1===c)c=74;V0.CHARCODESET[n]=c}}static fromArchive(i,n){let c=new f(i.read(n+".dat")),d=new f(i.read("index.dat"));d.pos=c.g2()+4;let u=d.g1();if(u>0)d.pos+=3*(u-1);let m=new V0;for(let i=0;i<94;i++){m.charOffsetX[i]=d.g1(),m.charOffsetY[i]=d.g1();let n=m.charMaskWidth[i]=d.g2(),u=m.charMaskHeight[i]=d.g2(),v=d.g1(),S=n*u;if(m.charMask[i]=new Int8Array(S),0===v)for(let d=0;d<n*u;d++)m.charMask[i][d]=c.g1b();else if(1===v)for(let d=0;d<n;d++)for(let v=0;v<u;v++)m.charMask[i][d+v*n]=c.g1b();if(u>m.height2d)m.height2d=u;m.charOffsetX[i]=1,m.charAdvance[i]=n+2;{let c=0;for(let d=u/7|0;d<u;d++)c+=m.charMask[i][d*n];if(c<=(u/7|0))m.charAdvance[i]--,m.charOffsetX[i]=0}{let c=0;for(let d=u/7|0;d<u;d++)c+=m.charMask[i][n+d*n-1];if(c<=(u/7|0))m.charAdvance[i]--}}m.charAdvance[94]=m.charAdvance[8];for(let i=0;i<256;i++)m.drawWidth[i]=m.charAdvance[V0.CHARCODESET[i]];return m}drawString(i,n,c,d){if(!c)return;i|=0,n|=0;let u=c.length;n-=this.height2d;for(let m=0;m<u;m++){let u=V0.CHARCODESET[c.charCodeAt(m)];if(94!==u)this.drawChar(this.charMask[u],i+this.charOffsetX[u],n+this.charOffsetY[u],this.charMaskWidth[u],this.charMaskHeight[u],d);i+=this.charAdvance[u]}}drawStringTaggable(i,n,c,d,u){i|=0,n|=0;let m=c.length;n-=this.height2d;for(let v=0;v<m;v++)if("@"===c.charAt(v)&&v+4<m&&"@"===c.charAt(v+4))d=this.evaluateTag(c.substring(v+1,v+4)),v+=4;else{let m=V0.CHARCODESET[c.charCodeAt(v)];if(94!==m){if(u)this.drawChar(this.charMask[m],i+this.charOffsetX[m]+1,n+this.charOffsetY[m]+1,this.charMaskWidth[m],this.charMaskHeight[m],0);this.drawChar(this.charMask[m],i+this.charOffsetX[m],n+this.charOffsetY[m],this.charMaskWidth[m],this.charMaskHeight[m],d)}i+=this.charAdvance[m]}}stringWidth(i){if(!i)return 0;let n=i.length,c=0;for(let d=0;d<n;d++)if("@"===i.charAt(d)&&d+4<n&&"@"===i.charAt(d+4))d+=4;else c+=this.drawWidth[i.charCodeAt(d)];return c}drawStringTaggableCenter(i,n,c,d,u){i|=0,n|=0,this.drawStringTaggable(i-(this.stringWidth(c)/2|0),n,c,d,u)}drawStringCenter(i,n,c,d){if(!c)return;i|=0,n|=0,this.drawString(i-(this.stringWidth(c)/2|0),n,c,d)}drawStringTooltip(i,n,c,d,u,m){i|=0,n|=0,this.random.setSeed(BigInt(m));let v=(31&this.random.nextInt())+192,S=n-this.height2d;for(let n=0;n<c.length;n++)if("@"===c.charAt(n)&&n+4<c.length&&"@"===c.charAt(n+4))d=this.evaluateTag(c.substring(n+1,n+4)),n+=4;else{let m=V0.CHARCODESET[c.charCodeAt(n)];if(94!==m){if(u)this.drawCharAlpha(i+this.charOffsetX[m]+1,S+this.charOffsetY[m]+1,this.charMaskWidth[m],this.charMaskHeight[m],0,192,this.charMask[m]);this.drawCharAlpha(i+this.charOffsetX[m],S+this.charOffsetY[m],this.charMaskWidth[m],this.charMaskHeight[m],d,v,this.charMask[m])}if(i+=this.charAdvance[m],!(3&this.random.nextInt()))i++}}drawStringRight(i,n,c,d,u=!0){if(i|=0,n|=0,u)this.drawString(i-this.stringWidth(c)+1,n+1,c,0);this.drawString(i-this.stringWidth(c),n,c,d)}drawCenteredWave(i,n,c,d,u){if(!c)return;i|=0,n|=0,i-=this.stringWidth(c)/2|0;let m=n-this.height2d;for(let n=0;n<c.length;n++){let v=V0.CHARCODESET[c.charCodeAt(n)];if(94!=v)this.drawChar(this.charMask[v],i+this.charOffsetX[v],m+this.charOffsetY[v]+(5*Math.sin(n/2+u/5)|0),this.charMaskWidth[v],this.charMaskHeight[v],d);i+=this.charAdvance[v]}}drawChar(i,n,c,d,u,m){d|=0,u|=0;let v=(n|=0)+(c|=0)*T.width2d,S=T.width2d-d,b=0,x=0;if(c<T.top){let i=T.top-c;u-=i,c=T.top,x+=i*d,v+=i*T.width2d}if(c+u>=T.bottom)u-=c+u+1-T.bottom;if(n<T.left){let i=T.left-n;d-=i,n=T.left,x+=i,v+=i,b+=i,S+=i}if(n+d>=T.right){let i=n+d+1-T.right;d-=i,b+=i,S+=i}if(d>0&&u>0)this.drawMask(d,u,i,x,b,T.pixels,v,S,m)}drawCharAlpha(i,n,c,d,u,m,v){c|=0,d|=0;let S=(i|=0)+(n|=0)*T.width2d,b=T.width2d-c,x=0,I=0;if(n<T.top){let i=T.top-n;d-=i,n=T.top,I+=i*c,S+=i*T.width2d}if(n+d>=T.bottom)d-=n+d+1-T.bottom;if(i<T.left){let n=T.left-i;c-=n,i=T.left,I+=n,S+=n,x+=n,b+=n}if(i+c>=T.right){let n=i+c+1-T.right;c-=n,x+=n,b+=n}if(c>0&&d>0)this.drawMaskAlpha(c,d,T.pixels,S,b,v,I,x,u,m)}drawMask(i,n,c,d,u,m,v,S,b){let x=-((i|=0)>>2);i=-(3&i);for(let I=-(n|=0);I<0;I++){for(let i=x;i<0;i++){if(0===c[d++])v++;else m[v++]=b;if(0===c[d++])v++;else m[v++]=b;if(0===c[d++])v++;else m[v++]=b;if(0===c[d++])v++;else m[v++]=b}for(let n=i;n<0;n++)if(0===c[d++])v++;else m[v++]=b;v+=S,d+=u}}drawMaskAlpha(i,n,c,d,u,m,v,S,b,x){i|=0;let I=((16711935&b)*x&4278255360)+((65280&b)*x&16711680)>>8,A=256-x;for(let b=-(n|=0);b<0;b++){for(let n=-i;n<0;n++)if(0===m[v++])d++;else{let i=c[d];c[d++]=(((16711935&i)*A&4278255360)+((65280&i)*A&16711680)>>8)+I}d+=u,v+=S}}evaluateTag(i){if("red"===i)return 16711680;else if("gre"===i)return 65280;else if("blu"===i)return 255;else if("yel"===i)return 16776960;else if("cya"===i)return 65535;else if("mag"===i)return 16711935;else if("whi"===i)return 16777215;else if("bla"===i)return 0;else if("lre"===i)return 16748608;else if("dre"===i)return 8388608;else if("dbl"===i)return 128;else if("or1"===i)return 16756736;else if("or2"===i)return 16740352;else if("or3"===i)return 16723968;else if("gr1"===i)return 12648192;else if("gr2"===i)return 8453888;else if("gr3"===i)return 4259584;else return 0}split(i,n){if(0===i.length)return[i];let c=[];while(i.length>0){if(this.stringWidth(i)<=n&&-1===i.indexOf("|")){c.push(i);break}let d=i.length;for(let c=0;c<i.length;c++)if(" "===i[c]){if(this.stringWidth(i.substring(0,c))>n)break;d=c}else if("|"===i[c]){d=c;break}c.push(i.substring(0,d)),i=i.substring(d+1)}return c}}class x0{socket;wsin;wsout;closed=!1;ioerror=!1;static async openSocket(i,n){return await new Promise((c,d)=>{let u=new WebSocket(`${n?"wss":"ws"}://${i}`,"binary");u.addEventListener("open",()=>{c(u)}),u.addEventListener("error",()=>{d(u)})})}constructor(i){i.onclose=this.onclose,i.onerror=this.onerror,this.wsin=new W_(i,5e3),this.wsout=new A_(i,5e3),this.socket=i}get host(){return this.socket.url.split("/")[2]}get port(){return parseInt(this.socket.url.split(":")[2],10)}get available(){return this.closed?0:this.wsin.available}write(i,n){if(!this.closed)this.wsout.write(i,n)}async read(){return this.closed?0:await this.wsin.read()}async readBytes(i,n,c){if(this.closed)return;await this.wsin.readBytes(i,n,c)}close(){this.closed=!0,this.socket.close(),this.wsin.close(),this.wsout.close()}onclose=i=>{if(this.closed)return;this.close()};onerror=i=>{if(this.closed)return;this.ioerror=!0,this.close()}}class A_{socket;limit;closed=!1;ioerror=!1;constructor(i,n){this.socket=i,this.limit=n}write(i,n){if(this.closed)return;if(this.ioerror)throw this.ioerror=!1,new Error;if(n>this.limit||i.length>this.limit)throw new Error;try{this.socket.send(i.slice(0,n))}catch(i){this.ioerror=!0}}close(){this.closed=!0}}class X_{bytes;position;constructor(i){this.bytes=i,this.position=0}get available(){return this.bytes.length-this.position}get read(){return this.bytes[this.position++]}get len(){return this.bytes.length}}class W_{limit;queue=[];event=null;callback=null;closed=!1;total=0;constructor(i,n){this.limit=n,i.binaryType="arraybuffer",i.onmessage=this.onmessage}get available(){return this.total}onmessage=i=>{if(this.closed)throw new Error;let n=new X_(new Uint8Array(i.data));if(this.total+=n.available,this.callback){let i=this.callback;this.callback=null,i(n)}else this.queue.push(n)};async read(){if(this.closed)throw new Error;return await Promise.race([new Promise(i=>{if(!this.event||0===this.event.available)this.event=this.queue.shift()??null;if(this.event&&this.event.available>0)i(this.event.read),this.total--;else this.callback=n=>{this.event=n,this.total--,i(n.read)}}),new Promise((i,n)=>{setTimeout(()=>{if(this.closed)n(new Error);else n(new Error)},2e4)})])}async readBytes(i,n,c){if(this.closed)throw new Error;for(let d=0;d<c;d++)i[n+d]=await this.read();return i}close(){this.closed=!0,this.callback=null,this.event=null,this.queue=[]}}class i0{db;constructor(i){i.onerror=this.onerror,i.onclose=this.onclose,this.db=i}static async openDatabase(){return await new Promise((i,n)=>{let c=indexedDB.open("lostcity",1);c.onsuccess=n=>{let c=n.target;i(c.result)},c.onupgradeneeded=i=>{i.target.result.createObjectStore("cache")},c.onerror=i=>{let c=i.target;n(c.result)}})}async cacheload(i){return await new Promise(n=>{let c=this.db.transaction("cache","readonly").objectStore("cache").get(i);c.onsuccess=()=>{if(c.result)n(new Uint8Array(c.result));else n(void 0)},c.onerror=()=>{n(void 0)}})}async cachesave(i,n){if(null===n)return;return await new Promise((c,d)=>{let u=this.db.transaction("cache","readwrite").objectStore("cache").put(n,i);u.onsuccess=()=>{c()},u.onerror=()=>{c()}})}onclose=i=>{};onerror=i=>{}}class a0{count=0;rsl=new Int32Array(256);mem=new Int32Array(256);a=0;b=0;c=0;constructor(i){for(let n=0;n<i.length;n++)this.rsl[n]=i[n];this.init()}get nextInt(){if(0===this.count--)this.isaac(),this.count=255;return this.rsl[this.count]}init(){let i=2654435769,n=2654435769,c=2654435769,d=2654435769,u=2654435769,m=2654435769,v=2654435769,S=2654435769;for(let b=0;b<4;b++)i^=n<<11,d+=i,n+=c,n^=c>>>2,u+=n,c+=d,c^=d<<8,m+=c,d+=u,d^=u>>>16,v+=d,u+=m,u^=m<<10,S+=u,m+=v,m^=v>>>4,i+=m,v+=S,v^=S<<8,n+=v,S+=i,S^=i>>>9,c+=S,i+=n;for(let b=0;b<256;b+=8)i+=this.rsl[b],n+=this.rsl[b+1],c+=this.rsl[b+2],d+=this.rsl[b+3],u+=this.rsl[b+4],m+=this.rsl[b+5],v+=this.rsl[b+6],S+=this.rsl[b+7],i^=n<<11,d+=i,n+=c,n^=c>>>2,u+=n,c+=d,c^=d<<8,m+=c,d+=u,d^=u>>>16,v+=d,u+=m,u^=m<<10,S+=u,m+=v,m^=v>>>4,i+=m,v+=S,v^=S<<8,n+=v,S+=i,S^=i>>>9,c+=S,i+=n,this.mem[b]=i,this.mem[b+1]=n,this.mem[b+2]=c,this.mem[b+3]=d,this.mem[b+4]=u,this.mem[b+5]=m,this.mem[b+6]=v,this.mem[b+7]=S;for(let b=0;b<256;b+=8)i+=this.mem[b],n+=this.mem[b+1],c+=this.mem[b+2],d+=this.mem[b+3],u+=this.mem[b+4],m+=this.mem[b+5],v+=this.mem[b+6],S+=this.mem[b+7],i^=n<<11,d+=i,n+=c,n^=c>>>2,u+=n,c+=d,c^=d<<8,m+=c,d+=u,d^=u>>>16,v+=d,u+=m,u^=m<<10,S+=u,m+=v,m^=v>>>4,i+=m,v+=S,v^=S<<8,n+=v,S+=i,S^=i>>>9,c+=S,i+=n,this.mem[b]=i,this.mem[b+1]=n,this.mem[b+2]=c,this.mem[b+3]=d,this.mem[b+4]=u,this.mem[b+5]=m,this.mem[b+6]=v,this.mem[b+7]=S;this.isaac(),this.count=256}isaac(){this.c++,this.b+=this.c;for(let i=0;i<256;i++){let n=this.mem[i],c=3&i;if(0===c)this.a^=this.a<<13;else if(1===c)this.a^=this.a>>>6;else if(2===c)this.a^=this.a<<2;else if(3===c)this.a^=this.a>>>16;let d;this.a+=this.mem[i+128&255],this.mem[i]=d=this.mem[n>>>2&255]+this.a+this.b,this.rsl[i]=this.b=this.mem[d>>>8>>>2&255]+n}}}import{BZip2 as M_}from"./deps.js";class C0{static genHash(i){let n=0;i=i.toUpperCase();for(let c=0;c<i.length;c++)n=61*n+i.charCodeAt(c)-32|0;return n}jagSrc;compressedWhole;fileCount;fileHash;fileUnpackedSize;filePackedSize;fileOffset;fileUnpacked=[];constructor(i){let n=new f(new Uint8Array(i)),c=n.g3(),d;if(c===n.g3())this.jagSrc=i,this.compressedWhole=!1;else this.jagSrc=M_.decompress(i.subarray(6),c,!0),n=new f(new Uint8Array(this.jagSrc)),this.compressedWhole=!0;this.fileCount=n.g2(),this.fileHash=[],this.fileUnpackedSize=[],this.filePackedSize=[],this.fileOffset=[];let u=n.pos+10*this.fileCount;for(let i=0;i<this.fileCount;i++)this.fileHash.push(n.g4()),this.fileUnpackedSize.push(n.g3()),this.filePackedSize.push(n.g3()),this.fileOffset.push(u),u+=this.filePackedSize[i]}read(i){let n=C0.genHash(i),c=this.fileHash.indexOf(n);if(-1===c)return null;return this.readIndex(c)}readIndex(i){if(i<0||i>=this.fileCount)return null;if(this.fileUnpacked[i])return this.fileUnpacked[i];let n=this.fileOffset[i],c=n+this.filePackedSize[i],d=new Uint8Array(this.jagSrc.subarray(n,n+c));if(this.compressedWhole)return this.fileUnpacked[i]=d,d;else{let n=M_.decompress(d,this.fileUnpackedSize[i],!0);return this.fileUnpacked[i]=n,n}}}var B_=[0,-2,4,6,-1,0,0,2,0,0,0,0,5,4,2,2,0,0,0,0,2,-2,2,14,0,6,3,0,4,0,0,0,3,0,0,0,0,0,0,0,0,-1,4,2,6,0,6,0,0,3,7,0,0,0,-1,0,0,0,0,4,0,0,0,0,0,0,0,0,1,15,0,0,0,0,6,0,2,0,0,0,2,0,0,0,1,0,0,4,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,-2,0,0,2,0,0,0,2,9,0,0,0,0,0,4,0,0,0,3,7,9,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,3,2,0,0,0,0,0,0,6,0,0,0,0,0,0,0,0,-2,2,0,0,0,0,0,6,0,0,0,2,0,2,0,0,0,-2,0,0,4,0,0,0,0,6,0,0,-2,-2,0,0,0,0,0,0,-2,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0];class D0{static PERIOD=new Uint16Array(["d","o","t"].join("").split("").map(i=>i.charCodeAt(0)));static AMPERSAT=new Uint16Array(["(","a",")"].join("").split("").map(i=>i.charCodeAt(0)));static SLASH=new Uint16Array(["s","l","a","s","h"].join("").split("").map(i=>i.charCodeAt(0)));static whitelist=["cook","cook's","cooks","seeks","sheet"];static tlds=[];static tldTypes=[];static bads=[];static badCombinations=[];static domains=[];static fragments=[];static unpack(i){let n=new f(i.read("fragmentsenc.txt")),c=new f(i.read("badenc.txt")),d=new f(i.read("domainenc.txt")),u=new f(i.read("tldlist.txt"));this.read(c,d,n,u)}static filter(i){let n=[...i];this.format(n);let c=n.join("").trim(),d=c.toLowerCase(),u=[...d];this.filterTlds(u),this.filterBadWords(u),this.filterDomains(u),this.filterFragments(u);for(let i=0;i<this.whitelist.length;i++){let n=-1;while(-1!==(n=d.indexOf(this.whitelist[i],n+1))){let c=[...this.whitelist[i]];for(let i=0;i<c.length;i++)u[i+n]=c[i]}}return this.replaceUppercases(u,[...c]),this.formatUppercases(u),u.join("").trim()}static read(i,n,c,d){this.readBadWords(i),this.readDomains(n),this.readFragments(c),this.readTld(d)}static readTld(i){let n=i.g4();for(let c=0;c<n;c++)this.tldTypes[c]=i.g1(),this.tlds[c]=new Uint16Array(i.g1()).map(()=>i.g1())}static readBadWords(i){let n=i.g4();for(let c=0;c<n;c++){this.bads[c]=new Uint16Array(i.g1()).map(()=>i.g1());let n=new Array(i.g1()).fill([]).map(()=>[i.g1b(),i.g1b()]);if(n.length>0)this.badCombinations[c]=n}}static readDomains(i){let n=i.g4();for(let c=0;c<n;c++)this.domains[c]=new Uint16Array(i.g1()).map(()=>i.g1())}static readFragments(i){let n=i.g4();for(let c=0;c<n;c++)this.fragments[c]=i.g2()}static filterTlds(i){let n=[...i],c=[...i];this.filterBadCombinations(null,n,this.PERIOD),this.filterBadCombinations(null,c,this.SLASH);for(let d=0;d<this.tlds.length;d++)this.filterTld(c,this.tldTypes[d],i,this.tlds[d],n)}static filterBadWords(i){for(let n=0;n<2;n++)for(let n=this.bads.length-1;n>=0;n--)this.filterBadCombinations(this.badCombinations[n],i,this.bads[n])}static filterDomains(i){let n=[...i],c=[...i];this.filterBadCombinations(null,n,this.AMPERSAT),this.filterBadCombinations(null,c,this.PERIOD);for(let d=this.domains.length-1;d>=0;d--)this.filterDomain(c,n,this.domains[d],i)}static filterFragments(i){for(let n=0;n<i.length;){let c=this.indexOfNumber(i,n);if(-1===c)return;let d=!1;for(let u=n;u>=0&&u<c&&!d;u++)if(!this.isSymbol(i[u])&&!this.isNotLowercaseAlpha(i[u]))d=!0;let u=0;if(d)u=0;if(0===u)u=1,n=c;let m=0;for(let d=c;d<i.length&&d<n;d++)m=10*m+i[d].charCodeAt(0)-48;if(m<=255&&n-c<=8)u++;else u=0;if(4===u)this.maskChars(c,n,i),u=0;n=this.indexOfNonNumber(n,i)}}static isBadFragment(i){if(this.isNumericalChars(i))return!0;let n=this.getInteger(i),c=this.fragments,d=c.length;if(n===c[0]||n===c[d-1])return!0;let u=0,m=d-1;while(u<=m){let i=(u+m)/2|0;if(n===c[i])return!0;else if(n<c[i])m=i-1;else u=i+1}return!1}static getInteger(i){if(i.length>6)return 0;let n=0;for(let c=0;c<i.length;c++){let d=i[i.length-c-1];if(this.isLowercaseAlpha(d))n=38*n+d.charCodeAt(0)+1-97;else if("'"===d)n=38*n+27;else if(this.isNumerical(d))n=38*n+d.charCodeAt(0)+28-48;else if("\0"!==d)return 0}return n}static indexOfNumber(i,n){for(let c=n;c<i.length&&c>=0;c++)if(this.isNumerical(i[c]))return c;return-1}static indexOfNonNumber(i,n){for(let c=i;c<n.length&&c>=0;c++)if(!this.isNumerical(n[c]))return c;return n.length}static getEmulatedDomainCharLen(i,n,c){if(n===c)return 1;else if("o"===n&&"0"===c)return 1;else if("o"===n&&"("===c&&")"===i)return 2;else if("c"===n&&("("===c||"<"===c||"["===c))return 1;else if("e"===n&&"â¬"===c)return 1;else if("s"===n&&"$"===c)return 1;else if("l"===n&&"i"===c)return 1;return 0}static filterDomain(i,n,c,d){let u=c.length,m=d.length;for(let v=0;v<=m-u;v++){let{matched:u,currentIndex:m}=this.findMatchingDomain(v,c,d);if(!u)continue;let S=this.prefixSymbolStatus(v,d,3,n,["@"]),b=this.suffixSymbolStatus(m-1,d,3,i,[".",","]);if(!(S>2||b>2))continue;this.maskChars(v,m,d)}}static findMatchingDomain(i,n,c){let d=n.length,u=i,m=0;while(u<c.length&&m<d){let v=c[u],S=u+1<c.length?c[u+1]:"\0",b=this.getEmulatedDomainCharLen(S,String.fromCharCode(n[m]),v);if(b>0)u+=b,m++;else{if(0===m)break;let c=this.getEmulatedDomainCharLen(S,String.fromCharCode(n[m-1]),v);if(c>0){if(u+=c,1===m)i++}else{if(m>=d||!this.isSymbol(v))break;u++}}}return{matched:m>=d,currentIndex:u}}static filterBadCombinations(i,n,c){if(c.length>n.length)return;for(let d=0;d<=n.length-c.length;d++){let u=d,{currentIndex:m,badIndex:v,hasSymbol:S,hasNumber:b,hasDigit:x}=this.processBadCharacters(n,c,u);u=m;let I=n[u],A=u+1<n.length?n[u+1]:"\0";if(!(v>=c.length&&(!b||!x)))continue;let k=!0,L;if(S){let i=!1,c=!1;if(d-1<0||this.isSymbol(n[d-1])&&"'"!==n[d-1])i=!0;if(u>=n.length||this.isSymbol(n[u])&&"'"!==n[u])c=!0;if(!i||!c){let c=!1;if(L=d-2,i)L=d;while(!c&&L<u){if(L>=0&&(!this.isSymbol(n[L])||"'"===n[L])){let i=[],d;for(d=0;d<3&&L+d<n.length&&(!this.isSymbol(n[L+d])||"'"===n[L+d]);d++)i[d]=n[L+d];let u=!0;if(0===d)u=!1;if(d<3&&L-1>=0&&(!this.isSymbol(n[L-1])||"'"===n[L-1]))u=!1;if(u&&!this.isBadFragment(i))c=!0}L++}if(!c)k=!1}}else{if(I=" ",d-1>=0)I=n[d-1];if(A=" ",u<n.length)A=n[u];let c=this.getIndex(I),m=this.getIndex(A);if(i&&this.comboMatches(c,i,m))k=!1}if(!k)continue;let O=0,X=0;for(let i=d;i<u;i++)if(this.isNumerical(n[i]))O++;else if(this.isAlpha(n[i]))X++;if(O<=X)this.maskChars(d,u,n)}}static processBadCharacters(i,n,c){let d=c,u=0,m=0,v=!1,S=!1,b=!1;for(;d<i.length&&!(S&&b);){if(d>=i.length||S&&b)break;let x=i[d],I=d+1<i.length?i[d+1]:"\0",A;if(u<n.length&&(A=this.getEmulatedBadCharLen(I,String.fromCharCode(n[u]),x))>0){if(1===A&&this.isNumerical(x))S=!0;if(2===A&&(this.isNumerical(x)||this.isNumerical(I)))S=!0;d+=A,u++}else{if(0===u)break;let i;if((i=this.getEmulatedBadCharLen(I,String.fromCharCode(n[u-1]),x))>0)d+=i;else{if(u>=n.length||!this.isNotLowercaseAlpha(x))break;if(this.isSymbol(x)&&"'"!==x)v=!0;if(this.isNumerical(x))b=!0;if(d++,m++,(100*m/(d-c)|0)>90)break}}}return{currentIndex:d,badIndex:u,hasSymbol:v,hasNumber:S,hasDigit:b}}static getEmulatedBadCharLen(i,n,c){if(n===c)return 1;if(n>="a"&&n<="m"){if("a"===n){if("4"!==c&&"@"!==c&&"^"!==c){if("/"===c&&"\\"===i)return 2;return 0}return 1}if("b"===n){if("6"!==c&&"8"!==c){if("1"===c&&"3"===i)return 2;return 0}return 1}if("c"===n){if("("!==c&&"<"!==c&&"{"!==c&&"["!==c)return 0;return 1}if("d"===n){if("["===c&&")"===i)return 2;return 0}if("e"===n){if("3"!==c&&"â¬"!==c)return 0;return 1}if("f"===n){if("p"===c&&"h"===i)return 2;if("Â£"===c)return 1;return 0}if("g"===n){if("9"!==c&&"6"!==c)return 0;return 1}if("h"===n){if("#"===c)return 1;return 0}if("i"===n){if("y"!==c&&"l"!==c&&"j"!==c&&"1"!==c&&"!"!==c&&":"!==c&&";"!==c&&"|"!==c)return 0;return 1}if("j"===n)return 0;if("k"===n)return 0;if("l"===n){if("1"!==c&&"|"!==c&&"i"!==c)return 0;return 1}if("m"===n)return 0}if(n>="n"&&n<="z"){if("n"===n)return 0;if("o"===n){if("0"!==c&&"*"!==c){if(!("("===c&&")"===i||"["===c&&"]"===i||"{"===c&&"}"===i||"<"===c&&">"===i))return 0;return 2}return 1}if("p"===n)return 0;if("q"===n)return 0;if("r"===n)return 0;if("s"===n){if("5"!==c&&"z"!==c&&"$"!==c&&"2"!==c)return 0;return 1}if("t"===n){if("7"!==c&&"+"!==c)return 0;return 1}if("u"===n){if("v"===c)return 1;if(!("\\"===c&&"/"===i||"\\"===c&&"|"===i||"|"===c&&"/"===i))return 0;return 2}if("v"===n){if(!("\\"===c&&"/"===i||"\\"===c&&"|"===i||"|"===c&&"/"===i))return 0;return 2}if("w"===n){if("v"===c&&"v"===i)return 2;return 0}if("x"===n){if(!(")"===c&&"("===i||"}"===c&&"{"===i||"]"===c&&"["===i||">"===c&&"<"===i))return 0;return 2}if("y"===n)return 0;if("z"===n)return 0}if(n>="0"&&n<="9")if("0"===n)if("o"===c||"O"===c)return 1;else if(!("("===c&&")"===i||"{"===c&&"}"===i||"["===c&&"]"===i))return 0;else return 2;else if("1"===n)return"l"===c?1:0;else return 0;else if(","===n)return"."===c?1:0;else if("."===n)return","===c?1:0;else if("!"===n)return"i"===c?1:0;return 0}static comboMatches(i,n,c){let d=0,u=n.length-1;while(d<=u){let m=(d+u)/2|0;if(n[m][0]===i&&n[m][1]===c)return!0;else if(i<n[m][0]||i===n[m][0]&&c<n[m][1])u=m-1;else d=m+1}return!1}static getIndex(i){if(this.isLowercaseAlpha(i))return i.charCodeAt(0)+1-97;else if("'"===i)return 28;else if(this.isNumerical(i))return i.charCodeAt(0)+29-48;return 27}static filterTld(i,n,c,d,u){if(d.length>c.length)return;for(let m=0;m<=c.length-d.length;m++){let{currentIndex:v,tldIndex:S}=this.processTlds(c,d,m);if(S<d.length)continue;let b=!1,x=this.prefixSymbolStatus(m,c,3,u,[",","."]),I=this.suffixSymbolStatus(v-1,c,5,i,["\\","/"]);if(1===n&&x>0&&I>0)b=!0;if(2===n&&(x>2&&I>0||x>0&&I>2))b=!0;if(3===n&&x>0&&I>2)b=!0;if(!b)continue;let A=m,k=v-1,L=!1,O;if(x>2){if(4===x)for(L=!1,O=m-1;O>=0;O--)if(L){if("*"!==u[O])break;A=O}else if("*"===u[O])A=O,L=!0;for(L=!1,O=A-1;O>=0;O--)if(L){if(this.isSymbol(c[O]))break;A=O}else if(!this.isSymbol(c[O]))L=!0,A=O}if(I>2){if(4===I)for(L=!1,O=k+1;O<c.length;O++)if(L){if("*"!==i[O])break;k=O}else if("*"===i[O])k=O,L=!0;for(L=!1,O=k+1;O<c.length;O++)if(L){if(this.isSymbol(c[O]))break;k=O}else if(!this.isSymbol(c[O]))L=!0,k=O}this.maskChars(A,k+1,c)}}static processTlds(i,n,c){let d=0;while(c<i.length&&d<n.length){let u=i[c],m=c+1<i.length?i[c+1]:"\0",v;if((v=this.getEmulatedDomainCharLen(m,String.fromCharCode(n[d]),u))>0)c+=v,d++;else{if(0===d)break;let i;if((i=this.getEmulatedDomainCharLen(m,String.fromCharCode(n[d-1]),u))>0)c+=i;else{if(!this.isSymbol(u))break;c++}}}return{currentIndex:c,tldIndex:d}}static isSymbol(i){return!this.isAlpha(i)&&!this.isNumerical(i)}static isNotLowercaseAlpha(i){return this.isLowercaseAlpha(i)?"v"===i||"x"===i||"j"===i||"q"===i||"z"===i:!0}static isAlpha(i){return this.isLowercaseAlpha(i)||this.isUppercaseAlpha(i)}static isNumerical(i){return i>="0"&&i<="9"}static isLowercaseAlpha(i){return i>="a"&&i<="z"}static isUppercaseAlpha(i){return i>="A"&&i<="Z"}static isNumericalChars(i){for(let n=0;n<i.length;n++)if(!this.isNumerical(i[n])&&"\0"!==i[n])return!1;return!0}static maskChars(i,n,c){for(let d=i;d<n;d++)c[d]="*"}static maskedCountBackwards(i,n){let c=0;for(let d=n-1;d>=0&&this.isSymbol(i[d]);d--)if("*"===i[d])c++;return c}static maskedCountForwards(i,n){let c=0;for(let d=n+1;d<i.length&&this.isSymbol(i[d]);d++)if("*"===i[d])c++;return c}static maskedCharsStatus(i,n,c,d,u){if((u?this.maskedCountBackwards(n,c):this.maskedCountForwards(n,c))>=d)return 4;else if(this.isSymbol(u?i[c-1]:i[c+1]))return 1;return 0}static prefixSymbolStatus(i,n,c,d,u){if(0===i)return 2;for(let c=i-1;c>=0&&this.isSymbol(n[c]);c--)if(u.includes(n[c]))return 3;return this.maskedCharsStatus(n,d,i,c,!0)}static suffixSymbolStatus(i,n,c,d,u){if(i+1===n.length)return 2;for(let c=i+1;c<n.length&&this.isSymbol(n[c]);c++)if(u.includes(n[c]))return 3;return this.maskedCharsStatus(n,d,i,c,!1)}static format(i){let n=0;for(let c=0;c<i.length;c++){if(this.isCharacterAllowed(i[c]))i[n]=i[c];else i[n]=" ";if(0===n||" "!==i[n]||" "!==i[n-1])n++}for(let c=n;c<i.length;c++)i[c]=" "}static isCharacterAllowed(i){return i>=" "&&i<=""||" "===i||i===`\n`||"\t"===i||"Â£"===i||"â¬"===i}static replaceUppercases(i,n){for(let c=0;c<n.length;c++)if("*"!==i[c]&&this.isUppercaseAlpha(n[c]))i[c]=n[c]}static formatUppercases(i){let n=!0;for(let c=0;c<i.length;c++){let d=i[c];if(!this.isAlpha(d))n=!0;else if(n){if(this.isLowercaseAlpha(d))n=!1}else if(this.isUppercaseAlpha(d))i[c]=String.fromCharCode(d.charCodeAt(0)+97-65)}}}class v0{static TABLE=[" ","e","t","a","o","i","h","n","s","r","d","l","u","m","w","c","y","f","g","p","b","v","k","x","j","q","z","0","1","2","3","4","5","6","7","8","9"," ","!","?",".",",",":",";","(",")","-","&","*","\\","'","@","#","+","=","Â£","$","%",'"',"[","]"];static charBuffer=[];static unpack(i,n){let c=0,d=-1,u;for(let m=0;m<n&&c<100;m++){let n=i.g1();if(u=n>>4&15,-1!==d)this.charBuffer[c++]=this.TABLE[(d<<4)+u-195],d=-1;else if(u<13)this.charBuffer[c++]=this.TABLE[u];else d=u;if(u=15&n,-1!==d)this.charBuffer[c++]=this.TABLE[(d<<4)+u-195],d=-1;else if(u<13)this.charBuffer[c++]=this.TABLE[u];else d=u}let m=!0;for(let i=0;i<c;i++){let n=this.charBuffer[i];if(m&&n>="a"&&n<="z")this.charBuffer[i]=n.toUpperCase(),m=!1;if("."===n||"!"===n)m=!0}return this.charBuffer.slice(0,c).join("")}static pack(i,n){if(n.length>80)n=n.substring(0,80);n=n.toLowerCase();let c=-1;for(let d=0;d<n.length;d++){let u=n.charAt(d),m=0;for(let i=0;i<this.TABLE.length;i++)if(u===this.TABLE[i]){m=i;break}if(m>12)m+=195;if(-1===c)if(m<13)c=m;else i.p1(m);else if(m<13)i.p1((c<<4)+m),c=-1;else i.p1((c<<4)+(m>>4)),c=15&m}if(-1!==c)i.p1(c<<4)}}class M0{start=0;end=0;form=0;envLength=0;shapeDelta=null;shapePeak=null;envThreshold=0;envPosition=0;delta=0;envAmplitude=0;ticks=0;read(i){this.form=i.g1(),this.start=i.g4(),this.end=i.g4(),this.envLength=i.g1(),this.shapeDelta=new Int32Array(this.envLength),this.shapePeak=new Int32Array(this.envLength);for(let n=0;n<this.envLength;n++)this.shapeDelta[n]=i.g2(),this.shapePeak[n]=i.g2()}reset(){this.envThreshold=0,this.envPosition=0,this.delta=0,this.envAmplitude=0,this.ticks=0}evaluateAt(i){if(this.ticks>=this.envThreshold&&this.shapePeak&&this.shapeDelta){if(this.envAmplitude=this.shapePeak[this.envPosition++]<<15,this.envPosition>=this.envLength)this.envPosition=this.envLength-1;if(this.envThreshold=this.shapeDelta[this.envPosition]/65536*i|0,this.envThreshold>this.ticks)this.delta=((this.shapePeak[this.envPosition]<<15)-this.envAmplitude)/(this.envThreshold-this.ticks)|0}return this.envAmplitude+=this.delta,this.ticks++,this.envAmplitude-this.delta>>15}}class L0{static toneSrc=null;static noise=null;static sin=null;static tmpPhases=new Int32Array(5);static tmpDelays=new Int32Array(5);static tmpVolumes=new Int32Array(5);static tmpSemitones=new Int32Array(5);static tmpStarts=new Int32Array(5);frequencyBase=null;amplitudeBase=null;frequencyModRate=null;frequencyModRange=null;amplitudeModRate=null;amplitudeModRange=null;envRelease=null;envAttack=null;harmonicVolume=new Int32Array(5);harmonicSemitone=new Int32Array(5);harmonicDelay=new Int32Array(5);toneStart=0;toneLength=500;reverbVolume=100;reverbDelay=0;static init(){this.noise=new Int32Array(32768);for(let i=0;i<32768;i++)if(Math.random()>.5)this.noise[i]=1;else this.noise[i]=-1;this.sin=new Int32Array(32768);for(let i=0;i<32768;i++)this.sin[i]=16384*Math.sin(i/5215.1903)|0;this.toneSrc=new Int32Array(220500)}generate(i,n){for(let n=0;n<i;n++)L0.toneSrc[n]=0;if(n<10)return L0.toneSrc;let c=i/n|0;this.frequencyBase?.reset(),this.amplitudeBase?.reset();let d=0,u=0,m=0;if(this.frequencyModRate&&this.frequencyModRange)this.frequencyModRate.reset(),this.frequencyModRange.reset(),d=32.768*(this.frequencyModRate.end-this.frequencyModRate.start)/c|0,u=32.768*this.frequencyModRate.start/c|0;let v=0,S=0,b=0;if(this.amplitudeModRate&&this.amplitudeModRange)this.amplitudeModRate.reset(),this.amplitudeModRange.reset(),v=32.768*(this.amplitudeModRate.end-this.amplitudeModRate.start)/c|0,S=32.768*this.amplitudeModRate.start/c|0;for(let i=0;i<5;i++)if(this.frequencyBase&&0!==this.harmonicVolume[i])L0.tmpPhases[i]=0,L0.tmpDelays[i]=this.harmonicDelay[i]*c,L0.tmpVolumes[i]=(this.harmonicVolume[i]<<14)/100|0,L0.tmpSemitones[i]=32.768*(this.frequencyBase.end-this.frequencyBase.start)*Math.pow(1.0057929410678534,this.harmonicSemitone[i])/c|0,L0.tmpStarts[i]=32.768*this.frequencyBase.start/c|0;if(this.frequencyBase&&this.amplitudeBase)for(let n=0;n<i;n++){let c=this.frequencyBase.evaluateAt(i),x=this.amplitudeBase.evaluateAt(i);if(this.frequencyModRate&&this.frequencyModRange){let n=this.frequencyModRate.evaluateAt(i),v=this.frequencyModRange.evaluateAt(i);c+=this.generate2(v,m,this.frequencyModRate.form)>>1,m+=(n*d>>16)+u}if(this.amplitudeModRate&&this.amplitudeModRange){let n=this.amplitudeModRate.evaluateAt(i),c=this.amplitudeModRange.evaluateAt(i);x=x*((this.generate2(c,b,this.amplitudeModRate.form)>>1)+32768)>>15,b+=(n*v>>16)+S}for(let d=0;d<5;d++)if(0!==this.harmonicVolume[d]){let u=n+L0.tmpDelays[d];if(u<i)L0.toneSrc[u]+=this.generate2(x*L0.tmpVolumes[d]>>15,L0.tmpPhases[d],this.frequencyBase.form),L0.tmpPhases[d]+=(c*L0.tmpSemitones[d]>>16)+L0.tmpStarts[d]}}if(this.envRelease&&this.envAttack){this.envRelease.reset(),this.envAttack.reset();let n=0,c=!0;for(let d=0;d<i;d++){let u=this.envRelease.evaluateAt(i),m=this.envAttack.evaluateAt(i),v;if(c)v=this.envRelease.start+((this.envRelease.end-this.envRelease.start)*u>>8);else v=this.envRelease.start+((this.envRelease.end-this.envRelease.start)*m>>8);if(n+=256,n>=v)n=0,c=!c;if(c)L0.toneSrc[d]=0}}if(this.reverbDelay>0&&this.reverbVolume>0){let n=this.reverbDelay*c;for(let c=n;c<i;c++)L0.toneSrc[c]+=L0.toneSrc[c-n]*this.reverbVolume/100|0,L0.toneSrc[c]|=0}for(let n=0;n<i;n++){if(L0.toneSrc[n]<-32768)L0.toneSrc[n]=-32768;if(L0.toneSrc[n]>32767)L0.toneSrc[n]=32767}return L0.toneSrc}generate2(i,n,c){if(1===c)return(32767&n)<16384?i:-i;else if(2===c)return L0.sin[32767&n]*i>>14;else if(3===c)return((32767&n)*i>>14)-i;else if(4===c)return L0.noise[32767&(n/2607|0)]*i;else return 0}read(i){if(this.frequencyBase=new M0,this.frequencyBase.read(i),this.amplitudeBase=new M0,this.amplitudeBase.read(i),0!==i.g1())i.pos--,this.frequencyModRate=new M0,this.frequencyModRate.read(i),this.frequencyModRange=new M0,this.frequencyModRange.read(i);if(0!==i.g1())i.pos--,this.amplitudeModRate=new M0,this.amplitudeModRate.read(i),this.amplitudeModRange=new M0,this.amplitudeModRange.read(i);if(0!==i.g1())i.pos--,this.envRelease=new M0,this.envRelease.read(i),this.envAttack=new M0,this.envAttack.read(i);for(let n=0;n<10;n++){let c=i.gsmarts();if(0===c)break;this.harmonicVolume[n]=c,this.harmonicSemitone[n]=i.gsmart(),this.harmonicDelay[n]=i.gsmarts()}this.reverbDelay=i.gsmarts(),this.reverbVolume=i.gsmarts(),this.toneLength=i.g2(),this.toneStart=i.g2()}}class E0{static delays=new Int32Array(1e3);static waveBytes=null;static waveBuffer=null;static tracks=new C(1e3,null);tones=new C(10,null);waveLoopBegin=0;waveLoopEnd=0;static unpack(i){let n=new f(i.read("sounds.dat"));this.waveBytes=new Uint8Array(441e3),this.waveBuffer=new f(this.waveBytes),L0.init();while(!0){let i=n.g2();if(65535===i)break;let c=new E0;c.read(n),this.tracks[i]=c,this.delays[i]=c.trim()}}static generate(i,n){if(!this.tracks[i])return null;return this.tracks[i]?.getWave(n)??null}read(i){for(let n=0;n<10;n++)if(0!==i.g1())i.pos--,this.tones[n]=new L0,this.tones[n]?.read(i);this.waveLoopBegin=i.g2(),this.waveLoopEnd=i.g2()}trim(){let i=9999999;for(let n=0;n<10;n++)if(this.tones[n]&&(this.tones[n].toneStart/20|0)<i)i=this.tones[n].toneStart/20|0;if(this.waveLoopBegin<this.waveLoopEnd&&(this.waveLoopBegin/20|0)<i)i=this.waveLoopBegin/20|0;if(9999999===i||0===i)return 0;for(let n=0;n<10;n++)if(this.tones[n])this.tones[n].toneStart-=20*i;if(this.waveLoopBegin<this.waveLoopEnd)this.waveLoopBegin-=20*i,this.waveLoopEnd-=20*i;return i}getWave(i){let n=this.generate(i);return E0.waveBuffer.pos=0,E0.waveBuffer?.p4(1380533830),E0.waveBuffer?.ip4(n+36),E0.waveBuffer?.p4(1463899717),E0.waveBuffer?.p4(1718449184),E0.waveBuffer?.ip4(16),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip4(22050),E0.waveBuffer?.ip4(22050),E0.waveBuffer?.ip2(1),E0.waveBuffer?.ip2(8),E0.waveBuffer?.p4(1684108385),E0.waveBuffer?.ip4(n),E0.waveBuffer.pos+=n,E0.waveBuffer}generate(i){let n=0;for(let i=0;i<10;i++)if(this.tones[i]&&this.tones[i].toneLength+this.tones[i].toneStart>n)n=this.tones[i].toneLength+this.tones[i].toneStart;if(0===n)return 0;let c=22050*n/1e3|0,d=22050*this.waveLoopBegin/1e3|0,u=22050*this.waveLoopEnd/1e3|0;if(d<0||u<0||u>c||d>=u)i=0;let m=c+(u-d)*(i-1);for(let i=44;i<m+44;i++)if(E0.waveBytes)E0.waveBytes[i]=-128;for(let i=0;i<10;i++)if(this.tones[i]){let n=22050*this.tones[i].toneLength/1e3|0,c=22050*this.tones[i].toneStart/1e3|0,d=this.tones[i].generate(n,this.tones[i].toneLength);for(let i=0;i<n;i++)if(E0.waveBytes)E0.waveBytes[i+c+44]+=d[i]>>8<<24>>24}if(i>1){d+=44,u+=44,c+=44,m+=44;let n=m-c;for(let i=c-1;i>=u;i--)if(E0.waveBytes)E0.waveBytes[i+n]=E0.waveBytes[i];for(let n=1;n<i;n++){let i=(u-d)*n;for(let n=d;n<u;n++)if(E0.waveBytes)E0.waveBytes[n+i]=E0.waveBytes[n]}m-=44}return m}}class p extends l0{static nodeId=10;static members=!0;static lowMemory=!1;static cyclelogic1=0;static cyclelogic2=0;static cyclelogic3=0;static cyclelogic4=0;static cyclelogic5=0;static cyclelogic6=0;static oplogic1=0;static oplogic2=0;static oplogic3=0;static oplogic4=0;static oplogic5=0;static oplogic6=0;static oplogic7=0;static oplogic8=0;static oplogic9=0;alreadyStarted=!1;errorStarted=!1;errorLoading=!1;errorHost=!1;errorMessage=null;db=null;loopCycle=0;archiveChecksums=[];netStream=null;in=f.alloc(1);out=f.alloc(1);loginout=f.alloc(1);serverSeed=0n;idleNetCycles=0;idleTimeout=0;systemUpdateTimer=0;randomIn=null;inPacketType=0;inPacketSize=0;lastPacketType0=0;lastPacketType1=0;lastPacketType2=0;titleArchive=null;redrawTitleBackground=!0;titleScreenState=0;titleLoginField=0;imageTitle2=null;imageTitle3=null;imageTitle4=null;imageTitle0=null;imageTitle1=null;imageTitle5=null;imageTitle6=null;imageTitle7=null;imageTitle8=null;imageTitlebox=null;imageTitlebutton=null;loginMessage0="";loginMessage1="";usernameInput="";passwordInput="";fontPlain11=null;fontPlain12=null;fontBold12=null;fontQuill8=null;imageRunes=[];flameActive=!1;imageFlamesLeft=null;imageFlamesRight=null;flameBuffer1=null;flameBuffer0=null;flameBuffer3=null;flameBuffer2=null;flameGradient=null;flameGradient0=null;flameGradient1=null;flameGradient2=null;flameLineOffset=new Int32Array(256);flameCycle0=0;flameGradientCycle0=0;flameGradientCycle1=0;flamesInterval=null;areaSidebar=null;areaMapback=null;areaViewport=null;areaChatback=null;areaBackbase1=null;areaBackbase2=null;areaBackhmid1=null;areaBackleft1=null;areaBackleft2=null;areaBackright1=null;areaBackright2=null;areaBacktop1=null;areaBacktop2=null;areaBackvmid1=null;areaBackvmid2=null;areaBackvmid3=null;areaBackhmid2=null;areaChatbackOffsets=null;areaSidebarOffsets=null;areaViewportOffsets=null;compassMaskLineOffsets=new Int32Array(33);compassMaskLineLengths=new Int32Array(33);minimapMaskLineOffsets=new Int32Array(151);minimapMaskLineLengths=new Int32Array(151);imageInvback=null;imageChatback=null;imageMapback=null;imageBackbase1=null;imageBackbase2=null;imageBackhmid1=null;imageSideicons=new C(13,null);imageMinimap=null;imageCompass=null;imageMapscene=new C(50,null);imageMapfunction=new C(50,null);imageHitmarks=new C(20,null);imageHeadicons=new C(20,null);imageMapflag=null;imageCrosses=new C(8,null);imageMapdot0=null;imageMapdot1=null;imageMapdot2=null;imageMapdot3=null;imageScrollbar0=null;imageScrollbar1=null;imageRedstone1=null;imageRedstone2=null;imageRedstone3=null;imageRedstone1h=null;imageRedstone2h=null;imageRedstone1v=null;imageRedstone2v=null;imageRedstone3v=null;imageRedstone1hv=null;imageRedstone2hv=null;genderButtonImage0=null;genderButtonImage1=null;activeMapFunctions=new C(1e3,null);redrawSidebar=!1;redrawChatback=!1;redrawSideicons=!1;redrawPrivacySettings=!1;viewportInterfaceId=-1;dragCycles=0;crossMode=0;crossCycle=0;crossX=0;crossY=0;overrideChat=0;menuVisible=!1;menuArea=0;menuX=0;menuY=0;menuWidth=0;menuHeight=0;menuSize=0;menuOption=[];sidebarInterfaceId=-1;chatInterfaceId=-1;chatInterface=new s;chatScrollHeight=78;chatScrollOffset=0;ignoreCount=0;ignoreName37=[];hintType=0;hintNpc=0;hintOffsetX=0;hintOffsetZ=0;hintPlayer=0;hintTileX=0;hintTileZ=0;hintHeight=0;skillExperience=[];skillLevel=[];skillBaseLevel=[];levelExperience=[];modalMessage=null;flashingTab=-1;selectedTab=3;tabInterfaceId=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1];publicChatSetting=0;privateChatSetting=0;tradeChatSetting=0;scrollGrabbed=!1;scrollInputPadding=0;showSocialInput=!1;socialMessage="";socialInput="";socialAction=0;chatbackInput="";chatbackInputOpen=!1;stickyChatInterfaceId=-1;messageText=new C(100,null);messageTextSender=new C(100,null);messageTextType=new Int32Array(100);messageTextIds=new Int32Array(100);privateMessageCount=0;splitPrivateChat=0;chatEffects=0;chatTyped="";viewportHoveredInterfaceIndex=0;sidebarHoveredInterfaceIndex=0;chatHoveredInterfaceIndex=0;objDragInterfaceId=0;objDragSlot=0;objDragArea=0;objGrabX=0;objGrabY=0;objDragCycles=0;objGrabThreshold=!1;objSelected=0;objSelectedSlot=0;objSelectedInterface=0;objInterface=0;objSelectedName=null;selectedArea=0;selectedItem=0;selectedInterface=0;selectedCycle=0;pressedContinueOption=!1;varps=[];varCache=[];spellSelected=0;activeSpellId=0;activeSpellFlags=0;spellCaption=null;mouseButtonsOption=0;menuAction=new Int32Array(500);menuParamA=new Int32Array(500);menuParamB=new Int32Array(500);menuParamC=new Int32Array(500);hoveredSlotParentId=0;hoveredSlot=0;lastHoveredInterfaceId=0;reportAbuseInput="";reportAbuseMuteOption=!1;reportAbuseInterfaceID=-1;lastAddress=0;daysSinceLastLogin=0;daysSinceRecoveriesChanged=0;unreadMessages=0;activeMapFunctionCount=0;activeMapFunctionX=new Int32Array(1e3);activeMapFunctionZ=new Int32Array(1e3);scene=null;sceneState=0;sceneDelta=0;sceneCycle=0;flagSceneTileX=0;flagSceneTileZ=0;cutscene=!1;cameraOffsetCycle=0;cameraAnticheatOffsetX=0;cameraAnticheatOffsetZ=0;cameraAnticheatAngle=0;cameraOffsetXModifier=2;cameraOffsetZModifier=2;cameraOffsetYawModifier=1;cameraModifierCycle=new Int32Array(5);cameraModifierEnabled=new C(5,!1);cameraModifierJitter=new Int32Array(5);cameraModifierWobbleScale=new Int32Array(5);cameraModifierWobbleSpeed=new Int32Array(5);cameraX=0;cameraY=0;cameraZ=0;cameraPitch=0;cameraYaw=0;cameraPitchClamp=0;minimapOffsetCycle=0;minimapAnticheatAngle=0;minimapZoom=0;minimapZoomModifier=1;minimapAngleModifier=2;minimapLevel=-1;baseX=0;baseZ=0;sceneCenterZoneX=0;sceneCenterZoneZ=0;sceneBaseTileX=0;sceneBaseTileZ=0;sceneMapLandData=null;sceneMapLandReady=null;sceneMapLocData=null;sceneMapLocReady=null;sceneMapIndex=null;sceneAwaitingSync=!1;scenePrevBaseTileX=0;scenePrevBaseTileZ=0;textureBuffer=new Int8Array(16384);levelCollisionMap=new C(4,null);currentLevel=0;cameraMovedWrite=0;orbitCameraPitch=128;orbitCameraYaw=0;orbitCameraYawVelocity=0;orbitCameraPitchVelocity=0;orbitCameraX=0;orbitCameraZ=0;levelHeightmap=null;levelTileFlags=null;tileLastOccupiedCycle=new W0(104,104);projectX=0;projectY=0;cutsceneDstLocalTileX=0;cutsceneDstLocalTileZ=0;cutsceneDstHeight=0;cutsceneRotateSpeed=0;cutsceneRotateAcceleration=0;cutsceneSrcLocalTileX=0;cutsceneSrcLocalTileZ=0;cutsceneSrcHeight=0;cutsceneMoveSpeed=0;cutsceneMoveAcceleration=0;players=new C(2048,null);playerCount=0;playerIds=new Int32Array(2048);entityUpdateCount=0;entityRemovalCount=0;entityUpdateIds=new Int32Array(2048);entityRemovalIds=new Int32Array(1e3);playerAppearanceBuffer=new C(2048,null);npcs=new C(8192,null);npcCount=0;npcIds=new Int32Array(8192);projectiles=new m0;spotanims=new m0;locList=new m0;objStacks=new p0(4,104,104,null);addedLocs=new m0;bfsStepX=new Int32Array(4e3);bfsStepZ=new Int32Array(4e3);bfsDirection=new Int32Array(104*104);bfsCost=new Int32Array(104*104);tryMoveNearest=0;localPlayer=null;energy=0;inMultizone=0;localPid=-1;weightCarried=0;heartbeatTimer=0;wildernessLevel=0;worldLocationState=0;rights=!1;designGenderMale=!0;updateDesignModel=!1;designIdentikits=new Int32Array(7);designColors=new Int32Array(5);static CHAT_COLORS=Int32Array.of(16776960,16711680,65280,65535,16711935,16777215);friendCount=0;chatCount=0;chatX=new Int32Array(50);chatY=new Int32Array(50);chatHeight=new Int32Array(50);chatWidth=new Int32Array(50);chatColors=new Int32Array(50);chatStyles=new Int32Array(50);chatTimers=new Int32Array(50);chats=new C(50,null);friendName=new C(100,null);friendName37=new BigInt64Array(100);friendWorld=new Int32Array(100);socialName37=null;waveCount=0;waveEnabled=!0;waveIds=new Int32Array(50);waveLoops=new Int32Array(50);waveDelay=new Int32Array(50);waveVolume=64;lastWaveId=-1;lastWaveLoops=-1;lastWaveLength=0;lastWaveStartTime=0;nextMusicDelay=0;midiActive=!0;currentMidi=null;midiCrc=0;midiSize=0;midiVolume=64;displayFps=!1;static setHighMemory(){V.lowMemory=!1,w.lowMemory=!1,p.lowMemory=!1,a.lowMemory=!1}static setLowMemory(){V.lowMemory=!0,w.lowMemory=!0,p.lowMemory=!0,a.lowMemory=!0}constructor(i,n,c){if(super(),void 0===i||void 0===n||void 0===c)return;if(p.nodeId=i,p.members=c,n)p.setLowMemory();else p.setHighMemory();this.run()}getTitleScreenState(){return this.titleScreenState}isChatBackInputOpen(){return this.chatbackInputOpen}isShowSocialInput(){return this.showSocialInput}getChatInterfaceId(){return this.chatInterfaceId}getViewportInterfaceId(){return this.viewportInterfaceId}getReportAbuseInterfaceId(){return this.reportAbuseInterfaceID}unloadTitle(){if(this.flameActive=!1,this.flamesInterval)clearInterval(this.flamesInterval),this.flamesInterval=null;this.imageTitlebox=null,this.imageTitlebutton=null,this.imageRunes=[],this.flameGradient=null,this.flameGradient0=null,this.flameGradient1=null,this.flameGradient2=null,this.flameBuffer0=null,this.flameBuffer1=null,this.flameBuffer3=null,this.flameBuffer2=null,this.imageFlamesLeft=null,this.imageFlamesRight=null}async loadArchive(i,n,c,d){let u=5,m=await(this.db?.cacheload(i));if(m&&f.crc32(m)!==c)m=void 0;if(m)return new C0(m);while(!m){await this.showProgress(d,`Requesting ${n}`);try{m=await t0(`/${i}${c}`)}catch(i){m=void 0;for(let i=u;i>0;i--)await this.showProgress(d,`Error loading - Will retry in ${i} secs.`),await S0(1e3);if(u*=2,u>60)u=60}}return await(this.db?.cachesave(i,m)),new C0(m)}async setMidi(i,n,c,d){try{let u=await(this.db?.cacheload(i+".mid"));if(u&&12345678!==n&&f.crc32(u)!==n)u=void 0;if(!u||!u.length)try{if(u=await t0(`/${i}_${n}.mid`),c!==u.length)u=u.slice(0,c)}catch(i){}if(!u)return;try{await(this.db?.cachesave(i+".mid",u));let n=U_.decompress(u,-1,!1,!0);S_(n,this.midiVolume,d)}catch(i){}}catch(i){}}drawError(){t.fillStyle="black",t.fillRect(0,0,this.width,this.height),this.setFramerate(1),this.flameActive=!1;let i=35;if(this.errorLoading)t.font="bold 16px helvetica, sans-serif",t.textAlign="left",t.fillStyle="yellow",t.fillText("Sorry, an error has occured whilst loading RuneScape",30,i),i+=50,t.fillStyle="white",t.fillText("To fix this try the following (in order):",30,i),i+=50,t.font="bold 12px helvetica, sans-serif",t.fillText("1: Try closing ALL open web-browser windows, and reloading",30,i),i+=30,t.fillText("2: Try clearing your web-browsers cache",30,i),i+=30,t.fillText("3: Try using a different game-world",30,i),i+=30,t.fillText("4: Try rebooting your computer",30,i);else if(this.errorHost)t.font="bold 20px helvetica, sans-serif",t.textAlign="left",t.fillStyle="white",t.fillText("Error - unable to load game!",50,50),t.fillText("To play RuneScape make sure you play from an approved domain",50,100);else if(this.errorStarted)t.font="bold 13px helvetica, sans-serif",t.textAlign="left",t.fillStyle="yellow",t.fillText("Error a copy of RuneScape already appears to be loaded",30,i),i+=50,t.fillStyle="white",t.fillText("To fix this try the following (in order):",30,i),i+=50,t.font="bold 12px helvetica, sans-serif",t.fillText("1: Try closing ALL open web-browser windows, and reloading",30,i),i+=30,t.fillText("2: Try rebooting your computer, and reloading",30,i);if(this.errorMessage)i+=50,t.fillStyle="red",t.fillText("Error: "+this.errorMessage,30,i)}executeInterfaceScript(i){if(!i.scriptComparator)return!1;for(let n=0;n<i.scriptComparator.length;n++){let c=this.executeClientscript1(i,n);if(!i.scriptOperand)return!1;let d=i.scriptOperand[n];if(2===i.scriptComparator[n]){if(c>=d)return!1}else if(3===i.scriptComparator[n]){if(c<=d)return!1}else if(4===i.scriptComparator[n]){if(c===d)return!1}else if(c!==d)return!1}return!0}drawScrollbar(i,n,c,d,u){this.imageScrollbar0?.draw(i,n),this.imageScrollbar1?.draw(i,n+u-16),T.fillRect2d(i,n+16,16,u-32,2301979);let m=(u-32)*u/d|0;if(m<8)m=8;let v=(u-m-32)*c/(d-u)|0;T.fillRect2d(i,n+v+16,16,m,5063219),T.drawVerticalLine(i,n+v+16,7759444,m),T.drawVerticalLine(i+1,n+v+16,7759444,m),T.drawHorizontalLine(i,n+v+16,7759444,16),T.drawHorizontalLine(i,n+v+17,7759444,16),T.drawVerticalLine(i+15,n+v+16,3353893,m),T.drawVerticalLine(i+14,n+v+17,3353893,m-1),T.drawHorizontalLine(i,n+v+m+15,3353893,16),T.drawHorizontalLine(i+1,n+v+m+14,3353893,15)}updateInterfaceAnimation(i,n){let c=!1,d=s.instances[i];if(!d.childId)return!1;for(let i=0;i<d.childId.length&&-1!==d.childId[i];i++){let u=s.instances[d.childId[i]];if(1===u.comType)c||=this.updateInterfaceAnimation(u.id,n);if(6===u.comType&&(-1!==u.anim||-1!==u.activeAnim)){let i,d;if(this.executeInterfaceScript(u))d=u.activeAnim;else d=u.anim;if(-1!==d){let i=r.instances[d];if(u.seqCycle+=n,i.seqDelay)while(u.seqCycle>i.seqDelay[u.seqFrame]){if(u.seqCycle-=i.seqDelay[u.seqFrame]+1,u.seqFrame++,u.seqFrame>=i.seqFrameCount)if(u.seqFrame-=i.replayoff,u.seqFrame<0||u.seqFrame>=i.seqFrameCount)u.seqFrame=0;c=!0}}}}return c}drawInterface(i,n,c,d,u=!1){if(0!==i.comType||!i.childId||i.hide&&this.viewportHoveredInterfaceIndex!==i.id&&this.sidebarHoveredInterfaceIndex!==i.id&&this.chatHoveredInterfaceIndex!==i.id)return;let m=T.left,v=T.top,S=T.right,b=T.bottom;T.setBounds(n,c,n+i.width,c+i.height);let x=i.childId.length;for(let m=0;m<x;m++){if(!i.childX||!i.childY)continue;let v=i.childX[m]+n,S=i.childY[m]+c-d,b=s.instances[i.childId[m]];if(v+=b.x,S+=b.y,u)T.drawRect(v,S,b.width,b.height,16777215);if(b.clientCode>0)this.updateInterfaceContent(b);if(0===b.comType){if(b.scrollPosition>b.scroll-b.height)b.scrollPosition=b.scroll-b.height;if(b.scrollPosition<0)b.scrollPosition=0;if(this.drawInterface(b,v,S,b.scrollPosition,u),b.scroll>b.height)this.drawScrollbar(v+b.width,S,b.scrollPosition,b.scroll,b.height)}else if(2===b.comType){let i=0;for(let n=0;n<b.height;n++)for(let c=0;c<b.width;c++){if(!(b.invSlotOffsetX&&b.invSlotOffsetY&&b.invSlotObjId&&b.invSlotObjCount))continue;let d=v+c*(b.marginX+32),u=S+n*(b.marginY+32);if(i<20)d+=b.invSlotOffsetX[i],u+=b.invSlotOffsetY[i];if(b.invSlotObjId[i]>0){let n=0,c=0,m=b.invSlotObjId[i]-1;if(d>=-32&&d<=512&&u>=-32&&u<=334||0!==this.objDragArea&&this.objDragSlot===i){let v=_0.getIcon(m,b.invSlotObjCount[i]);if(0!==this.objDragArea&&this.objDragSlot===i&&this.objDragInterfaceId===b.id){if(n=this.mouseX-this.objGrabX,c=this.mouseY-this.objGrabY,n<5&&n>-5)n=0;if(c<5&&c>-5)c=0;if(this.objDragCycles<5)n=0,c=0;v.drawAlpha(128,d+n,u+c)}else if(0!==this.selectedArea&&this.selectedItem===i&&this.selectedInterface===b.id)v.drawAlpha(128,d,u);else v.draw(d,u);if(this.mouseX>=d&&this.mouseX<d+32&&this.mouseY>=u&&this.mouseY<u+32){let i=this.mouseX+10;let n=this.mouseY-20;if(i+100>512)i=this.mouseX-110;if(n<0)n=this.mouseY+20;if(T.fillRect2d(i,n,100,20,0),T.drawRect(i,n,100,20,16776960),this.fontPlain11){let c="Item #"+m;if(995===m)c="Coins";else if(1038===m)c="Red partyhat";else if(1040===m)c="Yellow partyhat";else if(1042===m)c="Blue partyhat";else if(1044===m)c="Green partyhat";else if(1046===m)c="Purple partyhat";else if(1048===m)c="White partyhat";else if(4151===m)c="Abyssal whip";else if(1163===m)c="Rune full helm";else if(1127===m)c="Rune platebody";else if(1079===m)c="Rune platelegs";else if(1333===m)c="Rune scimitar";else if(554===m)c="Fire rune";else if(555===m)c="Water rune";else if(556===m)c="Air rune";else if(557===m)c="Earth rune";else if(560===m)c="Death rune";else if(561===m)c="Nature rune";else if(562===m)c="Chaos rune";else if(563===m)c="Law rune";this.fontPlain11.drawString(i+3,n+13,c,16776960)}}if(33===v.cropW||1!==b.invSlotObjCount[i]){let m=b.invSlotObjCount[i];this.fontPlain11?.drawString(d+n+1,u+10+c,this.formatObjCount(m),0),this.fontPlain11?.drawString(d+n,u+9+c,this.formatObjCount(m),16776960)}}}else if(b.invSlotSprite&&i<20)b.invSlotSprite[i]?.draw(d,u);i++}}else if(3===b.comType)if(b.fill)T.fillRect2d(v,S,b.width,b.height,b.colour);else T.drawRect(v,S,b.width,b.height,b.colour);else if(4===b.comType){let{font:i,colour:n,text:c}=b;if((this.chatHoveredInterfaceIndex===b.id||this.sidebarHoveredInterfaceIndex===b.id||this.viewportHoveredInterfaceIndex===b.id)&&0!==b.overColour)n=b.overColour;if(this.executeInterfaceScript(b))if(n=b.activeColour,b.activeText&&b.activeText.length>0)c=b.activeText;if(6===b.buttonType&&this.pressedContinueOption)c="Please wait...",n=b.colour;if(!i||!c)continue;for(let d=S+i.height2d;c.length>0;d+=i.height2d){if(-1!==c.indexOf("%")){do{let i=c.indexOf("%1");if(-1===i)break;c=c.substring(0,i)+this.getIntString(this.executeClientscript1(b,0))+c.substring(i+2)}while(!0);do{let i=c.indexOf("%2");if(-1===i)break;c=c.substring(0,i)+this.getIntString(this.executeClientscript1(b,1))+c.substring(i+2)}while(!0);do{let i=c.indexOf("%3");if(-1===i)break;c=c.substring(0,i)+this.getIntString(this.executeClientscript1(b,2))+c.substring(i+2)}while(!0);do{let i=c.indexOf("%4");if(-1===i)break;c=c.substring(0,i)+this.getIntString(this.executeClientscript1(b,3))+c.substring(i+2)}while(!0);do{let i=c.indexOf("%5");if(-1===i)break;c=c.substring(0,i)+this.getIntString(this.executeClientscript1(b,4))+c.substring(i+2)}while(!0)}let u=c.indexOf("\\n"),m;if(-1!==u)m=c.substring(0,u),c=c.substring(u+2);else m=c,c="";if(b.center)i.drawStringTaggableCenter(v+(b.width/2|0),d,m,n,b.shadowed);else i.drawStringTaggable(v,d,m,n,b.shadowed)}}else if(5===b.comType){let i;if(this.executeInterfaceScript(b))i=b.activeGraphic;else i=b.graphic;i?.draw(v,S)}else if(6===b.comType){let i=w.centerX,n=w.centerY;w.centerX=v+(b.width/2|0),w.centerY=S+(b.height/2|0);let c=w.sin[b.xan]*b.zoom>>16,d=w.cos[b.xan]*b.zoom>>16,u=this.executeInterfaceScript(b),m;if(u)m=b.activeAnim;else m=b.anim;let x=null;if(-1===m)x=b.getModel(-1,-1,u);else{let i=r.instances[m];if(i.seqFrames&&i.seqIframes)x=b.getModel(i.seqFrames[b.seqFrame],i.seqIframes[b.seqFrame],u)}if(x)x.drawSimple(0,b.yan,0,b.xan,0,c,d);w.centerX=i,w.centerY=n}else if(7===b.comType){let i=b.font;if(!i||!b.invSlotObjId||!b.invSlotObjCount)continue;let n=0;for(let c=0;c<b.height;c++)for(let d=0;d<b.width;d++){if(b.invSlotObjId[n]>0){let u=_0.get(b.invSlotObjId[n]-1),m=u.name;if(u.stackable||1!==b.invSlotObjCount[n])m=m+" x"+this.formatObjCountTagged(b.invSlotObjCount[n]);if(!m)continue;let x=v+d*(b.marginX+115),I=S+c*(b.marginY+12);if(b.center)i.drawStringTaggableCenter(x+(b.width/2|0),I,m,b.colour,b.shadowed);else i.drawStringTaggable(x,I,m,b.colour,b.shadowed)}n++}}}T.setBounds(m,v,S,b)}updateInterfaceContent(i){let n=i.clientCode;if(n>=1&&n<=100)if(n--,n>=this.friendCount)i.text="",i.buttonType=0;else i.text=this.friendName[n],i.buttonType=1;else if(n>=101&&n<=200)if(n-=101,n>=this.friendCount)i.text="",i.buttonType=0;else{if(0===this.friendWorld[n])i.text="@red@Offline";else if(this.friendWorld[n]===p.nodeId)i.text="@gre@World-"+(this.friendWorld[n]-9);else i.text="@yel@World-"+(this.friendWorld[n]-9);i.buttonType=1}else if(203===n){if(i.scroll=15*this.friendCount+20,i.scroll<=i.height)i.scroll=i.height+1}else if(n>=401&&n<=500)if(n-=401,n>=this.ignoreCount)i.text="",i.buttonType=0;else i.text=l.formatName(l.fromBase37(this.ignoreName37[n])),i.buttonType=1;else if(503===n){if(i.scroll=15*this.ignoreCount+20,i.scroll<=i.height)i.scroll=i.height+1}else if(327===n){if(i.xan=150,i.yan=2047&(256*Math.sin(this.loopCycle/40)|0),this.updateDesignModel){this.updateDesignModel=!1;let n=new C(7,null),c=0;for(let i=0;i<7;i++){let d=this.designIdentikits[i];if(d>=0)n[c++]=Y0.instances[d].getModel()}let d=J.modelFromModels(n,c);for(let i=0;i<5;i++)if(0!==this.designColors[i])if(d.recolor(K0.DESIGN_IDK_COLORS[i][0],K0.DESIGN_IDK_COLORS[i][this.designColors[i]]),1===i)d.recolor(K0.TORSO_RECOLORS[0],K0.TORSO_RECOLORS[this.designColors[i]]);if(this.localPlayer){let n=r.instances[this.localPlayer.seqStandId].seqFrames;if(n)d.createLabelReferences(),d.applyTransform(n[0]),d.calculateNormals(64,850,-30,-50,-30,!0),i.model=d}}}else if(324===n){if(!this.genderButtonImage0)this.genderButtonImage0=i.graphic,this.genderButtonImage1=i.activeGraphic;if(this.designGenderMale)i.graphic=this.genderButtonImage1;else i.graphic=this.genderButtonImage0}else if(325===n){if(!this.genderButtonImage0)this.genderButtonImage0=i.graphic,this.genderButtonImage1=i.activeGraphic;if(this.designGenderMale)i.graphic=this.genderButtonImage0;else i.graphic=this.genderButtonImage1}else if(600===n)if(i.text=this.reportAbuseInput,this.loopCycle%20<10)i.text=i.text+"|";else i.text=i.text+" ";else if(613===n)if(!this.rights)i.text="";else if(this.reportAbuseMuteOption)i.colour=16711680,i.text="Moderator option: Mute player for 48 hours: <ON>";else i.colour=16777215,i.text="Moderator option: Mute player for 48 hours: <OFF>";else if(650===n||655===n)if(0===this.lastAddress)i.text="";else{let n;if(0===this.daysSinceLastLogin)n="earlier today";else if(1===this.daysSinceLastLogin)n="yesterday";else n=this.daysSinceLastLogin+" days ago";let c=l.formatIPv4(this.lastAddress);i.text="You last logged in "+n+("127.0.0.1"===c?".":" from: "+c)}else if(651===n){if(0===this.unreadMessages)i.text="0 unread messages",i.colour=16776960;if(1===this.unreadMessages)i.text="1 unread message",i.colour=65280;if(this.unreadMessages>1)i.text=this.unreadMessages+" unread messages",i.colour=65280}else if(652===n)if(201===this.daysSinceRecoveriesChanged)i.text="";else if(200===this.daysSinceRecoveriesChanged)i.text="You have not yet set any password recovery questions.";else{let n;if(0===this.daysSinceRecoveriesChanged)n="Earlier today";else if(1===this.daysSinceRecoveriesChanged)n="Yesterday";else n=this.daysSinceRecoveriesChanged+" days ago";i.text=n+" you changed your recovery questions"}else if(653===n)if(201===this.daysSinceRecoveriesChanged)i.text="";else if(200===this.daysSinceRecoveriesChanged)i.text="We strongly recommend you do so now to secure your account.";else i.text="If you do not remember making this change then cancel it immediately";else if(654===n)if(201===this.daysSinceRecoveriesChanged)i.text="";else if(200===this.daysSinceRecoveriesChanged)i.text="Do this from the 'account management' area on our front webpage";else i.text="Do this from the 'account management' area on our front webpage"}executeClientscript1(i,n){if(!i.script||n>=i.script.length)return-2;try{let c=i.script[n];if(!c)return-1;let d=0,u=0;while(!0){let i=c[u++];if(0===i)return d;if(1===i)d+=this.skillLevel[c[u++]];else if(2===i)d+=this.skillBaseLevel[c[u++]];else if(3===i)d+=this.skillExperience[c[u++]];else if(4===i){let i=s.instances[c[u++]],n=c[u++]+1;if(i.invSlotObjId&&i.invSlotObjCount){for(let c=0;c<i.invSlotObjId.length;c++)if(i.invSlotObjId[c]===n)d+=i.invSlotObjCount[c]}else d+=0}else if(5===i)d+=this.varps[c[u++]];else if(6===i)d+=this.levelExperience[this.skillBaseLevel[c[u++]]-1];else if(7===i)d+=100*this.varps[c[u++]]/46875|0;else if(8===i)d+=this.localPlayer?.combatLevel||0;else if(9===i)for(let i=0;i<19;i++){if(18===i)i=20;d+=this.skillBaseLevel[i]}else if(10===i){let i=s.instances[c[u++]],n=c[u++]+1;for(let c=0;c<i.invSlotObjId.length;c++)if(i.invSlotObjId[c]===n){d+=999999999;break}}else if(11===i)d+=this.energy;else if(12===i)d+=this.weightCarried;else if(13===i){let i,n;d+=!(this.varps[c[u++]]&1<<c[u++])?0:1}}}catch(i){return-1}}getIntString(i){return i<999999999?String(i):"*"}formatObjCountTagged(i){let n=String(i);for(let i=n.length-3;i>0;i-=3)n=n.substring(0,i)+","+n.substring(i);if(n.length>8)n="@gre@"+n.substring(0,n.length-8)+" million @whi@("+n+")";else if(n.length>4)n="@cya@"+n.substring(0,n.length-4)+"K @whi@("+n+")";return" "+n}formatObjCount(i){if(i<1e5)return String(i);else if(i<1e7)return(i/1e3|0)+"K";else return(i/1e6|0)+"M"}async load(){if(this.isMobile&&p.lowMemory)this.setTargetedFramerate(30);if(this.alreadyStarted)return void(this.errorStarted=!0);this.alreadyStarted=!0;try{await this.showProgress(10,"Connecting to fileserver");try{this.db=new i0(await i0.openDatabase())}catch(i){this.db=null}let i=new f(await t0("/crc"));for(let n=0;n<9;n++)this.archiveChecksums[n]=i.g4();if(!p.lowMemory)await this.setMidi("scape_main",12345678,4e4,!1);let n=await this.loadArchive("title","title screen",this.archiveChecksums[1],10);this.titleArchive=n,this.fontPlain11=V0.fromArchive(n,"p11"),this.fontPlain12=V0.fromArchive(n,"p12"),this.fontBold12=V0.fromArchive(n,"b12"),this.fontQuill8=V0.fromArchive(n,"q8"),await this.loadTitleBackground(),this.loadTitleImages();let c=await this.loadArchive("config","config",this.archiveChecksums[2],15),d=await this.loadArchive("interface","interface",this.archiveChecksums[3],20),u=await this.loadArchive("media","2d graphics",this.archiveChecksums[4],30),m=await this.loadArchive("models","3d graphics",this.archiveChecksums[5],40),v=await this.loadArchive("textures","textures",this.archiveChecksums[6],60),S=await this.loadArchive("wordenc","chat system",this.archiveChecksums[7],65),b=await this.loadArchive("sounds","sound effects",this.archiveChecksums[8],70);if(this.levelTileFlags=new B0(4,104,104),this.levelHeightmap=new g0(4,104+1,104+1),this.levelHeightmap)this.scene=new V(this.levelHeightmap,104,4,104);for(let i=0;i<4;i++)this.levelCollisionMap[i]=new o;this.imageMinimap=new e(512,512),await this.showProgress(75,"Unpacking media"),this.imageInvback=I0.fromArchive(u,"invback",0),this.imageChatback=I0.fromArchive(u,"chatback",0),this.imageMapback=I0.fromArchive(u,"mapback",0),this.imageBackbase1=I0.fromArchive(u,"backbase1",0),this.imageBackbase2=I0.fromArchive(u,"backbase2",0),this.imageBackhmid1=I0.fromArchive(u,"backhmid1",0);for(let i=0;i<13;i++)this.imageSideicons[i]=I0.fromArchive(u,"sideicons",i);this.imageCompass=e.fromArchive(u,"compass",0);try{for(let i=0;i<50;i++){if(22===i)continue;this.imageMapscene[i]=I0.fromArchive(u,"mapscene",i)}}catch(i){}try{for(let i=0;i<50;i++)this.imageMapfunction[i]=e.fromArchive(u,"mapfunction",i)}catch(i){}try{for(let i=0;i<20;i++)this.imageHitmarks[i]=e.fromArchive(u,"hitmarks",i)}catch(i){}try{for(let i=0;i<20;i++)this.imageHeadicons[i]=e.fromArchive(u,"headicons",i)}catch(i){}this.imageMapflag=e.fromArchive(u,"mapflag",0);for(let i=0;i<8;i++)this.imageCrosses[i]=e.fromArchive(u,"cross",i);this.imageMapdot0=e.fromArchive(u,"mapdots",0),this.imageMapdot1=e.fromArchive(u,"mapdots",1),this.imageMapdot2=e.fromArchive(u,"mapdots",2),this.imageMapdot3=e.fromArchive(u,"mapdots",3),this.imageScrollbar0=I0.fromArchive(u,"scrollbar",0),this.imageScrollbar1=I0.fromArchive(u,"scrollbar",1),this.imageRedstone1=I0.fromArchive(u,"redstone1",0),this.imageRedstone2=I0.fromArchive(u,"redstone2",0),this.imageRedstone3=I0.fromArchive(u,"redstone3",0),this.imageRedstone1h=I0.fromArchive(u,"redstone1",0),this.imageRedstone1h?.flipHorizontally(),this.imageRedstone2h=I0.fromArchive(u,"redstone2",0),this.imageRedstone2h?.flipHorizontally(),this.imageRedstone1v=I0.fromArchive(u,"redstone1",0),this.imageRedstone1v?.flipVertically(),this.imageRedstone2v=I0.fromArchive(u,"redstone2",0),this.imageRedstone2v?.flipVertically(),this.imageRedstone3v=I0.fromArchive(u,"redstone3",0),this.imageRedstone3v?.flipVertically(),this.imageRedstone1hv=I0.fromArchive(u,"redstone1",0),this.imageRedstone1hv?.flipHorizontally(),this.imageRedstone1hv?.flipVertically(),this.imageRedstone2hv=I0.fromArchive(u,"redstone2",0),this.imageRedstone2hv?.flipHorizontally(),this.imageRedstone2hv?.flipVertically();let x=e.fromArchive(u,"backleft1",0);this.areaBackleft1=new b0(x.width2d,x.height2d),x.blitOpaque(0,0);let I=e.fromArchive(u,"backleft2",0);this.areaBackleft2=new b0(I.width2d,I.height2d),I.blitOpaque(0,0);let A=e.fromArchive(u,"backright1",0);this.areaBackright1=new b0(A.width2d,A.height2d),A.blitOpaque(0,0);let k=e.fromArchive(u,"backright2",0);this.areaBackright2=new b0(k.width2d,k.height2d),k.blitOpaque(0,0);let L=e.fromArchive(u,"backtop1",0);this.areaBacktop1=new b0(L.width2d,L.height2d),L.blitOpaque(0,0);let O=e.fromArchive(u,"backtop2",0);this.areaBacktop2=new b0(O.width2d,O.height2d),O.blitOpaque(0,0);let X=e.fromArchive(u,"backvmid1",0);this.areaBackvmid1=new b0(X.width2d,X.height2d),X.blitOpaque(0,0);let M=e.fromArchive(u,"backvmid2",0);this.areaBackvmid2=new b0(M.width2d,M.height2d),M.blitOpaque(0,0);let Y=e.fromArchive(u,"backvmid3",0);this.areaBackvmid3=new b0(Y.width2d,Y.height2d),Y.blitOpaque(0,0);let B=e.fromArchive(u,"backhmid2",0);this.areaBackhmid2=new b0(B.width2d,B.height2d),B.blitOpaque(0,0);let F=(21*Math.random()|0)-10,E=(21*Math.random()|0)-10,D=(21*Math.random()|0)-10,R=(41*Math.random()|0)-20;for(let i=0;i<50;i++){if(this.imageMapfunction[i])this.imageMapfunction[i]?.translate2d(F+R,E+R,D+R);if(this.imageMapscene[i])this.imageMapscene[i]?.translate2d(F+R,E+R,D+R)}if(await this.showProgress(80,"Unpacking textures"),w.unpackTextures(v),w.setBrightness(.8),w.initPool(20),await this.showProgress(83,"Unpacking models"),J.unpack(m),f0.unpack(m),X0.unpack(m),await this.showProgress(86,"Unpacking config"),r.unpack(c),Q0.unpack(c),N0.unpack(c),_0.unpack(c,p.members),w0.unpack(c),Y0.unpack(c),T0.unpack(c),z0.unpack(c),!p.lowMemory)await this.showProgress(90,"Unpacking sounds"),E0.unpack(b);await this.showProgress(92,"Unpacking interfaces"),s.unpack(d,u,[this.fontPlain11,this.fontPlain12,this.fontBold12,this.fontQuill8]),await this.showProgress(97,"Preparing game engine");for(let i=0;i<33;i++){let n=999,c=0;for(let d=0;d<35;d++)if(0===this.imageMapback.pixels[d+i*this.imageMapback.width2d]){if(999===n)n=d}else if(999!==n){c=d;break}this.compassMaskLineOffsets[i]=n,this.compassMaskLineLengths[i]=c-n}for(let i=9;i<160;i++){let n=999,c=0;for(let d=10;d<168;d++)if(0===this.imageMapback.pixels[d+i*this.imageMapback.width2d]&&(d>34||i>34)){if(999===n)n=d}else if(999!==n){c=d;break}this.minimapMaskLineOffsets[i-9]=n-21,this.minimapMaskLineLengths[i-9]=c-n}w.init3D(479,96),this.areaChatbackOffsets=w.lineOffset,w.init3D(190,261),this.areaSidebarOffsets=w.lineOffset,w.init3D(512,334),this.areaViewportOffsets=w.lineOffset;let _=new Int32Array(9);for(let i=0;i<9;i++){let n=32*i+128+15,c=3*n+600,d=w.sin[n];_[i]=c*d>>16}V.init(512,334,500,800,_),D0.unpack(S),this.initializeLevelExperience()}catch(i){if(this.errorLoading=!0,i instanceof Error)this.errorMessage=i.message}}async update(){if(this.errorStarted||this.errorLoading||this.errorHost)return;if(this.loopCycle++,this.ingame)await this.updateGame();else await this.updateTitleScreen()}async draw(){if(this.errorStarted||this.errorLoading||this.errorHost)return void this.drawError();if(this.ingame)this.drawGame();else await this.drawTitleScreen();this.dragCycles=0}async refresh(){this.redrawTitleBackground=!0}async showProgress(i,n){if(await this.loadTitle(),!this.titleArchive)return void await super.showProgress(i,n);this.imageTitle4?.bind();let c=360,d=200,u=20;this.fontBold12?.drawStringCenter(c/2|0,(d/2|0)-u-26,"RuneScape is loading - please wait...",16777215);let m=(d/2|0)-18-u;if(T.drawRect((c/2|0)-152,m,304,34,9179409),T.drawRect((c/2|0)-151,m+1,302,32,0),T.fillRect2d((c/2|0)-150,m+2,3*i,30,9179409),T.fillRect2d((c/2|0)-150+3*i,m+2,300-3*i,30,0),this.fontBold12?.drawStringCenter(c/2|0,(d/2|0)+5-u,n,16777215),this.imageTitle4?.draw(214,186),this.redrawTitleBackground){if(this.redrawTitleBackground=!1,!this.flameActive)this.imageTitle0?.draw(0,0),this.imageTitle1?.draw(661,0);this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)}await S0(5)}runFlames(){if(!this.flameActive)return;this.updateFlames(),this.updateFlames(),this.drawFlames()}async loadTitle(){if(!this.imageTitle2){if(this.drawArea=null,this.areaChatback=null,this.areaMapback=null,this.areaSidebar=null,this.areaViewport=null,this.areaBackbase1=null,this.areaBackbase2=null,this.areaBackhmid1=null,this.imageTitle0=new b0(128,265),T.clear(),this.imageTitle1=new b0(128,265),T.clear(),this.imageTitle2=new b0(533,186),T.clear(),this.imageTitle3=new b0(360,146),T.clear(),this.imageTitle4=new b0(360,200),T.clear(),this.imageTitle5=new b0(214,267),T.clear(),this.imageTitle6=new b0(215,267),T.clear(),this.imageTitle7=new b0(86,79),T.clear(),this.imageTitle8=new b0(87,79),T.clear(),this.titleArchive)await this.loadTitleBackground(),this.loadTitleImages();this.redrawTitleBackground=!0}}async loadTitleBackground(){if(!this.titleArchive)return;let i=await e.fromJpeg(this.titleArchive,"title");this.imageTitle0?.bind(),i.blitOpaque(0,0),this.imageTitle1?.bind(),i.blitOpaque(-661,0),this.imageTitle2?.bind(),i.blitOpaque(-128,0),this.imageTitle3?.bind(),i.blitOpaque(-214,-386),this.imageTitle4?.bind(),i.blitOpaque(-214,-186),this.imageTitle5?.bind(),i.blitOpaque(0,-265),this.imageTitle6?.bind(),i.blitOpaque(-128,-186),this.imageTitle7?.bind(),i.blitOpaque(-128,-186),this.imageTitle8?.bind(),i.blitOpaque(-574,-186),i.flipHorizontally(),this.imageTitle0?.bind(),i.blitOpaque(394,0),this.imageTitle1?.bind(),i.blitOpaque(-267,0),this.imageTitle2?.bind(),i.blitOpaque(266,0),this.imageTitle3?.bind(),i.blitOpaque(180,-386),this.imageTitle4?.bind(),i.blitOpaque(180,-186),this.imageTitle5?.bind(),i.blitOpaque(394,-265),this.imageTitle6?.bind(),i.blitOpaque(-180,-265),this.imageTitle7?.bind(),i.blitOpaque(212,-186),this.imageTitle8?.bind(),i.blitOpaque(-180,-186);let n=e.fromArchive(this.titleArchive,"logo");this.imageTitle2?.bind(),n.draw((this.width/2|0)-(n.width2d/2|0)-128,18)}updateFlameBuffer(i){if(!this.flameBuffer0||!this.flameBuffer1)return;let n=256;this.flameBuffer0.fill(0);for(let i=0;i<5e3;i++){let i=128*Math.random()*n|0;this.flameBuffer0[i]=256*Math.random()|0}for(let i=0;i<20;i++){for(let i=1;i<n-1;i++)for(let n=1;n<127;n++){let c=n+(i<<7);this.flameBuffer1[c]=(this.flameBuffer0[c-1]+this.flameBuffer0[c+1]+this.flameBuffer0[c-128]+this.flameBuffer0[c+128])/4|0}let i=this.flameBuffer0;this.flameBuffer0=this.flameBuffer1,this.flameBuffer1=i}if(i){let n=0;for(let c=0;c<i.height2d;c++)for(let d=0;d<i.width2d;d++)if(0!==i.pixels[n++]){let n,u,m=d+i.cropX+16+(c+i.cropY+16<<7);this.flameBuffer0[m]=0}}}loadTitleImages(){if(!this.titleArchive)return;this.imageTitlebox=I0.fromArchive(this.titleArchive,"titlebox"),this.imageTitlebutton=I0.fromArchive(this.titleArchive,"titlebutton");for(let i=0;i<12;i++)this.imageRunes[i]=I0.fromArchive(this.titleArchive,"runes",i);if(this.imageFlamesLeft=new e(128,265),this.imageFlamesRight=new e(128,265),this.imageTitle0)F_(this.imageTitle0.pixels,0,this.imageFlamesLeft.pixels,0,33920);if(this.imageTitle1)F_(this.imageTitle1.pixels,0,this.imageFlamesRight.pixels,0,33920);this.flameGradient0=new Int32Array(256);for(let i=0;i<64;i++)this.flameGradient0[i]=262144*i;for(let i=0;i<64;i++)this.flameGradient0[i+64]=1024*i+16711680;for(let i=0;i<64;i++)this.flameGradient0[i+128]=4*i+16776960;for(let i=0;i<64;i++)this.flameGradient0[i+192]=16777215;this.flameGradient1=new Int32Array(256);for(let i=0;i<64;i++)this.flameGradient1[i]=1024*i;for(let i=0;i<64;i++)this.flameGradient1[i+64]=4*i+65280;for(let i=0;i<64;i++)this.flameGradient1[i+128]=262144*i+65535;for(let i=0;i<64;i++)this.flameGradient1[i+192]=16777215;this.flameGradient2=new Int32Array(256);for(let i=0;i<64;i++)this.flameGradient2[i]=4*i;for(let i=0;i<64;i++)this.flameGradient2[i+64]=262144*i+255;for(let i=0;i<64;i++)this.flameGradient2[i+128]=1024*i+16711935;for(let i=0;i<64;i++)this.flameGradient2[i+192]=16777215;this.flameGradient=new Int32Array(256),this.flameBuffer0=new Int32Array(32768),this.flameBuffer1=new Int32Array(32768),this.updateFlameBuffer(null),this.flameBuffer3=new Int32Array(32768),this.flameBuffer2=new Int32Array(32768),this.showProgress(10,"Connecting to fileserver").then(()=>{if(!this.flameActive)this.flameActive=!0,this.flamesInterval=setInterval(this.runFlames.bind(this),35)})}async updateTitleScreen(){if(0===this.titleScreenState){let i=(this.width/2|0)-80,n=(this.height/2|0)+20;if(n+=20,1===this.mouseClickButton&&this.mouseClickX>=i-75&&this.mouseClickX<=i+75&&this.mouseClickY>=n-20&&this.mouseClickY<=n+20)this.titleScreenState=3,this.titleLoginField=0;if(i=(this.width/2|0)+80,1===this.mouseClickButton&&this.mouseClickX>=i-75&&this.mouseClickX<=i+75&&this.mouseClickY>=n-20&&this.mouseClickY<=n+20)this.loginMessage0="",this.loginMessage1="Enter your username & password.",this.titleScreenState=2,this.titleLoginField=0}else if(2===this.titleScreenState){let i=(this.height/2|0)-40;if(i+=30,i+=25,1===this.mouseClickButton&&this.mouseClickY>=i-15&&this.mouseClickY<i)this.titleLoginField=0;if(i+=15,1===this.mouseClickButton&&this.mouseClickY>=i-15&&this.mouseClickY<i)this.titleLoginField=1;let n=(this.width/2|0)-80,c=(this.height/2|0)+50;if(c+=20,1===this.mouseClickButton&&this.mouseClickX>=n-75&&this.mouseClickX<=n+75&&this.mouseClickY>=c-20&&this.mouseClickY<=c+20)await this.tryLogin(this.usernameInput,this.passwordInput,!1);if(n=(this.width/2|0)+80,1===this.mouseClickButton&&this.mouseClickX>=n-75&&this.mouseClickX<=n+75&&this.mouseClickY>=c-20&&this.mouseClickY<=c+20)this.titleScreenState=0,this.usernameInput="",this.passwordInput="";while(!0){let i=this.pollKey();if(-1===i)return;let n=!1;for(let c=0;c<V0.CHARSET.length;c++)if(String.fromCharCode(i)===V0.CHARSET.charAt(c)){n=!0;break}if(0===this.titleLoginField){if(8===i&&this.usernameInput.length>0)this.usernameInput=this.usernameInput.substring(0,this.usernameInput.length-1);if(9===i||10===i||13===i)this.titleLoginField=1;if(n)this.usernameInput=this.usernameInput+String.fromCharCode(i);if(this.usernameInput.length>12)this.usernameInput=this.usernameInput.substring(0,12)}else if(1===this.titleLoginField){if(8===i&&this.passwordInput.length>0)this.passwordInput=this.passwordInput.substring(0,this.passwordInput.length-1);if(9===i||10===i||13===i)this.titleLoginField=0;if(n)this.passwordInput=this.passwordInput+String.fromCharCode(i);if(this.passwordInput.length>20)this.passwordInput=this.passwordInput.substring(0,20)}}}else if(3===this.titleScreenState){let i=this.width/2|0,n=(this.height/2|0)+50;if(n+=20,1===this.mouseClickButton&&this.mouseClickX>=i-75&&this.mouseClickX<=i+75&&this.mouseClickY>=n-20&&this.mouseClickY<=n+20)this.titleScreenState=0}}async drawTitleScreen(){await this.loadTitle(),this.imageTitle4?.bind(),this.imageTitlebox?.draw(0,0);let i=360,n=200;if(0===this.titleScreenState){let c=i/2|0,d=(n/2|0)-20;this.fontBold12?.drawStringTaggableCenter(c,d,"Welcome to RuneScape",16776960,!0),c=(i/2|0)-80,d=(n/2|0)+20,this.imageTitlebutton?.draw(c-73,d-20),this.fontBold12?.drawStringTaggableCenter(c,d+5,"New user",16777215,!0),c=(i/2|0)+80,this.imageTitlebutton?.draw(c-73,d-20),this.fontBold12?.drawStringTaggableCenter(c,d+5,"Existing User",16777215,!0)}else if(2===this.titleScreenState){let c=(i/2|0)-80,d=(n/2|0)-40;if(this.loginMessage0.length>0)this.fontBold12?.drawStringTaggableCenter(i/2,d-15,this.loginMessage0,16776960,!0),this.fontBold12?.drawStringTaggableCenter(i/2,d,this.loginMessage1,16776960,!0),d+=30;else this.fontBold12?.drawStringTaggableCenter(i/2,d-7,this.loginMessage1,16776960,!0),d+=30;this.fontBold12?.drawStringTaggable(i/2-90,d,`Username: ${this.usernameInput}${0===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),d+=15,this.fontBold12?.drawStringTaggable(i/2-88,d,`Password: ${l.toAsterisks(this.passwordInput)}${1===this.titleLoginField&&this.loopCycle%40<20?"@yel@|":""}`,16777215,!0),d=(n/2|0)+50,this.imageTitlebutton?.draw(c-73,d-20),this.fontBold12?.drawStringTaggableCenter(c,d+5,"Login",16777215,!0),c=(i/2|0)+80,this.imageTitlebutton?.draw(c-73,d-20),this.fontBold12?.drawStringTaggableCenter(c,d+5,"Cancel",16777215,!0)}else if(3===this.titleScreenState){this.fontBold12?.drawStringTaggableCenter(i/2,n/2-60,"Create a free account",16776960,!0);let c=i/2|0,d=(n/2|0)-35;this.fontBold12?.drawStringTaggableCenter(i/2|0,d,"To create a new account you need to",16777215,!0),d+=15,this.fontBold12?.drawStringTaggableCenter(i/2|0,d,"go back to the main RuneScape webpage",16777215,!0),d+=15,this.fontBold12?.drawStringTaggableCenter(i/2|0,d,"and choose the red 'create account'",16777215,!0),d+=15,this.fontBold12?.drawStringTaggableCenter(i/2|0,d,"button at the top right of that page.",16777215,!0),d=(n/2|0)+50,this.imageTitlebutton?.draw(c-73,d-20),this.fontBold12?.drawStringTaggableCenter(c,d+5,"Cancel",16777215,!0)}if(this.imageTitle4?.draw(214,186),this.redrawTitleBackground)this.redrawTitleBackground=!1,this.imageTitle2?.draw(128,0),this.imageTitle3?.draw(214,386),this.imageTitle5?.draw(0,265),this.imageTitle6?.draw(574,265),this.imageTitle7?.draw(128,186),this.imageTitle8?.draw(574,186)}async tryLogin(i,n,c){try{if(!c)this.loginMessage0="",this.loginMessage1="Connecting to server...",await this.drawTitleScreen();this.netStream=new x0(await x0.openSocket(window.location.host,"https:"===window.location.protocol)),await this.netStream.readBytes(this.in.data,0,8),this.in.pos=0,this.serverSeed=this.in.g8();let d=new Int32Array([Math.floor(99999999*Math.random()),Math.floor(99999999*Math.random()),Number(this.serverSeed>>32n),Number(this.serverSeed&BigInt(4294967295))]);if(this.out.pos=0,this.out.p1(10),this.out.p4(d[0]),this.out.p4(d[1]),this.out.p4(d[2]),this.out.p4(d[3]),this.out.p4(1337),this.out.pjstr(i),this.out.pjstr(n),this.out.rsaenc(BigInt("7162900525229798032761816791230527296329313291232324290237849263501208207972894053929065636522363163621000728841182238772712427862772219676577293600221789"),BigInt("58778699976184461502525193738213253649000149147835990136706041084440742975821")),this.loginout.pos=0,c)this.loginout.p1(18);else this.loginout.p1(16);this.loginout.p1(this.out.pos+36+1+1),this.loginout.p1(225),this.loginout.p1(p.lowMemory?1:0);for(let i=0;i<9;i++)this.loginout.p4(this.archiveChecksums[i]);this.loginout.pdata(this.out.data,this.out.pos,0),this.out.random=new a0(d);for(let i=0;i<4;i++)d[i]+=50;this.randomIn=new a0(d),this.netStream?.write(this.loginout.data,this.loginout.pos);let u=await this.netStream.read();if(1===u)return await S0(2e3),void await this.tryLogin(i,n,c);if(2===u||18===u){this.rights=18===u,$0.setDisabled(),this.ingame=!0,this.out.pos=0,this.in.pos=0,this.inPacketType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.inPacketSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.idleTimeout=0,this.hintType=0,this.menuSize=0,this.menuVisible=!1,this.idleCycles=performance.now();for(let i=0;i<100;i++)this.messageText[i]=null;this.objSelected=0,this.spellSelected=0,this.sceneState=0,this.waveCount=0,this.cameraAnticheatOffsetX=(100*Math.random()|0)-50,this.cameraAnticheatOffsetZ=(110*Math.random()|0)-55,this.cameraAnticheatAngle=(80*Math.random()|0)-40,this.minimapAnticheatAngle=(120*Math.random()|0)-60,this.minimapZoom=(30*Math.random()|0)-20,this.orbitCameraYaw=(20*Math.random()|0)-10&2047,this.minimapLevel=-1,this.flagSceneTileX=0,this.flagSceneTileZ=0,this.playerCount=0,this.npcCount=0;for(let i=0;i<2048;i++)this.players[i]=null,this.playerAppearanceBuffer[i]=null;for(let i=0;i<8192;i++)this.npcs[i]=null;this.localPlayer=this.players[2047]=new K0,this.projectiles.clear(),this.spotanims.clear();for(let i=0;i<4;i++)for(let n=0;n<104;n++)for(let c=0;c<104;c++)this.objStacks[i][n][c]=null;this.addedLocs=new m0,this.friendCount=0,this.stickyChatInterfaceId=-1,this.chatInterfaceId=-1,this.viewportInterfaceId=-1,this.sidebarInterfaceId=-1,this.pressedContinueOption=!1,this.selectedTab=3,this.chatbackInputOpen=!1,this.menuVisible=!1,this.showSocialInput=!1,this.modalMessage=null,this.inMultizone=0,this.flashingTab=-1,this.designGenderMale=!0,this.validateCharacterDesign();for(let i=0;i<5;i++)this.designColors[i]=0;return p.oplogic1=0,p.oplogic2=0,p.oplogic3=0,p.oplogic4=0,p.oplogic5=0,p.oplogic6=0,p.oplogic7=0,p.oplogic8=0,p.oplogic9=0,void this.prepareGameScreen()}if(3===u)return this.loginMessage0="",void(this.loginMessage1="Invalid username or password.");if(4===u)return this.loginMessage0="Your account has been disabled.",void(this.loginMessage1="Please check your message-centre for details.");if(5===u)return this.loginMessage0="Your account is already logged in.",void(this.loginMessage1="Try again in 60 secs...");if(6===u)return this.loginMessage0="RuneScape has been updated!",void(this.loginMessage1="Please reload this page.");if(7===u)return this.loginMessage0="This world is full.",void(this.loginMessage1="Please use a different world.");if(8===u)return this.loginMessage0="Unable to connect.",void(this.loginMessage1="Login server offline.");if(9===u)return this.loginMessage0="Login limit exceeded.",void(this.loginMessage1="Too many connections from your address.");if(10===u)return this.loginMessage0="Unable to connect.",void(this.loginMessage1="Bad session id.");if(11===u)return this.loginMessage1="Login server rejected session.",void(this.loginMessage1="Please try again.");if(12===u)return this.loginMessage0="You need a members account to login to this world.",void(this.loginMessage1="Please subscribe, or use a different world.");if(13===u)return this.loginMessage0="Could not complete login.",void(this.loginMessage1="Please try using a different world.");if(14===u)return this.loginMessage0="The server is being updated.",void(this.loginMessage1="Please wait 1 minute and try again.");if(15===u)return this.ingame=!0,this.out.pos=0,this.in.pos=0,this.inPacketType=-1,this.lastPacketType0=-1,this.lastPacketType1=-1,this.lastPacketType2=-1,this.inPacketSize=0,this.idleNetCycles=0,this.systemUpdateTimer=0,this.menuSize=0,void(this.menuVisible=!1);if(16===u)return this.loginMessage0="Login attempts exceeded.",void(this.loginMessage1="Please wait 1 minute and try again.");if(17===u)this.loginMessage0="You are standing in a members-only area.",this.loginMessage1="To play on this world move to a free area first"}catch(i){this.loginMessage0="",this.loginMessage1="Error connecting to server."}}async updateGame(){if(null===this.players)return;if(this.systemUpdateTimer>1)this.systemUpdateTimer--;if(this.idleTimeout>0)this.idleTimeout--;for(let i=0;i<5&&await this.read();i++);if(this.ingame){for(let i=0;i<this.waveCount;i++)if(this.waveDelay[i]<=0){try{let n=E0.generate(this.waveIds[i],this.waveLoops[i]);if(!n)throw new Error;if(performance.now()+(n.pos/22|0)>this.lastWaveStartTime+(this.lastWaveLength/22|0))this.lastWaveLength=n.pos,this.lastWaveStartTime=performance.now(),this.lastWaveId=this.waveIds[i],this.lastWaveLoops=this.waveLoops[i],await v_(n.data.slice(0,n.pos))}catch(i){}this.waveCount--;for(let n=i;n<this.waveCount;n++)this.waveIds[n]=this.waveIds[n+1],this.waveLoops[n]=this.waveLoops[n+1],this.waveDelay[n]=this.waveDelay[n+1];i--}else this.waveDelay[i]--;if(this.nextMusicDelay>0){if(this.nextMusicDelay-=20,this.nextMusicDelay<0)this.nextMusicDelay=0;if(0===this.nextMusicDelay&&this.midiActive&&!p.lowMemory&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1)}let i=$0.flush();if(i)this.out.p1isaac(81),this.out.p2(i.pos),this.out.pdata(i.data,i.pos,0),i.release();if(this.updateSceneState(),this.updateAddedLocs(),this.idleNetCycles++,this.idleNetCycles>250)await this.tryReconnect();if(this.updatePlayers(),this.updateNpcs(),this.updateEntityChats(),(1===this.actionKey[1]||1===this.actionKey[2]||1===this.actionKey[3]||1===this.actionKey[4])&&this.cameraMovedWrite++>5)this.cameraMovedWrite=0,this.out.p1isaac(189),this.out.p2(this.orbitCameraPitch),this.out.p2(this.orbitCameraYaw),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom);if(this.sceneDelta++,0!==this.crossMode)if(this.crossCycle+=20,this.crossCycle>=400)this.crossMode=0;if(0!==this.selectedArea)if(this.selectedCycle++,this.selectedCycle>=15){if(2===this.selectedArea)this.redrawSidebar=!0;if(3===this.selectedArea)this.redrawChatback=!0;this.selectedArea=0}if(0!==this.objDragArea){if(this.objDragCycles++,this.mouseX>this.objGrabX+5||this.mouseX<this.objGrabX-5||this.mouseY>this.objGrabY+5||this.mouseY<this.objGrabY-5)this.objGrabThreshold=!0;if(0===this.mouseButton){if(2===this.objDragArea)this.redrawSidebar=!0;if(3===this.objDragArea)this.redrawChatback=!0;if(this.objDragArea=0,this.objGrabThreshold&&this.objDragCycles>=5){if(this.hoveredSlotParentId=-1,this.handleInput(),this.hoveredSlotParentId===this.objDragInterfaceId&&this.hoveredSlot!==this.objDragSlot){let i=s.instances[this.objDragInterfaceId];if(i.invSlotObjId){let n=i.invSlotObjId[this.hoveredSlot];i.invSlotObjId[this.hoveredSlot]=i.invSlotObjId[this.objDragSlot],i.invSlotObjId[this.objDragSlot]=n}if(i.invSlotObjCount){let n=i.invSlotObjCount[this.hoveredSlot];i.invSlotObjCount[this.hoveredSlot]=i.invSlotObjCount[this.objDragSlot],i.invSlotObjCount[this.objDragSlot]=n}this.out.p1isaac(159),this.out.p2(this.objDragInterfaceId),this.out.p2(this.objDragSlot),this.out.p2(this.hoveredSlot)}}else if((1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)this.showContextMenu();else if(this.menuSize>0)await this.useMenuOption(this.menuSize-1);this.selectedCycle=10,this.mouseClickButton=0}}if(p.cyclelogic3++,p.cyclelogic3>127)p.cyclelogic3=0,this.out.p1isaac(215),this.out.p3(4991788);if(-1!==V.clickTileX)if(this.localPlayer){let i=V.clickTileX,n=V.clickTileZ,c=this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i,n,0,0,0,0,0,0,!0);if(V.clickTileX=-1,c)this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=1,this.crossCycle=0}if(1===this.mouseClickButton&&this.modalMessage)this.modalMessage=null,this.redrawChatback=!0,this.mouseClickButton=0;if(await this.handleMouseInput(),this.handleMinimapInput(),this.handleTabInput(),this.handleChatSettingsInput(),1===this.mouseButton||1===this.mouseClickButton)this.dragCycles++;if(2===this.sceneState)this.updateOrbitCamera();if(2===this.sceneState&&this.cutscene)this.applyCutscene();for(let i=0;i<5;i++)this.cameraModifierCycle[i]++;if(await this.handleInputKey(),performance.now()-this.idleCycles>9e4)this.idleTimeout=250,this.idleCycles=performance.now()-1e4,this.out.p1isaac(70);if(this.cameraOffsetCycle++,this.cameraOffsetCycle>500){this.cameraOffsetCycle=0;let i=8*Math.random()|0;if(!(1&~i))this.cameraAnticheatOffsetX+=this.cameraOffsetXModifier;if(!(2&~i))this.cameraAnticheatOffsetZ+=this.cameraOffsetZModifier;if(!(4&~i))this.cameraAnticheatAngle+=this.cameraOffsetYawModifier}if(this.cameraAnticheatOffsetX<-50)this.cameraOffsetXModifier=2;if(this.cameraAnticheatOffsetX>50)this.cameraOffsetXModifier=-2;if(this.cameraAnticheatOffsetZ<-55)this.cameraOffsetZModifier=2;if(this.cameraAnticheatOffsetZ>55)this.cameraOffsetZModifier=-2;if(this.cameraAnticheatAngle<-40)this.cameraOffsetYawModifier=1;if(this.cameraAnticheatAngle>40)this.cameraOffsetYawModifier=-1;if(this.minimapOffsetCycle++,this.minimapOffsetCycle>500){this.minimapOffsetCycle=0;let i=8*Math.random()|0;if(!(1&~i))this.minimapAnticheatAngle+=this.minimapAngleModifier;if(!(2&~i))this.minimapZoom+=this.minimapZoomModifier}if(this.minimapAnticheatAngle<-60)this.minimapAngleModifier=2;if(this.minimapAnticheatAngle>60)this.minimapAngleModifier=-2;if(this.minimapZoom<-20)this.minimapZoomModifier=1;if(this.minimapZoom>10)this.minimapZoomModifier=-1;if(p.cyclelogic4++,p.cyclelogic4>110)p.cyclelogic4=0,this.out.p1isaac(236),this.out.p4(0);if(this.heartbeatTimer++,this.heartbeatTimer>50)this.out.p1isaac(108);try{if(this.netStream&&this.out.pos>0)this.netStream.write(this.out.data,this.out.pos),this.out.pos=0,this.heartbeatTimer=0}catch(i){await this.tryReconnect()}}}updateSceneState(){if(p.lowMemory&&2===this.sceneState&&a.levelBuilt!==this.currentLevel)this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11),this.sceneState=1;if(1===this.sceneState)this.checkScene();if(2===this.sceneState&&this.currentLevel!==this.minimapLevel)this.minimapLevel=this.currentLevel,this.createMinimap(this.currentLevel)}checkScene(){if(!(this.sceneMapLandData&&this.sceneMapLandReady&&this.sceneMapLocData&&this.sceneMapLocReady))return-1e3;for(let i=0;i<this.sceneMapLandReady.length;i++){if(!1===this.sceneMapLandReady[i])return-1;if(!1===this.sceneMapLocReady[i])return-2}if(this.sceneAwaitingSync)return-3;return this.sceneState=2,a.levelBuilt=this.currentLevel,this.buildScene(),0}updateAddedLocs(){if(2!==this.sceneState)return;for(let i=this.addedLocs.head();i;i=this.addedLocs.next()){if(i.duration>0)i.duration--;if(0!=i.duration){if(i.delay>0)i.delay--;if(0===i.delay&&i.x>=1&&i.z>=1&&i.x<=102&&i.z<=102)if(this.addLoc(i.plane,i.x,i.z,i.locIndex,i.locAngle,i.shape,i.layer),i.delay=-1,i.lastLocIndex===i.locIndex&&-1===i.lastLocIndex)i.unlink();else if(i.lastLocIndex===i.locIndex&&i.lastAngle===i.locAngle&&i.lastShape===i.shape)i.unlink()}else this.addLoc(i.plane,i.x,i.z,i.lastLocIndex,i.lastAngle,i.lastShape,i.layer),i.unlink()}if(p.cyclelogic5++,p.cyclelogic5>85)p.cyclelogic5=0,this.out.p1isaac(85)}clearAddedLocs(){for(let i=this.addedLocs.head();i;i=this.addedLocs.next())if(-1===i.duration)i.delay=0,this.storeLoc(i);else i.unlink()}appendLoc(i,n,c,d,u,m,v,S,b){let x=null;for(let i=this.addedLocs.head();i;i=this.addedLocs.next())if(i.plane===this.currentLevel&&i.x===S&&i.z===u&&i.layer===d){x=i;break}if(!x)x=new Q_,x.plane=v,x.layer=d,x.x=S,x.z=u,this.storeLoc(x),this.addedLocs.addTail(x);x.locIndex=n,x.shape=m,x.locAngle=c,x.delay=b,x.duration=i}storeLoc(i){if(!this.scene)return;let n=0,c=-1,d=0,u=0;if(0===i.layer)n=this.scene.getWallTypecode(i.plane,i.x,i.z);else if(1===i.layer)n=this.scene.getDecorTypecode(i.plane,i.z,i.x);else if(2===i.layer)n=this.scene.getLocTypecode(i.plane,i.x,i.z);else if(3===i.layer)n=this.scene.getGroundDecorTypecode(i.plane,i.x,i.z);if(0!==n){let m=this.scene.getInfo(i.plane,i.x,i.z,n);c=n>>14&32767,d=31&m,u=m>>6}i.lastLocIndex=c,i.lastShape=d,i.lastAngle=u}drawGame(){if(null===this.players)return;if(this.redrawTitleBackground)if(this.redrawTitleBackground=!1,this.areaBackleft1?.draw(0,11),this.areaBackleft2?.draw(0,375),this.areaBackright1?.draw(729,5),this.areaBackright2?.draw(752,231),this.areaBacktop1?.draw(0,0),this.areaBacktop2?.draw(561,0),this.areaBackvmid1?.draw(520,11),this.areaBackvmid2?.draw(520,231),this.areaBackvmid3?.draw(501,375),this.areaBackhmid2?.draw(0,345),this.redrawSidebar=!0,this.redrawChatback=!0,this.redrawSideicons=!0,this.redrawPrivacySettings=!0,2!==this.sceneState)this.areaViewport?.draw(8,11),this.areaMapback?.draw(561,5);if(2===this.sceneState)this.drawScene();if(this.menuVisible&&1===this.menuArea)this.redrawSidebar=!0;let i=!1;if(-1!==this.sidebarInterfaceId)if(i=this.updateInterfaceAnimation(this.sidebarInterfaceId,this.sceneDelta),i)this.redrawSidebar=!0;if(2===this.selectedArea)this.redrawSidebar=!0;if(2===this.objDragArea)this.redrawSidebar=!0;if(this.redrawSidebar)this.drawSidebar(),this.redrawSidebar=!1;if(-1===this.chatInterfaceId){if(this.chatInterface.scrollPosition=this.chatScrollHeight-this.chatScrollOffset-77,this.mouseX>453&&this.mouseX<565&&this.mouseY>350)this.handleScrollInput(this.mouseX-22,this.mouseY-375,this.chatScrollHeight,77,!1,463,0,this.chatInterface);let i=this.chatScrollHeight-this.chatInterface.scrollPosition-77;if(i<0)i=0;if(i>this.chatScrollHeight-77)i=this.chatScrollHeight-77;if(this.chatScrollOffset!==i)this.chatScrollOffset=i,this.redrawChatback=!0}if(-1!==this.chatInterfaceId)if(i=this.updateInterfaceAnimation(this.chatInterfaceId,this.sceneDelta),i)this.redrawChatback=!0;if(3===this.selectedArea)this.redrawChatback=!0;if(3===this.objDragArea)this.redrawChatback=!0;if(this.modalMessage)this.redrawChatback=!0;if(this.menuVisible&&2===this.menuArea)this.redrawChatback=!0;if(this.redrawChatback)this.drawChatback(),this.redrawChatback=!1;if(2===this.sceneState)this.drawMinimap(),this.areaMapback?.draw(561,5);if(-1!==this.flashingTab)this.redrawSideicons=!0;if(this.redrawSideicons){if(-1!==this.flashingTab&&this.flashingTab===this.selectedTab)this.flashingTab=-1,this.out.p1isaac(175),this.out.p1(this.selectedTab);if(this.redrawSideicons=!1,this.areaBackhmid1?.bind(),this.imageBackhmid1?.draw(0,0),-1===this.sidebarInterfaceId){if(-1!==this.tabInterfaceId[this.selectedTab])if(0===this.selectedTab)this.imageRedstone1?.draw(29,30);else if(1===this.selectedTab)this.imageRedstone2?.draw(59,29);else if(2===this.selectedTab)this.imageRedstone2?.draw(87,29);else if(3===this.selectedTab)this.imageRedstone3?.draw(115,29);else if(4===this.selectedTab)this.imageRedstone2h?.draw(156,29);else if(5===this.selectedTab)this.imageRedstone2h?.draw(184,29);else if(6===this.selectedTab)this.imageRedstone1h?.draw(212,30);if(-1!==this.tabInterfaceId[0]&&(0!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[0]?.draw(35,34);if(-1!==this.tabInterfaceId[1]&&(1!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[1]?.draw(59,32);if(-1!==this.tabInterfaceId[2]&&(2!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[2]?.draw(86,32);if(-1!==this.tabInterfaceId[3]&&(3!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[3]?.draw(121,33);if(-1!==this.tabInterfaceId[4]&&(4!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[4]?.draw(157,34);if(-1!==this.tabInterfaceId[5]&&(5!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[5]?.draw(185,32);if(-1!==this.tabInterfaceId[6]&&(6!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[6]?.draw(212,34)}if(this.areaBackhmid1?.draw(520,165),this.areaBackbase2?.bind(),this.imageBackbase2?.draw(0,0),-1===this.sidebarInterfaceId){if(-1!==this.tabInterfaceId[this.selectedTab])if(7===this.selectedTab)this.imageRedstone1v?.draw(49,0);else if(8===this.selectedTab)this.imageRedstone2v?.draw(81,0);else if(9===this.selectedTab)this.imageRedstone2v?.draw(108,0);else if(10===this.selectedTab)this.imageRedstone3v?.draw(136,1);else if(11===this.selectedTab)this.imageRedstone2hv?.draw(178,0);else if(12===this.selectedTab)this.imageRedstone2hv?.draw(205,0);else if(13===this.selectedTab)this.imageRedstone1hv?.draw(233,0);if(-1!==this.tabInterfaceId[8]&&(8!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[7]?.draw(80,2);if(-1!==this.tabInterfaceId[9]&&(9!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[8]?.draw(107,3);if(-1!==this.tabInterfaceId[10]&&(10!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[9]?.draw(142,4);if(-1!==this.tabInterfaceId[11]&&(11!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[10]?.draw(179,2);if(-1!==this.tabInterfaceId[12]&&(12!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[11]?.draw(206,2);if(-1!==this.tabInterfaceId[13]&&(13!==this.flashingTab||this.loopCycle%20<10))this.imageSideicons[12]?.draw(230,2)}this.areaBackbase2?.draw(501,492),this.areaViewport?.bind()}if(this.redrawPrivacySettings){if(this.redrawPrivacySettings=!1,this.areaBackbase1?.bind(),this.imageBackbase1?.draw(0,0),this.fontPlain12?.drawStringTaggableCenter(57,33,"Public chat",16777215,!0),0===this.publicChatSetting)this.fontPlain12?.drawStringTaggableCenter(57,46,"On",65280,!0);if(1===this.publicChatSetting)this.fontPlain12?.drawStringTaggableCenter(57,46,"Friends",16776960,!0);if(2===this.publicChatSetting)this.fontPlain12?.drawStringTaggableCenter(57,46,"Off",16711680,!0);if(3===this.publicChatSetting)this.fontPlain12?.drawStringTaggableCenter(57,46,"Hide",65535,!0);if(this.fontPlain12?.drawStringTaggableCenter(186,33,"Private chat",16777215,!0),0===this.privateChatSetting)this.fontPlain12?.drawStringTaggableCenter(186,46,"On",65280,!0);if(1===this.privateChatSetting)this.fontPlain12?.drawStringTaggableCenter(186,46,"Friends",16776960,!0);if(2===this.privateChatSetting)this.fontPlain12?.drawStringTaggableCenter(186,46,"Off",16711680,!0);if(this.fontPlain12?.drawStringTaggableCenter(326,33,"Trade/duel",16777215,!0),0===this.tradeChatSetting)this.fontPlain12?.drawStringTaggableCenter(326,46,"On",65280,!0);if(1===this.tradeChatSetting)this.fontPlain12?.drawStringTaggableCenter(326,46,"Friends",16776960,!0);if(2===this.tradeChatSetting)this.fontPlain12?.drawStringTaggableCenter(326,46,"Off",16711680,!0);this.fontPlain12?.drawStringTaggableCenter(462,38,"Report abuse",16777215,!0),this.areaBackbase1?.draw(0,471),this.areaViewport?.bind()}this.sceneDelta=0}drawScene(){if(this.sceneCycle++,this.pushPlayers(),this.pushNpcs(),this.pushProjectiles(),this.pushSpotanims(),this.pushLocs(),!this.cutscene){let i=this.orbitCameraPitch;if((this.cameraPitchClamp/256|0)>i)i=this.cameraPitchClamp/256|0;if(this.cameraModifierEnabled[4]&&this.cameraModifierWobbleScale[4]+128>i)i=this.cameraModifierWobbleScale[4]+128;let n=this.orbitCameraYaw+this.cameraAnticheatAngle&2047;if(this.localPlayer)this.orbitCamera(this.orbitCameraX,this.getHeightmapY(this.currentLevel,this.localPlayer.x,this.localPlayer.z)-50,this.orbitCameraZ,n,i,3*i+600);if(p.cyclelogic2++,p.cyclelogic2>1802){p.cyclelogic2=0,this.out.p1isaac(146),this.out.p1(0);let i=this.out.pos;if(this.out.p2(29711),this.out.p1(70),this.out.p1(256*Math.random()|0),this.out.p1(242),this.out.p1(186),this.out.p1(39),this.out.p1(61),!(2*Math.random()|0))this.out.p1(13);if(!(2*Math.random()|0))this.out.p2(57856);this.out.p2(65536*Math.random()|0),this.out.psize1(this.out.pos-i)}}let i;if(this.cutscene)i=this.getTopLevelCutscene();else i=this.getTopLevel();let n=this.cameraX,c=this.cameraY,d=this.cameraZ,u=this.cameraPitch,m=this.cameraYaw,v;for(let i=0;i<5;i++)if(this.cameraModifierEnabled[i]){if(v=Math.random()*(2*this.cameraModifierJitter[i]+1)-this.cameraModifierJitter[i]+Math.sin(this.cameraModifierCycle[i]*(this.cameraModifierWobbleSpeed[i]/100))*this.cameraModifierWobbleScale[i]|0,0===i)this.cameraX+=v;if(1===i)this.cameraY+=v;if(2===i)this.cameraZ+=v;if(3===i)this.cameraYaw=this.cameraYaw+v&2047;if(4===i){if(this.cameraPitch+=v,this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}}v=w.cycle,J.checkHover=!0,J.pickedCount=0,J.mouseX=this.mouseX-8,J.mouseY=this.mouseY-11,T.clear(),this.scene?.draw(this.cameraX,this.cameraY,this.cameraZ,i,this.cameraYaw,this.cameraPitch,this.loopCycle),this.scene?.clearTemporaryLocs(),this.draw2DEntityElements(),this.drawTileHint(),this.updateTextures(v),this.draw3DEntityElements(),this.areaViewport?.draw(8,11),this.cameraX=n,this.cameraY=c,this.cameraZ=d,this.cameraPitch=u,this.cameraYaw=m}clearCaches(){Q0.modelCacheStatic?.clear(),Q0.modelCacheDynamic?.clear(),w0.modelCache?.clear(),_0.modelCache?.clear(),_0.iconCache?.clear(),K0.modelCache?.clear(),T0.modelCache?.clear()}projectFromEntity(i,n){this.projectFromGround(i.x,n,i.z)}projectFromGround(i,n,c){if(i<128||c<128||i>13056||c>13056)return this.projectX=-1,void(this.projectY=-1);let d=this.getHeightmapY(this.currentLevel,i,c)-n;this.project(i,d,c)}project(i,n,c){let d=i-this.cameraX,u=n-this.cameraY,m=c-this.cameraZ,v=w.sin[this.cameraPitch],S=w.cos[this.cameraPitch],b=w.sin[this.cameraYaw],x=w.cos[this.cameraYaw],I=m*b+d*x>>16;if(m=m*x-d*b>>16,d=I,I=u*S-m*v>>16,m=u*v+m*S>>16,u=I,m>=50)this.projectX=w.centerX+((d<<9)/m|0),this.projectY=w.centerY+((u<<9)/m|0);else this.projectX=-1,this.projectY=-1}draw2DEntityElements(){this.chatCount=0;for(let i=-1;i<this.playerCount+this.npcCount;i++){let n=null;if(-1===i)n=this.localPlayer;else if(i<this.playerCount)n=this.players[this.playerIds[i]];else n=this.npcs[this.npcIds[i-this.playerCount]];if(!n||!n.isVisibleNow())continue;if(i<this.playerCount){let c=30,d=n;if(0!==d.headicons)if(this.projectFromEntity(n,n.maxY+15),this.projectX>-1)for(let i=0;i<8;i++)if(!!(d.headicons&1<<i))this.imageHeadicons[i]?.draw(this.projectX-12,this.projectY-c),c-=25;if(i>=0&&10===this.hintType&&this.hintPlayer===this.playerIds[i])if(this.projectFromEntity(n,n.maxY+15),this.projectX>-1)this.imageHeadicons[7]?.draw(this.projectX-12,this.projectY-c)}else if(1===this.hintType&&this.hintNpc===this.npcIds[i-this.playerCount]&&this.loopCycle%20<10)if(this.projectFromEntity(n,n.maxY+15),this.projectX>-1)this.imageHeadicons[2]?.draw(this.projectX-12,this.projectY-28);if(n.chat&&(i>=this.playerCount||0===this.publicChatSetting||3===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(n.name)))if(this.projectFromEntity(n,n.maxY),this.projectX>-1&&this.chatCount<50&&this.fontBold12){if(this.chatWidth[this.chatCount]=this.fontBold12.stringWidth(n.chat)/2|0,this.chatHeight[this.chatCount]=this.fontBold12.height2d,this.chatX[this.chatCount]=this.projectX,this.chatY[this.chatCount]=this.projectY,this.chatColors[this.chatCount]=n.chatColor,this.chatStyles[this.chatCount]=n.chatStyle,this.chatTimers[this.chatCount]=n.chatTimer,this.chats[this.chatCount++]=n.chat,0===this.chatEffects&&1===n.chatStyle)this.chatHeight[this.chatCount]+=10,this.chatY[this.chatCount]+=5;if(0===this.chatEffects&&2===n.chatStyle)this.chatWidth[this.chatCount]=60}if(n.combatCycle>this.loopCycle+100)if(this.projectFromEntity(n,n.maxY+15),this.projectX>-1){let i=30*n.health/n.totalHealth|0;if(i>30)i=30;T.fillRect2d(this.projectX-15,this.projectY-3,i,5,65280),T.fillRect2d(this.projectX-15+i,this.projectY-3,30-i,5,16711680)}if(n.combatCycle>this.loopCycle+330)if(this.projectFromEntity(n,n.maxY/2|0),this.projectX>-1)this.imageHitmarks[n.damageType]?.draw(this.projectX-12,this.projectY-12),this.fontPlain11?.drawStringCenter(this.projectX,this.projectY+4,n.damage.toString(),0),this.fontPlain11?.drawStringCenter(this.projectX-1,this.projectY+3,n.damage.toString(),16777215)}for(let i=0;i<this.chatCount;i++){let n=this.chatX[i],c=this.chatY[i],d=this.chatWidth[i],u=this.chatHeight[i],m=!0;while(m){m=!1;for(let v=0;v<i;v++)if(c+2>this.chatY[v]-this.chatHeight[v]&&c-u<this.chatY[v]+2&&n-d<this.chatX[v]+this.chatWidth[v]&&n+d>this.chatX[v]-this.chatWidth[v]&&this.chatY[v]-this.chatHeight[v]<c)c=this.chatY[v]-this.chatHeight[v],m=!0}this.projectX=this.chatX[i],this.projectY=this.chatY[i]=c;let v=this.chats[i];if(0===this.chatEffects){let n=16776960;if(this.chatColors[i]<6)n=p.CHAT_COLORS[this.chatColors[i]];if(6===this.chatColors[i])n=this.sceneCycle%20<10?16711680:16776960;if(7===this.chatColors[i])n=this.sceneCycle%20<10?255:65535;if(8===this.chatColors[i])n=this.sceneCycle%20<10?45056:8454016;if(9===this.chatColors[i]){let c=150-this.chatTimers[i];if(c<50)n=1280*c+16711680;else if(c<100)n=16776960-327680*(c-50);else if(c<150)n=5*(c-100)+65280}if(10===this.chatColors[i]){let c=150-this.chatTimers[i];if(c<50)n=5*c+16711680;else if(c<100)n=16711935-327680*(c-50);else if(c<150)n=327680*(c-100)+255-5*(c-100)}if(11===this.chatColors[i]){let c=150-this.chatTimers[i];if(c<50)n=16777215-327685*c;else if(c<100)n=327685*(c-50)+65280;else if(c<150)n=16777215-327680*(c-100)}if(0===this.chatStyles[i])this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,v,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,v,n);if(1===this.chatStyles[i])this.fontBold12?.drawCenteredWave(this.projectX,this.projectY+1,v,0,this.sceneCycle),this.fontBold12?.drawCenteredWave(this.projectX,this.projectY,v,n,this.sceneCycle);if(2===this.chatStyles[i]){let c=this.fontBold12?.stringWidth(v)??0,d=(150-this.chatTimers[i])*(c+100)/150;T.setBounds(this.projectX-50,0,this.projectX+50,334),this.fontBold12?.drawString(this.projectX+50-d,this.projectY+1,v,0),this.fontBold12?.drawString(this.projectX+50-d,this.projectY,v,n),T.resetBounds()}}else this.fontBold12?.drawStringCenter(this.projectX,this.projectY+1,v,0),this.fontBold12?.drawStringCenter(this.projectX,this.projectY,v,16776960)}}drawTileHint(){if(2!==this.hintType||!this.imageHeadicons[2])return;if(this.projectFromGround((this.hintTileX-this.sceneBaseTileX<<7)+this.hintOffsetX,2*this.hintHeight,(this.hintTileZ-this.sceneBaseTileZ<<7)+this.hintOffsetZ),this.projectX>-1&&this.loopCycle%20<10)this.imageHeadicons[2].draw(this.projectX-12,this.projectY-28)}draw3DEntityElements(){if(this.drawPrivateMessages(),1===this.crossMode)this.imageCrosses[this.crossCycle/100|0]?.draw(this.crossX-8-8,this.crossY-8-11);if(2===this.crossMode)this.imageCrosses[(this.crossCycle/100|0)+4]?.draw(this.crossX-8-8,this.crossY-8-11);if(-1!==this.viewportInterfaceId)this.updateInterfaceAnimation(this.viewportInterfaceId,this.sceneDelta),this.drawInterface(s.instances[this.viewportInterfaceId],0,0,0);if(this.drawWildyLevel(),!this.menuVisible)this.handleInput(),this.drawTooltip();else if(0===this.menuArea)this.drawMenu();if(1===this.inMultizone)if(this.wildernessLevel>0||1===this.worldLocationState)this.imageHeadicons[1]?.draw(472,258);else this.imageHeadicons[1]?.draw(472,296);if(this.wildernessLevel>0)this.imageHeadicons[0]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Level: "+this.wildernessLevel,16776960);if(1===this.worldLocationState)this.imageHeadicons[6]?.draw(472,296),this.fontPlain12?.drawStringCenter(484,329,"Arena",16776960);if(this.displayFps){let i=507,n=20,c=16776960;if(this.fps<15)c=16711680;this.fontPlain12?.drawStringRight(i,n,"Fps:"+this.fps,c),n+=15;let d=-1;if(void 0!==window.performance.memory)d=window.performance.memory.usedJSHeapSize/1024|0;if(-1!==d)this.fontPlain12?.drawStringRight(i,n,"Mem:"+d+"k",16776960)}if(0!==this.systemUpdateTimer){let i=this.systemUpdateTimer/50|0,n=i/60|0;if(i%=60,i<10)this.fontPlain12?.drawString(4,329,"System update in: "+n+":0"+i,16776960);else this.fontPlain12?.drawString(4,329,"System update in: "+n+":"+i,16776960)}}drawPrivateMessages(){if(0===this.splitPrivateChat)return;let i=this.fontPlain12,n=0;if(0!==this.systemUpdateTimer)n=1;for(let c=0;c<100;c++){if(!this.messageText[c])continue;let d=this.messageTextType[c],u;if((3===d||7===d)&&(7===d||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageTextSender[c])))if(u=329-13*n,i?.drawString(4,u,"From "+this.messageTextSender[c]+": "+this.messageText[c],0),i?.drawString(4,u-1,"From "+this.messageTextSender[c]+": "+this.messageText[c],65535),n++,n>=5)return;if(5===d&&this.privateChatSetting<2)if(u=329-13*n,i?.drawString(4,u,this.messageText[c],0),i?.drawString(4,u-1,this.messageText[c],65535),n++,n>=5)return;if(6===d&&this.privateChatSetting<2)if(u=329-13*n,i?.drawString(4,u,"To "+this.messageTextSender[c]+": "+this.messageText[c],0),i?.drawString(4,u-1,"To "+this.messageTextSender[c]+": "+this.messageText[c],65535),n++,n>=5)return}}drawWildyLevel(){if(!this.localPlayer)return;let i=(this.localPlayer.x>>7)+this.sceneBaseTileX,n=(this.localPlayer.z>>7)+this.sceneBaseTileZ;if(i>=2944&&i<3392&&n>=3520&&n<6400)this.wildernessLevel=((n-3520)/8|0)+1;else if(i>=2944&&i<3392&&n>=9920&&n<12800)this.wildernessLevel=((n-9920)/8|0)+1;else this.wildernessLevel=0;if(this.worldLocationState=0,i>=3328&&i<3392&&n>=3200&&n<3264){let c=63&i,d=63&n;if(c>=4&&c<=29&&d>=44&&d<=58)this.worldLocationState=1;else if(c>=36&&c<=61&&d>=44&&d<=58)this.worldLocationState=1;else if(c>=4&&c<=29&&d>=25&&d<=39)this.worldLocationState=1;else if(c>=36&&c<=61&&d>=25&&d<=39)this.worldLocationState=1;else if(c>=4&&c<=29&&d>=6&&d<=20)this.worldLocationState=1;else if(c>=36&&c<=61&&d>=6&&d<=20)this.worldLocationState=1}if(0===this.worldLocationState&&i>=3328&&i<=3393&&n>=3203&&n<=3325)this.worldLocationState=2;if(this.overrideChat=0,i>=3053&&i<=3156&&n>=3056&&n<=3136)this.overrideChat=1;else if(i>=3072&&i<=3118&&n>=9492&&n<=9535)this.overrideChat=1;if(1===this.overrideChat&&i>=3139&&i<=3199&&n>=3008&&n<=3062)this.overrideChat=0}drawSidebar(){if(this.areaSidebar?.bind(),this.areaSidebarOffsets)w.lineOffset=this.areaSidebarOffsets;if(this.imageInvback?.draw(0,0),-1!==this.sidebarInterfaceId)this.drawInterface(s.instances[this.sidebarInterfaceId],0,0,0);else if(-1!==this.tabInterfaceId[this.selectedTab])this.drawInterface(s.instances[this.tabInterfaceId[this.selectedTab]],0,0,0);if(this.menuVisible&&1===this.menuArea)this.drawMenu();if(this.areaSidebar?.draw(562,231),this.areaViewport?.bind(),this.areaViewportOffsets)w.lineOffset=this.areaViewportOffsets}drawChatback(){if(this.areaChatback?.bind(),this.areaChatbackOffsets)w.lineOffset=this.areaChatbackOffsets;if(this.imageChatback?.draw(0,0),this.showSocialInput)this.fontBold12?.drawStringCenter(239,40,this.socialMessage,0),this.fontBold12?.drawStringCenter(239,60,this.socialInput+"*",128);else if(this.chatbackInputOpen)this.fontBold12?.drawStringCenter(239,40,"Enter amount:",0),this.fontBold12?.drawStringCenter(239,60,this.chatbackInput+"*",128);else if(this.modalMessage)this.fontBold12?.drawStringCenter(239,40,this.modalMessage,0),this.fontBold12?.drawStringCenter(239,60,"Click to continue",128);else if(-1!==this.chatInterfaceId)this.drawInterface(s.instances[this.chatInterfaceId],0,0,0);else if(-1===this.stickyChatInterfaceId){let i=this.fontPlain12,n=0;T.setBounds(0,0,463,77);for(let c=0;c<100;c++){let d=this.messageText[c];if(!d)continue;let u=this.messageTextType[c],m=this.chatScrollOffset+70-14*n;if(0===u){if(m>0&&m<110)i?.drawString(4,m,d,0);n++}if(1===u){if(m>0&&m<110)i?.drawString(4,m,this.messageTextSender[c]+":",16777215),i?.drawString(i.stringWidth(this.messageTextSender[c])+12,m,d,255);n++}if(2===u&&(0===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(this.messageTextSender[c]))){if(m>0&&m<110)i?.drawString(4,m,this.messageTextSender[c]+":",0),i?.drawString(i.stringWidth(this.messageTextSender[c])+12,m,d,255);n++}if((3===u||7===u)&&0===this.splitPrivateChat&&(7===u||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageTextSender[c]))){if(m>0&&m<110)i?.drawString(4,m,"From "+this.messageTextSender[c]+":",0),i?.drawString(i.stringWidth("From "+this.messageTextSender[c])+12,m,d,8388608);n++}if(4===u&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageTextSender[c]))){if(m>0&&m<110)i?.drawString(4,m,this.messageTextSender[c]+" "+this.messageText[c],8388736);n++}if(5===u&&0===this.splitPrivateChat&&this.privateChatSetting<2){if(m>0&&m<110)i?.drawString(4,m,d,8388608);n++}if(6===u&&0===this.splitPrivateChat&&this.privateChatSetting<2){if(m>0&&m<110)i?.drawString(4,m,"To "+this.messageTextSender[c]+":",0),i?.drawString(i.stringWidth("To "+this.messageTextSender[c])+12,m,d,8388608);n++}if(8===u&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageTextSender[c]))){if(m>0&&m<110)i?.drawString(4,m,this.messageTextSender[c]+" "+this.messageText[c],13350793);n++}}if(T.resetBounds(),this.chatScrollHeight=14*n+7,this.chatScrollHeight<78)this.chatScrollHeight=78;this.drawScrollbar(463,0,this.chatScrollHeight-this.chatScrollOffset-77,this.chatScrollHeight,77),i?.drawString(4,90,l.formatName(this.usernameInput)+":",0),i?.drawString(i.stringWidth(this.usernameInput+": ")+6,90,this.chatTyped+"*",255),T.drawHorizontalLine(0,77,0,479)}else this.drawInterface(s.instances[this.stickyChatInterfaceId],0,0,0);if(this.menuVisible&&2===this.menuArea)this.drawMenu();if(this.areaChatback?.draw(22,375),this.areaViewport?.bind(),this.areaViewportOffsets)w.lineOffset=this.areaViewportOffsets}drawMinimap(){if(this.areaMapback?.bind(),!this.localPlayer)return;let i=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,n=(this.localPlayer.x/32|0)+48,c=464-(this.localPlayer.z/32|0);this.imageMinimap?.drawRotatedMasked(21,9,146,151,this.minimapMaskLineOffsets,this.minimapMaskLineLengths,n,c,i,this.minimapZoom+256),this.imageCompass?.drawRotatedMasked(0,0,33,33,this.compassMaskLineOffsets,this.compassMaskLineLengths,25,25,this.orbitCameraYaw,256);for(let i=0;i<this.activeMapFunctionCount;i++)n=4*this.activeMapFunctionX[i]+2-(this.localPlayer.x/32|0),c=4*this.activeMapFunctionZ[i]+2-(this.localPlayer.z/32|0),this.drawOnMinimap(c,this.activeMapFunctions[i],n);for(let i=0;i<104;i++)for(let d=0;d<104;d++)if(this.objStacks[this.currentLevel][i][d])n=4*i+2-(this.localPlayer.x/32|0),c=4*d+2-(this.localPlayer.z/32|0),this.drawOnMinimap(c,this.imageMapdot0,n);for(let i=0;i<this.npcCount;i++){let d=this.npcs[this.npcIds[i]];if(d&&d.isVisibleNow()&&d.npcType&&d.npcType.minimap)n=(d.x/32|0)-(this.localPlayer.x/32|0),c=(d.z/32|0)-(this.localPlayer.z/32|0),this.drawOnMinimap(c,this.imageMapdot1,n)}for(let i=0;i<this.playerCount;i++){let d=this.players[this.playerIds[i]];if(d&&d.isVisibleNow()&&d.name){n=(d.x/32|0)-(this.localPlayer.x/32|0),c=(d.z/32|0)-(this.localPlayer.z/32|0);let i=!1,u=l.toBase37(d.name);for(let n=0;n<this.friendCount;n++)if(u===this.friendName37[n]&&0!==this.friendWorld[n]){i=!0;break}if(i)this.drawOnMinimap(c,this.imageMapdot3,n);else this.drawOnMinimap(c,this.imageMapdot2,n)}}if(0!==this.flagSceneTileX)n=4*this.flagSceneTileX+2-(this.localPlayer.x/32|0),c=4*this.flagSceneTileZ+2-(this.localPlayer.z/32|0),this.drawOnMinimap(c,this.imageMapflag,n);T.fillRect2d(93,82,3,3,16777215),this.areaViewport?.bind()}drawOnMinimap(i,n,c){if(!n)return;let d=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,u=c*c+i*i;if(u>6400)return;let m=w.sin[d],v=w.cos[d];m=256*m/(this.minimapZoom+256)|0,v=256*v/(this.minimapZoom+256)|0;let S=i*m+c*v>>16,b=i*v-c*m>>16;if(u>2500&&this.imageMapback)n.drawMasked(S+94-(n.cropW/2|0),83-b-(n.cropH/2|0),this.imageMapback);else n.draw(S+94-(n.cropW/2|0),83-b-(n.cropH/2|0))}createMinimap(i){if(!this.imageMinimap)return;let n=this.imageMinimap.pixels,c=n.length;for(let i=0;i<c;i++)n[i]=0;for(let c=1;c<104-1;c++){let d=512*(104-1-c)*4+24628;for(let u=1;u<104-1;u++){if(this.levelTileFlags&&!(24&this.levelTileFlags[i][u][c]))this.scene?.drawMinimapTile(i,u,c,n,d,512);if(i<3&&this.levelTileFlags&&!!(8&this.levelTileFlags[i+1][u][c]))this.scene?.drawMinimapTile(i+1,u,c,n,d,512);d+=4}}let d=((20*Math.random()|0)+238-10<<16)+((20*Math.random()|0)+238-10<<8)+(20*Math.random()|0)+238-10,u=(20*Math.random()|0)+238-10<<16;this.imageMinimap.bind();for(let n=1;n<104-1;n++)for(let c=1;c<104-1;c++){if(this.levelTileFlags&&!(24&this.levelTileFlags[i][c][n]))this.drawMinimapLoc(c,n,i,d,u);if(i<3&&this.levelTileFlags&&!!(8&this.levelTileFlags[i+1][c][n]))this.drawMinimapLoc(c,n,i+1,d,u)}this.areaViewport?.bind(),this.activeMapFunctionCount=0;for(let i=0;i<104;i++)for(let n=0;n<104;n++){let c=this.scene?.getGroundDecorTypecode(this.currentLevel,i,n)??0;if(0===c)continue;c=c>>14&32767;let d=Q0.get(c).mapfunction;if(d<0)continue;let u=i,m=n;if(22!==d&&29!==d&&34!==d&&36!==d&&46!==d&&47!==d&&48!==d){let c=104,d=104,v=this.levelCollisionMap[this.currentLevel];if(v){let S=v.flags;for(let v=0;v<10;v++){let v=4*Math.random()|0;if(0===v&&u>0&&u>i-3&&!(2621704&S[o.index(u-1,m)]))u--;if(1===v&&u<c-1&&u<i+3&&!(2621824&S[o.index(u+1,m)]))u++;if(2===v&&m>0&&m>n-3&&!(2621698&S[o.index(u,m-1)]))m--;if(3===v&&m<d-1&&m<n+3&&!(2621728&S[o.index(u,m+1)]))m++}}}this.activeMapFunctions[this.activeMapFunctionCount]=this.imageMapfunction[d],this.activeMapFunctionX[this.activeMapFunctionCount]=u,this.activeMapFunctionZ[this.activeMapFunctionCount]=m,this.activeMapFunctionCount++}}drawMinimapLoc(i,n,c,d,u){if(!this.scene||!this.imageMinimap)return;let m=this.scene.getWallTypecode(c,i,n);if(0!==m){let v=this.scene.getInfo(c,i,n,m),S=v>>6&3,b=31&v,x=d;if(m>0)x=u;let I=this.imageMinimap.pixels,A=4*i+512*(103-n)*4+24624,k=m>>14&32767,L=Q0.get(k);if(-1===L.mapscene){if(b===h.WALL_STRAIGHT.id||b===h.WALL_L.id)if(0===S)I[A]=x,I[A+512]=x,I[A+1024]=x,I[A+1536]=x;else if(1===S)I[A]=x,I[A+1]=x,I[A+2]=x,I[A+3]=x;else if(2===S)I[A+3]=x,I[A+3+512]=x,I[A+3+1024]=x,I[A+3+1536]=x;else if(3===S)I[A+1536]=x,I[A+1536+1]=x,I[A+1536+2]=x,I[A+1536+3]=x;if(b===h.WALL_SQUARE_CORNER.id)if(0===S)I[A]=x;else if(1===S)I[A+3]=x;else if(2===S)I[A+3+1536]=x;else if(3===S)I[A+1536]=x;if(b===h.WALL_L.id)if(3===S)I[A]=x,I[A+512]=x,I[A+1024]=x,I[A+1536]=x;else if(0===S)I[A]=x,I[A+1]=x,I[A+2]=x,I[A+3]=x;else if(1===S)I[A+3]=x,I[A+3+512]=x,I[A+3+1024]=x,I[A+3+1536]=x;else if(2===S)I[A+1536]=x,I[A+1536+1]=x,I[A+1536+2]=x,I[A+1536+3]=x}else{let c=this.imageMapscene[L.mapscene];if(c){let d=(4*L.width-c.width2d)/2|0,u=(4*L.length-c.height2d)/2|0;c.draw(4*i+48+d,4*(104-n-L.length)+u+48)}}}if(m=this.scene.getLocTypecode(c,i,n),0!==m){let d=this.scene.getInfo(c,i,n,m),u=d>>6&3,v=31&d,S=m>>14&32767,b=Q0.get(S);if(-1!==b.mapscene){let c=this.imageMapscene[b.mapscene];if(c){let d=(4*b.width-c.width2d)/2|0,u=(4*b.length-c.height2d)/2|0;c.draw(4*i+48+d,4*(104-n-b.length)+u+48)}}else if(v===h.WALL_DIAGONAL.id){let c=15658734;if(m>0)c=15597568;let d=this.imageMinimap.pixels,v=4*i+512*(104-1-n)*4+24624;if(0===u||2===u)d[v+1536]=c,d[v+1024+1]=c,d[v+512+2]=c,d[v+3]=c;else d[v]=c,d[v+512+1]=c,d[v+1024+2]=c,d[v+1536+3]=c}}if(m=this.scene.getGroundDecorTypecode(c,i,n),0!==m){let c=Q0.get(m>>14&32767);if(-1!==c.mapscene){let d=this.imageMapscene[c.mapscene];if(d){let u=(4*c.width-d.width2d)/2|0,m=(4*c.length-d.height2d)/2|0;d.draw(4*i+48+u,4*(104-n-c.length)+m+48)}}}}drawTooltip(){if(this.menuSize<2&&0===this.objSelected&&0===this.spellSelected)return;let i;if(1===this.objSelected&&this.menuSize<2)i="Use "+this.objSelectedName+" with...";else if(1===this.spellSelected&&this.menuSize<2)i=this.spellCaption+"...";else i=this.menuOption[this.menuSize-1];if(this.menuSize>2)i=i+"@whi@ / "+(this.menuSize-2)+" more options";this.fontBold12?.drawStringTooltip(4,15,i,16777215,!0,this.loopCycle/1e3|0)}drawMenu(){let i=this.menuX,n=this.menuY,c=this.menuWidth,d=this.menuHeight,u=6116423;T.fillRect2d(i,n,c,d,u),T.fillRect2d(i+1,n+1,c-2,16,0),T.drawRect(i+1,n+18,c-2,d-19,0),this.fontBold12?.drawString(i+3,n+14,"Choose Option",u);let m=this.mouseX,v=this.mouseY;if(0===this.menuArea)m-=8,v-=11;if(1===this.menuArea)m-=562,v-=231;if(2===this.menuArea)m-=22,v-=375;for(let d=0;d<this.menuSize;d++){let u=n+15*(this.menuSize-1-d)+31,S=16777215;if(m>i&&m<i+c&&v>u-13&&v<u+3)S=16776960;this.fontBold12?.drawStringTaggable(i+3,u,this.menuOption[d],S,!0)}}async handleMouseInput(){if(0!==this.objDragArea)return;let i=this.mouseClickButton;if(1===this.spellSelected&&this.mouseClickX>=520&&this.mouseClickY>=165&&this.mouseClickX<=788&&this.mouseClickY<=230)i=0;if(this.menuVisible){if(1!==i){let i=this.mouseX,n=this.mouseY;if(0===this.menuArea)i-=8,n-=11;else if(1===this.menuArea)i-=562,n-=231;else if(2===this.menuArea)i-=22,n-=375;if(i<this.menuX-10||i>this.menuX+this.menuWidth+10||n<this.menuY-10||n>this.menuY+this.menuHeight+10){if(this.menuVisible=!1,1===this.menuArea)this.redrawSidebar=!0;if(2===this.menuArea)this.redrawChatback=!0}}if(1===i){let i=this.menuX,n=this.menuY,c=this.menuWidth,d=this.mouseClickX,u=this.mouseClickY;if(0===this.menuArea)d-=8,u-=11;else if(1===this.menuArea)d-=562,u-=231;else if(2===this.menuArea)d-=22,u-=375;let m=-1;for(let v=0;v<this.menuSize;v++){let S=n+15*(this.menuSize-1-v)+31;if(d>i&&d<i+c&&u>S-13&&u<S+3)m=v}if(-1!==m)await this.useMenuOption(m);if(this.menuVisible=!1,1===this.menuArea)this.redrawSidebar=!0;else if(2===this.menuArea)this.redrawChatback=!0}}else{if(1===i&&this.menuSize>0){let i=this.menuAction[this.menuSize-1];if(602===i||596===i||22===i||892===i||415===i||405===i||38===i||422===i||478===i||347===i||188===i){let i=this.menuParamB[this.menuSize-1],n=this.menuParamC[this.menuSize-1];if(s.instances[n].draggable){if(this.objGrabThreshold=!1,this.objDragCycles=0,this.objDragInterfaceId=n,this.objDragSlot=i,this.objDragArea=2,this.objGrabX=this.mouseClickX,this.objGrabY=this.mouseClickY,s.instances[n].layer===this.viewportInterfaceId)this.objDragArea=1;if(s.instances[n].layer===this.chatInterfaceId)this.objDragArea=3;return}}}if(1===i&&(1===this.mouseButtonsOption||this.isAddFriendOption(this.menuSize-1))&&this.menuSize>2)i=2;if(1===i&&this.menuSize>0)await this.useMenuOption(this.menuSize-1);if(2!==i||this.menuSize<=0)return;this.showContextMenu()}}handleMinimapInput(){if(1===this.mouseClickButton&&this.localPlayer){let i=this.mouseClickX-21-561,n=this.mouseClickY-9-5;if(i>=0&&n>=0&&i<146&&n<151){i-=73,n-=75;let c=this.orbitCameraYaw+this.minimapAnticheatAngle&2047,d=w.sin[c],u=w.cos[c];d=d*(this.minimapZoom+256)>>8,u=u*(this.minimapZoom+256)>>8;let m=n*d+i*u>>11,v=n*u-i*d>>11,S=this.localPlayer.x+m>>7,b=this.localPlayer.z-v>>7;if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],S,b,1,0,0,0,0,0,!0))this.out.p1(i),this.out.p1(n),this.out.p2(this.orbitCameraYaw),this.out.p1(57),this.out.p1(this.minimapAnticheatAngle),this.out.p1(this.minimapZoom),this.out.p1(89),this.out.p2(this.localPlayer.x),this.out.p2(this.localPlayer.z),this.out.p1(this.tryMoveNearest),this.out.p1(63)}}}isAddFriendOption(i){if(i<0)return!1;let n=this.menuAction[i];if(n>=2e3)n-=2e3;return 406===n}async useMenuOption(i){if(i<0)return;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;let n=this.menuAction[i],c=this.menuParamA[i],d=this.menuParamB[i],u=this.menuParamC[i];if(n>=2e3)n-=2e3;if(903===n||363===n){let c=this.menuOption[i],d=c.indexOf("@whi@");if(-1!==d){c=c.substring(d+5).trim();let i=l.formatName(l.fromBase37(l.toBase37(c))),u=!1;for(let c=0;c<this.playerCount;c++){let d=this.players[this.playerIds[c]];if(d&&d.name&&d.name.toLowerCase()===i.toLowerCase()&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d.routeFlagX[0],d.routeFlagZ[0],2,1,1,0,0,0,!1),903===n)this.out.p1isaac(206);else if(363===n)this.out.p1isaac(164);this.out.p2(this.playerIds[c]),u=!0;break}}if(!u)this.addMessage(0,"Unable to find "+i,"")}}else if(450===n&&this.interactWithLoc(75,d,u,c))this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface);else if(405===n||38===n||422===n||478===n||347===n){if(478===n){if(!(3&d))p.oplogic5++;if(p.oplogic5>=90)this.out.p1isaac(220);this.out.p1isaac(157)}else if(347===n)this.out.p1isaac(211);else if(422===n)this.out.p1isaac(133);else if(405===n){if(p.oplogic3+=c,p.oplogic3>=97)this.out.p1isaac(30),this.out.p3(14953816);this.out.p1isaac(195)}else if(38===n)this.out.p1isaac(71);if(this.out.p2(c),this.out.p2(d),this.out.p2(u),this.selectedCycle=0,this.selectedInterface=u,this.selectedItem=d,this.selectedArea=2,s.instances[u].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[u].layer===this.chatInterfaceId)this.selectedArea=3}else if(728===n||542===n||6===n||963===n||245===n){let i=this.npcs[c];if(i&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,542===n)this.out.p1isaac(8);else if(6===n){if(!(3&c))p.oplogic2++;if(p.oplogic2>=124)this.out.p1isaac(88),this.out.p4(0);this.out.p1isaac(27)}else if(963===n)this.out.p1isaac(113);else if(728===n)this.out.p1isaac(194);else if(245===n){if(!(3&c))p.oplogic4++;if(p.oplogic4>=85)this.out.p1isaac(176),this.out.p2(39596);this.out.p1isaac(100)}this.out.p2(c)}}else if(217===n){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(239),this.out.p2(d+this.sceneBaseTileX),this.out.p2(u+this.sceneBaseTileZ),this.out.p2(c),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}}else if(1175===n){let i=c>>14&32767,n=Q0.get(i),d;if(!n.desc)d="It's a "+n.name+".";else d=n.desc;this.addMessage(0,d,"")}else if(285===n)this.interactWithLoc(245,d,u,c);else if(881===n){if(this.out.p1isaac(130),this.out.p2(c),this.out.p2(d),this.out.p2(u),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface),this.selectedCycle=0,this.selectedInterface=u,this.selectedItem=d,this.selectedArea=2,s.instances[u].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[u].layer===this.chatInterfaceId)this.selectedArea=3}else if(391===n){if(this.out.p1isaac(48),this.out.p2(c),this.out.p2(d),this.out.p2(u),this.out.p2(this.activeSpellId),this.selectedCycle=0,this.selectedInterface=u,this.selectedItem=d,this.selectedArea=2,s.instances[u].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[u].layer===this.chatInterfaceId)this.selectedArea=3}else if(660===n)if(this.menuVisible)this.scene?.click(d-8,u-11);else this.scene?.click(this.mouseClickX-8,this.mouseClickY-11);else if(188===n)return this.objSelected=1,this.objSelectedSlot=d,this.objSelectedInterface=u,this.objInterface=c,this.objSelectedName=_0.get(c).name,void(this.spellSelected=0);else if(44===n){if(!this.pressedContinueOption)this.out.p1isaac(235),this.out.p2(u),this.pressedContinueOption=!0}else if(1773===n){let i=_0.get(c),n;if(u>=1e5)n=u+" x "+i.name;else if(!i.desc)n="It's a "+i.name+".";else n=i.desc;this.addMessage(0,n,"")}else if(900===n){let i=this.npcs[c];if(i&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(202),this.out.p2(c),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(1373===n||1544===n||151===n||1101===n){let i=this.players[c];if(i&&this.localPlayer){if(this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,1101===n)this.out.p1isaac(164);else if(151===n){if(p.oplogic8++,p.oplogic8>=90)this.out.p1isaac(2),this.out.p2(31114);this.out.p1isaac(53)}else if(1373===n)this.out.p1isaac(206);else if(1544===n)this.out.p1isaac(185);this.out.p2(c)}}else if(265===n){let i=this.npcs[c];if(i&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(134),this.out.p2(c),this.out.p2(this.activeSpellId)}else if(679===n){let n=this.menuOption[i],c=n.indexOf("@whi@");if(-1!==c){let i=l.toBase37(n.substring(c+5).trim()),d=-1;for(let n=0;n<this.friendCount;n++)if(this.friendName37[n]===i){d=n;break}if(-1!==d&&this.friendWorld[d]>0)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=3,this.socialName37=this.friendName37[d],this.socialMessage="Enter message to send to "+this.friendName[d]}}else if(55===n){if(this.interactWithLoc(9,d,u,c))this.out.p2(this.activeSpellId)}else if(224===n||993===n||99===n||746===n||877===n){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,1,1,0,0,0,!1);if(this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,224===n)this.out.p1isaac(140);else if(746===n)this.out.p1isaac(178);else if(877===n)this.out.p1isaac(247);else if(99===n)this.out.p1isaac(200);else if(993===n)this.out.p1isaac(40);this.out.p2(d+this.sceneBaseTileX),this.out.p2(u+this.sceneBaseTileZ),this.out.p2(c)}}else if(1607===n){let i=this.npcs[c];if(i&&i.npcType){let n;if(!i.npcType.desc)n="It's a "+i.npcType.name+".";else n=i.npcType.desc;this.addMessage(0,n,"")}}else if(504===n)this.interactWithLoc(172,d,u,c);else if(930===n){let i=s.instances[u];this.spellSelected=1,this.activeSpellId=u,this.activeSpellFlags=i.actionTarget,this.objSelected=0;let n=i.actionVerb;if(n&&-1!==n.indexOf(" "))n=n.substring(0,n.indexOf(" "));let c=i.actionVerb;if(c&&-1!==c.indexOf(" "))c=c.substring(c.indexOf(" ")+1);if(this.spellCaption=n+" "+i.action+" "+c,16===this.activeSpellFlags)this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;return}else if(951===n){let i=s.instances[u],n=!0;if(i.clientCode>0)n=this.handleInterfaceAction(i);if(n)this.out.p1isaac(155),this.out.p2(u)}else if(602===n||596===n||22===n||892===n||415===n){if(22===n)this.out.p1isaac(212);else if(415===n){if(!(3&u))p.oplogic7++;if(p.oplogic7>=55)this.out.p1isaac(17),this.out.p4(0);this.out.p1isaac(6)}else if(602===n)this.out.p1isaac(31);else if(892===n){if(!(3&d))p.oplogic9++;if(p.oplogic9>=130)this.out.p1isaac(238),this.out.p1(177);this.out.p1isaac(38)}else if(596===n)this.out.p1isaac(59);if(this.out.p2(c),this.out.p2(d),this.out.p2(u),this.selectedCycle=0,this.selectedInterface=u,this.selectedItem=d,this.selectedArea=2,s.instances[u].layer===this.viewportInterfaceId)this.selectedArea=1;if(s.instances[u].layer===this.chatInterfaceId)this.selectedArea=3}else if(581===n){if(!(3&c))p.oplogic1++;if(p.oplogic1>=99)this.out.p1isaac(7),this.out.p4(0);this.interactWithLoc(97,d,u,c)}else if(965===n){if(this.localPlayer){if(!this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,0,0,0,0,0,!1))this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],d,u,2,1,1,0,0,0,!1);this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(138),this.out.p2(d+this.sceneBaseTileX),this.out.p2(u+this.sceneBaseTileZ),this.out.p2(c),this.out.p2(this.activeSpellId)}}else if(1501===n){if(p.oplogic6+=this.sceneBaseTileZ,p.oplogic6>=92)this.out.p1isaac(66),this.out.p4(0);this.interactWithLoc(116,d,u,c)}else if(364===n)this.interactWithLoc(96,d,u,c);else if(1102===n){let i=_0.get(c),n;if(!i.desc)n="It's a "+i.name+".";else n=i.desc;this.addMessage(0,n,"")}else if(960===n){this.out.p1isaac(155),this.out.p2(u);let i=s.instances[u];if(i.script&&i.script[0]&&5===i.script[0][0]){let n=i.script[0][1];if(i.scriptOperand&&this.varps[n]!==i.scriptOperand[0])this.varps[n]=i.scriptOperand[0],await this.updateVarp(n),this.redrawSidebar=!0}}else if(34===n){let n=this.menuOption[i],c=n.indexOf("@whi@");if(-1!==c){this.closeInterfaces(),this.reportAbuseInput=n.substring(c+5).trim(),this.reportAbuseMuteOption=!1;for(let i=0;i<s.instances.length;i++)if(s.instances[i]&&600===s.instances[i].clientCode){this.reportAbuseInterfaceID=this.viewportInterfaceId=s.instances[i].layer;break}}}else if(947===n)this.closeInterfaces();else if(367===n){let i=this.players[c];if(i&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(248),this.out.p2(c),this.out.p2(this.objInterface),this.out.p2(this.objSelectedSlot),this.out.p2(this.objSelectedInterface)}else if(465===n){this.out.p1isaac(155),this.out.p2(u);let i=s.instances[u];if(i.script&&i.script[0]&&5===i.script[0][0]){let n=i.script[0][1];this.varps[n]=1-this.varps[n],await this.updateVarp(n),this.redrawSidebar=!0}}else if(406===n||436===n||557===n||556===n){let c=this.menuOption[i],d=c.indexOf("@whi@");if(-1!==d){let i=l.toBase37(c.substring(d+5).trim());if(406===n)this.addFriend(i);else if(436===n)this.addIgnore(i);else if(557===n)this.removeFriend(i);else if(556===n)this.removeIgnore(i)}}else if(651===n){let i=this.players[c];if(i&&this.localPlayer)this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],i.routeFlagX[0],i.routeFlagZ[0],2,1,1,0,0,0,!1),this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(177),this.out.p2(c),this.out.p2(this.activeSpellId)}this.objSelected=0,this.spellSelected=0}handleInterfaceAction(i){let n=i.clientCode;if(201===n)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=1,this.socialMessage="Enter name of friend to add to list";if(202===n)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=2,this.socialMessage="Enter name of friend to delete from list";if(205===n)return this.idleTimeout=250,!0;if(501===n)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=4,this.socialMessage="Enter name of player to add to list";if(502===n)this.redrawChatback=!0,this.chatbackInputOpen=!1,this.showSocialInput=!0,this.socialInput="",this.socialAction=5,this.socialMessage="Enter name of player to delete from list";if(n>=300&&n<=313){let i=(n-300)/2|0,c=1&n,d=this.designIdentikits[i];if(-1!==d)while(!0){if(0===c)if(d--,d<0)d=Y0.totalCount-1;if(1===c)if(d++,d>=Y0.totalCount)d=0;if(!Y0.instances[d].disableKit&&Y0.instances[d].bodyPart===i+(this.designGenderMale?0:7)){this.designIdentikits[i]=d,this.updateDesignModel=!0;break}}}if(n>=314&&n<=323){let i=(n-314)/2|0,c=1&n,d=this.designColors[i];if(0===c)if(d--,d<0)d=K0.DESIGN_IDK_COLORS[i].length-1;if(1===c)if(d++,d>=K0.DESIGN_IDK_COLORS[i].length)d=0;this.designColors[i]=d,this.updateDesignModel=!0}if(324===n&&!this.designGenderMale)this.designGenderMale=!0,this.validateCharacterDesign();if(325===n&&this.designGenderMale)this.designGenderMale=!1,this.validateCharacterDesign();if(326===n){this.out.p1isaac(52),this.out.p1(this.designGenderMale?0:1);for(let i=0;i<7;i++)this.out.p1(this.designIdentikits[i]);for(let i=0;i<5;i++)this.out.p1(this.designColors[i]);return!0}if(613===n)this.reportAbuseMuteOption=!this.reportAbuseMuteOption;if(n>=601&&n<=612)if(this.closeInterfaces(),this.reportAbuseInput.length>0)this.out.p1isaac(190),this.out.p8(l.toBase37(this.reportAbuseInput)),this.out.p1(n-601),this.out.p1(this.reportAbuseMuteOption?1:0);return!1}validateCharacterDesign(){this.updateDesignModel=!0;for(let i=0;i<7;i++){this.designIdentikits[i]=-1;for(let n=0;n<Y0.totalCount;n++)if(!Y0.instances[n].disableKit&&Y0.instances[n].bodyPart===i+(this.designGenderMale?0:7)){this.designIdentikits[i]=n;break}}}interactWithLoc(i,n,c,d){if(!this.localPlayer||!this.scene)return!1;let u=d>>14&32767,m=this.scene.getInfo(this.currentLevel,n,c,d);if(-1===m)return!1;let v=31&m,S=m>>6&3;if(v===h.CENTREPIECE_STRAIGHT.id||v===h.CENTREPIECE_DIAGONAL.id||v===h.GROUND_DECOR.id){let i=Q0.get(u),d,m;if(0===S||2===S)d=i.width,m=i.length;else d=i.length,m=i.width;let v=i.forceapproach;if(0!==S)v=(v<<S&15)+(v>>4-S);this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],n,c,2,d,m,0,0,v,!1)}else this.tryMove(this.localPlayer.routeFlagX[0],this.localPlayer.routeFlagZ[0],n,c,2,0,0,S,v+1,0,!1);return this.crossX=this.mouseClickX,this.crossY=this.mouseClickY,this.crossMode=2,this.crossCycle=0,this.out.p1isaac(i),this.out.p2(n+this.sceneBaseTileX),this.out.p2(c+this.sceneBaseTileZ),this.out.p2(u),!0}handleTabInput(){if(1===this.mouseClickButton){if(this.mouseClickX>=549&&this.mouseClickX<=583&&this.mouseClickY>=195&&this.mouseClickY<231&&-1!==this.tabInterfaceId[0])this.redrawSidebar=!0,this.selectedTab=0,this.redrawSideicons=!0;else if(this.mouseClickX>=579&&this.mouseClickX<=609&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[1])this.redrawSidebar=!0,this.selectedTab=1,this.redrawSideicons=!0;else if(this.mouseClickX>=607&&this.mouseClickX<=637&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[2])this.redrawSidebar=!0,this.selectedTab=2,this.redrawSideicons=!0;else if(this.mouseClickX>=635&&this.mouseClickX<=679&&this.mouseClickY>=194&&this.mouseClickY<229&&-1!==this.tabInterfaceId[3])this.redrawSidebar=!0,this.selectedTab=3,this.redrawSideicons=!0;else if(this.mouseClickX>=676&&this.mouseClickX<=706&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[4])this.redrawSidebar=!0,this.selectedTab=4,this.redrawSideicons=!0;else if(this.mouseClickX>=704&&this.mouseClickX<=734&&this.mouseClickY>=194&&this.mouseClickY<231&&-1!==this.tabInterfaceId[5])this.redrawSidebar=!0,this.selectedTab=5,this.redrawSideicons=!0;else if(this.mouseClickX>=732&&this.mouseClickX<=766&&this.mouseClickY>=195&&this.mouseClickY<231&&-1!==this.tabInterfaceId[6])this.redrawSidebar=!0,this.selectedTab=6,this.redrawSideicons=!0;else if(this.mouseClickX>=550&&this.mouseClickX<=584&&this.mouseClickY>=492&&this.mouseClickY<528&&-1!==this.tabInterfaceId[7])this.redrawSidebar=!0,this.selectedTab=7,this.redrawSideicons=!0;else if(this.mouseClickX>=582&&this.mouseClickX<=612&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[8])this.redrawSidebar=!0,this.selectedTab=8,this.redrawSideicons=!0;else if(this.mouseClickX>=609&&this.mouseClickX<=639&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[9])this.redrawSidebar=!0,this.selectedTab=9,this.redrawSideicons=!0;else if(this.mouseClickX>=637&&this.mouseClickX<=681&&this.mouseClickY>=493&&this.mouseClickY<528&&-1!==this.tabInterfaceId[10])this.redrawSidebar=!0,this.selectedTab=10,this.redrawSideicons=!0;else if(this.mouseClickX>=679&&this.mouseClickX<=709&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[11])this.redrawSidebar=!0,this.selectedTab=11,this.redrawSideicons=!0;else if(this.mouseClickX>=706&&this.mouseClickX<=736&&this.mouseClickY>=492&&this.mouseClickY<529&&-1!==this.tabInterfaceId[12])this.redrawSidebar=!0,this.selectedTab=12,this.redrawSideicons=!0;else if(this.mouseClickX>=734&&this.mouseClickX<=768&&this.mouseClickY>=492&&this.mouseClickY<528&&-1!==this.tabInterfaceId[13])this.redrawSidebar=!0,this.selectedTab=13,this.redrawSideicons=!0;if(p.cyclelogic1++,p.cyclelogic1>150)p.cyclelogic1=0,this.out.p1isaac(233),this.out.p1(43)}}async handleInputKey(){while(!0){let i;do{while(!0){if(i=this.pollKey(),-1===i)return;if(-1!==this.viewportInterfaceId&&this.viewportInterfaceId===this.reportAbuseInterfaceID){if(8===i&&this.reportAbuseInput.length>0)this.reportAbuseInput=this.reportAbuseInput.substring(0,this.reportAbuseInput.length-1);break}if(this.showSocialInput){if(i>=32&&i<=122&&this.socialInput.length<80)this.socialInput=this.socialInput+String.fromCharCode(i),this.redrawChatback=!0;if(8===i&&this.socialInput.length>0)this.socialInput=this.socialInput.substring(0,this.socialInput.length-1),this.redrawChatback=!0;if(13===i||10===i){let i;if(this.showSocialInput=!1,this.redrawChatback=!0,1===this.socialAction)i=l.toBase37(this.socialInput),this.addFriend(i);if(2===this.socialAction&&this.friendCount>0)i=l.toBase37(this.socialInput),this.removeFriend(i);if(3===this.socialAction&&this.socialInput.length>0&&this.socialName37){this.out.p1isaac(148),this.out.p1(0);let i=this.out.pos;if(this.out.p8(this.socialName37),v0.pack(this.out,this.socialInput),this.out.psize1(this.out.pos-i),this.socialInput=l.toSentenceCase(this.socialInput),this.socialInput=D0.filter(this.socialInput),this.addMessage(6,this.socialInput,l.formatName(l.fromBase37(this.socialName37))),2===this.privateChatSetting)this.privateChatSetting=1,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}if(4===this.socialAction&&this.ignoreCount<100)i=l.toBase37(this.socialInput),this.addIgnore(i);if(5===this.socialAction&&this.ignoreCount>0)i=l.toBase37(this.socialInput),this.removeIgnore(i)}}else if(this.chatbackInputOpen){if(i>=48&&i<=57&&this.chatbackInput.length<10)this.chatbackInput=this.chatbackInput+String.fromCharCode(i),this.redrawChatback=!0;if(8===i&&this.chatbackInput.length>0)this.chatbackInput=this.chatbackInput.substring(0,this.chatbackInput.length-1),this.redrawChatback=!0;if(13===i||10===i){if(this.chatbackInput.length>0){let i=0;try{i=parseInt(this.chatbackInput,10)}catch(i){}this.out.p1isaac(237),this.out.p4(i)}this.chatbackInputOpen=!1,this.redrawChatback=!0}}else if(-1===this.chatInterfaceId){if(i>=32&&(i<=122||this.chatTyped.startsWith("::")&&i<=126)&&this.chatTyped.length<80)this.chatTyped=this.chatTyped+String.fromCharCode(i),this.redrawChatback=!0;if(8===i&&this.chatTyped.length>0)this.chatTyped=this.chatTyped.substring(0,this.chatTyped.length-1),this.redrawChatback=!0;if((13===i||10===i)&&this.chatTyped.length>0){if(this.chatTyped.startsWith("::"))if("::fpson"===this.chatTyped)this.displayFps=!0;else if("::fpsoff"===this.chatTyped)this.displayFps=!1;else if(this.chatTyped.startsWith("::fps "))try{let i=parseInt(this.chatTyped.substring(6))||50;this.setTargetedFramerate(i)}catch(i){}else this.out.p1isaac(4),this.out.p1(this.chatTyped.length-1),this.out.pjstr(this.chatTyped.substring(2));else{let i=0;if(this.chatTyped.startsWith("yellow:"))i=0,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("red:"))i=1,this.chatTyped=this.chatTyped.substring(4);else if(this.chatTyped.startsWith("green:"))i=2,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("cyan:"))i=3,this.chatTyped=this.chatTyped.substring(5);else if(this.chatTyped.startsWith("purple:"))i=4,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("white:"))i=5,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("flash1:"))i=6,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash2:"))i=7,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("flash3:"))i=8,this.chatTyped=this.chatTyped.substring(7);else if(this.chatTyped.startsWith("glow1:"))i=9,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow2:"))i=10,this.chatTyped=this.chatTyped.substring(6);else if(this.chatTyped.startsWith("glow3:"))i=11,this.chatTyped=this.chatTyped.substring(6);let n=0;if(this.chatTyped.startsWith("wave:"))n=1,this.chatTyped=this.chatTyped.substring(5);if(this.chatTyped.startsWith("scroll:"))n=2,this.chatTyped=this.chatTyped.substring(7);this.out.p1isaac(158),this.out.p1(0);let c=this.out.pos;if(this.out.p1(i),this.out.p1(n),v0.pack(this.out,this.chatTyped),this.out.psize1(this.out.pos-c),this.chatTyped=l.toSentenceCase(this.chatTyped),this.chatTyped=D0.filter(this.chatTyped),this.localPlayer&&this.localPlayer.name)this.localPlayer.chat=this.chatTyped,this.localPlayer.chatColor=i,this.localPlayer.chatStyle=n,this.localPlayer.chatTimer=150,this.addMessage(2,this.localPlayer.chat,this.localPlayer.name);if(2===this.publicChatSetting)this.publicChatSetting=3,this.redrawPrivacySettings=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting)}this.chatTyped="",this.redrawChatback=!0}}}}while((i<97||i>122)&&(i<65||i>90)&&(i<48||i>57)&&32!==i);if(this.reportAbuseInput.length<12)this.reportAbuseInput=this.reportAbuseInput+String.fromCharCode(i)}}handleChatSettingsInput(){if(1===this.mouseClickButton)if(this.mouseClickX>=8&&this.mouseClickX<=108&&this.mouseClickY>=490&&this.mouseClickY<=522)this.publicChatSetting=(this.publicChatSetting+1)%4,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=137&&this.mouseClickX<=237&&this.mouseClickY>=490&&this.mouseClickY<=522)this.privateChatSetting=(this.privateChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=275&&this.mouseClickX<=375&&this.mouseClickY>=490&&this.mouseClickY<=522)this.tradeChatSetting=(this.tradeChatSetting+1)%3,this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.out.p1isaac(244),this.out.p1(this.publicChatSetting),this.out.p1(this.privateChatSetting),this.out.p1(this.tradeChatSetting);else if(this.mouseClickX>=416&&this.mouseClickX<=516&&this.mouseClickY>=490&&this.mouseClickY<=522){this.closeInterfaces(),this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let i=0;i<s.instances.length;i++)if(s.instances[i]&&600===s.instances[i].clientCode)return void(this.reportAbuseInterfaceID=this.viewportInterfaceId=s.instances[i].layer)}}handleScrollInput(i,n,c,d,u,m,v,S){if(this.scrollGrabbed)this.scrollInputPadding=32;else this.scrollInputPadding=0;if(this.scrollGrabbed=!1,i>=m&&i<m+16&&n>=v&&n<v+16){if(S.scrollPosition-=4*this.dragCycles,u)this.redrawSidebar=!0}else if(i>=m&&i<m+16&&n>=v+d-16&&n<v+d){if(S.scrollPosition+=4*this.dragCycles,u)this.redrawSidebar=!0}else if(i>=m-this.scrollInputPadding&&i<m+this.scrollInputPadding+16&&n>=v+16&&n<v+d-16&&this.dragCycles>0){let i=(d-32)*d/c|0;if(i<8)i=8;let m=n-v-(i/2|0)-16,b=d-i-32;if(S.scrollPosition=(c-d)*m/b|0,u)this.redrawSidebar=!0;this.scrollGrabbed=!0}}prepareGameScreen(){if(!this.areaChatback)this.unloadTitle(),this.drawArea=null,this.imageTitle2=null,this.imageTitle3=null,this.imageTitle4=null,this.imageTitle0=null,this.imageTitle1=null,this.imageTitle5=null,this.imageTitle6=null,this.imageTitle7=null,this.imageTitle8=null,this.areaChatback=new b0(479,96),this.areaMapback=new b0(168,160),T.clear(),this.imageMapback?.draw(0,0),this.areaSidebar=new b0(190,261),this.areaViewport=new b0(512,334),T.clear(),this.areaBackbase1=new b0(501,61),this.areaBackbase2=new b0(288,40),this.areaBackhmid1=new b0(269,66),this.redrawTitleBackground=!0}isFriend(i){if(!i)return!1;for(let n=0;n<this.friendCount;n++)if(i.toLowerCase()===this.friendName[n]?.toLowerCase())return!0;if(!this.localPlayer)return!1;return i.toLowerCase()===this.localPlayer.name?.toLowerCase()}addFriend(i){if(0n===i)return;if(this.friendCount>=100)return void this.addMessage(0,"Your friends list is full. Max of 100 hit","");let n=l.formatName(l.fromBase37(i));for(let c=0;c<this.friendCount;c++)if(this.friendName37[c]===i)return void this.addMessage(0,n+" is already on your friend list","");for(let c=0;c<this.ignoreCount;c++)if(this.ignoreName37[c]===i)return void this.addMessage(0,"Please remove "+n+" from your ignore list first","");if(!this.localPlayer||!this.localPlayer.name)return;if(n!==this.localPlayer.name)this.friendName[this.friendCount]=n,this.friendName37[this.friendCount]=i,this.friendWorld[this.friendCount]=0,this.friendCount++,this.redrawSidebar=!0,this.out.p1isaac(118),this.out.p8(i)}removeFriend(i){if(0n===i)return;for(let n=0;n<this.friendCount;n++)if(this.friendName37[n]===i){this.friendCount--,this.redrawSidebar=!0;for(let i=n;i<this.friendCount;i++)this.friendName[i]=this.friendName[i+1],this.friendWorld[i]=this.friendWorld[i+1],this.friendName37[i]=this.friendName37[i+1];return this.out.p1isaac(11),void this.out.p8(i)}}addIgnore(i){if(0n===i)return;if(this.ignoreCount>=100)return void this.addMessage(0,"Your ignore list is full. Max of 100 hit","");let n=l.formatName(l.fromBase37(i));for(let c=0;c<this.ignoreCount;c++)if(this.ignoreName37[c]===i)return void this.addMessage(0,n+" is already on your ignore list","");for(let c=0;c<this.friendCount;c++)if(this.friendName37[c]===i)return void this.addMessage(0,"Please remove "+n+" from your friend list first","");this.ignoreName37[this.ignoreCount++]=i,this.redrawSidebar=!0,this.out.p1isaac(79),this.out.p8(i)}removeIgnore(i){if(0n===i)return;for(let n=0;n<this.ignoreCount;n++)if(this.ignoreName37[n]===i){this.ignoreCount--,this.redrawSidebar=!0;for(let i=n;i<this.ignoreCount;i++)this.ignoreName37[i]=this.ignoreName37[i+1];return this.out.p1isaac(171),void this.out.p8(i)}}sortObjStacks(i,n){let c=this.objStacks[this.currentLevel][i][n];if(!c)return void this.scene?.removeObjStack(this.currentLevel,i,n);let d=-99999999,u=null;for(let i=c.head();i;i=c.next()){let n=_0.get(i.index),c=n.cost;if(n.stackable)c*=i.count+1;if(c>d)d=c,u=i}if(!u)return;c.addHead(u);let m=-1,v=-1,S=0,b=0;for(let i=c.head();i;i=c.next()){if(i.index!==u.index&&-1===m)m=i.index,S=i.count;if(i.index!==u.index&&i.index!==m&&-1===v)v=i.index,b=i.count}let x=null;if(-1!==m)x=_0.get(m).getInterfaceModel(S);let I=null;if(-1!==v)I=_0.get(v).getInterfaceModel(b);let A=i+(n<<7)+1610612736|0,k=_0.get(u.index);this.scene?.addObjStack(i,n,this.getHeightmapY(this.currentLevel,128*i+64,128*n+64),this.currentLevel,A,k.getInterfaceModel(u.count),I,x)}addLoc(i,n,c,d,u,m,v){if(n<1||c<1||n>102||c>102)return;if(p.lowMemory&&i!==this.currentLevel)return;if(!this.scene)return;let S=0;if(0===v)S=this.scene.getWallTypecode(i,n,c);else if(1===v)S=this.scene.getDecorTypecode(i,c,n);else if(2===v)S=this.scene.getLocTypecode(i,n,c);else if(3===v)S=this.scene.getGroundDecorTypecode(i,n,c);if(0!==S){let d=this.scene.getInfo(i,n,c,S),u=S>>14&32767,m=31&d,b=d>>6;if(0===v){this.scene?.removeWall(i,n,c,1);let d=Q0.get(u);if(d.blockwalk)this.levelCollisionMap[i]?.removeWall(n,c,m,b,d.blockrange)}else if(1===v)this.scene?.removeWallDecoration(i,n,c);else if(2===v){this.scene.removeLoc(i,n,c);let d=Q0.get(u);if(n+d.width>104-1||c+d.width>104-1||n+d.length>104-1||c+d.length>104-1)return;if(d.blockwalk)this.levelCollisionMap[i]?.removeLoc(n,c,d.width,d.length,b,d.blockrange)}else if(3===v){this.scene?.removeGroundDecoration(i,n,c);let d=Q0.get(u);if(d.blockwalk&&d.locActive)this.levelCollisionMap[i]?.removeFloor(n,c)}}if(d>=0){let v=i;if(this.levelTileFlags&&i<3&&!(2&~this.levelTileFlags[1][n][c]))v=i+1;if(this.levelHeightmap)a.addLoc(i,n,c,this.scene,this.levelHeightmap,this.locList,this.levelCollisionMap[i],d,m,u,v)}}closeInterfaces(){if(this.out.p1isaac(231),-1!==this.sidebarInterfaceId)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.pressedContinueOption=!1,this.redrawSideicons=!0;if(-1!==this.chatInterfaceId)this.chatInterfaceId=-1,this.redrawChatback=!0,this.pressedContinueOption=!1;this.viewportInterfaceId=-1}async tryReconnect(){if(this.idleTimeout>0)await this.logout();else if(this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,144,"Connection lost",0),this.fontPlain12?.drawStringCenter(256,143,"Connection lost",16777215),this.fontPlain12?.drawStringCenter(257,159,"Please wait - attempting to reestablish",0),this.fontPlain12?.drawStringCenter(256,158,"Please wait - attempting to reestablish",16777215),this.areaViewport?.draw(8,11),this.flagSceneTileX=0,this.netStream?.close(),this.ingame=!1,await this.tryLogin(this.usernameInput,this.passwordInput,!0),!this.ingame)await this.logout()}async logout(){if(this.netStream)this.netStream.close();this.netStream=null,this.ingame=!1,this.titleScreenState=0,this.usernameInput="",this.passwordInput="",$0.setDisabled(),this.clearCaches(),this.scene?.reset();for(let i=0;i<4;i++)this.levelCollisionMap[i]?.reset();z_(!1),this.currentMidi=null,this.nextMusicDelay=0}async read(){if(!this.netStream)return!1;try{let i=this.netStream.available;if(0===i)return!1;if(-1===this.inPacketType){if(await this.netStream.readBytes(this.in.data,0,1),this.inPacketType=255&this.in.data[0],this.randomIn)this.inPacketType=this.inPacketType-this.randomIn.nextInt&255;this.inPacketSize=B_[this.inPacketType],i--}if(-1===this.inPacketSize){if(i<=0)return!1;await this.netStream.readBytes(this.in.data,0,1),this.inPacketSize=255&this.in.data[0],i--}if(-2===this.inPacketSize){if(i<=1)return!1;await this.netStream.readBytes(this.in.data,0,2),this.in.pos=0,this.inPacketSize=this.in.g2(),i-=2}if(i<this.inPacketSize)return!1;if(this.in.pos=0,await this.netStream.readBytes(this.in.data,0,this.inPacketSize),this.idleNetCycles=0,this.lastPacketType2=this.lastPacketType1,this.lastPacketType1=this.lastPacketType0,this.lastPacketType0=this.inPacketType,150===this.inPacketType){let i=this.in.g2(),n=this.in.g1b();if(this.varCache[i]=n,this.varps[i]!==n)if(this.varps[i]=n,await this.updateVarp(i),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId)this.redrawChatback=!0;return this.inPacketType=-1,!0}if(152===this.inPacketType){let i=this.in.g8(),n=this.in.g1(),c=l.formatName(l.fromBase37(i));for(let d=0;d<this.friendCount;d++)if(i===this.friendName37[d]){if(this.friendWorld[d]!==n){if(this.friendWorld[d]=n,this.redrawSidebar=!0,n>0)this.addMessage(5,c+" has logged in.","");if(0===n)this.addMessage(5,c+" has logged out.","")}c=null;break}if(c&&this.friendCount<100)this.friendName37[this.friendCount]=i,this.friendName[this.friendCount]=c,this.friendWorld[this.friendCount]=n,this.friendCount++,this.redrawSidebar=!0;let d=!1;while(!d){d=!0;for(let i=0;i<this.friendCount-1;i++)if(this.friendWorld[i]!==p.nodeId&&this.friendWorld[i+1]===p.nodeId||0===this.friendWorld[i]&&0!==this.friendWorld[i+1]){let n=this.friendWorld[i];this.friendWorld[i]=this.friendWorld[i+1],this.friendWorld[i+1]=n;let c=this.friendName[i];this.friendName[i]=this.friendName[i+1],this.friendName[i+1]=c;let u=this.friendName37[i];this.friendName37[i]=this.friendName37[i+1],this.friendName37[i+1]=u,this.redrawSidebar=!0,d=!1}}return this.inPacketType=-1,!0}if(43===this.inPacketType)return this.systemUpdateTimer=30*this.in.g2(),this.inPacketType=-1,!0;if(80===this.inPacketType){let i=this.in.g1(),n=this.in.g1();if(this.sceneMapIndex&&this.sceneMapLandData&&this.sceneMapLandReady){let c=-1;for(let d=0;d<this.sceneMapIndex.length;d++)if(this.sceneMapIndex[d]===(i<<8)+n)c=d;if(-1!==c)this.db?.cachesave(`m${i}_${n}`,this.sceneMapLandData[c]),this.sceneMapLandReady[c]=!0}return this.inPacketType=-1,!0}if(1===this.inPacketType)return this.readNpcInfo(this.in,this.inPacketSize),this.inPacketType=-1,!0;if(237===this.inPacketType){let i=this.in.g2(),n=this.in.g2();if(this.sceneCenterZoneX===i&&this.sceneCenterZoneZ===n&&0!==this.sceneState)return this.inPacketType=-1,!0;this.sceneCenterZoneX=i,this.sceneCenterZoneZ=n,this.sceneBaseTileX=8*(this.sceneCenterZoneX-6),this.sceneBaseTileZ=8*(this.sceneCenterZoneZ-6),this.sceneState=1,this.areaViewport?.bind(),this.fontPlain12?.drawStringCenter(257,151,"Loading - please wait.",0),this.fontPlain12?.drawStringCenter(256,150,"Loading - please wait.",16777215),this.areaViewport?.draw(8,11);let c=(this.inPacketSize-2)/10|0;this.sceneMapLandData=new C(c,null),this.sceneMapLandReady=new C(c,!1),this.sceneMapLocData=new C(c,null),this.sceneMapLocReady=new C(c,!1),this.sceneMapIndex=new Int32Array(c),this.out.p1isaac(150),this.out.p1(0);let d=0;for(let i=0;i<c;i++){let n=this.in.g1(),c=this.in.g1(),u=this.in.g4(),m=this.in.g4();let v;if(this.sceneMapIndex[i]=(n<<8)+c,0!==u){if(v=await(this.db?.cacheload(`m${n}_${c}`)),v&&f.crc32(v)!==u)v=void 0;if(!v)this.out.p1(0),this.out.p1(n),this.out.p1(c),d+=3;else this.sceneMapLandData[i]=v,this.sceneMapLandReady[i]=!0}else this.sceneMapLandReady[i]=!0;if(0!==m){if(v=await(this.db?.cacheload(`l${n}_${c}`)),v&&f.crc32(v)!==m)v=void 0;if(!v)this.out.p1(1),this.out.p1(n),this.out.p1(c),d+=3;else this.sceneMapLocData[i]=v,this.sceneMapLocReady[i]=!0}else this.sceneMapLocReady[i]=!0}if(this.out.psize1(d),this.areaViewport?.bind(),0===this.sceneState)this.fontPlain12?.drawStringCenter(257,166,"Map area updated since last visit, so load will take longer this time only",0),this.fontPlain12?.drawStringCenter(256,165,"Map area updated since last visit, so load will take longer this time only",16777215);this.areaViewport?.draw(8,11);let u=this.sceneBaseTileX-this.scenePrevBaseTileX,m=this.sceneBaseTileZ-this.scenePrevBaseTileZ;this.scenePrevBaseTileX=this.sceneBaseTileX,this.scenePrevBaseTileZ=this.sceneBaseTileZ;for(let i=0;i<8192;i++){let n=this.npcs[i];if(n){for(let i=0;i<10;i++)n.routeFlagX[i]-=u,n.routeFlagZ[i]-=m;n.x-=128*u,n.z-=128*m}}for(let i=0;i<2048;i++){let n=this.players[i];if(n){for(let i=0;i<10;i++)n.routeFlagX[i]-=u,n.routeFlagZ[i]-=m;n.x-=128*u,n.z-=128*m}}this.sceneAwaitingSync=!0;let v=0,S=104,b=1;if(u<0)v=104-1,S=-1,b=-1;let x=0,I=104,A=1;if(m<0)x=104-1,I=-1,A=-1;for(let i=v;i!==S;i+=b)for(let n=x;n!==I;n+=A){let c=i+u,d=n+m;for(let u=0;u<4;u++)if(c>=0&&d>=0&&c<104&&d<104)this.objStacks[u][i][n]=this.objStacks[u][c][d];else this.objStacks[u][i][n]=null}for(let i=this.addedLocs.head();i;i=this.addedLocs.next())if(i.x-=u,i.z-=m,i.x<0||i.z<0||i.x>=104||i.z>=104)i.unlink();if(0!==this.flagSceneTileX)this.flagSceneTileX-=u,this.flagSceneTileZ-=m;return this.cutscene=!1,this.inPacketType=-1,!0}if(197===this.inPacketType)return s.instances[this.in.g2()].model=this.localPlayer?.getHeadModel()||null,this.inPacketType=-1,!0;if(25===this.inPacketType){if(this.hintType=this.in.g1(),1===this.hintType)this.hintNpc=this.in.g2();if(this.hintType>=2&&this.hintType<=6){if(2===this.hintType)this.hintOffsetX=64,this.hintOffsetZ=64;if(3===this.hintType)this.hintOffsetX=0,this.hintOffsetZ=64;if(4===this.hintType)this.hintOffsetX=128,this.hintOffsetZ=64;if(5===this.hintType)this.hintOffsetX=64,this.hintOffsetZ=0;if(6===this.hintType)this.hintOffsetX=64,this.hintOffsetZ=128;this.hintType=2,this.hintTileX=this.in.g2(),this.hintTileZ=this.in.g2(),this.hintHeight=this.in.g1()}if(10===this.hintType)this.hintPlayer=this.in.g2();return this.inPacketType=-1,!0}if(54===this.inPacketType){let i=this.in.gjstr(),n=this.in.g4(),c=this.in.g4();if(i!==this.currentMidi&&this.midiActive&&!p.lowMemory)await this.setMidi(i,n,c,!0);return this.currentMidi=i,this.midiCrc=n,this.midiSize=c,this.nextMusicDelay=0,this.inPacketType=-1,!0}if(142===this.inPacketType)return await this.logout(),this.inPacketType=-1,!1;if(20===this.inPacketType){let i=this.in.g1(),n=this.in.g1();if(this.sceneMapIndex&&this.sceneMapLocData&&this.sceneMapLocReady){let c=-1;for(let d=0;d<this.sceneMapIndex.length;d++)if(this.sceneMapIndex[d]===(i<<8)+n)c=d;if(-1!==c)this.db?.cachesave(`l${i}_${n}`,this.sceneMapLocData[c]),this.sceneMapLocReady[c]=!0}return this.inPacketType=-1,!0}if(19===this.inPacketType)return this.flagSceneTileX=0,this.inPacketType=-1,!0;if(139===this.inPacketType)return this.localPid=this.in.g2(),this.inPacketType=-1,!0;if(151===this.inPacketType||23===this.inPacketType||50===this.inPacketType||191===this.inPacketType||69===this.inPacketType||49===this.inPacketType||223===this.inPacketType||42===this.inPacketType||76===this.inPacketType||59===this.inPacketType)return this.readZonePacket(this.in,this.inPacketType),this.inPacketType=-1,!0;if(28===this.inPacketType){let i=this.in.g2(),n=this.in.g2();if(-1!==this.chatInterfaceId)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=i,this.sidebarInterfaceId=n,this.redrawSidebar=!0,this.redrawSideicons=!0,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(175===this.inPacketType){let i=this.in.g2(),n=this.in.g4();if(this.varCache[i]=n,this.varps[i]!==n)if(this.varps[i]=n,await this.updateVarp(i),this.redrawSidebar=!0,-1!==this.stickyChatInterfaceId)this.redrawChatback=!0;return this.inPacketType=-1,!0}if(146===this.inPacketType){let i=this.in.g2();return s.instances[i].anim=this.in.g2(),this.inPacketType=-1,!0}if(167===this.inPacketType){let i=this.in.g2(),n=this.in.g1();if(65535===i)i=-1;return this.tabInterfaceId[n]=i,this.redrawSidebar=!0,this.redrawSideicons=!0,this.inPacketType=-1,!0}if(220===this.inPacketType){let i=this.in.g1(),n=this.in.g1(),c=this.in.g2(),d=this.in.g2(),u=-1;if(this.sceneMapIndex)for(let c=0;c<this.sceneMapIndex.length;c++)if(this.sceneMapIndex[c]===(i<<8)+n)u=c;if(-1!==u&&this.sceneMapLocData){if(!this.sceneMapLocData[u]||this.sceneMapLocData[u]?.length!==d)this.sceneMapLocData[u]=new Uint8Array(d);let i=this.sceneMapLocData[u];if(i)this.in.gdata(this.inPacketSize-6,c,i)}return this.inPacketType=-1,!0}if(133===this.inPacketType){let i=$0.stop();if(i)this.out.p1isaac(81),this.out.p2(i.pos),this.out.pdata(i.data,i.pos,0),i.release();return this.inPacketType=-1,!0}if(98===this.inPacketType){this.redrawSidebar=!0;let i=this.in.g2(),n=s.instances[i],c=this.in.g1();if(n.invSlotObjId&&n.invSlotObjCount){for(let i=0;i<c;i++){n.invSlotObjId[i]=this.in.g2();let c=this.in.g1();if(255===c)c=this.in.g4();n.invSlotObjCount[i]=c}for(let i=c;i<n.invSlotObjId.length;i++)n.invSlotObjId[i]=0,n.invSlotObjCount[i]=0}else for(let i=0;i<c;i++)if(this.in.g2(),255===this.in.g1())this.in.g4();return this.inPacketType=-1,!0}if(226===this.inPacketType)return $0.setEnabled(),this.inPacketType=-1,!0;if(243===this.inPacketType){if(this.showSocialInput=!1,this.chatbackInputOpen=!0,this.chatbackInput="",this.redrawChatback=!0,this.inPacketType=-1,this.isMobile)P_.show();return!0}if(15===this.inPacketType){let i=s.instances[this.in.g2()];if(i.invSlotObjId)for(let n=0;n<i.invSlotObjId.length;n++)i.invSlotObjId[n]=-1,i.invSlotObjId[n]=0;return this.inPacketType=-1,!0}if(140===this.inPacketType){if(this.lastAddress=this.in.g4(),this.daysSinceLastLogin=this.in.g2(),this.daysSinceRecoveriesChanged=this.in.g1(),this.unreadMessages=this.in.g2(),0!==this.lastAddress&&-1===this.viewportInterfaceId){this.closeInterfaces();let i=650;if(201!==this.daysSinceRecoveriesChanged)i=655;this.reportAbuseInput="",this.reportAbuseMuteOption=!1;for(let n=0;n<s.instances.length;n++)if(s.instances[n]&&s.instances[n].clientCode===i){this.viewportInterfaceId=s.instances[n].layer;break}}return this.inPacketType=-1,!0}if(126===this.inPacketType){if(this.flashingTab=this.in.g1(),this.flashingTab===this.selectedTab){if(3===this.flashingTab)this.selectedTab=1;else this.selectedTab=3;this.redrawSidebar=!0}return this.inPacketType=-1,!0}if(212===this.inPacketType){if(this.midiActive&&!p.lowMemory){let i=this.in.g2(),n=this.in.data.subarray(this.in.pos,this.inPacketSize),c=U_.decompress(n,-1,!1,!0);S_(c,this.midiVolume,!1),this.nextMusicDelay=i}return this.inPacketType=-1,!0}if(254===this.inPacketType)return this.inMultizone=this.in.g1(),this.inPacketType=-1,!0;if(12===this.inPacketType){let i=this.in.g2(),n=this.in.g1(),c=this.in.g2();if(this.waveEnabled&&!p.lowMemory&&this.waveCount<50)this.waveIds[this.waveCount]=i,this.waveLoops[this.waveCount]=n,this.waveDelay[this.waveCount]=c+E0.delays[i],this.waveCount++;return this.inPacketType=-1,!0}if(204===this.inPacketType){let i=this.in.g2(),n=this.in.g2(),c=w0.get(n);return s.instances[i].model=c.getHeadModel(),this.inPacketType=-1,!0}if(7===this.inPacketType)return this.baseX=this.in.g1(),this.baseZ=this.in.g1(),this.inPacketType=-1,!0;if(103===this.inPacketType){let i=this.in.g2(),n=this.in.g2(),c=this.in.g2();return s.instances[i].model?.recolor(n,c),this.inPacketType=-1,!0}if(32===this.inPacketType)return this.publicChatSetting=this.in.g1(),this.privateChatSetting=this.in.g1(),this.tradeChatSetting=this.in.g1(),this.redrawPrivacySettings=!0,this.redrawChatback=!0,this.inPacketType=-1,!0;if(195===this.inPacketType){let i=this.in.g2();if(this.resetInterfaceAnimation(i),-1!==this.chatInterfaceId)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.sidebarInterfaceId=i,this.redrawSidebar=!0,this.redrawSideicons=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(14===this.inPacketType){let i=this.in.g2();if(this.resetInterfaceAnimation(i),-1!==this.sidebarInterfaceId)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;return this.chatInterfaceId=i,this.redrawChatback=!0,this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(209===this.inPacketType){let i=this.in.g2(),n=this.in.g2b(),c=this.in.g2b(),d=s.instances[i];return d.x=n,d.y=c,this.inPacketType=-1,!0}if(3===this.inPacketType){if(this.cutscene=!0,this.cutsceneSrcLocalTileX=this.in.g1(),this.cutsceneSrcLocalTileZ=this.in.g1(),this.cutsceneSrcHeight=this.in.g2(),this.cutsceneMoveSpeed=this.in.g1(),this.cutsceneMoveAcceleration=this.in.g1(),this.cutsceneMoveAcceleration>=100)this.cameraX=128*this.cutsceneSrcLocalTileX+64,this.cameraZ=128*this.cutsceneSrcLocalTileZ+64,this.cameraY=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;return this.inPacketType=-1,!0}if(135===this.inPacketType){this.baseX=this.in.g1(),this.baseZ=this.in.g1();for(let i=this.baseX;i<this.baseX+8;i++)for(let n=this.baseZ;n<this.baseZ+8;n++)if(this.objStacks[this.currentLevel][i][n])this.objStacks[this.currentLevel][i][n]=null,this.sortObjStacks(i,n);for(let i=this.addedLocs.head();i;i=this.addedLocs.next())if(i.x>=this.baseX&&i.x<this.baseX+8&&i.z>=this.baseZ&&i.z<this.baseZ+8&&i.plane===this.currentLevel)i.duration=0;return this.inPacketType=-1,!0}if(132===this.inPacketType){let i=this.in.g1(),n=this.in.g1(),c=this.in.g2(),d=this.in.g2(),u=-1;if(this.sceneMapIndex)for(let c=0;c<this.sceneMapIndex.length;c++)if(this.sceneMapIndex[c]===(i<<8)+n)u=c;if(-1!==u&&this.sceneMapLandData){if(!this.sceneMapLandData[u]||this.sceneMapLandData[u]?.length!==d)this.sceneMapLandData[u]=new Uint8Array(d);let i=this.sceneMapLandData[u];if(i)this.in.gdata(this.inPacketSize-6,c,i)}return this.inPacketType=-1,!0}if(41===this.inPacketType){let i=this.in.g8(),n=this.in.g4(),c=this.in.g1(),d=!1;for(let i=0;i<100;i++)if(this.messageTextIds[i]===n){d=!0;break}if(c<=1)for(let n=0;n<this.ignoreCount;n++)if(this.ignoreName37[n]===i){d=!0;break}if(!d&&0===this.overrideChat)try{this.messageTextIds[this.privateMessageCount]=n,this.privateMessageCount=(this.privateMessageCount+1)%100;let d=v0.unpack(this.in,this.inPacketSize-13),u=D0.filter(d);if(c>1)this.addMessage(7,u,l.formatName(l.fromBase37(i)));else this.addMessage(3,u,l.formatName(l.fromBase37(i)))}catch(i){}return this.inPacketType=-1,!0}if(193===this.inPacketType){for(let i=0;i<this.varps.length;i++)if(this.varps[i]!==this.varCache[i])this.varps[i]=this.varCache[i],await this.updateVarp(i),this.redrawSidebar=!0;return this.inPacketType=-1,!0}if(87===this.inPacketType){let i=this.in.g2(),n=this.in.g2();return s.instances[i].model=J.model(n),this.inPacketType=-1,!0}if(185===this.inPacketType)return this.stickyChatInterfaceId=this.in.g2b(),this.redrawChatback=!0,this.inPacketType=-1,!0;if(68===this.inPacketType){if(12===this.selectedTab)this.redrawSidebar=!0;return this.energy=this.in.g1(),this.inPacketType=-1,!0}if(74===this.inPacketType){if(this.cutscene=!0,this.cutsceneDstLocalTileX=this.in.g1(),this.cutsceneDstLocalTileZ=this.in.g1(),this.cutsceneDstHeight=this.in.g2(),this.cutsceneRotateSpeed=this.in.g1(),this.cutsceneRotateAcceleration=this.in.g1(),this.cutsceneRotateAcceleration>=100){let i=128*this.cutsceneDstLocalTileX+64,n=128*this.cutsceneDstLocalTileZ+64,c=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight,d=i-this.cameraX,u=c-this.cameraY,m=n-this.cameraZ,v=0|Math.sqrt(d*d+m*m);if(this.cameraPitch=2047&(325.949*Math.atan2(u,v)|0),this.cameraYaw=2047&(-325.949*Math.atan2(d,m)|0),this.cameraPitch<128)this.cameraPitch=128;if(this.cameraPitch>383)this.cameraPitch=383}return this.inPacketType=-1,!0}if(84===this.inPacketType)return this.selectedTab=this.in.g1(),this.redrawSidebar=!0,this.redrawSideicons=!0,this.inPacketType=-1,!0;if(4===this.inPacketType){let i=this.in.gjstr(),n;if(i.endsWith(":tradereq:")){let c=i.substring(0,i.indexOf(":"));n=l.toBase37(c);let d=!1;for(let i=0;i<this.ignoreCount;i++)if(this.ignoreName37[i]===n){d=!0;break}if(!d&&0===this.overrideChat)this.addMessage(4,"wishes to trade with you.",c)}else if(i.endsWith(":duelreq:")){let c=i.substring(0,i.indexOf(":"));n=l.toBase37(c);let d=!1;for(let i=0;i<this.ignoreCount;i++)if(this.ignoreName37[i]===n){d=!0;break}if(!d&&0===this.overrideChat)this.addMessage(8,"wishes to duel with you.",c)}else this.addMessage(0,i,"");return this.inPacketType=-1,!0}if(46===this.inPacketType){let i=this.in.g2(),n=this.in.g2(),c=this.in.g2(),d=_0.get(n);return s.instances[i].model=d.getInterfaceModel(50),s.instances[i].xan=d.xan2d,s.instances[i].yan=d.yan2d,s.instances[i].zoom=100*d.zoom2d/c|0,this.inPacketType=-1,!0}if(168===this.inPacketType){let i=this.in.g2();if(this.resetInterfaceAnimation(i),-1!==this.sidebarInterfaceId)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(-1!==this.chatInterfaceId)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=i,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(2===this.inPacketType){let i=this.in.g2(),n=this.in.g2(),c=n>>10&31,d=n>>5&31,u=31&n;return s.instances[i].colour=(c<<19)+(d<<11)+(u<<3),this.inPacketType=-1,!0}if(136===this.inPacketType){for(let i=0;i<this.players.length;i++){let n=this.players[i];if(!n)continue;n.primarySeqId=-1}for(let i=0;i<this.npcs.length;i++){let n=this.npcs[i];if(!n)continue;n.primarySeqId=-1}return this.inPacketType=-1,!0}if(26===this.inPacketType){let i=this.in.g2();return s.instances[i].hide=1===this.in.g1(),this.inPacketType=-1,!0}if(21===this.inPacketType){this.ignoreCount=this.inPacketSize/8|0;for(let i=0;i<this.ignoreCount;i++)this.ignoreName37[i]=this.in.g8();return this.inPacketType=-1,!0}if(239===this.inPacketType){this.cutscene=!1;for(let i=0;i<5;i++)this.cameraModifierEnabled[i]=!1;return this.inPacketType=-1,!0}if(129===this.inPacketType){if(-1!==this.sidebarInterfaceId)this.sidebarInterfaceId=-1,this.redrawSidebar=!0,this.redrawSideicons=!0;if(-1!==this.chatInterfaceId)this.chatInterfaceId=-1,this.redrawChatback=!0;if(this.chatbackInputOpen)this.chatbackInputOpen=!1,this.redrawChatback=!0;return this.viewportInterfaceId=-1,this.pressedContinueOption=!1,this.inPacketType=-1,!0}if(201===this.inPacketType){let i=this.in.g2();if(s.instances[i].text=this.in.gjstr(),s.instances[i].layer===this.tabInterfaceId[this.selectedTab])this.redrawSidebar=!0;return this.inPacketType=-1,!0}if(44===this.inPacketType){this.redrawSidebar=!0;let i=this.in.g1(),n=this.in.g4(),c=this.in.g1();this.skillExperience[i]=n,this.skillLevel[i]=c,this.skillBaseLevel[i]=1;for(let c=0;c<98;c++)if(n>=this.levelExperience[c])this.skillBaseLevel[i]=c+2;return this.inPacketType=-1,!0}if(162===this.inPacketType){this.baseX=this.in.g1(),this.baseZ=this.in.g1();while(this.in.pos<this.inPacketSize){let i=this.in.g1();this.readZonePacket(this.in,i)}return this.inPacketType=-1,!0}if(22===this.inPacketType){if(12===this.selectedTab)this.redrawSidebar=!0;return this.weightCarried=this.in.g2b(),this.inPacketType=-1,!0}if(13===this.inPacketType){let i=this.in.g1(),n=this.in.g1(),c=this.in.g1(),d=this.in.g1();return this.cameraModifierEnabled[i]=!0,this.cameraModifierJitter[i]=n,this.cameraModifierWobbleScale[i]=c,this.cameraModifierWobbleSpeed[i]=d,this.cameraModifierCycle[i]=0,this.inPacketType=-1,!0}if(213===this.inPacketType){this.redrawSidebar=!0;let i=this.in.g2(),n=s.instances[i];while(this.in.pos<this.inPacketSize){let i=this.in.g1(),c=this.in.g2(),d=this.in.g1();if(255===d)d=this.in.g4();if(n.invSlotObjId&&n.invSlotObjCount&&i>=0&&i<n.invSlotObjId.length)n.invSlotObjId[i]=c,n.invSlotObjCount[i]=d}return this.inPacketType=-1,!0}if(184===this.inPacketType)return this.readPlayerInfo(this.in,this.inPacketSize),this.sceneAwaitingSync=!1,this.inPacketType=-1,!0;await this.logout()}catch(i){await this.logout()}return!0}buildScene(){try{this.minimapLevel=-1,this.locList.clear(),this.spotanims.clear(),this.projectiles.clear(),w.clearTexels(),this.clearCaches(),this.scene?.reset();for(let i=0;i<4;i++)this.levelCollisionMap[i]?.reset();let i=new a(104,104,this.levelHeightmap,this.levelTileFlags);a.lowMemory=p.lowMemory;let n=this.sceneMapLandData?.length??0;if(this.sceneMapIndex)for(let i=0;i<n;i++){let n=this.sceneMapIndex[i]>>8,c=255&this.sceneMapIndex[i];if(33===n&&c>=71&&c<=73){a.lowMemory=!1;break}}if(p.lowMemory)this.scene?.setMinLevel(this.currentLevel);else this.scene?.setMinLevel(0);if(this.sceneMapIndex&&this.sceneMapLandData){this.out.p1isaac(108);for(let c=0;c<n;c++){let n=64*(this.sceneMapIndex[c]>>8)-this.sceneBaseTileX,d=64*(255&this.sceneMapIndex[c])-this.sceneBaseTileZ,u=this.sceneMapLandData[c];if(u){let c=U_.decompress(u,-1,!1,!0);i.readLandscape(8*(this.sceneCenterZoneX-6),8*(this.sceneCenterZoneZ-6),n,d,c)}else if(this.sceneCenterZoneZ<800)i.clearLandscape(d,n,64,64)}}if(this.sceneMapIndex&&this.sceneMapLocData){this.out.p1isaac(108);for(let c=0;c<n;c++){let n=64*(this.sceneMapIndex[c]>>8)-this.sceneBaseTileX,d=64*(255&this.sceneMapIndex[c])-this.sceneBaseTileZ,u=this.sceneMapLocData[c];if(u){let c=U_.decompress(u,-1,!1,!0);i.readLocs(this.scene,this.locList,this.levelCollisionMap,c,n,d)}}}this.out.p1isaac(108),i.build(this.scene,this.levelCollisionMap),this.areaViewport?.bind(),this.out.p1isaac(108);for(let i=this.locList.head();i;i=this.locList.next())if(2===(this.levelTileFlags&&2&this.levelTileFlags[1][i.heightmapNE][i.heightmapNW]))if(i.heightmapSW--,i.heightmapSW<0)i.unlink();for(let i=0;i<104;i++)for(let n=0;n<104;n++)this.sortObjStacks(i,n);this.clearAddedLocs()}catch(i){}Q0.modelCacheStatic?.clear(),w.initPool(20)}resetInterfaceAnimation(i){let n=s.instances[i];if(!n.childId)return;for(let i=0;i<n.childId.length&&-1!==n.childId[i];i++){let c=s.instances[n.childId[i]];if(1===c.comType)this.resetInterfaceAnimation(c.id);c.seqFrame=0,c.seqCycle=0}}initializeLevelExperience(){let i=0;for(let n=0;n<99;n++){let c=n+1,d;i+=c+300*Math.pow(2,c/7)|0,this.levelExperience[n]=i/4|0}}addMessage(i,n,c){if(0===i&&-1!==this.stickyChatInterfaceId)this.modalMessage=n,this.mouseClickButton=0;if(-1===this.chatInterfaceId)this.redrawChatback=!0;for(let i=99;i>0;i--)this.messageTextType[i]=this.messageTextType[i-1],this.messageTextSender[i]=this.messageTextSender[i-1],this.messageText[i]=this.messageText[i-1];this.messageTextType[0]=i,this.messageTextSender[0]=c,this.messageText[0]=n}async updateVarp(i){let n=z0.instances[i].clientcode;if(0!==n){let c=this.varps[i];if(1===n){if(1===c)w.setBrightness(.9);if(2===c)w.setBrightness(.8);if(3===c)w.setBrightness(.7);if(4===c)w.setBrightness(.6);_0.iconCache?.clear(),this.redrawTitleBackground=!0}if(3===n){let i=this.midiActive;if(0===c)this.midiVolume=128,K_(128),this.midiActive=!0;if(1===c)this.midiVolume=96,K_(96),this.midiActive=!0;if(2===c)this.midiVolume=64,K_(64),this.midiActive=!0;if(3===c)this.midiVolume=32,K_(32),this.midiActive=!0;if(4===c)this.midiActive=!1;if(this.midiActive!==i){if(this.midiActive&&this.currentMidi)await this.setMidi(this.currentMidi,this.midiCrc,this.midiSize,!1);else z_(!1);this.nextMusicDelay=0}}if(4===n){if(0===c)this.waveVolume=128,J_(128),this.waveEnabled=!0;if(1===c)this.waveVolume=96,J_(96),this.waveEnabled=!0;if(2===c)this.waveVolume=64,J_(64),this.waveEnabled=!0;if(3===c)this.waveVolume=32,J_(32),this.waveEnabled=!0;if(4===c)this.waveEnabled=!1}if(5===n)this.mouseButtonsOption=c;if(6===n)this.chatEffects=c;if(8===n)this.splitPrivateChat=c,this.redrawChatback=!0}}handleChatMouseInput(i,n){let c=0;for(let i=0;i<100;i++){if(!this.messageText[i])continue;let d=this.messageTextType[i],u=this.chatScrollOffset+70+4-14*c;if(u<-20)break;if(0===d)c++;if((1===d||2===d)&&(1===d||0===this.publicChatSetting||1===this.publicChatSetting&&this.isFriend(this.messageTextSender[i]))){if(n>u-14&&n<=u&&this.localPlayer&&this.messageTextSender[i]!==this.localPlayer.name){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=406,this.menuSize++}c++}if((3===d||7===d)&&0===this.splitPrivateChat&&(7===d||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageTextSender[i]))){if(n>u-14&&n<=u){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=34,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=406,this.menuSize++}c++}if(4===d&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageTextSender[i]))){if(n>u-14&&n<=u)this.menuOption[this.menuSize]="Accept trade @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=903,this.menuSize++;c++}if((5===d||6===d)&&0===this.splitPrivateChat&&this.privateChatSetting<2)c++;if(8===d&&(0===this.tradeChatSetting||1===this.tradeChatSetting&&this.isFriend(this.messageTextSender[i]))){if(n>u-14&&n<=u)this.menuOption[this.menuSize]="Accept duel @whi@"+this.messageTextSender[i],this.menuAction[this.menuSize]=363,this.menuSize++;c++}}}handlePrivateChatInput(i){if(0===this.splitPrivateChat)return;let n=0;if(0!==this.systemUpdateTimer)n=1;for(let c=0;c<100;c++)if(null!==this.messageText[c]){let d=this.messageTextType[c];if((3===d||7===d)&&(7===d||0===this.privateChatSetting||1===this.privateChatSetting&&this.isFriend(this.messageTextSender[c]))){let d=329-13*n;if(this.mouseX>8&&this.mouseX<520&&i-11>d-10&&i-11<=d+3){if(this.rights)this.menuOption[this.menuSize]="Report abuse @whi@"+this.messageTextSender[c],this.menuAction[this.menuSize]=2034,this.menuSize++;this.menuOption[this.menuSize]="Add ignore @whi@"+this.messageTextSender[c],this.menuAction[this.menuSize]=2436,this.menuSize++,this.menuOption[this.menuSize]="Add friend @whi@"+this.messageTextSender[c],this.menuAction[this.menuSize]=2406,this.menuSize++}if(n++,n>=5)return}if((5===d||6===d)&&this.privateChatSetting<2)if(n++,n>=5)return}}handleInterfaceInput(i,n,c,d,u,m){if(0!==i.comType||!i.childId||i.hide||n<d||c<u||n>d+i.width||c>u+i.height||!i.childX||!i.childY)return;let v=i.childId.length;for(let S=0;S<v;S++){let v=i.childX[S]+d,b=i.childY[S]+u-m,x=s.instances[i.childId[S]];if(v+=x.x,b+=x.y,(x.overLayer>=0||0!==x.overColour)&&n>=v&&c>=b&&n<v+x.width&&c<b+x.height)if(x.overLayer>=0)this.lastHoveredInterfaceId=x.overLayer;else this.lastHoveredInterfaceId=x.id;if(0===x.comType){if(this.handleInterfaceInput(x,n,c,v,b,x.scrollPosition),x.scroll>x.height)this.handleScrollInput(n,c,x.scroll,x.height,!0,v+x.width,b,x)}else if(2===x.comType){let i=0;for(let d=0;d<x.height;d++)for(let u=0;u<x.width;u++){let m=v+u*(x.marginX+32),S=b+d*(x.marginY+32);if(i<20&&x.invSlotOffsetX&&x.invSlotOffsetY)m+=x.invSlotOffsetX[i],S+=x.invSlotOffsetY[i];if(n<m||c<S||n>=m+32||c>=S+32){i++;continue}if(this.hoveredSlot=i,this.hoveredSlotParentId=x.id,!x.invSlotObjId||x.invSlotObjId[i]<=0){i++;continue}let I=_0.get(x.invSlotObjId[i]-1);if(1===this.objSelected&&x.interactable){if(x.id!==this.objSelectedInterface||i!==this.objSelectedSlot)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+I.name,this.menuAction[this.menuSize]=881,this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++}else if(1===this.spellSelected&&x.interactable){if(!(16&~this.activeSpellFlags))this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+I.name,this.menuAction[this.menuSize]=391,this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++}else{if(x.interactable)for(let n=4;n>=3;n--)if(I.iop&&I.iop[n]){if(this.menuOption[this.menuSize]=I.iop[n]+" @lre@"+I.name,3===n)this.menuAction[this.menuSize]=478;else if(4===n)this.menuAction[this.menuSize]=347;this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++}else if(4===n)this.menuOption[this.menuSize]="Drop @lre@"+I.name,this.menuAction[this.menuSize]=347,this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++;if(x.usable)this.menuOption[this.menuSize]="Use @lre@"+I.name,this.menuAction[this.menuSize]=188,this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++;if(x.interactable&&I.iop)for(let n=2;n>=0;n--)if(I.iop[n]){if(this.menuOption[this.menuSize]=I.iop[n]+" @lre@"+I.name,0===n)this.menuAction[this.menuSize]=405;else if(1===n)this.menuAction[this.menuSize]=38;else if(2===n)this.menuAction[this.menuSize]=422;this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++}if(x.iops)for(let n=4;n>=0;n--)if(x.iops[n]){if(this.menuOption[this.menuSize]=x.iops[n]+" @lre@"+I.name,0===n)this.menuAction[this.menuSize]=602;else if(1===n)this.menuAction[this.menuSize]=596;else if(2===n)this.menuAction[this.menuSize]=22;else if(3===n)this.menuAction[this.menuSize]=892;else if(4===n)this.menuAction[this.menuSize]=415;this.menuParamA[this.menuSize]=I.id,this.menuParamB[this.menuSize]=i,this.menuParamC[this.menuSize]=x.id,this.menuSize++}if(this.menuOption[this.menuSize]="Examine @lre@"+I.name,this.menuAction[this.menuSize]=1773,this.menuParamA[this.menuSize]=I.id,x.invSlotObjCount)this.menuParamC[this.menuSize]=x.invSlotObjCount[i];this.menuSize++}i++}}else if(n>=v&&c>=b&&n<v+x.width&&c<b+x.height)if(1===x.buttonType){let i=!1;if(0!==x.clientCode)i=this.handleSocialMenuOption(x);if(!i&&x.option)this.menuOption[this.menuSize]=x.option,this.menuAction[this.menuSize]=951,this.menuParamC[this.menuSize]=x.id,this.menuSize++}else if(2===x.buttonType&&0===this.spellSelected){let i=x.actionVerb;if(i&&-1!==i.indexOf(" "))i=i.substring(0,i.indexOf(" "));this.menuOption[this.menuSize]=i+" @gre@"+x.action,this.menuAction[this.menuSize]=930,this.menuParamC[this.menuSize]=x.id,this.menuSize++}else if(3===x.buttonType)this.menuOption[this.menuSize]="Close",this.menuAction[this.menuSize]=947,this.menuParamC[this.menuSize]=x.id,this.menuSize++;else if(4===x.buttonType&&x.option)this.menuOption[this.menuSize]=x.option,this.menuAction[this.menuSize]=465,this.menuParamC[this.menuSize]=x.id,this.menuSize++;else if(5===x.buttonType&&x.option)this.menuOption[this.menuSize]=x.option,this.menuAction[this.menuSize]=960,this.menuParamC[this.menuSize]=x.id,this.menuSize++;else if(6===x.buttonType&&!this.pressedContinueOption&&x.option)this.menuOption[this.menuSize]=x.option,this.menuAction[this.menuSize]=44,this.menuParamC[this.menuSize]=x.id,this.menuSize++}}handleSocialMenuOption(i){let n=i.clientCode;if(n>=1&&n<=200){if(n>=101)n-=101;else n--;return this.menuOption[this.menuSize]="Remove @whi@"+this.friendName[n],this.menuAction[this.menuSize]=557,this.menuSize++,this.menuOption[this.menuSize]="Message @whi@"+this.friendName[n],this.menuAction[this.menuSize]=679,this.menuSize++,!0}else if(n>=401&&n<=500)return this.menuOption[this.menuSize]="Remove @whi@"+i.text,this.menuAction[this.menuSize]=556,this.menuSize++,!0;return!1}handleViewportOptions(){if(0===this.objSelected&&0===this.spellSelected)this.menuOption[this.menuSize]="Walk here",this.menuAction[this.menuSize]=660,this.menuParamB[this.menuSize]=this.mouseX,this.menuParamC[this.menuSize]=this.mouseY,this.menuSize++;let i=-1;for(let n=0;n<J.pickedCount;n++){let c=J.picked[n],d=127&c,u=c>>7&127,m=c>>29&3,v=c>>14&32767;if(c===i)continue;if(i=c,2===m&&this.scene&&this.scene.getInfo(this.currentLevel,d,u,c)>=0){let i=Q0.get(v);if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @cya@"+i.name,this.menuAction[this.menuSize]=450,this.menuParamA[this.menuSize]=c,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++;else if(1!==this.spellSelected){if(i.op)for(let n=4;n>=0;n--)if(i.op[n]){if(this.menuOption[this.menuSize]=i.op[n]+" @cya@"+i.name,0===n)this.menuAction[this.menuSize]=285;if(1===n)this.menuAction[this.menuSize]=504;if(2===n)this.menuAction[this.menuSize]=364;if(3===n)this.menuAction[this.menuSize]=581;if(4===n)this.menuAction[this.menuSize]=1501;this.menuParamA[this.menuSize]=c,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}this.menuOption[this.menuSize]="Examine @cya@"+i.name,this.menuAction[this.menuSize]=1175,this.menuParamA[this.menuSize]=c,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}else if(!(4&~this.activeSpellFlags))this.menuOption[this.menuSize]=this.spellCaption+" @cya@"+i.name,this.menuAction[this.menuSize]=55,this.menuParamA[this.menuSize]=c,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}if(1===m){let i=this.npcs[v];if(i&&i.npcType&&1===i.npcType.size&&64==(127&i.x)&&64==(127&i.z))for(let n=0;n<this.npcCount;n++){let c=this.npcs[this.npcIds[n]];if(c&&c!==i&&c.npcType&&1===c.npcType.size&&c.x===i.x&&c.z===i.z)this.addNpcOptions(c.npcType,this.npcIds[n],d,u)}if(i&&i.npcType)this.addNpcOptions(i.npcType,v,d,u)}if(0===m){let i=this.players[v];if(i&&64==(127&i.x)&&64==(127&i.z)){for(let n=0;n<this.npcCount;n++){let c=this.npcs[this.npcIds[n]];if(c&&c.npcType&&1===c.npcType.size&&c.x===i.x&&c.z===i.z)this.addNpcOptions(c.npcType,this.npcIds[n],d,u)}for(let n=0;n<this.playerCount;n++){let c=this.players[this.playerIds[n]];if(c&&c!==i&&c.x===i.x&&c.z===i.z)this.addPlayerOptions(c,this.playerIds[n],d,u)}}if(i)this.addPlayerOptions(i,v,d,u)}if(3===m){let i=this.objStacks[this.currentLevel][d][u];if(!i)continue;for(let n=i.tail();n;n=i.prev()){let i=_0.get(n.index);if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @lre@"+i.name,this.menuAction[this.menuSize]=217,this.menuParamA[this.menuSize]=n.index,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++;else if(1!==this.spellSelected){for(let c=4;c>=0;c--)if(i.op&&i.op[c]){if(this.menuOption[this.menuSize]=i.op[c]+" @lre@"+i.name,0===c)this.menuAction[this.menuSize]=224;if(1===c)this.menuAction[this.menuSize]=993;if(2===c)this.menuAction[this.menuSize]=99;if(3===c)this.menuAction[this.menuSize]=746;if(4===c)this.menuAction[this.menuSize]=877;this.menuParamA[this.menuSize]=n.index,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}else if(2===c)this.menuOption[this.menuSize]="Take @lre@"+i.name,this.menuAction[this.menuSize]=99,this.menuParamA[this.menuSize]=n.index,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++;this.menuOption[this.menuSize]="Examine @lre@"+i.name,this.menuAction[this.menuSize]=1102,this.menuParamA[this.menuSize]=n.index,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}else if(!(1&~this.activeSpellFlags))this.menuOption[this.menuSize]=this.spellCaption+" @lre@"+i.name,this.menuAction[this.menuSize]=965,this.menuParamA[this.menuSize]=n.index,this.menuParamB[this.menuSize]=d,this.menuParamC[this.menuSize]=u,this.menuSize++}}}}addNpcOptions(i,n,c,d){if(this.menuSize>=400)return;let u=i.name;if(0!==i.vislevel&&this.localPlayer)u=u+this.getCombatLevelColorTag(this.localPlayer.combatLevel,i.vislevel)+" (level-"+i.vislevel+")";if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @yel@"+u,this.menuAction[this.menuSize]=900,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++;else if(1!==this.spellSelected){let m;if(i.op)for(m=4;m>=0;m--)if(i.op[m]&&"attack"!==i.op[m]?.toLowerCase()){if(this.menuOption[this.menuSize]=i.op[m]+" @yel@"+u,0===m)this.menuAction[this.menuSize]=728;else if(1===m)this.menuAction[this.menuSize]=542;else if(2===m)this.menuAction[this.menuSize]=6;else if(3===m)this.menuAction[this.menuSize]=963;else if(4===m)this.menuAction[this.menuSize]=245;this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}if(i.op)for(m=4;m>=0;m--)if(i.op[m]&&"attack"===i.op[m]?.toLowerCase()){let v=0;if(this.localPlayer&&i.vislevel>this.localPlayer.combatLevel)v=2e3;if(this.menuOption[this.menuSize]=i.op[m]+" @yel@"+u,0===m)this.menuAction[this.menuSize]=v+728;else if(1===m)this.menuAction[this.menuSize]=v+542;else if(2===m)this.menuAction[this.menuSize]=v+6;else if(3===m)this.menuAction[this.menuSize]=v+963;else if(4===m)this.menuAction[this.menuSize]=v+245;this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}this.menuOption[this.menuSize]="Examine @yel@"+u,this.menuAction[this.menuSize]=1607,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}else if(!(2&~this.activeSpellFlags))this.menuOption[this.menuSize]=this.spellCaption+" @yel@"+u,this.menuAction[this.menuSize]=265,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}addPlayerOptions(i,n,c,d){if(i===this.localPlayer||this.menuSize>=400)return;let u=null;if(this.localPlayer)u=i.name+this.getCombatLevelColorTag(this.localPlayer.combatLevel,i.combatLevel)+" (level-"+i.combatLevel+")";if(1===this.objSelected)this.menuOption[this.menuSize]="Use "+this.objSelectedName+" with @whi@"+u,this.menuAction[this.menuSize]=367,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++;else if(1!==this.spellSelected){if(this.menuOption[this.menuSize]="Follow @whi@"+u,this.menuAction[this.menuSize]=1544,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++,0===this.overrideChat)this.menuOption[this.menuSize]="Trade with @whi@"+u,this.menuAction[this.menuSize]=1373,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++;if(this.wildernessLevel>0){if(this.menuOption[this.menuSize]="Attack @whi@"+u,this.localPlayer&&this.localPlayer.combatLevel>=i.combatLevel)this.menuAction[this.menuSize]=151;else this.menuAction[this.menuSize]=2151;this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}if(1===this.worldLocationState)this.menuOption[this.menuSize]="Fight @whi@"+u,this.menuAction[this.menuSize]=151,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++;if(2===this.worldLocationState)this.menuOption[this.menuSize]="Duel-with @whi@"+u,this.menuAction[this.menuSize]=1101,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++}else if(!(8&~this.activeSpellFlags))this.menuOption[this.menuSize]=this.spellCaption+" @whi@"+u,this.menuAction[this.menuSize]=651,this.menuParamA[this.menuSize]=n,this.menuParamB[this.menuSize]=c,this.menuParamC[this.menuSize]=d,this.menuSize++;for(let i=0;i<this.menuSize;i++)if(660===this.menuAction[i])return void(this.menuOption[i]="Walk here @whi@"+u)}getCombatLevelColorTag(i,n){let c=i-n;if(c<-9)return"@red@";else if(c<-6)return"@or3@";else if(c<-3)return"@or2@";else if(c<0)return"@or1@";else if(c>9)return"@gre@";else if(c>6)return"@gr3@";else if(c>3)return"@gr2@";else if(c>0)return"@gr1@";else return"@yel@"}handleInput(){if(0===this.objDragArea){if(this.menuOption[0]="Cancel",this.menuAction[0]=1252,this.menuSize=1,this.handlePrivateChatInput(this.mouseY),this.lastHoveredInterfaceId=0,this.mouseX>8&&this.mouseY>11&&this.mouseX<520&&this.mouseY<345)if(-1===this.viewportInterfaceId)this.handleViewportOptions();else this.handleInterfaceInput(s.instances[this.viewportInterfaceId],this.mouseX,this.mouseY,8,11,0);if(this.lastHoveredInterfaceId!==this.viewportHoveredInterfaceIndex)this.viewportHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>562&&this.mouseY>231&&this.mouseX<752&&this.mouseY<492)if(-1!==this.sidebarInterfaceId)this.handleInterfaceInput(s.instances[this.sidebarInterfaceId],this.mouseX,this.mouseY,562,231,0);else if(-1!==this.tabInterfaceId[this.selectedTab])this.handleInterfaceInput(s.instances[this.tabInterfaceId[this.selectedTab]],this.mouseX,this.mouseY,562,231,0);if(this.lastHoveredInterfaceId!==this.sidebarHoveredInterfaceIndex)this.redrawSidebar=!0,this.sidebarHoveredInterfaceIndex=this.lastHoveredInterfaceId;if(this.lastHoveredInterfaceId=0,this.mouseX>22&&this.mouseY>375&&this.mouseX<431&&this.mouseY<471)if(-1===this.chatInterfaceId)this.handleChatMouseInput(this.mouseX-22,this.mouseY-375);else this.handleInterfaceInput(s.instances[this.chatInterfaceId],this.mouseX,this.mouseY,22,375,0);if(-1!==this.chatInterfaceId&&this.lastHoveredInterfaceId!==this.chatHoveredInterfaceIndex)this.redrawChatback=!0,this.chatHoveredInterfaceIndex=this.lastHoveredInterfaceId;let i=!1;while(!i){i=!0;for(let n=0;n<this.menuSize-1;n++)if(this.menuAction[n]<1e3&&this.menuAction[n+1]>1e3){let c=this.menuOption[n];this.menuOption[n]=this.menuOption[n+1],this.menuOption[n+1]=c;let d=this.menuAction[n];this.menuAction[n]=this.menuAction[n+1],this.menuAction[n+1]=d;let u=this.menuParamB[n];this.menuParamB[n]=this.menuParamB[n+1],this.menuParamB[n+1]=u;let m=this.menuParamC[n];this.menuParamC[n]=this.menuParamC[n+1],this.menuParamC[n+1]=m;let v=this.menuParamA[n];this.menuParamA[n]=this.menuParamA[n+1],this.menuParamA[n+1]=v,i=!1}}}}showContextMenu(){let i=0;if(this.fontBold12){let n;i=this.fontBold12.stringWidth("Choose Option");for(let c=0;c<this.menuSize;c++)if(n=this.fontBold12.stringWidth(this.menuOption[c]),n>i)i=n}i+=8;let n=15*this.menuSize+21,c,d;if(this.mouseClickX>8&&this.mouseClickY>11&&this.mouseClickX<520&&this.mouseClickY<345){if(c=this.mouseClickX-(i/2|0)-8,c+i>512)c=512-i;else if(c<0)c=0;if(d=this.mouseClickY-11,d+n>334)d=334-n;else if(d<0)d=0;this.menuVisible=!0,this.menuArea=0,this.menuX=c,this.menuY=d,this.menuWidth=i,this.menuHeight=15*this.menuSize+22}if(this.mouseClickX>562&&this.mouseClickY>231&&this.mouseClickX<752&&this.mouseClickY<492){if(c=this.mouseClickX-(i/2|0)-562,c<0)c=0;else if(c+i>190)c=190-i;if(d=this.mouseClickY-231,d<0)d=0;else if(d+n>261)d=261-n;this.menuVisible=!0,this.menuArea=1,this.menuX=c,this.menuY=d,this.menuWidth=i,this.menuHeight=15*this.menuSize+22}if(this.mouseClickX>22&&this.mouseClickY>375&&this.mouseClickX<501&&this.mouseClickY<471){if(c=this.mouseClickX-(i/2|0)-22,c<0)c=0;else if(c+i>479)c=479-i;if(d=this.mouseClickY-375,d<0)d=0;else if(d+n>96)d=96-n;this.menuVisible=!0,this.menuArea=2,this.menuX=c,this.menuY=d,this.menuWidth=i,this.menuHeight=15*this.menuSize+22}}tryMove(i,n,c,d,u,m,v,S,b,x,I){let A=this.levelCollisionMap[this.currentLevel];if(!A)return!1;let k=104,L=104;for(let i=0;i<k;i++)for(let n=0;n<L;n++){let c=o.index(i,n);this.bfsDirection[c]=0,this.bfsCost[c]=99999999}let O=i,X=n,M=o.index(i,n);this.bfsDirection[M]=99,this.bfsCost[M]=0;let Y=0,B=0;this.bfsStepX[Y]=i,this.bfsStepZ[Y++]=n;let F=!1,E=this.bfsStepX.length,D=A.flags;while(B!==Y){if(O=this.bfsStepX[B],X=this.bfsStepZ[B],B=(B+1)%E,O===c&&X===d){F=!0;break}if(b!==h.WALL_STRAIGHT.id){if((b<h.WALLDECOR_STRAIGHT_OFFSET.id||b===h.CENTREPIECE_STRAIGHT.id)&&A.reachedWall(O,X,c,d,b-1,S)){F=!0;break}if(b<h.CENTREPIECE_STRAIGHT.id&&A.reachedWallDecoration(O,X,c,d,b-1,S)){F=!0;break}}if(0!==m&&0!==v&&A.reachedLoc(O,X,c,d,m,v,x)){F=!0;break}let i=this.bfsCost[o.index(O,X)]+1,n=o.index(O-1,X);if(O>0&&0===this.bfsDirection[n]&&!(2621704&D[n]))this.bfsStepX[Y]=O-1,this.bfsStepZ[Y]=X,Y=(Y+1)%E,this.bfsDirection[n]=2,this.bfsCost[n]=i;if(n=o.index(O+1,X),O<k-1&&0===this.bfsDirection[n]&&!(2621824&D[n]))this.bfsStepX[Y]=O+1,this.bfsStepZ[Y]=X,Y=(Y+1)%E,this.bfsDirection[n]=8,this.bfsCost[n]=i;if(n=o.index(O,X-1),X>0&&0===this.bfsDirection[n]&&!(2621698&D[n]))this.bfsStepX[Y]=O,this.bfsStepZ[Y]=X-1,Y=(Y+1)%E,this.bfsDirection[n]=1,this.bfsCost[n]=i;if(n=o.index(O,X+1),X<L-1&&0===this.bfsDirection[n]&&!(2621728&D[n]))this.bfsStepX[Y]=O,this.bfsStepZ[Y]=X+1,Y=(Y+1)%E,this.bfsDirection[n]=4,this.bfsCost[n]=i;if(n=o.index(O-1,X-1),!(!(O>0&&X>0&&0===this.bfsDirection[n])||2621710&D[n]||2621704&D[o.index(O-1,X)]||2621698&D[o.index(O,X-1)]))this.bfsStepX[Y]=O-1,this.bfsStepZ[Y]=X-1,Y=(Y+1)%E,this.bfsDirection[n]=3,this.bfsCost[n]=i;if(n=o.index(O+1,X-1),!(!(O<k-1&&X>0&&0===this.bfsDirection[n])||2621827&D[n]||2621824&D[o.index(O+1,X)]||2621698&D[o.index(O,X-1)]))this.bfsStepX[Y]=O+1,this.bfsStepZ[Y]=X-1,Y=(Y+1)%E,this.bfsDirection[n]=9,this.bfsCost[n]=i;if(n=o.index(O-1,X+1),!(!(O>0&&X<L-1&&0===this.bfsDirection[n])||2621752&D[n]||2621704&D[o.index(O-1,X)]||2621728&D[o.index(O,X+1)]))this.bfsStepX[Y]=O-1,this.bfsStepZ[Y]=X+1,Y=(Y+1)%E,this.bfsDirection[n]=6,this.bfsCost[n]=i;if(n=o.index(O+1,X+1),!(!(O<k-1&&X<L-1&&0===this.bfsDirection[n])||2621920&D[n]||2621824&D[o.index(O+1,X)]||2621728&D[o.index(O,X+1)]))this.bfsStepX[Y]=O+1,this.bfsStepZ[Y]=X+1,Y=(Y+1)%E,this.bfsDirection[n]=12,this.bfsCost[n]=i}if(this.tryMoveNearest=0,!F){if(I){let i=100;for(let n=1;n<2;n++){for(let u=c-n;u<=c+n;u++)for(let c=d-n;c<=d+n;c++){let n=o.index(u,c);if(u>=0&&c>=0&&u<104&&c<104&&this.bfsCost[n]<i)i=this.bfsCost[n],O=u,X=c,this.tryMoveNearest=1,F=!0}if(F)break}}if(!F)return!1}B=0,this.bfsStepX[B]=O,this.bfsStepZ[B++]=X;let R=this.bfsDirection[o.index(O,X)],_=R;while(O!==i||X!==n){if(_!==R)R=_,this.bfsStepX[B]=O,this.bfsStepZ[B++]=X;if(!!(2&_))O++;else if(!!(8&_))O--;if(!!(1&_))X++;else if(!!(4&_))X--;_=this.bfsDirection[o.index(O,X)]}if(B>0){E=Math.min(B,25),B--;let i=this.bfsStepX[B],n=this.bfsStepZ[B];if(0===u)this.out.p1isaac(181),this.out.p1(E+E+3);else if(1===u)this.out.p1isaac(165),this.out.p1(E+E+3+14);else if(2===u)this.out.p1isaac(93),this.out.p1(E+E+3);if(1===this.actionKey[5])this.out.p1(1);else this.out.p1(0);this.out.p2(i+this.sceneBaseTileX),this.out.p2(n+this.sceneBaseTileZ),this.flagSceneTileX=this.bfsStepX[0],this.flagSceneTileZ=this.bfsStepZ[0];for(let c=1;c<E;c++)B--,this.out.p1(this.bfsStepX[B]-i),this.out.p1(this.bfsStepZ[B]-n);return!0}return 1!==u}readPlayerInfo(i,n){this.entityRemovalCount=0,this.entityUpdateCount=0,this.readLocalPlayer(i),this.readPlayers(i),this.readNewPlayers(i,n),this.readPlayerUpdates(i);for(let i=0;i<this.entityRemovalCount;i++){let n=this.entityRemovalIds[i],c=this.players[n];if(!c)continue;if(c.cycle!==this.loopCycle)this.players[n]=null}if(i.pos!==n)throw new Error;for(let i=0;i<this.playerCount;i++)if(!this.players[this.playerIds[i]])throw new Error}readLocalPlayer(i){if(i.bits(),0!==i.gBit(1)){let n=i.gBit(2);if(0===n)this.entityUpdateIds[this.entityUpdateCount++]=2047;else if(1===n){let n=i.gBit(3);if(this.localPlayer?.step(!1,n),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(2===n){let n=i.gBit(3);this.localPlayer?.step(!0,n);let c=i.gBit(3);if(this.localPlayer?.step(!0,c),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=2047}else if(3===n){this.currentLevel=i.gBit(2);let n=i.gBit(7),c=i.gBit(7),d=i.gBit(1);if(this.localPlayer?.move(1===d,n,c),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=2047}}}readPlayers(i){let n=i.gBit(8);if(n<this.playerCount)for(let i=n;i<this.playerCount;i++)this.entityRemovalIds[this.entityRemovalCount++]=this.playerIds[i];if(n>this.playerCount)throw new Error;this.playerCount=0;for(let c=0;c<n;c++){let n=this.playerIds[c],d=this.players[n];if(0===i.gBit(1)){if(this.playerIds[this.playerCount++]=n,d)d.cycle=this.loopCycle}else{let c=i.gBit(2);if(0===c){if(this.playerIds[this.playerCount++]=n,d)d.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=n}else if(1===c){if(this.playerIds[this.playerCount++]=n,d)d.cycle=this.loopCycle;let c=i.gBit(3);if(d?.step(!1,c),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=n}else if(2===c){if(this.playerIds[this.playerCount++]=n,d)d.cycle=this.loopCycle;let c=i.gBit(3);d?.step(!0,c);let u=i.gBit(3);if(d?.step(!0,u),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=n}else if(3===c)this.entityRemovalIds[this.entityRemovalCount++]=n}}}readNewPlayers(i,n){let c;while(i.bitPos+10<8*n){if(c=i.gBit(11),2047===c)break;if(!this.players[c]){this.players[c]=new K0;let i=this.playerAppearanceBuffer[c];if(i)this.players[c]?.read(i)}this.playerIds[this.playerCount++]=c;let n=this.players[c];if(n)n.cycle=this.loopCycle;let d=i.gBit(5);if(d>15)d-=32;let u=i.gBit(5);if(u>15)u-=32;let m=i.gBit(1);if(this.localPlayer)n?.move(1===m,this.localPlayer.routeFlagX[0]+d,this.localPlayer.routeFlagZ[0]+u);if(1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=c}i.bytes()}readPlayerUpdates(i){for(let n=0;n<this.entityUpdateCount;n++){let c=this.entityUpdateIds[n],d=this.players[c];if(!d)continue;let u=i.g1();if(!!(128&u))u+=i.g1()<<8;this.readPlayerUpdatesBlocks(d,c,u,i)}}readPlayerUpdatesBlocks(i,n,c,d){if(i.lastMask=c,i.lastMaskCycle=this.loopCycle,!!(1&c)){let c=d.g1(),u=new Uint8Array(c),m=new f(u);d.gdata(c,0,u),this.playerAppearanceBuffer[n]=m,i.read(m)}if(!!(2&c)){let n=d.g2();if(65535===n)n=-1;if(n===i.primarySeqId)i.primarySeqLoop=0;let c=d.g1();if(-1===n||-1===i.primarySeqId||r.instances[n].seqPriority>r.instances[i.primarySeqId].seqPriority||0===r.instances[i.primarySeqId].seqPriority)i.primarySeqId=n,i.primarySeqFrame=0,i.primarySeqCycle=0,i.primarySeqDelay=c,i.primarySeqLoop=0}if(!!(4&c))if(i.targetId=d.g2(),65535===i.targetId)i.targetId=-1;if(!!(8&c))if(i.chat=d.gjstr(),i.chatColor=0,i.chatStyle=0,i.chatTimer=150,i.name)this.addMessage(2,i.chat,i.name);if(!!(16&c))i.damage=d.g1(),i.damageType=d.g1(),i.combatCycle=this.loopCycle+400,i.health=d.g1(),i.totalHealth=d.g1();if(!!(32&c))i.targetTileX=d.g2(),i.targetTileZ=d.g2(),i.lastFaceX=i.targetTileX,i.lastFaceZ=i.targetTileZ;if(!!(64&c)){let n=d.g2(),c=d.g1(),u=d.g1(),m=d.pos;if(i.name){let m=l.toBase37(i.name),v=!1;if(c<=1)for(let i=0;i<this.ignoreCount;i++)if(this.ignoreName37[i]===m){v=!0;break}if(!v&&0===this.overrideChat)try{let m=v0.unpack(d,u),v=D0.filter(m);if(i.chat=v,i.chatColor=n>>8,i.chatStyle=255&n,i.chatTimer=150,c>1)this.addMessage(1,v,i.name);else this.addMessage(2,v,i.name)}catch(i){}}d.pos=m+u}if(!!(256&c)){i.spotanimId=d.g2();let n=d.g4();if(i.spotanimOffset=n>>16,i.spotanimLastCycle=this.loopCycle+(65535&n),i.spotanimFrame=0,i.spotanimCycle=0,i.spotanimLastCycle>this.loopCycle)i.spotanimFrame=-1;if(65535===i.spotanimId)i.spotanimId=-1}if(!!(512&c))i.forceMoveStartSceneTileX=d.g1(),i.forceMoveStartSceneTileZ=d.g1(),i.forceMoveEndSceneTileX=d.g1(),i.forceMoveEndSceneTileZ=d.g1(),i.forceMoveEndCycle=d.g2()+this.loopCycle,i.forceMoveStartCycle=d.g2()+this.loopCycle,i.forceMoveFaceDirection=d.g1(),i.routeLength=0,i.routeFlagX[0]=i.forceMoveEndSceneTileX,i.routeFlagZ[0]=i.forceMoveEndSceneTileZ}readNpcInfo(i,n){this.entityRemovalCount=0,this.entityUpdateCount=0,this.readNpcs(i),this.readNewNpcs(i,n),this.readNpcUpdates(i);for(let i=0;i<this.entityRemovalCount;i++){let n=this.entityRemovalIds[i],c=this.npcs[n];if(!c)continue;if(c.cycle!==this.loopCycle)c.npcType=null,this.npcs[n]=null}if(i.pos!==n)throw new Error;for(let i=0;i<this.npcCount;i++)if(!this.npcs[this.npcIds[i]])throw new Error}readNpcs(i){i.bits();let n=i.gBit(8);if(n<this.npcCount)for(let i=n;i<this.npcCount;i++)this.entityRemovalIds[this.entityRemovalCount++]=this.npcIds[i];if(n>this.npcCount)throw new Error;this.npcCount=0;for(let c=0;c<n;c++){let n=this.npcIds[c],d=this.npcs[n];if(0===i.gBit(1)){if(this.npcIds[this.npcCount++]=n,d)d.cycle=this.loopCycle}else{let c=i.gBit(2);if(0===c){if(this.npcIds[this.npcCount++]=n,d)d.cycle=this.loopCycle;this.entityUpdateIds[this.entityUpdateCount++]=n}else if(1===c){if(this.npcIds[this.npcCount++]=n,d)d.cycle=this.loopCycle;let c=i.gBit(3);if(d?.step(!1,c),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=n}else if(2===c){if(this.npcIds[this.npcCount++]=n,d)d.cycle=this.loopCycle;let c=i.gBit(3);d?.step(!0,c);let u=i.gBit(3);if(d?.step(!0,u),1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=n}else if(3===c)this.entityRemovalIds[this.entityRemovalCount++]=n}}}readNewNpcs(i,n){while(i.bitPos+21<8*n){let n=i.gBit(13);if(8191===n)break;if(!this.npcs[n])this.npcs[n]=new I_;let c=this.npcs[n];if(this.npcIds[this.npcCount++]=n,c)c.cycle=this.loopCycle,c.npcType=w0.get(i.gBit(11)),c.size=c.npcType.size,c.seqWalkId=c.npcType.walkanim,c.seqTurnAroundId=c.npcType.walkanim_b,c.seqTurnLeftId=c.npcType.walkanim_r,c.seqTurnRightId=c.npcType.walkanim_l,c.seqStandId=c.npcType.readyanim;else i.gBit(11);let d=i.gBit(5);if(d>15)d-=32;let u=i.gBit(5);if(u>15)u-=32;if(this.localPlayer)c?.move(!1,this.localPlayer.routeFlagX[0]+d,this.localPlayer.routeFlagZ[0]+u);if(1===i.gBit(1))this.entityUpdateIds[this.entityUpdateCount++]=n}i.bytes()}readNpcUpdates(i){for(let n=0;n<this.entityUpdateCount;n++){let c=this.entityUpdateIds[n],d=this.npcs[c];if(!d)continue;let u=i.g1();if(d.lastMask=u,d.lastMaskCycle=this.loopCycle,!!(2&u)){let n=i.g2();if(65535===n)n=-1;if(n===d.primarySeqId)d.primarySeqLoop=0;let c=i.g1();if(-1===n||-1===d.primarySeqId||r.instances[n].seqPriority>r.instances[d.primarySeqId].seqPriority||0===r.instances[d.primarySeqId].seqPriority)d.primarySeqId=n,d.primarySeqFrame=0,d.primarySeqCycle=0,d.primarySeqDelay=c,d.primarySeqLoop=0}if(!!(4&u))if(d.targetId=i.g2(),65535===d.targetId)d.targetId=-1;if(!!(8&u))d.chat=i.gjstr(),d.chatTimer=100;if(!!(16&u))d.damage=i.g1(),d.damageType=i.g1(),d.combatCycle=this.loopCycle+400,d.health=i.g1(),d.totalHealth=i.g1();if(!!(32&u))d.npcType=w0.get(i.g2()),d.seqWalkId=d.npcType.walkanim,d.seqTurnAroundId=d.npcType.walkanim_b,d.seqTurnLeftId=d.npcType.walkanim_r,d.seqTurnRightId=d.npcType.walkanim_l,d.seqStandId=d.npcType.readyanim;if(!!(64&u)){d.spotanimId=i.g2();let n=i.g4();if(d.spotanimOffset=n>>16,d.spotanimLastCycle=this.loopCycle+(65535&n),d.spotanimFrame=0,d.spotanimCycle=0,d.spotanimLastCycle>this.loopCycle)d.spotanimFrame=-1;if(65535===d.spotanimId)d.spotanimId=-1}if(!!(128&u))d.targetTileX=i.g2(),d.targetTileZ=i.g2(),d.lastFaceX=d.targetTileX,d.lastFaceZ=d.targetTileZ}}updatePlayers(){for(let i=-1;i<this.playerCount;i++){let n;if(-1===i)n=2047;else n=this.playerIds[i];let c=this.players[n];if(c)this.updateEntity(c)}if(p.cyclelogic6++,p.cyclelogic6>1406){p.cyclelogic6=0,this.out.p1isaac(219),this.out.p1(0);let i=this.out.pos;if(this.out.p1(162),this.out.p1(22),!(2*Math.random()|0))this.out.p1(84);if(this.out.p2(31824),this.out.p2(13490),!(2*Math.random()|0))this.out.p1(123);if(!(2*Math.random()|0))this.out.p1(134);this.out.p1(100),this.out.p1(94),this.out.p2(35521),this.out.psize1(this.out.pos-i)}}updateEntity(i){if(i.x<128||i.z<128||i.x>=13184||i.z>=13184)i.primarySeqId=-1,i.spotanimId=-1,i.forceMoveEndCycle=0,i.forceMoveStartCycle=0,i.x=128*i.routeFlagX[0]+64*i.size,i.z=128*i.routeFlagZ[0]+64*i.size,i.routeLength=0;if(i===this.localPlayer&&(i.x<1536||i.z<1536||i.x>=11776||i.z>=11776))i.primarySeqId=-1,i.spotanimId=-1,i.forceMoveEndCycle=0,i.forceMoveStartCycle=0,i.x=128*i.routeFlagX[0]+64*i.size,i.z=128*i.routeFlagZ[0]+64*i.size,i.routeLength=0;if(i.forceMoveEndCycle>this.loopCycle)this.updateForceMovement(i);else if(i.forceMoveStartCycle>=this.loopCycle)this.startForceMovement(i);else this.updateMovement(i);this.updateFacingDirection(i),this.updateSequences(i)}pushPlayers(){if(!this.localPlayer)return;if(this.localPlayer.x>>7===this.flagSceneTileX&&this.localPlayer.z>>7===this.flagSceneTileZ)this.flagSceneTileX=0;for(let i=-1;i<this.playerCount;i++){let n,c;if(-1===i)n=this.localPlayer,c=33538048;else n=this.players[this.playerIds[i]],c=this.playerIds[i]<<14;if(!n||!n.isVisibleNow())continue;n.lowMemory=(p.lowMemory&&this.playerCount>50||this.playerCount>200)&&-1!==i&&n.secondarySeqId===n.seqStandId;let d=n.x>>7,u=n.z>>7;if(d<0||d>=104||u<0||u>=104)continue;if(!n.locModel||this.loopCycle<n.locStartCycle||this.loopCycle>=n.locStopCycle){if(64==(127&n.x)&&64==(127&n.z)){if(this.tileLastOccupiedCycle[d][u]===this.sceneCycle)continue;this.tileLastOccupiedCycle[d][u]=this.sceneCycle}n.y=this.getHeightmapY(this.currentLevel,n.x,n.z),this.scene?.addTemporary(this.currentLevel,n.x,n.y,n.z,null,n,c,n.yaw,60,n.seqStretches)}else n.lowMemory=!1,n.y=this.getHeightmapY(this.currentLevel,n.x,n.z),this.scene?.addTemporary2(this.currentLevel,n.x,n.y,n.z,n.minTileX,n.minTileZ,n.maxTileX,n.maxTileZ,null,n,c,n.yaw)}}updateNpcs(){for(let i=0;i<this.npcCount;i++){let n=this.npcIds[i],c=this.npcs[n];if(c&&c.npcType)this.updateEntity(c)}}pushNpcs(){for(let i=0;i<this.npcCount;i++){let n=this.npcs[this.npcIds[i]],c=(this.npcIds[i]<<14)+536870911+1|0;if(!n||!n.isVisibleNow())continue;let d=n.x>>7,u=n.z>>7;if(d<0||d>=104||u<0||u>=104)continue;if(1===n.size&&64==(127&n.x)&&64==(127&n.z)){if(this.tileLastOccupiedCycle[d][u]===this.sceneCycle)continue;this.tileLastOccupiedCycle[d][u]=this.sceneCycle}this.scene?.addTemporary(this.currentLevel,n.x,this.getHeightmapY(this.currentLevel,n.x,n.z),n.z,null,n,c,n.yaw,64*(n.size-1)+60,n.seqStretches)}}pushProjectiles(){for(let i=this.projectiles.head();i;i=this.projectiles.next())if(i.projLevel!==this.currentLevel||this.loopCycle>i.lastCycle)i.unlink();else if(this.loopCycle>=i.startCycle){if(i.projTarget>0){let n=this.npcs[i.projTarget-1];if(n)i.updateVelocity(n.x,this.getHeightmapY(i.projLevel,n.x,n.z)-i.projOffsetY,n.z,this.loopCycle)}if(i.projTarget<0){let n=-i.projTarget-1,c;if(n===this.localPid)c=this.localPlayer;else c=this.players[n];if(c)i.updateVelocity(c.x,this.getHeightmapY(i.projLevel,c.x,c.z)-i.projOffsetY,c.z,this.loopCycle)}i.update(this.sceneDelta),this.scene?.addTemporary(this.currentLevel,0|i.x,0|i.y,0|i.z,null,i,-1,i.yaw,60,!1)}}pushSpotanims(){for(let i=this.spotanims.head();i;i=this.spotanims.next())if(i.spotLevel!==this.currentLevel||i.seqComplete)i.unlink();else if(this.loopCycle>=i.startCycle)if(i.update(this.sceneDelta),i.seqComplete)i.unlink();else this.scene?.addTemporary(i.spotLevel,i.x,i.y,i.z,null,i,-1,0,60,!1)}pushLocs(){for(let i=this.locList.head();i;i=this.locList.next()){let n=!1;if(i.seqCycle+=this.sceneDelta,-1===i.seqFrame)i.seqFrame=0,n=!0;if(i.seq.seqDelay)while(i.seqCycle>i.seq.seqDelay[i.seqFrame])if(i.seqCycle-=i.seq.seqDelay[i.seqFrame]+1,i.seqFrame++,n=!0,i.seqFrame>=i.seq.seqFrameCount)if(i.seqFrame-=i.seq.replayoff,i.seqFrame<0||i.seqFrame>=i.seq.seqFrameCount){i.unlink(),n=!1;break}if(n&&this.scene){let{heightmapSW:n,heightmapNE:c,heightmapNW:d}=i,u=0;if(0===i.heightmapSE)u=this.scene.getWallTypecode(n,c,d);else if(1===i.heightmapSE)u=this.scene.getDecorTypecode(n,d,c);else if(2===i.heightmapSE)u=this.scene.getLocTypecode(n,c,d);else if(3===i.heightmapSE)u=this.scene.getGroundDecorTypecode(n,c,d);if(this.levelHeightmap&&0!==u&&(u>>14&32767)===i.index){let m=this.levelHeightmap[n][c][d],v=this.levelHeightmap[n][c+1][d],S=this.levelHeightmap[n][c+1][d+1],b=this.levelHeightmap[n][c][d+1],x=Q0.get(i.index),I=-1;if(-1!==i.seqFrame&&i.seq.seqFrames)I=i.seq.seqFrames[i.seqFrame];if(2===i.heightmapSE){let i=this.scene.getInfo(n,c,d,u),A=31&i,k=i>>6;if(A===h.CENTREPIECE_DIAGONAL.id)A=h.CENTREPIECE_STRAIGHT.id;this.scene?.setLocModel(n,c,d,x.getModel(A,k,m,v,S,b,I))}else if(1===i.heightmapSE)this.scene?.setWallDecorationModel(n,c,d,x.getModel(h.WALLDECOR_STRAIGHT_NOOFFSET.id,0,m,v,S,b,I));else if(0===i.heightmapSE){let i=this.scene.getInfo(n,c,d,u),A=31&i,k=i>>6;if(A===h.WALL_L.id){let i=k+1&3;this.scene?.setWallModels(c,d,n,x.getModel(h.WALL_L.id,k+4,m,v,S,b,I),x.getModel(h.WALL_L.id,i,m,v,S,b,I))}else this.scene?.setWallModel(n,c,d,x.getModel(A,k,m,v,S,b,I))}else if(3===i.heightmapSE){let i=this.scene.getInfo(n,c,d,u)>>6;this.scene?.setGroundDecorationModel(n,c,d,x.getModel(h.GROUND_DECOR.id,i,m,v,S,b,I))}}else i.unlink()}}}updateEntityChats(){for(let i=-1;i<this.playerCount;i++){let n;if(-1===i)n=2047;else n=this.playerIds[i];let c=this.players[n];if(c&&c.chatTimer>0)if(c.chatTimer--,0===c.chatTimer)c.chat=null}for(let i=0;i<this.npcCount;i++){let n=this.npcIds[i],c=this.npcs[n];if(c&&c.chatTimer>0)if(c.chatTimer--,0===c.chatTimer)c.chat=null}}updateForceMovement(i){let n=i.forceMoveEndCycle-this.loopCycle,c=128*i.forceMoveStartSceneTileX+64*i.size,d=128*i.forceMoveStartSceneTileZ+64*i.size;if(i.x+=(c-i.x)/n|0,i.z+=(d-i.z)/n|0,i.seqTrigger=0,0===i.forceMoveFaceDirection)i.dstYaw=1024;if(1===i.forceMoveFaceDirection)i.dstYaw=1536;if(2===i.forceMoveFaceDirection)i.dstYaw=0;if(3===i.forceMoveFaceDirection)i.dstYaw=512}startForceMovement(i){if(i.forceMoveStartCycle===this.loopCycle||-1===i.primarySeqId||0!==i.primarySeqDelay||i.primarySeqCycle+1>r.instances[i.primarySeqId].seqDelay[i.primarySeqFrame]){let n=i.forceMoveStartCycle-i.forceMoveEndCycle,c=this.loopCycle-i.forceMoveEndCycle,d=128*i.forceMoveStartSceneTileX+64*i.size,u=128*i.forceMoveStartSceneTileZ+64*i.size,m=128*i.forceMoveEndSceneTileX+64*i.size,v=128*i.forceMoveEndSceneTileZ+64*i.size;i.x=(d*(n-c)+m*c)/n|0,i.z=(u*(n-c)+v*c)/n|0}if(i.seqTrigger=0,0===i.forceMoveFaceDirection)i.dstYaw=1024;if(1===i.forceMoveFaceDirection)i.dstYaw=1536;if(2===i.forceMoveFaceDirection)i.dstYaw=0;if(3===i.forceMoveFaceDirection)i.dstYaw=512;i.yaw=i.dstYaw}updateFacingDirection(i){if(-1!==i.targetId&&i.targetId<32768){let n=this.npcs[i.targetId];if(n){let c=i.x-n.x,d=i.z-n.z;if(0!==c||0!==d)i.dstYaw=2047&(325.949*Math.atan2(c,d)|0)}}if(i.targetId>=32768){let n=i.targetId-32768;if(n===this.localPid)n=2047;let c=this.players[n];if(c){let n=i.x-c.x,d=i.z-c.z;if(0!==n||0!==d)i.dstYaw=2047&(325.949*Math.atan2(n,d)|0)}}if((0!==i.targetTileX||0!==i.targetTileZ)&&(0===i.routeLength||i.seqTrigger>0)){let n=i.x-64*(i.targetTileX-this.sceneBaseTileX-this.sceneBaseTileX),c=i.z-64*(i.targetTileZ-this.sceneBaseTileZ-this.sceneBaseTileZ);if(0!==n||0!==c)i.dstYaw=2047&(325.949*Math.atan2(n,c)|0);i.targetTileX=0,i.targetTileZ=0}let n=i.dstYaw-i.yaw&2047;if(0!==n){if(n<32||n>2016)i.yaw=i.dstYaw;else if(n>1024)i.yaw-=32;else i.yaw+=32;if(i.yaw&=2047,i.secondarySeqId===i.seqStandId&&i.yaw!==i.dstYaw){if(-1!==i.seqTurnId)return void(i.secondarySeqId=i.seqTurnId);i.secondarySeqId=i.seqWalkId}}}updateSequences(i){let n;if(i.seqStretches=!1,-1!==i.secondarySeqId){if(n=r.instances[i.secondarySeqId],i.secondarySeqCycle++,n.seqDelay&&i.secondarySeqFrame<n.seqFrameCount&&i.secondarySeqCycle>n.seqDelay[i.secondarySeqFrame])i.secondarySeqCycle=0,i.secondarySeqFrame++;if(i.secondarySeqFrame>=n.seqFrameCount)i.secondarySeqCycle=0,i.secondarySeqFrame=0}if(-1!==i.primarySeqId&&0===i.primarySeqDelay){n=r.instances[i.primarySeqId],i.primarySeqCycle++;while(n.seqDelay&&i.primarySeqFrame<n.seqFrameCount&&i.primarySeqCycle>n.seqDelay[i.primarySeqFrame])i.primarySeqCycle-=n.seqDelay[i.primarySeqFrame],i.primarySeqFrame++;if(i.primarySeqFrame>=n.seqFrameCount){if(i.primarySeqFrame-=n.replayoff,i.primarySeqLoop++,i.primarySeqLoop>=n.replaycount)i.primarySeqId=-1;if(i.primarySeqFrame<0||i.primarySeqFrame>=n.seqFrameCount)i.primarySeqId=-1}i.seqStretches=n.stretches}if(i.primarySeqDelay>0)i.primarySeqDelay--;if(-1!==i.spotanimId&&this.loopCycle>=i.spotanimLastCycle){if(i.spotanimFrame<0)i.spotanimFrame=0;n=T0.instances[i.spotanimId].seq,i.spotanimCycle++;while(n&&n.seqDelay&&i.spotanimFrame<n.seqFrameCount&&i.spotanimCycle>n.seqDelay[i.spotanimFrame])i.spotanimCycle-=n.seqDelay[i.spotanimFrame],i.spotanimFrame++;if(n&&i.spotanimFrame>=n.seqFrameCount)if(i.spotanimFrame<0||i.spotanimFrame>=n.seqFrameCount)i.spotanimId=-1}}updateMovement(i){if(i.secondarySeqId=i.seqStandId,0===i.routeLength)return void(i.seqTrigger=0);if(-1!==i.primarySeqId&&0===i.primarySeqDelay)if(!r.instances[i.primarySeqId].walkmerge)return void i.seqTrigger++;let{x:n,z:c}=i,d=128*i.routeFlagX[i.routeLength-1]+64*i.size,u=128*i.routeFlagZ[i.routeLength-1]+64*i.size;if(d-n<=256&&d-n>=-256&&u-c<=256&&u-c>=-256){if(n<d)if(c<u)i.dstYaw=1280;else if(c>u)i.dstYaw=1792;else i.dstYaw=1536;else if(n>d)if(c<u)i.dstYaw=768;else if(c>u)i.dstYaw=256;else i.dstYaw=512;else if(c<u)i.dstYaw=1024;else i.dstYaw=0;let m=i.dstYaw-i.yaw&2047;if(m>1024)m-=2048;let v=i.seqTurnAroundId;if(m>=-256&&m<=256)v=i.seqWalkId;else if(m>=256&&m<768)v=i.seqTurnRightId;else if(m>=-768&&m<=-256)v=i.seqTurnLeftId;if(-1===v)v=i.seqWalkId;i.secondarySeqId=v;let S=4;if(i.yaw!==i.dstYaw&&-1===i.targetId)S=2;if(i.routeLength>2)S=6;if(i.routeLength>3)S=8;if(i.seqTrigger>0&&i.routeLength>1)S=8,i.seqTrigger--;if(i.routeRun[i.routeLength-1])S<<=1;if(S>=8&&i.secondarySeqId===i.seqWalkId&&-1!==i.seqRunId)i.secondarySeqId=i.seqRunId;if(n<d){if(i.x+=S,i.x>d)i.x=d}else if(n>d)if(i.x-=S,i.x<d)i.x=d;if(c<u){if(i.z+=S,i.z>u)i.z=u}else if(c>u)if(i.z-=S,i.z<u)i.z=u;if(i.x===d&&i.z===u)i.routeLength--}else i.x=d,i.z=u}getTopLevel(){let i=3;if(this.cameraPitch<310&&this.localPlayer){let n=this.cameraX>>7,c=this.cameraZ>>7,d=this.localPlayer.x>>7,u=this.localPlayer.z>>7;if(this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][n][c]))i=this.currentLevel;let m;if(d>n)m=d-n;else m=n-d;let v;if(u>c)v=u-c;else v=c-u;let S,b;if(m>v){S=65536*v/m|0,b=32768;while(n!==d){if(n<d)n++;else if(n>d)n--;if(this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][n][c]))i=this.currentLevel;if(b+=S,b>=65536){if(b-=65536,c<u)c++;else if(c>u)c--;if(this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][n][c]))i=this.currentLevel}}}else{S=65536*m/v|0,b=32768;while(c!==u){if(c<u)c++;else if(c>u)c--;if(this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][n][c]))i=this.currentLevel;if(b+=S,b>=65536){if(b-=65536,n<d)n++;else if(n>d)n--;if(this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][n][c]))i=this.currentLevel}}}}if(this.localPlayer&&this.levelTileFlags&&!!(4&this.levelTileFlags[this.currentLevel][this.localPlayer.x>>7][this.localPlayer.z>>7]))i=this.currentLevel;return i}getTopLevelCutscene(){if(!this.levelTileFlags)return 0;return this.getHeightmapY(this.currentLevel,this.cameraX,this.cameraZ)-this.cameraY>=800||!(4&this.levelTileFlags[this.currentLevel][this.cameraX>>7][this.cameraZ>>7])?3:this.currentLevel}getHeightmapY(i,n,c){if(!this.levelHeightmap)return 0;let d=Math.min(n>>7,104-1),u=Math.min(c>>7,104-1),m=i;if(i<3&&this.levelTileFlags&&!(2&~this.levelTileFlags[1][d][u]))m=i+1;let v=127&n,S=127&c,b,x;return(this.levelHeightmap[m][d][u]*(128-v)+this.levelHeightmap[m][d+1][u]*v>>7)*(128-S)+(this.levelHeightmap[m][d][u+1]*(128-v)+this.levelHeightmap[m][d+1][u+1]*v>>7)*S>>7}orbitCamera(i,n,c,d,u,m){let v=2048-u&2047,S=2048-d&2047,b=0,x=0,I=m,A,k,L;if(0!==v)A=w.sin[v],k=w.cos[v],L=x*k-m*A>>16,I=x*A+m*k>>16,x=L;if(0!==S)A=w.sin[S],k=w.cos[S],L=I*A+b*k>>16,I=I*k-b*A>>16,b=L;this.cameraX=i-b,this.cameraY=n-x,this.cameraZ=c-I,this.cameraPitch=u,this.cameraYaw=d}updateOrbitCamera(){if(!this.localPlayer)return;let i=this.localPlayer.x+this.cameraAnticheatOffsetX,n=this.localPlayer.z+this.cameraAnticheatOffsetZ;if(this.orbitCameraX-i<-500||this.orbitCameraX-i>500||this.orbitCameraZ-n<-500||this.orbitCameraZ-n>500)this.orbitCameraX=i,this.orbitCameraZ=n;if(this.orbitCameraX!==i)this.orbitCameraX+=(i-this.orbitCameraX)/16|0;if(this.orbitCameraZ!==n)this.orbitCameraZ+=(n-this.orbitCameraZ)/16|0;if(1===this.actionKey[1])this.orbitCameraYawVelocity+=(-this.orbitCameraYawVelocity-24)/2|0;else if(1===this.actionKey[2])this.orbitCameraYawVelocity+=(24-this.orbitCameraYawVelocity)/2|0;else this.orbitCameraYawVelocity=this.orbitCameraYawVelocity/2|0;if(1===this.actionKey[3])this.orbitCameraPitchVelocity+=(12-this.orbitCameraPitchVelocity)/2|0;else if(1===this.actionKey[4])this.orbitCameraPitchVelocity+=(-this.orbitCameraPitchVelocity-12)/2|0;else this.orbitCameraPitchVelocity=this.orbitCameraPitchVelocity/2|0;if(this.orbitCameraYaw=2047&(this.orbitCameraYaw+this.orbitCameraYawVelocity/2|0),this.orbitCameraPitch+=this.orbitCameraPitchVelocity/2|0,this.orbitCameraPitch<128)this.orbitCameraPitch=128;if(this.orbitCameraPitch>383)this.orbitCameraPitch=383;let c=this.orbitCameraX>>7,d=this.orbitCameraZ>>7,u=this.getHeightmapY(this.currentLevel,this.orbitCameraX,this.orbitCameraZ),m=0;if(this.levelHeightmap)if(c>3&&d>3&&c<100&&d<100)for(let i=c-4;i<=c+4;i++)for(let n=d-4;n<=d+4;n++){let c=this.currentLevel;if(c<3&&this.levelTileFlags&&!(2&~this.levelTileFlags[1][i][n]))c++;let d=u-this.levelHeightmap[c][i][n];if(d>m)m=d}let v=192*m;if(v>98048)v=98048;if(v<32768)v=32768;if(v>this.cameraPitchClamp)this.cameraPitchClamp+=(v-this.cameraPitchClamp)/24|0;else if(v<this.cameraPitchClamp)this.cameraPitchClamp+=(v-this.cameraPitchClamp)/80|0}applyCutscene(){let i=128*this.cutsceneSrcLocalTileX+64,n=128*this.cutsceneSrcLocalTileZ+64,c=this.getHeightmapY(this.currentLevel,this.cutsceneSrcLocalTileX,this.cutsceneSrcLocalTileZ)-this.cutsceneSrcHeight;if(this.cameraX<i)if(this.cameraX+=this.cutsceneMoveSpeed+((i-this.cameraX)*this.cutsceneMoveAcceleration/1e3|0),this.cameraX>i)this.cameraX=i;if(this.cameraX>i)if(this.cameraX-=this.cutsceneMoveSpeed+((this.cameraX-i)*this.cutsceneMoveAcceleration/1e3|0),this.cameraX<i)this.cameraX=i;if(this.cameraY<c)if(this.cameraY+=this.cutsceneMoveSpeed+((c-this.cameraY)*this.cutsceneMoveAcceleration/1e3|0),this.cameraY>c)this.cameraY=c;if(this.cameraY>c)if(this.cameraY-=this.cutsceneMoveSpeed+((this.cameraY-c)*this.cutsceneMoveAcceleration/1e3|0),this.cameraY<c)this.cameraY=c;if(this.cameraZ<n)if(this.cameraZ+=this.cutsceneMoveSpeed+((n-this.cameraZ)*this.cutsceneMoveAcceleration/1e3|0),this.cameraZ>n)this.cameraZ=n;if(this.cameraZ>n)if(this.cameraZ-=this.cutsceneMoveSpeed+((this.cameraZ-n)*this.cutsceneMoveAcceleration/1e3|0),this.cameraZ<n)this.cameraZ=n;i=128*this.cutsceneDstLocalTileX+64,n=128*this.cutsceneDstLocalTileZ+64,c=this.getHeightmapY(this.currentLevel,this.cutsceneDstLocalTileX,this.cutsceneDstLocalTileZ)-this.cutsceneDstHeight;let d=i-this.cameraX,u=c-this.cameraY,m=n-this.cameraZ,v=0|Math.sqrt(d*d+m*m),S=2047&(325.949*Math.atan2(u,v)|0),b=2047&(-325.949*Math.atan2(d,m)|0);if(S<128)S=128;if(S>383)S=383;if(this.cameraPitch<S)if(this.cameraPitch+=this.cutsceneRotateSpeed+((S-this.cameraPitch)*this.cutsceneRotateAcceleration/1e3|0),this.cameraPitch>S)this.cameraPitch=S;if(this.cameraPitch>S)if(this.cameraPitch-=this.cutsceneRotateSpeed+((this.cameraPitch-S)*this.cutsceneRotateAcceleration/1e3|0),this.cameraPitch<S)this.cameraPitch=S;let x=b-this.cameraYaw;if(x>1024)x-=2048;if(x<-1024)x+=2048;if(x>0)this.cameraYaw+=this.cutsceneRotateSpeed+(x*this.cutsceneRotateAcceleration/1e3|0),this.cameraYaw&=2047;if(x<0)this.cameraYaw-=this.cutsceneRotateSpeed+(-x*this.cutsceneRotateAcceleration/1e3|0),this.cameraYaw&=2047;let I=b-this.cameraYaw;if(I>1024)I-=2048;if(I<-1024)I+=2048;if(I<0&&x>0||I>0&&x<0)this.cameraYaw=b}readZonePacket(i,n){let c=i.g1(),d=this.baseX+(c>>4&7),u=this.baseZ+(7&c);if(59===n){let n=i.g1(),c=i.g2(),m=n>>2,v=3&n,S=h.of(m).layer;if(d>=0&&u>=0&&d<104&&u<104)this.appendLoc(-1,c,v,S,u,m,this.currentLevel,d,0)}else if(76===n){let n=i.g1(),c=n>>2,m=3&n,v=h.of(c).layer;if(d>=0&&u>=0&&d<104&&u<104)this.appendLoc(-1,-1,m,v,u,c,this.currentLevel,d,0)}else if(42===n){let n=i.g1()>>2,c=h.of(n).layer,m=i.g2();if(d>=0&&u>=0&&d<104&&u<104&&this.scene){let i=0;if(0===c)i=this.scene.getWallTypecode(this.currentLevel,d,u);else if(1===c)i=this.scene.getDecorTypecode(this.currentLevel,u,d);else if(2===c)i=this.scene.getLocTypecode(this.currentLevel,d,u);else if(3===c)i=this.scene.getGroundDecorTypecode(this.currentLevel,d,u);if(0!==i){let n=new G0(i>>14&32767,this.currentLevel,c,d,u,r.instances[m],!1);this.locList.addTail(n)}}}else if(223===n){let n=i.g2(),c=i.g2();if(d>=0&&u>=0&&d<104&&u<104){let i=new y0(n,c);if(!this.objStacks[this.currentLevel][d][u])this.objStacks[this.currentLevel][d][u]=new m0;this.objStacks[this.currentLevel][d][u]?.addTail(i),this.sortObjStacks(d,u)}}else if(49===n){let n=i.g2();if(d>=0&&u>=0&&d<104&&u<104){let i=this.objStacks[this.currentLevel][d][u];if(i){for(let c=i.head();c;c=i.next())if(c.index===(32767&n)){c.unlink();break}if(!i.head())this.objStacks[this.currentLevel][d][u]=null;this.sortObjStacks(d,u)}}}else if(69===n){let n=d+i.g1b(),c=u+i.g1b(),m=i.g2b(),v=i.g2(),S=i.g1(),b=i.g1(),x=i.g2(),I=i.g2(),A=i.g1(),k=i.g1();if(d>=0&&u>=0&&d<104&&u<104&&n>=0&&c>=0&&n<104&&c<104){d=128*d+64,u=128*u+64,n=128*n+64,c=128*c+64;let i=new q_(v,this.currentLevel,d,this.getHeightmapY(this.currentLevel,d,u)-S,u,x+this.loopCycle,I+this.loopCycle,A,k,m,b);i.updateVelocity(n,this.getHeightmapY(this.currentLevel,n,c)-b,c,x+this.loopCycle),this.projectiles.addTail(i)}}else if(191===n){let n=i.g2(),c=i.g1(),m=i.g2();if(d>=0&&u>=0&&d<104&&u<104){d=128*d+64,u=128*u+64;let i=new O_(n,this.currentLevel,d,u,this.getHeightmapY(this.currentLevel,d,u)-c,this.loopCycle,m);this.spotanims.addTail(i)}}else if(50===n){let n=i.g2(),c=i.g2(),m=i.g2();if(d>=0&&u>=0&&d<104&&u<104&&m!==this.localPid){let i=new y0(n,c);if(!this.objStacks[this.currentLevel][d][u])this.objStacks[this.currentLevel][d][u]=new m0;this.objStacks[this.currentLevel][d][u]?.addTail(i),this.sortObjStacks(d,u)}}else if(23===n){let n=i.g1(),c=n>>2,m=3&n,v=h.of(c).layer,S=i.g2(),b=i.g2(),x=i.g2(),I=i.g2(),A=i.g1b(),k=i.g1b(),L=i.g1b(),O=i.g1b(),X;if(I===this.localPid)X=this.localPlayer;else X=this.players[I];if(X&&this.levelHeightmap){this.appendLoc(b+this.loopCycle,-1,m,v,u,c,this.currentLevel,d,x+this.loopCycle);let i=this.levelHeightmap[this.currentLevel][d][u],n=this.levelHeightmap[this.currentLevel][d+1][u],I=this.levelHeightmap[this.currentLevel][d+1][u+1],M=this.levelHeightmap[this.currentLevel][d][u+1],Y=Q0.get(S);X.locStartCycle=b+this.loopCycle,X.locStopCycle=x+this.loopCycle,X.locModel=Y.getModel(c,m,i,n,I,M,-1);let{width:B,length:F}=Y;if(1===m||3===m)B=Y.length,F=Y.width;let E;if(X.locOffsetX=128*d+64*B,X.locOffsetZ=128*u+64*F,X.locOffsetY=this.getHeightmapY(this.currentLevel,X.locOffsetX,X.locOffsetZ),A>L)E=A,A=L,L=E;if(k>O)E=k,k=O,O=E;X.minTileX=d+A,X.maxTileX=d+L,X.minTileZ=u+k,X.maxTileZ=u+O}}else if(151===n){let n=i.g2(),c=i.g2(),m=i.g2();if(d>=0&&u>=0&&d<104&&u<104){let i=this.objStacks[this.currentLevel][d][u];if(i){for(let d=i.head();d;d=i.next())if(d.index===(32767&n)&&d.count===c){d.count=m;break}this.sortObjStacks(d,u)}}}}updateTextures(i){if(!p.lowMemory){if(w.textureCycle[17]>=i){let i=w.textures[17];if(!i)return;let n=i.width2d*i.height2d-1,c=i.width2d*this.sceneDelta*2,d=i.pixels,u=this.textureBuffer;for(let i=0;i<=n;i++)u[i]=d[i-c&n];i.pixels=u,this.textureBuffer=d,w.pushTexture(17)}if(w.textureCycle[24]>=i){let i=w.textures[24];if(!i)return;let n=i.width2d*i.height2d-1,c=i.width2d*this.sceneDelta*2,d=i.pixels,u=this.textureBuffer;for(let i=0;i<=n;i++)u[i]=d[i-c&n];i.pixels=u,this.textureBuffer=d,w.pushTexture(24)}}}updateFlames(){if(!(this.flameBuffer3&&this.flameBuffer2&&this.flameBuffer0&&this.flameLineOffset))return;let i=256;for(let n=10;n<117;n++)if((100*Math.random()|0)<50)this.flameBuffer3[n+(i-2<<7)]=255;for(let i=0;i<100;i++){let i,n,c=(124*Math.random()|0)+2+((128*Math.random()|0)+128<<7);this.flameBuffer3[c]=192}for(let n=1;n<i-1;n++)for(let i=1;i<127;i++){let c=i+(n<<7);this.flameBuffer2[c]=(this.flameBuffer3[c-1]+this.flameBuffer3[c+1]+this.flameBuffer3[c-128]+this.flameBuffer3[c+128])/4|0}if(this.flameCycle0+=128,this.flameCycle0>this.flameBuffer0.length)this.flameCycle0-=this.flameBuffer0.length,this.updateFlameBuffer(this.imageRunes[12*Math.random()|0]);for(let n=1;n<i-1;n++)for(let i=1;i<127;i++){let c=i+(n<<7),d=this.flameBuffer2[c+128]-(this.flameBuffer0[c+this.flameCycle0&this.flameBuffer0.length-1]/5|0);if(d<0)d=0;this.flameBuffer3[c]=d}for(let n=0;n<i-1;n++)this.flameLineOffset[n]=this.flameLineOffset[n+1];if(this.flameLineOffset[i-1]=16*Math.sin(this.loopCycle/14)+14*Math.sin(this.loopCycle/15)+12*Math.sin(this.loopCycle/16)|0,this.flameGradientCycle0>0)this.flameGradientCycle0-=4;if(this.flameGradientCycle1>0)this.flameGradientCycle1-=4;if(0===this.flameGradientCycle0&&0===this.flameGradientCycle1){let i=2e3*Math.random()|0;if(0===i)this.flameGradientCycle0=1024;else if(1===i)this.flameGradientCycle1=1024}}mix(i,n,c){let d=256-n;return((16711935&i)*d+(16711935&c)*n&4278255360)+((65280&i)*d+(65280&c)*n&16711680)>>8}drawFlames(){if(!(this.flameGradient&&this.flameGradient0&&this.flameGradient1&&this.flameGradient2&&this.flameLineOffset&&this.flameBuffer3))return;let i=256;if(this.flameGradientCycle0>0)for(let i=0;i<256;i++)if(this.flameGradientCycle0>768)this.flameGradient[i]=this.mix(this.flameGradient0[i],1024-this.flameGradientCycle0,this.flameGradient1[i]);else if(this.flameGradientCycle0>256)this.flameGradient[i]=this.flameGradient1[i];else this.flameGradient[i]=this.mix(this.flameGradient1[i],256-this.flameGradientCycle0,this.flameGradient0[i]);else if(this.flameGradientCycle1>0)for(let i=0;i<256;i++)if(this.flameGradientCycle1>768)this.flameGradient[i]=this.mix(this.flameGradient0[i],1024-this.flameGradientCycle1,this.flameGradient2[i]);else if(this.flameGradientCycle1>256)this.flameGradient[i]=this.flameGradient2[i];else this.flameGradient[i]=this.mix(this.flameGradient2[i],256-this.flameGradientCycle1,this.flameGradient0[i]);else for(let i=0;i<256;i++)this.flameGradient[i]=this.flameGradient0[i];for(let i=0;i<33920;i++)if(this.imageTitle0&&this.imageFlamesLeft)this.imageTitle0.pixels[i]=this.imageFlamesLeft.pixels[i];let n=0,c=1152;for(let d=1;d<i-1;d++){let u=(this.flameLineOffset[d]*(i-d)/i|0)+22;if(u<0)u=0;n+=u;for(let i=u;i<128;i++){let i=this.flameBuffer3[n++];if(0===i)c++;else{let n=i,d=256-i;if(i=this.flameGradient[i],this.imageTitle0){let u=this.imageTitle0.pixels[c];this.imageTitle0.pixels[c++]=((16711935&i)*n+(16711935&u)*d&4278255360)+((65280&i)*n+(65280&u)*d&16711680)>>8}}}c+=u}this.imageTitle0?.draw(0,0);for(let i=0;i<33920;i++)if(this.imageTitle1&&this.imageFlamesRight)this.imageTitle1.pixels[i]=this.imageFlamesRight.pixels[i];n=0,c=1176;for(let d=1;d<i-1;d++){let u=this.flameLineOffset[d]*(i-d)/i|0,m=103-u;c+=u;for(let i=0;i<m;i++){let i=this.flameBuffer3[n++];if(0===i)c++;else{let n=i,d=256-i;if(i=this.flameGradient[i],this.imageTitle1){let u=this.imageTitle1.pixels[c];this.imageTitle1.pixels[c++]=((16711935&i)*n+(16711935&u)*d&4278255360)+((65280&i)*n+(65280&u)*d&16711680)>>8}}}n+=128-m,c+=128-m-u}if(this.imageTitle1?.draw(661,0),this.isMobile)P_.draw()}}export{p as Client};